主要用于实例的账号管理、在线DDL、在线SQL、在线SQL日志、数据库参数、防火墙和网关参数的设置。
## 账号管理
### 创建账号
#### 背景介绍
在正式使用实例之前，需要创建数据库的账号并设置访问权限。
####  操作步骤
1. 在赤兔管理台主界面，点击左侧菜单【实例管理】，进入实例管理界面。
2. 选择所需实例ID >【数据库管理】，系统默认进入【用户管理】子界面。
3. 点击【创建用户+】，系统弹出创建用户页面，进行相关账号信息及读写方式设置。
	- 【用户名】：由字母、数字、下划线组成，字母开通，字母或数字结尾，最长16个字符组成；
	- 【密码】：可点击【换一个密码】进行选择，也可手动收入，为8\~16位的任意字符；建议包括英文、数字和符号等，并定期修改密码。
	- 【客户端IP】：可理解为HOST，支持IP、IP段、%三种形式；%代表结尾符，例如，我们要支持10.10.10.1\~10.10.10.254的所有主机IP，可以输入10.10.10.%；不输入代表%。
	- 【过期时间】：代表该账号的失效时间，如果为临时账号，请设置该项。
 
**正常账号:只选择主机进行读写。**
  - 【读写方式】：设置为正常账号只选择主机进行读写。
  - 【最大并发连接数】：设置该账号的最大并发连接数。
     
**只读账号：优先在备机进行读，如果备机的延迟大于设置的延迟，则从主机读取。**
 - 【读写方式】：设置只读账号为优先在备机进行读，如果备机的延迟大于设置的延迟，则从主机读取。
 - 【连接备机的方式】：选择主备延迟过大时，自动选择备机或者断开连接。
 - 【当只读时】：选择只读方式。选则正常的备机进行读或者选择watch节点读。
 - 【IDC选择策略】：选择IDC策略。
	 1. 随机选择IDC（默认）
	 2. 优先选和主节点同一IDC的备机
	 3. 只选择和主节点同一IDC的备机
	 4. 优先访问和proxy同IDC备机
	 5. 优先访问和proxy同IDC备机的备机和主机
 - 【只读备机延迟值】：设置延迟值，=0: 使用配置文件中的num ，>0: 随机选择主备延迟小于该值的备机
 - 【最大并发连接数】：设置该账号的最大并发连接数。
     
**只读账号：只选择备机进行读，如果所有备机都大于设置的延迟值，则报错。**
  -      【读写方式】：设置只读账号为只选择备机进行读如果所有备机都大于设置的延迟值，则报错。
  -      【连接备机的方式】：选择主备延迟过大时，自动选择备机或者断开连接。
  -      【当只读时，将】：选择只读方式。选则正常的备机进行读或者选择watch节点读。
  -      【IDC选择策略】：选择IDC策略。
         1.  随机选择IDC（默认）
         2.  优先选和主节点同一IDC的备机
         3.  只选择和主节点同一IDC的备机
         4.  优先访问和proxy同IDC备机
         5.  优先访问和proxy同IDC备机的备机和主机
  -   【只读备机延迟值】：设置延迟值，=0: 使用配置文件中的num ，>0: 随机选择主备延迟小于该值的备机
  -   【最大并发连接数】：设置该账号的最大并发连接数。
    
**只读账号：只选择备机进行读，忽略延迟参数，一般用于拉取binlog同步。**
 -   【读写方式】：设置只读账号为只选择备机进行读如果所有备机都大于设置的延迟值，则报错。
 -   【当只读时，将】：选择只读方式。选则正常的备机进行读或者选择watch节点读。
 -   【IDC选择策略】：选择IDC策略。
	 1.  随机选择IDC（默认）
	 2.  优先选和主节点同一IDC的备机
	 3.  只选择和主节点同一IDC的备机
	 4.  优先访问和proxy同IDC备机
	 5.  优先访问和proxy同IDC备机的备机和主机
 -   【只读备机延迟值】：设置延迟值，=0: 使用配置文件中的num ，>0: 随机选择主备延迟小于该值的备机
 -   【最大并发连接数】：设置该账号的最大并发连接数。

**DCN读写分离账号：写主DCN优先读备DCN。**
 -   【读写方式】：设置只读账号为只选择备机进行读如果所有备机都大于设置的延迟值，则报错。
 -   【当只读时，将】：选择只读方式。选则正常的备机进行读或者选择watch节点读。
 -   【IDC选择策略】：选择IDC策略。
	 1.  随机选择IDC（默认）
	 2.  优先选和主节点同一IDC的备机
	 3.  只选择和主节点同一IDC的备机
	 4.  优先访问和proxy同IDC备机
	 5.  优先访问和proxy同IDC备机的备机和主机
 -   【只读备机延迟值】：设置延迟值，=0: 使用配置文件中的num ，>0: 随机选择主备延迟小于该值的备机 。
 -   【DCN账号属性】：选择DCN账号属性。
	 1.  关闭主城读写分离，关闭备城读写分离
	 2.  关闭主城读写分离，开启备城读写分离(单主不停服)
	 3.  开启主城读写分离(单主不停服)，开启备城读写分离(单主不停服)
 -   【最大并发连接数】：设置该账号的最大并发连接数。
 
4.  点击【下一步】，进入【权限设置】子菜单，选择授权的对象，并勾选相关权限项；如需选择全部权限，勾选【全部】。可设置数据库全部权限，也可为数据库中数据表、数据视图、存储过程和函数设置相应的权限。
>!如果未创建数据库时，将无法设置数据库相应对象的权限。暂不支持命令行"insert into mysql.user"、"grant"、"drop"的创建、修改账号。

5.  点击【开始创建】，系统进入详情页，可以查看账号和权限设置进度和结果。

### 修改密码和权限
#### 背景介绍
实例创建成功后，在“账户管理”页面点击“密码修改”、“权限设置”可修改账号权限。
#### 操作步骤
1. 在赤兔管理台主界面，点击左侧菜单【实例管理】>选择所需实例ID>选择【数据库管理】，系统默认进入【用户管理】子界面。
2. 选择所需用户，点击【操作】栏下方相应设置项进行设置。
 - 【修改用户】：修改用户的读写方式，如需批量修改用户的读写方式，点击【批量修改用户读写方式】。
 - 【修改权限】：修改用户的权限设置。
 - 【增加grant权限】：给用户的添加grant权限。
 - 【修改密码】：修改用户密码。
 - 【克隆用户】：修改用户名，并复制当前用户的相关设置项。
 - 【修改最大连接数】：修改该账号的最大并发连接数，仅适用于TCE390版。
 - 【删除用户】：删除用户信息。   
   
## OnlineDDL
### 背景介绍
通过在线DDL对数据库引擎，数据库表的字段和索引类型进行更改，生成对应的Alter语句，以对数据库表配置进行变更。大表结构的修改可能较慢，但不会影响应用层系统的稳定性。
>!进行在线DDL前，必须先安装OnlineDDL模块。

>?赤兔上支持指定的账户密码来执行 DDL 操作。OnlineDDL支持赤兔 create table/ database, drop table/database操作（分片表需填写ShardKey），语句直接转发给OnlineDDL执行。


### 操作步骤
1.  在赤兔管理台主界面，点击组左侧菜单【实例详情】，进入实例管理界面。
2.  在列表中选择所需实例，并点击该实例ID。
3.  点击【数据库管理】>【在线DDL】，进入数据库DDL子界面。
4.  选择左侧所需数据库，并点击数据下方所需数据库表。
5.  点击对应项右侧【编辑】，可在线修改表的引擎，字符集，排序规则，字段，类型，长度，默认值，NULL，自增，属性，索引类型，索引字段，索引名。
6.  修改后点击【确认保存】，系统进入【表结构变更确认】页面。
	-   【表变更条件】：填写连接数条件，如果当前活跃连接数小于设置值执行变更操作。
	-   【表变更时间】：默认为立即执行，也可设置变更时间。
	-   【表切换时间】：选择表变更后立即切换或者手动切换。
>!如果该实例是多源同步备或dcn备，系统会默认自动勾选"手动发起切换"。
	- 【变更指令】：输入变更指令，如：engine=innodb;（默认）。
	- 【是否使用PT】：默认使用。
	- 【PT相关参数】：默认使用check-alter
	- 【chunksize】：默认为0。
	- 【前置检测】：设置主备延迟检查，主备延迟大于设置值禁止变更。
	- 【用户名】：进行表结构变更的用户名。
	- 【密码】：进行表结构变更的用户名的密码。
7.  设置上述值后，点击【确定】，进入任务流程页面，可查看任务执行进度和结果。

## 在线SQL
### 背景介绍
用于在线数据库数据管理。 
### 操作步骤
1. 在赤兔管理台主界面，点击左侧菜单【实例详情】，进入实例管理界面。
2. 选择所需实例ID>选择【数据库管理】>选择【在线SQL】，进入在线SQL界面。
3. 选择对应数据库和表，输入SQL语句，选择【执行SQL】。

## 在线SQL日志
### 背景介绍
用于记录管理员对数据库在线SQL的相关操作信息。
### 操作步骤
1. 在赤兔管理台主界面，点击左侧菜单【实例详情】，进入实例管理界面。
2. 选择所需实例ID>选择【数据库管理】>选择在线SQL日志，进入在线SQL日志界面。 
3. 选择时间区间和操作账号。
4. 选择【查询】按钮，进行查询SQL日志。

## 数据库参数设置
### 背景介绍
用于设置数据库的引擎参数，建议采用系统默认参数配置。
>!部分参数值在实例初始化后不可修改，可能会存在某些参数无法选中和修改的情况。

### 操作步骤
1. 在赤兔管理台主界面，点击左侧菜单【实例管理】>点击所需实例ID>【数据库管理】>【数据库参数】，进入数据库参数子界面。 
2. 勾选需要更改的参数，并在对应【当前值】下拉框中选择合适的参数或手动输入数值。
3. 点击【保存】，可在线修改数据库相关参数。

## 数据库防火墙
### 背景介绍
对用户发送的SQL进行语法解析，过滤非法的SQL，确保数据库安全。
由于用户的业务情况复杂，不可能由系统预先指定并使用统一的标准来判定SQL是否非法，因此需要用户根据自己的业务场景自行定义判定标准，告诉系统哪些类型的SQL属于非法的SQL。而防火墙则根据用户自定义的判定标准对SQL进行过滤，从而实现过滤非法SQL的功能。

### 操作步骤
1. 在赤兔管理台主界面，点击左侧菜单【实例管理】>点击所需实例ID>【数据库管理】>【防火墙】，进入防火墙子界面。
2. 点击【设置状态】，系统弹出防火墙状态设置对话框，默认为关闭。
3. 设置防火墙状态为[关闭/开启/验证模式],点击【确定】保存 退出。
>!验证模式为不进行拦截，只记录日志。
4. 设置防火墙规则，点击【设置规则】系统弹出防火墙规则设置对话框。
5. 设置SQL规则，点击【新增SQL规则】。
	1.  填写【规则名称】：规则的名字。
	1. 	填写【类型】：规则的类型，columns、regex、digest、no_where。
	2. 	填写【规则值】：规则的内容。
	3. 【规则适用时间段】：标识Rule作用的时间段，例如at_times 12:00:00-18:00:00
	4. 【sql类型】：标识规则作用的sql类型。

| 类型|说明|
|---------|---------|
| Columns |根据SQL中的列进行匹配当SQL访问的列与规则中指定的列存在并集时，规则匹配成功。规则值例如 ：`salary`，…..|
| Regex |使用正则表达式对SQL进行匹配，正则表达式遵从perl正则表达式的书写规则规则值可不填.| 
| Digest |根据SQL摘要进行匹配。规则值例如Select * from where id=’xx’的SQL摘要为“ Select * from where id=’?’ ”| 
| no_where |匹配没有where 条件的SQL。规则值可不填| 

6. 点击右下侧【新增用户规则】选项，将SQL规则应用到具体用户上。
【用户】：用户名，格式为user@ip
【类型】：用户使用的action，值可选：allow,deny,log
	 - Allow：该用户SQL语句匹配到SQL规则，则允许SQL执行
	 - Deny：该用户SQL语句匹配了SQL规则，则拒绝SQL执行
	 - Log：该用户SQL语句匹配了SQL规则，则只记录日志
	 
【匹配方式】：mactch type， 值可选：any ，all
【使用规则】：用户采用的ＳＱＬ规则名称。

7. 点击【确定】，结束设置。
>!防火墙通过proxy实现，防火墙开启后，有专门的日志文件记录，路径/datax/tdsql_run/xxx/gateway/log/dbfw_instance_xx。

## 网关参数
>!产品以独立部署的TDSQL版本时，本功能不可用。

### 背景介绍
用于设置proxy参数，建议采用系统默认参数配置。
### 操作步骤
1. 在赤兔管理台主界面，点击左侧菜单【实例管理】>点击所需实例ID>【数据库管理】>【网关参数】，进入网关参数子界面。 
2. 勾选需要更改的参数，并在对应【当前值】下拉框中选择合适的参数或手动输入数值。
3. 点击【保存】，可在线修改网关相关参数。
>?各参数配置详见《网关参数》文档。
