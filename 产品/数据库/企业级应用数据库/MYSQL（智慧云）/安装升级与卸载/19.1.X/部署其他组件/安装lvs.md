## 概述
LVS设备作为数据库前端接入层，其可靠性直接影响数据库整体高可用服务，如果作为生产环境部署，请遵循以下规则：
- LVS服务器需要采用物理机，万兆网卡，CPU、内存最低配置不低于8核、32GB。
- LVS服务器建议独立部署，不建议与其他组件混合部署。
- LVS必须采用高可用架构部署，默认2台服务器起。
- 多台LVS设备IP必须在统一网段（此为VRRP协议要求），后端RS不做特殊要求。
- 多台LVS需要部署在同一IDC中。

>?强烈建议生产环境采用物理机部署LVS，基于对多种不同类型的虚拟机暴力测试，虚拟机通常会有如下问题：
1. 虚拟机网卡gro/lro配置不生效，当有大的请求包时，比如批量写入数据场景，LVS的转发效率会急剧下降。
1. 虚拟网卡出现跳ping情况，业务请求时延不稳定，毛刺大。
1. keepalive vrrp协议默认走的组播方式，不同厂商的虚拟机的vpc网络策略有可能限制组播的vrrp协议。

## 安装LVS
步骤1：返回主控机，确认或修改tdsql_hosts文件的LVS的IP。
```
# vim tdsql_hosts
 [tdsql_lvs]	
tdsql_lvs1 ansible_ssh_host=172.21.16.30
tdsql_lvs2 ansible_ssh_host=172.21.16.38

```
步骤2：安装LVS。
```
# ansible-playbook -i tdsql_hosts playbooks/tdsql_lvs.yml
```

## 配置VIP（虚拟IP）
步骤1：登录赤兔前台，点击左侧菜单【接入层管理】>【LVS设备资源管理】，点击【上报【LVS设备资源】】，在弹窗中填写：
- 设备IP：填入LVS机器的通信IP地址。
- 网卡名字：通信网卡设备名（ifconfig查看）。
- 子网掩码：填入实际的子网掩码（默认24）。
- IDC：LVS机器需要划分到同一个IDC中。 
>?如果部署了多台LVS，每一台都需要上报。

步骤2：点击左侧菜单【接入层管理】>【VIP管理】，点击【上报【VIP信息】】，在弹窗中填写：
- VIP：规划一个vip的地址（未使用的IP地址），vip的地址要和lvs机器的通信ip地址在同一个网段内。
- 设备IP列表：填入lvs机器的通信ip地址，一行一个。


步骤3：点击左侧菜单【接入层管理】>【VIP分组管理】，点击【创建【VIPGroup】】，在弹窗中填写一个有意义的vipgroup名，该名字需要易识别且全局唯一，点击确定。
步骤4：仍然在VIP分组管理页面，点击刚创建的VIPGroup的【添加VIP】，在弹窗中填写：
- LVSGroup名：vipgroup名字。
- 添加VIP：填入vip地址。

## 测试LVS和VIP配置
步骤1：跳转到【实例管理】菜单，选择任意一个测试实例，进入该实例实例详情，找到【添加【接入层】】按键，点击并选择：
- 访问配置：LVS
- VIPGroup：选择刚创建的VIPgroup

步骤2：刷新页面，获得本实例的LVS访问IP:PORT，使用MySQL客户端连接分配的LVS的IP:PORT（IP为VIP, PORT在赤兔的实例详情页的接入配置项），确认访问正常。
