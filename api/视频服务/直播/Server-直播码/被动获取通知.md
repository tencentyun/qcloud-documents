# 被动事件通知
## 功能介绍
频道音视频数据流的推流状态、新的录制文件的生成、以及新的截图文件的生成，这类事件在腾讯云内部管理，但您的后台服务器可能也同样有获知的需求，这时可以使用腾讯云的事件通知服务获知这些事件。

您可以在控制台注册一个来自您后台服务器的回调URL给腾讯云，当有事件发生时，腾讯云会通过HTTP POST的方式将新的事件投递给您的服务器，事件内容以JSON格式组织。

## 公共参数
下面这条消息的含义是直播流 8888_test001 持续一段时间没有音视频数据到腾讯云，判定为断流，故您的服务器应该会收到如下一条事件数据：
```json
{
    "t": 123456,"sign": "abcdeabcdeabcde","event_type": 0,"stream_id": "8888_test001","channel_id": "8888_test001"
}
```
其中每一条事件消息中都会包含如下的公共信息：

| 字段名称 | 类型 | 含义 | 备注 | 
|------------|-------------|---------|---------|
| t           | string      | 有效时间  |UNIX时间戳(十进制) |
| sign      | string     | 安全签名  | MD5(KEY+t) |
| event_type | int     | 事件类型   | 目前可能值为： 0、1、100、200  |
| stream_id | string     | 直播码   |    |
| channel_id | string     | 直播码  | 同stream_id   |

> 这里的 stream_id 和 channel_id 没有区别，只是因为API在设计之初意图兼容频道托管模式，所以保留了channel_id这个概念。

## 安全机制
t 和 sign是两个用来鉴权的参数，它们存在的意义是防止有攻击者伪造腾讯云给您的服务发送恶意通知。

原理跟推流和播放时的安全防盗链如出一辙，不同的是检查者与被检查者的身份进行了互换：安全防盗链是您的服务器生成签名，然后交给腾讯云进行安全校验；而此处则是腾讯云给出签名，之后交给您的后台服务器进行校验。

**sign = MD5(KEY+ t)** 
> 签名所使用的key在申请直播码服务时由管理控制台实时生成和分配（目前暂时内测，9月份开放网页配置入口）

**计算示例**
> 比如我们现在的时间是 2016-08-22 15:16:27，来自腾讯云的通知是在1分钟后过期，也就是：
> **<font color = 'blue'>时间戳： t = "2016-08-22 15:17:27" = 1471850187</font>**
> 
> 签名key假设是 **5d41402abc4b2a76b9719d911017c592**，那么如果请求真的来自于腾讯云，sign的计算结果就应该是：
> **<font color = 'blue'>签名： sign = MD5(5d41402abc4b2a76b9719d911017c5921471850187) = b17971b51ba0fe5916ddcd96692e9fb3</font>**



## 通知类型
### 推流和断流：
event_type = 0 代表断流  event_type = 1代表推流中，同时消息体会额外包含如下信息： 

| 字段名称  | 类型        | 含义        |
|---------|---------|---------|
| appname | string      | 推流路径  |
| app         | string      | 推流域名  |


### 新录制文件：
event_type = 100 代表有新的录制文件生成，同时消息体会额外包含如下信息：

| 字段名称  | 类型        | 含义        |
|------------  |-------------|-------------|
| video_id   | string      | 点播用vid，在点播平台可以唯一定位一个点播视频文件  |
| video_url  | string      | 点播视频的下载地址  | 
| file_size  | string       | 文件大小  |
| start_time  | int      | 开始时间（unix时间戳，由于I帧干扰，暂时不能精确到秒级）  |
| end_time  | int       | 结束时间（unix时间戳，由于I帧干扰，暂时不能精确到秒级）  |

### 新截图图片： 
event_type = 200 代表有新的截图图片生成，同时消息体会额外包含如下信息：

| 字段名称        | 类型       | 含义    |
|-------------------|-------------|---------|
| pic_url           | string      | 图片下载地址 |
| create_time   | int           |截图时间戳（unix时间戳，由于I帧干扰，暂时不能精确到秒级） |