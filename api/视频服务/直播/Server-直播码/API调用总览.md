# 调用方式

下图是直播码后台接口的调用方式，简单分为两种：
![](//mc.qcloudimg.com/static/img/ae90fa870c89c023a409988377de0bdc/image.png)

## 主动请求
即客户服务器主动调用腾讯云后台API查询所需的信息或者对直播流进行控制，包括如下API:

| API                                | 功能介绍                                                          |
|---------------------------------|--------------------------------------------------------------|
| Live_Channel_GetStatus | 查询某条流是否处于**正在直播**的状态               | 
| Live_Channel_SetStatus | 对某条流实行**禁播**操作，主要用于鉴黄场景       | 
| Live_Tape_GetFilelist      | 查询某条流在直播过程中的**录制**文件列表             | 
| Live_Queue_Get             | 查询某条流在直播过程中的**截图**文件列表             | 

>**请求地址**
> 主动请求的API地址统一为：http://fcgi.video.qcloud.com/common_access

## 被动通知
即腾讯云服务器在一些关键事情发生时，以事件的形式主动通知客户服务器，需要客户提前到腾讯云注册接收事件通知的URL，目前支持的事件通知有：
 
| 事件类型（event_type）   | 功能介绍                                                          |
|:-------------------------------:|--------------------------------------------------------------|
| 0                                   | 通知某个流已经断流                                           | 
| 1                                   | 通知某个流已经恢复推流                                    | 
| 100                               | 通知有一个新的录制文件已经生成                       | 
| 200                               | 通知有一个新的截图文件已经生成                         | 


# 公共参数
## 主动查询
每一个主动查询请求，都要包含如下的标准请求参数：

| 参数名 | 参数含义 | 类型 | 备注                            | 是否必须 |
|---------|-------------|-------|-------------------------------|-------------|
| cmd   | 客户ID     | int    | 用于区分不同客户的身份 |  Y          | 
| interface | 接口名称 | string |  如：Live_Channel_GetStatus |  Y          | 
| t              | 有效时间   | int     | UNIX时间戳(十进制)  |  Y          | 
| sign         | 签名      | string | MD5(key+t)             |  Y          | 

> cmd 是一个32位的整数，在申请直播码服务时由管理控制台实时生成和分配（目前暂时内测，9月份开放网页配置入口）。
> 签名所使用的key在申请直播码服务时由管理控制台实时生成和分配（目前暂时内测，9月份开放网页配置入口）。

## 被动通知
来自腾讯云的事件通知都是基于json格式的，每一个事件通知都至少包含如下几个必需字段：

| 字段名称 | 类型 | 含义 | 备注 | 
|------------|-------------|---------|---------|
| t           | string      | 有效时间  |UNIX时间戳(十进制) |
| sign      | string     | 安全签名  | MD5(KEY+t) |
| event_type | int     | 事件类型   | 目前可能值为： 0、1、100、200  |
| stream_id | string     | 直播码   |    |
| channel_id | string     | 直播码  | 同stream_id   |

> 这里的 stream_id 和 channel_id 没有区别，只是因为API在设计之初意图兼容频道托管模式，所以保留了channel_id这个概念。

# 安全检查

## 方案介绍
出于性能考虑，直播码相关后台API没有使用HTTPS接入方式，故安全检查非常重要。直播码相关的服务端API都使用了同一种统一的安全检查方法，即**t + sign 校验**：
- **t**：UNIX时间戳，即从1970年1月1日（UTC/GMT的午夜）开始所经过的秒数。
- **sign**: sign = MD5(key + t)，即把加密key和t字符串拼接后，计算一下md5值。（这里的key即CGI调用key，在管理控制台配置，目前暂时内测，9月份放开配置入口）

## 安全原理
由于MD5是不可逆的hash算法，所以只要确保KEY不泄露，即使攻击者拿到很多对t和sign也无法反算出KEY值，进而无法进行伪装攻击。

## 计算示例
比如我们现在的时间是 2016-08-22 15:16:27， 我们希望请求是在1分钟后过期，也就是：
 <font color = 'blue'>**时间戳： t = "2016-08-22 15:17:27" = 1471850187** </font>
我们的key假设是 **5d41402abc4b2a76b9719d911017c592**，那么我们计算的签名结果就是：
 <font color = 'blue'>**签名： sign = MD5(5d41402abc4b2a76b9719d911017c5921471850187) = b17971b51ba0fe5916ddcd96692e9fb3** </font>
 



