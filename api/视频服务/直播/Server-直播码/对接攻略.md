## 方案概述

所谓“直播码”方案，是指直播频道的控制和管理完全由客户自主掌控，除了对接难度低之外，这套方案的定制空间也非常大，您可以：
（1）自主定义推流和播放地址：不需要到腾讯云申请推流频道，您可以按照约定格式自主定义推流和播放地址。
（2）自主管理直播频道的状态：腾讯云管理频道状态会给您带来诸多不便，比如您需要频繁地查询和同步每个频道的状态，而且腾讯云通过音视频数据流来监控频道状态会有“感知迟钝”的问题，直播码方案则是建议您自主管理频道状态，我们稍后会建议一直非常简单、高效并且可靠的解决方案。

在这套方案中，腾讯云将主要负责推流、转码、CDN分发、录制以及安全保护等功能，状态管理等部分则完全放开，您可以自主实现自己需要的业务逻辑，腾讯云会辅助提供一些基于音视频数据流的状态信息供您使用。
![](//mccdn.qcloud.com/static/img/aa6cf00971df050b3b781b126064131f/image.png)

## 对接攻略

### 推流地址
上图中的步骤一，主播在开始推流之前会先到您的后台服务器上申请推流地址，您可以按照如下格式为其分配一个：
![test](//mccdn.qcloud.com/static/img/ea01558898efb695d561e0ff9440e36f/image.png)
- **bizid**: 
上图中的8888只是个示例数字，代表您在腾讯云分配到的bizid。
- **直播码**：
上图中8888_test_12345_test就是直播码了，这里唯一的要求就是以 “**bizid+下划线**” 作为前缀，剩下的部分您可以自由指定，只要确保不跟已经分配过的直播码冲突就行了，所以很多客户会选择用主播的用户id来作为直播码使用。


### 直播列表
您可以自己根据需求维护直播频道列表，下图是一种推荐的实现方案：
![server](//mccdn.qcloud.com/static/img/56bb81fdbc4c5ab4cdea9448cbe3554c/image.png)

- **Step1: 发起直播**: 
>APP在发起直播时会向服务器请求一个推流URL，推流URL的生成方式我们在刚才已经介绍过了。
>
>您的服务器在返回APP一个推流URL的同时，也要向直播列表中添加一条记录。该记录中最重要的信息就是**直播码**和**用户ID**了（不少客户会直接拿用户ID作为房间号，这样后面管理很方便），除此之外，您还可以根据需要增加**封面图片地址**、**点赞人数**以及**正在观看人数**等点缀列表用的信息。

- **Step2: 结束直播**: 
> APP在结束直播时，同样需要通知一下服务器，这样服务器就可以第一时间把相应的记录删掉，或者设置为“主播已经离线”。

- **Step3: 漏网之鱼**: 
> 但Step2总有意外，比如主播的APP崩溃了，或者流量突然用完了，这类情况会让APP根本没有机会通知服务器该主播已经下线，这些情况如果不考虑，会在直播列表中残留一些 “僵尸频道”，有两种解决办法：
> 
> （方案一）您可以使用腾讯云的**[消息通知服务](https://www.qcloud.com/doc/api/258/5957)**：您的服务器可以注册一个自己的**回调URL**给腾讯云，腾讯云会在您关心的频道在线状态有变化时通知给您。
> 
> （方案二）您可以通过腾讯云的状态查询接口（**[Live_Channel_GetStatus](https://www.qcloud.com/doc/api/258/5958)**）定时地检查所有“正在直播中”的频道是不是真的都是“正在推流”状态，不过这种方案在要查询的频道数特别多的时候，响应速度不理想。推荐的调用方式是一分钟轮询一次，如果某个频道在连续三次的轮询结果中均为离线，您就可以考虑将它的状态设置为离线了。
>
> （方案三）也可以让在APP和服务器之间增加**心跳机制**：主播在推流时，每分钟向服务器发送一个心跳包，如果服务器连续三次没有收到心跳包，即判定主播已经离线。

### 视频播放
有了直播码，推流地址就可以拼装出来，播放地址也同样，下图是用直播码 **8888_test_12345_test** 拼装出来的rtmp flv 和 hls 三种播放地址：
![play](//mccdn.qcloud.com/static/img/8438aadc91d16a1f02921bb178881893/image.png)

在方案设计上，不推荐在APP端拼装，这样会导致逻辑被锁死在APP端，建议由服务器拼装完成后返送给APP，这是为后续扩展考虑，比如随着产品的发展，您可能要在地址里增加更多的参数和后缀来实现更多的功能特性。

APP拿到播放地址后就可以直接丢给腾讯云的RTMP SDK进行播放了。
