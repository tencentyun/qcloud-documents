# 实时视频通话

## 双人视频

下载[Windows SDK+Demo](https://cloud.tencent.com/document/product/454/7873#Windows) ，打开CustomServiceDemo.exe程序，首页包含3种模式，**[标准直播](https://cloud.tencent.com/document/product/454/13627)**、**双人视频**和**多人视频**。

双人视频通话的功能，双人视频用于体验双人实时视频通话功能，金融和保险等行业的客服进行一对一的视频沟通，这是比较常见的场景。

![双人视频](http://mc.qcloudimg.com/static/img/8afc10c1b1bff78fc22dbdd4cad69467/image.png)



## 体验步骤

微信小程序和腾讯视频云的移动Demo，均可以和我们的Windows Demo进行体验双人视频通话的功能，为了免去安装的过程，推荐使用腾讯视频云小程序体验。

##### step1：打开Windows Demo

选择**双人视频**，进入后创建房间，房间的名称可以随意输入除了特殊字符外的任意文字，在创建后，能够看到Windows摄像头的画面，并且左侧边栏中出现创建的房间项，此时说明房间创建成功。

##### step3：加载腾讯视频云小程序

使用手机打开微信App，选择**发现**TAB页，打开**小程序**列表项，搜索框输入**腾讯视频云**，选择搜索结果进行加载。注意：如果搜索不到腾讯视频云，估计您使用的微信版本比较旧，建议先升级到最新版本。

##### step4：开始视频通话

在腾讯视频云小程序的首页，选择**双人音视频**项，打开step1中创建的房间，进入房间，可以看到手机摄像头的画面和Windows摄像头的画面，此时可以体验双人视频通话的功能。



## 技术指标

**双人视频**和**多人视频**功能的技术均达到下面的几个指标

- 通讯延迟：300ms - 800ms
- 底层协议：遵循 RTMP 标准对音视频数据进行切分和封装，支持超低延迟播放，丢包恢复和网络流控Qos。
- 安全加密：每次连接都独立启用一对全新的非对称加密密钥，整个通讯过程无法监听和篡改。




## 原理介绍

通话双方各自创建RTCRoom（即TXLivePusher+TXLivePlayer对）的实例，交换双方的超低延迟流地址，拉取对端的流进行播放。

![原理](http://mc.qcloudimg.com/static/img/4c17b5d8d3f39edeb17195b62909eb56/image.jpg)



下面介绍双人视频功能的交互过程，也包含如何接入SDK的功能，如下图所示

![时序图](http://mc.qcloudimg.com/static/img/ea4e53c29ae574288aa71ff4e7b0a757/image.png)

**step1：**A创建房间room-A，向业务服务器请求推流和拉流地址，获取 push-url-A 和低延时的 play-url-A，服务器分配 URL 的方法参考 [DOC](https://cloud.tencent.com/document/product/454/7915)

**step2：**A创建TXPusher实例，推流的URL使用push-url-A ，通过setCallback接口监听推流事件

**step3：**A收到PUSH_EVT_PUSH_BEGIN事件，此时成功推流到云服务器

**step4：**B选择进入A创建的房间room-A，向业务服务器请求推流和拉流地址，获取 push-url-B 和低延时的 play-url-B

**step5：**B创建TXPusher实例，推流的URL使用push-url-B ，通过setCallback接口监听推流事件

**step6：**B收到PUSH_EVT_PUSH_BEGIN事件，此时成功推流到云服务器

**step7：**A和B均收到业务服务器下方的房间成员变化的通知，获取得到对方的拉流地址

**step8：**A创建TXPlayer实例，拉取 play-url-B进行播放

 **step9：**B创建TXPlayer实例，拉取 play-url-A进行播放



## 多人视频

多人实时视频通话的功能，类似于远程会议的功能，和上面提到的双人视频最大的区别在于多人参与视频通话。但又不是简单加法，里边涉及很多状态同步的问题，下面继续具体介绍。

![多人视频](http://mc.qcloudimg.com/static/img/d924e2d0eb82eeaff969879395226d0d/image.png)



## 体验步骤

微信小程序和腾讯视频云的移动Demo，均可以和Windows Demo进行体验双人视频通话的功能，为了免去安装的过程，仍然推荐使用腾讯视频云小程序体验。

##### step1：打开Windows Demo

选择**多人视频**，进入后创建房间，房间的名称可以随意输入除了特殊字符外的任意文字，在创建后，能够看到Windows摄像头的画面，并且左侧边栏中出现创建的房间项，此时说明房间创建成功。

##### step3：加载腾讯视频云小程序

使用手机打开微信App，选择**发现**TAB页，打开**小程序**列表项，搜索框输入**腾讯视频云**，选择搜索结果进行加载。注意：如果搜索不到腾讯视频云，估计您使用的微信版本比较旧，建议先升级到最新版本。

##### step4：开始视频通话

在腾讯视频云小程序的首页，选择**多人音视频**项，打开step1中创建的房间，进入房间，可以看到手机摄像头的画面和Windows摄像头的画面。

##### step5：多人参与

目前腾讯云多人视频通话的功能，支持最多4个人同时进行，但实际场景下，不限定为4个，业务方根据自身需要设定支持参与通话的人数上限。再找两台手机，重复step3和step4的步骤，参与到同一房间中，此时可以体验多人视频通话的功能。



## 原理介绍

关于原理的介绍，在双人视频通话的文档中，主要是介绍两个人之间的通话连接建立和状态同步，超过2个人的视频通话，事情就变得更加复杂，但基本的原理类似。主要的问题，如何管理多个端的状态，如何正确同步状态变化，我们推荐的做法是在服务器管理和维护这些信息。

![原理](http://mc.qcloudimg.com/static/img/3370d82f2bed7534147d253d1fdd26ca/image.jpg)

#### Client

RTCRoom 的 Client 部分（即 RTCRoom.cs 的 C# 文件） 提供了一组 API 接口：

- **CreateRoom**
  创建一个双人（或多人）视频通话房间，调用这个接口的人即为创建者。
- **EnterRoom**
  进入一个已经创建好的视频通话房间，调用这个接口的人即为参与者。
- **ExitRoom**
  退出一个视频通话房间，在我们的默认实现中，如果是创建者退出，房间将被解散，您可以根据自己的需要进行调整。
- **SendTxtMsg**
  发送文本消息，用于作为视频交流的辅助手段，通常是用来发送一些不重要的系统通知。
- **事件通知**
  事件通知，比如新的与会者加入，或者有人离开，等等。

#### Server

- **列表管理**
  RTCRoom 的 Server 部分是一组用于**房间列表管理**和**成员列表管理**的简单代码实现。以视频会议为例，一个公司同时可能会有多个进行中的视频会议，那么每一个会议都是一个房间，每一个房间里又有多个与会者。所以对于房间的管理和对于房间中成员的管理就是 Server 部分的工作。
- **事件通知**
  Server 还有一个重要职责，就是当房间解散以及成员进出时，通过 IM 消息通道通知房间里的各个成员。由于腾讯云已经有非常成熟的 IM 通讯解决方案，所以我们能够直接复用。
- **心跳机制**
  考虑到商用解决方案应当尽量避免端口限制，因此我们并没有采用时下比较流行的 websocket 技术，而是基于简单的 http 协议实现后台接口，因为我们多实现了一个简单的心跳机制，以避免某个终端在崩溃或者异常退出时能够被 Server 感知到。
