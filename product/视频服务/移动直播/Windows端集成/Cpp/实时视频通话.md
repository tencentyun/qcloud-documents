# 实时视频通话

腾讯视频云 SDK 是集**标准推拉流**和**实时视频通话**于一体的音视频 SDK 组件，本文档主要介绍了其 C++ 版本的**实时视频通话**集成方案。该方案主要通过 RTCRoom 方案来实现。

## RTCRoom

RTCRoom（RealTime ChatRoom）存在的意义在于封装掉双人或者多人音视频实现过程中需要考虑的各种细节逻辑问题，比如房间管理、状态同步、消息收发等等，让您只需要面对几个非常简单的接口，从而快速构建自己的音视频能力。

您主要需要考虑的问题是：如何管理多个端的状态，如何正确同步状态变化。我们推荐的做法是在服务器管理和维护这些信息。

#### 流程解读

接口调用逻辑

![img](https://mc.qcloudimg.com/static/img/f5a0ce8f247931a3373346740cbf4f64/image.jpg)

状态变化同步机制

![img](https://mc.qcloudimg.com/static/img/ecbd1acb00c77e41dff4835fb1cabbd1/image.jpg)

#### Client

RTCRoom 的 Client 部分（即名为 RTCRoom.h 的 C++ 文件） 提供了一组 API 接口：

- **createRoom**
  创建一个双人（或多人）视频通话房间，调用这个接口的人即为创建者。
- **enterRoom**
  进入一个已经创建好的视频通话房间，调用这个接口的人即为参与者。
- **exitRoom**
  退出一个视频通话房间，在我们的默认实现中，如果是创建者退出，房间将被解散，您可以根据自己的需要进行调整。
- **sendRoomTextMsg**
  发送文本消息，用于作为视频交流的辅助手段，通常是用来发送一些不重要的系统通知。
- **事件通知**
  事件通知，比如新的与会者加入，或者有人离开，等等。

#### Server

- **列表管理**
  RTCRoom 的 Server 部分是一组用于**房间列表管理**和**成员列表管理**的简单代码实现。以视频会议为例，一个公司同时可能会有多个进行中的视频会议，那么每一个会议都是一个房间，每一个房间里又有多个与会者。所以对于房间的管理和对于房间中成员的管理就是 Server 部分的工作。

- **事件通知**
  Server 还有一个重要职责，就是当房间解散以及成员进出时，通过 IM 消息通道通知房间里的各个成员。由于腾讯云已经有非常成熟的 IM 通讯解决方案，所以我们能够直接复用。

- **心跳机制**
  考虑到商用解决方案应当尽量避免端口限制，因此我们并没有采用时下比较流行的 WebSocket 技术，而是基于简单的 http 协议实现后台接口，为此我们多实现了一个简单的心跳机制，以避免某个终端在崩溃或者异常退出时无法被 Server 感知到。

  ​

## 双人视频

下载 [Windows SDK+Demo](https://cloud.tencent.com/document/product/454/7873#Windows) ，打开 CustomServiceDemo.exe 程序，首页包含3种模式，**标准直播**、**双人视频**和**多人视频**。

双人视频用于体验双人实时视频通话功能，比较常见的场景为金融、保险等行业的客服与用户进行一对一的视频沟通。

![双人视频](http://mc.qcloudimg.com/static/img/8afc10c1b1bff78fc22dbdd4cad69467/image.png)



### 体验步骤

微信小程序和腾讯视频云的移动 Demo，均可以和我们的 Windows Demo 进行双人视频通话功能的体验。为了免去安装的过程，推荐使用[腾讯视频云小程序](https://cloud.tencent.com/document/product/454/12521#.E5.8A.9F.E8.83.BD.E4.BD.93.E9.AA.8C)体验。

##### step1：打开Windows Demo

选择**双人视频**，进入后创建房间，房间的名称可以随意输入除了特殊字符外的任意文字，在创建后，能够看到Windows摄像头的画面，并且左侧边栏中出现创建的房间项，此时说明房间创建成功。

##### step2：加载腾讯视频云小程序

使用手机打开微信App，选择**发现**TAB页，打开**小程序**列表项，搜索框输入**腾讯视频云**，选择搜索结果进行加载。注意：如果搜索不到腾讯视频云，估计您使用的微信版本比较旧，建议先升级到最新版本。

##### step3：开始视频通话

在腾讯视频云小程序的首页，选择**双人音视频**项，打开 step1 中创建的房间。进入房间后，可以看到手机摄像头的画面和Windows摄像头的画面，此时可以体验双人视频通话的功能。



## 多人视频

多人实时视频通话的功能，类似于远程会议的功能，和上面提到的双人视频最大的区别在于多人参与视频通话。出于 UI 美观和画面大小的考虑，Demo 中仅支持了最多四人的视频通话。您可以通过修改源码中的限制参数和UI界面来进行适配。

![多人视频](http://mc.qcloudimg.com/static/img/d924e2d0eb82eeaff969879395226d0d/image.png)



### 体验步骤

微信小程序和腾讯视频云的移动Demo，均可以和 Windows Demo 进行体验双人视频通话的功能，为了免去安装的过程，仍然推荐使用[腾讯视频云小程序](https://cloud.tencent.com/document/product/454/12521#.E5.8A.9F.E8.83.BD.E4.BD.93.E9.AA.8C)体验。

##### step1：打开Windows Demo

选择**多人视频**，进入后创建房间，房间的名称可以随意输入除了特殊字符外的任意文字，在创建后，能够看到Windows摄像头的画面，并且左侧边栏中出现创建的房间项，此时说明房间创建成功。

##### step2：加载腾讯视频云小程序

使用手机打开微信App，选择**发现**TAB页，打开**小程序**列表项，搜索框输入**腾讯视频云**，选择搜索结果进行加载。注意：如果搜索不到腾讯视频云，估计您使用的微信版本比较旧，建议先升级到最新版本。

##### step3：开始视频通话

在腾讯视频云小程序的首页，选择**多人音视频**项，打开 step1 中创建的房间。进入房间后，可以看到手机摄像头和Windows摄像头的画面。

##### step4：多人参与

目前腾讯云多人视频通话的功能，支持最多4个人同时进行，但实际场景下，不限定为4个，业务方根据自身需要设定支持参与通话的人数上限。再找两台手机或者电脑终端，重复 step2 和 step3 的步骤，参与到同一房间中，即可体验多人视频通话的功能。



## 技术指标

**双人视频**和**多人视频**功能的技术均达到下面的几个指标

- 通讯延迟：300ms - 800ms
- 底层协议：遵循 RTMP 标准对音视频数据进行切分和封装，支持超低延迟播放，丢包恢复和网络流控 QoS。
- 安全加密：每次连接都独立启用一对全新的非对称加密密钥，整个通讯过程无法监听和篡改。




## 原理介绍

通话双方各自创建 RTCRoom（即 TXLivePusher+TXLivePlayer 对）的实例，交换双方的超低延迟流地址，拉取对端的流进行播放。

![原理](http://mc.qcloudimg.com/static/img/4c17b5d8d3f39edeb17195b62909eb56/image.jpg)



具体的交互过程及接入 SDK 的功能以双人视频为例，如下图所示

![img](https://mc.qcloudimg.com/static/img/3e1e12f673cfc81fb946f6376e91e699/image1.png)

**step1：**A创建房间 room-A，先向业务服务器请求推流地址，获取 push-url-A ，服务器分配 URL 的方法参考 [DOC](https://cloud.tencent.com/document/product/454/7915)

**step2：**A创建 TXLivePusher 实例，使用 push-url-A 进行推流 ，通过 setCallback 接口监听推流事件

**step3：**A这边需要一些时间启动推流。当收到 PUSH_EVT_PUSH_BEGIN 事件时，已成功推流到云服务器，即可向业务服务器请求创建房间

**step4：**B选择进入A创建的房间 room-A，向业务服务器请求推流地址，获取 push-url-B。同时请求获取A的低延时播放链接 play-url-A

**step5：**B创建 TXLivePusher 实例，使用 push-url-B 进行推流 ，通过 setCallback 接口监听推流事件

**step6：**B收到 PUSH_EVT_PUSH_BEGIN 事件，此时成功推流到云服务器，即可向业务服务器请求加入房间

**step7：**A收到业务服务器下方的房间成员变化的通知，获取得到对方的拉流地址

**step8：**A创建 TXLivePlayer 实例，拉取 play-url-B进行播放



以上8个步骤虽然不难理解，但对于真正想要照此实现的您而言，显然也是个不小的工作量。在真实的场景中，我们需要面对的业务逻辑远比简单的把 A 和 B 连接起来要复杂。

- **房间管理** 以金融开户和保险定损为例，如果 A 端使用的是小程序，那么真正的 B 端一般情况下会是企业的客服职员（通常都是一个人），所以这里就牵扯到要给用户分配客服的逻辑。同时，如果目前所有的客服都是忙碌的，那就需要有排队等待的逻辑。

所以，真实场景下的逻辑是这样的： 客服 MM 在进入工作岗位后即创建好一个属于自己的“房间”，这个房间有三种状态：BUSY(占线)、IDLE(空闲) 以及 CLOSE(关闭)。处于 BUSY 状态的房间表示对应的客服正在跟用户进行沟通， IDLE 表示可以分配给新进来的呼叫，CLOSE 则表示客服 MM 已经下班了。

- **消息系统** 在 A 和 B 之间搭建 IM 消息系统也是必不可少的，一方面，如果 A 和 B 中某一方网络发生异常，那么文本消息可以用极低的带宽占用维持最基本的消息通讯；另一方面，消息系统对于事件的传递要比音视频通道更加可靠。

现代实时音视频系统一般都有数据通道和信令通道两个传输通道，这样设计的原因是音视频通道并不适合用于传输信令，比如 B 端的TXLivePlayer通知音视频数据没有了，可能原因是 A 已经挂断，但也有可能是 A 的网络出现了长时间的波动。而基于消息系统的“挂断事件”则不需要考虑这种不确定性问题。

基于以上原因，我们推荐您参考 RTCRoom 方案，它是我们腾讯视频云团队基于 TXLivePusher和 TXLivePlayer 所实现的一套开源接入方案，它包含房间管理、消息系统 和状态管理等组成部分，非常适合用于参考和调试。