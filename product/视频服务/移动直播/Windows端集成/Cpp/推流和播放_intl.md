# Push and Playback

Tencent Video Cloud SDK is an audio/video SDK component that integrates **standard push and pull** and **real-time video call**. This document mainly introduces the **standard push and pull** integration solution of C++ version.

## Product Description

Compared with Obs Studio (a commonly used push software) and Flash player (a common playback plug-in for PC browsers), the significant advantages of the Video Cloud SDK are:

- Low-delay optimization: Real-time audio/video calls.
- UDP protocol acceleration: Better push stability.


## User Experience

Download the [Windows SDK+Demo](https://cloud.tencent.com/document/product/454/7873#Windows) and zip package of C++ version. Decompress the package and open the LiteAVDemo(Qt).exe program. The home page contains such modes as **Push + Pull**, **LVB Experience Room**, **Two-person Audio & Video** and **Multi-person Audio & Video**.

After selecting **Push +Pull**, click the **New** button to get a new test push address. After enabling push and playback, Demo is shown as follows:

![](https://main.qcloudimg.com/raw/3c33d57e5aae6f4ede41140b5ca833e9.png)


## Interfacing

- Step 1: Go to the [LVB Console](https://console.cloud.tencent.com/live) to activate Tencent Cloud LVB service. For more information on how to activate the service, please see [DOC](https://cloud.tencent.com/document/product/454/7953#1.-.E8.A7.86.E9.A2.91.E7.9B.B4.E6.92.AD.EF.BC.88lvb.EF.BC.89).

- Step 2: Go to [LVB Console -> LVB Code Access -> Access Configuration](https://console.cloud.tencent.com/live/livecodemanage) to configure push hotlink protection KEY and API authentication KEY. For configuration method, please see [DOC](https://cloud.tencent.com/document/product/454/7953#1.2-.E7.9B.B4.E6.92.AD.E7.A0.81.E6.8E.A5.E5.85.A5.E6.80.8E.E4.B9.88.E9.85.8D.EF.BC.9F). These URLs are automatically generated by your backend business server.

- Step 3: Go to [LVB Console -> LVB Code Access -> Push Generator](https://console.cloud.tencent.com/live/livecodemanage) to generate a [Push URL](https://cloud.tencent.com/document/product/454/7915) for test. Constructing a playback URL is as simple as constructing a push URL, except that the sub-domain name needs to be changed from **livepush** to **liveplay**.

- Step 4: [Download](https://cloud.tencent.com/document/product/454/7873#Windows) SDK package, and embed the SDK in your APP development project according to [Project Configuration](https://cloud.tencent.com/document/product/454/13669). Then perform the related settings and access of push and playback according to the **code interfacing** section of this document.

- Step 5: You can also download source code of Demo in [Windows SDK+Demo](https://cloud.tencent.com/document/product/454/7873#MiniPrograms) for reference.


## Push

### Code interfacing

#### Step 1: Create a TXLivePusher object

Create a **TXLivePusher** object, which will be used later to complete the push task.

```
TXLivePusher pusher;
```

After the creation is completed, you can call the relevant API of TXLivePusher to set the mirror effect, bitrate, resolution and fill mode before starting push. For more information on specific APIs, please see [API List](https://cloud.tencent.com/document/product/454/13671).

```
pusher.setRenderYMirror(true);
pusher.setOutputYMirror(true);
pusher.setVideoBitRate(900);
pusher.setVideoBitRateMin(300);
pusher.setVideoBitRateMax(1000);
pusher.setVideoResolution(TXE_VIDEO_RESOLUTION_640x480);
pusher.setRenderMode(TXE_RENDER_MODE_FILLSCREEN);
...

```

#### Step 2: Set the preview area

Next, we need to look for a place to display the images of camera. For Windows, HWND window handle is used as the basic rendering unit. In a Qt form application, each control can call its WinID() to get the HWND. Therefore, you only need to prepare and pass a HWND and the rendering area to the **startPreview** API of the TXLivePusher object.

```
// Set callback for getting push event notification
pusher.setCallback(this, reinterpret_cast<void*>(index));
// Enable the camera, and the camera index value can be obtained via the enumCameras API of the TXLivePusher object.
//  When only one camera is accessed, the camera index value is 0 by default.
pusher.startPreview((HWND)ui.widget_video_push->winId(), 
        RECT{ 0, 0, ui.widget_video_push->width(), ui.widget_video_push->height() }, m_cameraIndex);

```

#### Step 3: Start push

After the preparations in Step 1 and Step 2, you can use the following codes to start the push:

```
// rtmpURL is the push URL generated during the interfacing process. You can also use the New feature in Demo to generate a test URL to experience it.
Qstring rtmpURL = "rtmp://3891.livepush.myqcloud.com/live/xxxxxx";
pusher.startPush(rtmpURL.toLocal8Bit());

```

#### Step 4: Control the camera

If there are multiple cameras in a computer, you can switch between different cameras simply by calling the **switchCamera** API of TXLivePusher object and passing the index value of the camera.

```
// Pass the index value of camera to be switched to
int index = ui.cmb_cameras->currentIndex();
pusher.switchCamera(index);

```

The enumCameras function of TXLivePusher can get the index value of the camera. For specific examples, please see [API List](https://cloud.tencent.com/document/product/454/13671).

- Enabling a USB camera under Windows takes a long time for circuit and drive startup. The recommended practice is to specify cameraIndex as -1 when calling the startPreview of TXLivePusher to enable all cameras, and then use switchCamera to instantly switch the camera.
- SDK supports virtual cameras, whose enabling method is the same as that of normal cameras. If your PC does not have a physical camera, you can install virtual camera software such as VCam to assist debugging.

#### Step 5: End push

Ending a push is simple but very important (for example, we need to release the occupied camera hardware). Improper cleanup may cause problems in the next push.

```
// Set callback as null
pusher.setCallback(NULL, NULL);
// Stop camera preview
pusher.stopPreview();
// Stop push
pusher.stopPush();
```

#### Step 6: More features

For more information on such features of the local camera as screen mirroring, mute and sharpness settings, please see [API List](https://cloud.tencent.com/document/product/454/13671).



### Event Handling

SDK monitors push-related events using the setCallback API of TXLivePusher object.

#### 1. Normal events

Events that are always prompted during successful pushes. For example, receiving 1003 means that the system will start rendering the camera pictures.

| Event ID | Value | Description |
| ------------------------------ | ---- | --------------- |
| PUSH_EVT_CONNECT_SUCC | 1001 | Successfully connected to push server |
| PUSH_EVT_PUSH_BEGIN | 1002 | Handshake with the server completed, and ready to start push |
| PUSH_EVT_OPEN_CAMERA_SUCC | 1003 | Camera is enabled |
| PUSH_EVT_CHANGE_RESOLUTION | 1005 | Dynamic push resolution adjustment |
| PUSH_EVT_CHANGE_BITRATE | 1006 | Dynamic push bitrate adjustment |
| PUSH_EVT_FIRST_FRAME_AVAILABLE | 1007 | The first frame is captured |
| PUSH_EVT_START_VIDEO_ENCODER | 1008 | Encoder is started |
| PUSH_EVT_CAMERA_REMOVED | 1009 | Camera device has been removed |
| PUSH_EVT_CAMERA_AVAILABLE | 1010 | Camera device is available again |
| PUSH_EVT_CAMERA_CLOSED | 1011 | Camera is disabled |
| PUSH_EVT_SNAPSHOT_RESULT | 1012 | Error code of screenshot snapshot |

#### 2. Error notification

SDK has found some serious problems, and the push cannot be continued. For example, the camera cannot be enabled as Camera has been occupied by other programs.

| Event ID | Value | Description |
| ------------------------------- | ----- | ---------------------------------- |
| PUSH_ERR_OPEN_CAMERA_FAIL | -1301 | Failed to start the camera |
| PUSH_ERR_OPEN_MIC_FAIL | -1302 | Failed to start the microphone |
| PUSH_ERR_VIDEO_ENCODE_FAIL | -1303 | Video encoding failed |
| PUSH_ERR_AUDIO_ENCODE_FAIL | -1304 | Audio encoding failed |
| PUSH_ERR_UNSUPPORTED_RESOLUTION | -1305 | Unsupported video resolution |
| PUSH_ERR_UNSUPPORTED_SAMPLERATE | -1306 | Unsupported audio sampling rate |
| PUSH_ERR_NET_DISCONNECT | -1307 | Network disconnected. Reconnection attempts have failed for many times, thus no more retries will be performed. Please restart the push manually |
| PUSH_ERR_CAMERA_OCCUPY | -1308 | The camera is being occupied. Enable another camera. |

#### 3. Warning events

Compared with the error message, issues represented by WARNING events usually do not interrupt the push process, and SDK generally initiates automatic repair logic internally. You don't need to care about most WARNING events, but the following two events are important and meaningful:

**WARNING_NET_BUSY**
Poor upstream network speed. It represents that the user's current audio/video data cannot be pushed smoothly to the server. In this case, generally the user can be given some UI prompts, for example, "Your network speed is not good" so as to allow the user to prepare for the lag on the other end.

**WARNING_SERVER_DISCONNECT**
The push request is rejected by the backend. This is usually because that txSecret in the push address is calculated incorrectly, or the push address is occupied by others (push URL is exclusive and a push URL can only be used by one user at a time).

| Event ID | Value | Description |
| ---------------------------------------- | ---- | ------------------------------- |
| PUSH_WARNING_NET_BUSY | 1101 | Bad network connection: data upload is blocked because upstream bandwidth is too small |
| PUSH_WARNING_RECONNECT | 1102 | Network disconnected. Auto reconnection has been initiated (no more attempts will be made after three failed attempts) |
| PUSH_WARNING_HW_ACCELERATION_FAIL | 1103 | Failed to start hard-encoding. Soft-encoding is used. |
| PUSH_WARNING_VIDEO_ENCODE_FAIL | 1104 | Video encoding failed. Non-fatal error. Encoder will be restarted internally. |
| PUSH_WARNING_BEAUTYSURFACE_VIEW_INIT_FAIL | 1105 | Warning of video encoding bitrate error |
| PUSH_WARNING_VIDEO_ENCODE_BITRATE_OVERFLOW | 1106 | Warning of video encoding bitrate error |
| PUSH_WARNING_DNS_FAIL | 3001 | RTMP - DNS resolution failed (this will trigger retry process) |
| PUSH_WARNING_SEVER_CONN_FAIL | 3002 | Failed to connect to the RTMP server (this will trigger retry process) |
| PUSH_WARNING_SHAKE_FAIL | 3003 | Handshake with RTMP server failed (this triggers a retry) |
| PUSH_WARNING_SERVER_DISCONNECT | 3004 | RTMP server disconnected automatically. Check the validity of push URL or the validity period of hotlink protection |
| PUSH_WARNING_SERVER_NO_DATA | 3005 | Actively disconnected for no data is sent for more than 30s. |



## Playback Feature

### Code interfacing

#### Step 1: Create a TXLivePlayer object

Create a **TXLivePlayer** object, which will be used later to complete the push task.

```
TXLivePlayer player;
```

#### Step 2: Set the rendering area

Similar to push, we need to look for a place to display the images of camera. For Windows, HWND window handle is used as the basic rendering unit. In a Qt form application, each control can call its WinID() to get the HWND. You only need to prepare and pass a HWND and the rendering area to the **setRenderFrame** API of the TXLivePusher object.

```
// Set callback to get playback event notification
player.setCallback(this, reinterpret_cast<void*>(index));
// Pass HWND window handle, rendering position and size
player.setRenderFrame((HWND)ui.widget_video_play->winId(), 
         RECT{ 0, 0, ui.widget_video_play->width(), ui.widget_video_play->height() });

```

#### Step 3: CDN playback

To start the playback feature, simply call the startPlay API of TXLivePlayer, where PLAY_TYPE_LIVE_RTMP is the RTMP address of the regular CDN. The advantage is that the bandwidth price is very low, but the delay is usually high.

```
// rtmpURL is the playback URL generated during the interfacing process.
string rtmpURL = "rtmp://3891.liveplay.myqcloud.com/live/xxxxxx";
player.startPlay(rtmpURL,PLAY_TYPE_LIVE_RTMP);

```

#### Step 3': Ultra-low delay playback

Ultra-low delay playback can pull the end-to-end delay down to about 400ms. In this mode, the internal mechanism of SDK is completely different from that in the normal mode. Meanwhile, the audio/video lines used by SDK are not regular CDN lines. Compared with CDN, the unit price is higher. It is generally applicable to audio/video calls and scenarios that highly requiring low delay.

```
// rtmpURL is the playback URL with hotlink protection signature generated during the interfacing process. You can also use the New feature in Demo to generate a test URL to experience it.
string rtmpURL = "rtmp://3891.liveplay.myqcloud.com/live/xxxxxxbizid=2157&
                  txSecret=xxxxxx&txTime=xxxxxx";
player.startPlay(rtmpURL,PLAY_TYPE_LIVE_RTMP_ACC);
```

##### Notes

- This feature does not need to be enabled in advance, but it requires that LVB stream be located in Tencent Cloud. Implementing low-latency linkage across cloud providers is not just a technical difficulty.
- The playback URL cannot be a normal CDN URL. It must have a hotlink protection signature.
- When calling the startPlay API, specify type as **PLAY_TYPE_LIVE_RTMP_ACC** for SDK to pull an ultra-low delay LVB stream.
- It supports concurrence playback of 10 channels simultaneously at most. So you can only use it in interactive scenarios (such as the channel of joint broadcasting VJ or the operator in Prize Claw LVB).
- The RTMP stream launched by Obs Studio introduces a delay of more than 1s on the client. Therefore, it is recommended to use the video cloud SDK for push.


- **updateRenderFrame**
  When the window size specified by the HWND changes, the video rendering area can be rescaled via the **updateRenderFrame** function.
- **setRenderMode**

#### Step 4: End playback

When ending a playback, the stopPlay API of TXLivePlayer needs to be called to release the resources (such as network downloading).

```
// Set callback as null
player.setCallback(NULL, NULL);
// Stop pull playback
player.stopPlay();

```

#### Step 5: More features

For more information, please see [API List](https://cloud.tencent.com/document/product/454/13671).



### Event Handling

Monitor playback-related events using the setCallback API of TXLivePlayer object.

#### 1. Normal events

Events that may be notified for successful playback.

| Event ID | Value | Description |
| ---------------------------- | ---- | -------------- |
| PLAY_EVT_CONNECT_SUCC | 2001 | Connected to the server |
| PLAY_EVT_RTMP_STREAM_BEGIN | 2002 | Connected to the server and started to pull stream |
| PLAY_EVT_RCV_FIRST_I_FRAME | 2003 | Render the first video packet (IDR) |
| PLAY_EVT_PLAY_BEGIN | 2004 | Video playback starts |
| PLAY_EVT_PLAY_PROGRESS | 2005 | Video playback progress |
| PLAY_EVT_PLAY_END | 2006 | Video playback ends |
| PLAY_EVT_PLAY_LOADING | 2007 | Video playback loading |
| PLAY_EVT_START_VIDEO_DECODER | 2008 | Decoder starts |
| PLAY_EVT_CHANGE_RESOLUTION | 2009 | Video resolution changes |
| PLAY_EVT_SNAPSHOT_RESULT | 2010 | Error code of screenshot snapshot |

#### 2. Error notification

Some fatal errors occurred with SDK, such as network disconnection, can cause the failure to continue playback. In this case, you need to deal with these errors accordingly.

| Event ID | Value | Description |
| ------------------------------ | ----- | --------------------- |
| PLAY_ERR_NET_DISCONNECT | -2301 | The network is disconnected and reconnection attempts failed, which will result in playback failure. |
| PLAY_ERR_GET_RTMP_ACC_URL_FAIL | -2302 | Failed to acquire pull accelerating address, which will result in playback failure |

#### 3. Warning events

SDK has found some non-fatal errors that generally do not end playback. You don't need to care about most WARNING events, but the following two events are important and meaningful:

**PLAY_WARNING_VIDEO_PLAY_LAG** 

The event signal for SDK to inform the playback stutter externally, which means that the stutter of video screen (the refresh time between two frames) exceeds 500ms.

**PLAY_WARNING_SERVER_DISCONNECT**
The playback request is rejected by the backend. In this case, you need to check whether the playback URL is valid.

| Event ID | Value | Description |
| ------------------------------------- | ---- | ------------------------------- |
| PLAY_WARNING_VIDEO_DECODE_FAIL | 2101 | Failed to decode the current video frame |
| PLAY_WARNING_AUDIO_DECODE_FAIL | 2102 | Failed to decode the current audio frame |
| PLAY_WARNING_RECONNECT | 2103 | Network disconnected. Auto reconnection has been initiated (no more attempts will be made after three failed attempts) |
| PLAY_WARNING_RECV_DATA_LAG | 2104 | Unstable incoming packet from network: This may be caused by insufficient downstream bandwidth, or unstable outgoing stream at the VJ end |
| PLAY_WARNING_VIDEO_PLAY_LAG | 2105 | Stutter occurred during the current video playback (intuitive user experience) |
| PLAY_WARNING_HW_ACCELERATION_FAIL | 2106 | Failed to start hard-decoding; Soft-decoding is used (not supported for now) |
| PLAY_WARNING_VIDEO_DISCONTINUITY | 2107 | Current video frames are discontinuous and frame loss may occur |
| PLAY_WARNING_FIRST_IDR_HW_DECODE_FAIL | 2108 | Hard decoding of Frame I for the current stream fails, and SDK automatically switches to soft decoding |
| PLAY_WARNING_DNS_FAIL | 3001 | RTMP - DNS resolution failed |
| PLAY_WARNING_SEVER_CONN_FAIL | 3002 | Failed to connect to the RTMP server |
| PLAY_WARNING_SHAKE_FAIL | 3003 | Handshake with RTMP server failed |
| PLAY_WARNING_SERVER_DISCONNECT | 3004 | The RTMP server is actively disconnected |

