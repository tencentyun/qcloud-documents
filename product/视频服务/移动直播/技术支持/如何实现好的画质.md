
## 场景一：美女直播

### Step1: 更新 1.9.1 版SDK 
这一版本的 RTMP SDK 中，我们对美颜做了很大的提升，主要体现在：

- **细节提升**：新版本美颜通过全新的区域识别和面部检测方案，将眼睛、眉毛、胡须、头发等细节的处理尽可能削减为零，以保证最大限度的接近真实情况。

- **前景侧重**：通过对编码方案进行优化，突出对前景人物的侧重，尽可能保留主播的细节，忽略其它非重要部分，在同样的码率下可以呈现更加清晰亮丽的人物细节。

- **算法优化**：通过对磨皮算法的优化，在真实度上提升的同时降低了GPU的负载，解决了之前把美颜效果调高后画面细节损失严重，“宛如油画”的效果不再出现，同时耗电和发热问题也有所改善。

- **曝光改善**：通过启用新的曝光方案，解决了iOS曝光过度的问题；同时针对 Android 各机型摄像头曝光敏感度不同的现状，提供了曝光设置功能，可以让主播在曝光不理想（低端机较常见）时手动修正曝光效果。

- **滤镜效果**：新版本美颜还增加了色彩滤镜效果，八种自带的滤镜给主播一些个性化的风格选择，滤镜的设计和调配均出自我们专业的视觉团队，无需担心版权问题。
  
### Step2: 设置画质级别
我们要知道直播端看到的画面跟观众端看到的画面是不一样的：

- **主播端**：  
   主播端看到的画面是只经过了 “采集” 和 “预处理" 两个过程，也就是画面从摄像头采集到之后，经过美颜和各种前处理就渲染在了手机屏幕上。
	 
- **观众端**： 
   主播端看到的画面先要经过**视频编码**，然后通过网络传输到观众端，并在观众端完成**视频解码**和渲染才能观看，这样做是为了降低视频在网络上的传输数据量，但视频编码+视频解码会导致画质的损失，而且不合理的参数设置会导致画质损失非常严重。
	 
- **怎么办？**
我在 1.9.1 版本的 TXLivePusher 中新加入的 setVideoQuality 函数，并给出了几个级别的设置，您选择 **高清** 模式即可达到最佳的美女直播效果。详情请关注 [iOS平台](https://www.qcloud.com/document/product/454/7879#step-9.3A-.E6.8E.A8.E8.8D.90.E7.9A.84.E6.B8.85.E6.99.B0.E5.BA.A6) & [Android平台](https://www.qcloud.com/document/product/454/7885#step-9.3A-.E6.8E.A8.E8.8D.90.E7.9A.84.E6.B8.85.E6.99.B0.E5.BA.A6)。

### Step3: Android 增加手动曝光
同样美颜算法，在不同的 Android 手机上差异可能很大，究其原因，主要是曝光的差异产生了视觉感受的大不同。

在 iOS 平台我们采用了系统的自动曝光，但是 Android 机型差异太大，很多千元机的自动曝光效果实在一般，所以我们还是推荐在您的 UI 界面上提供一个自动曝光的操作滑竿，让主播可以自己调节曝光值大小，以符合他/她的预期。

Android 版 RTMP SDK 中的 TXLivePush::**setExposureCompensation** 接口提供了调节曝光的能力，参数 value 为 -1 到 1 的浮点数： 0 表示不调整， -1 是将曝光降到最低， 1 表示是将曝光加强到最高。

![](//mc.qcloudimg.com/static/img/b4c3fcc20a580347bb1360c5b59fd08c/image.png)

### Step4: 增加色彩滤镜
滤镜也是很关键的一环，不同的色彩滤镜能够营造不同的氛围，主播配合衣服的颜色或者房间灯光选择合适的滤镜，会让整个画面的氛围有更好的效果。

![](//mc.qcloudimg.com/static/img/ad0711f3c35f2087d3520677bfd64391/image.png)

1.9.1 版本的 RTMP SDK 开始支持颜色滤镜， TXLivePusher 中新加入的 setVideoQuality 函数 setFilter 可以设置滤镜效果，我们设计师团队提供了八种素材，默认打包在了Demo中，您可以随意使用，不用担心版权问题。

### Step5: Android马赛克严重
有些客户会发现 Android 版 RTMP SDK 推流出来的画面马赛克特别严重，尤其是在画面有运动时，这个是由于 Android 硬件编码的表现：

Android 系统的 MediaCodec 硬件编码有两种模式：
- **CBR** 模式：该模式下码率比较稳定，用来做直播卡顿率低，但越是低端的机型，编码出的图像越是没有“马赛克”抵抗力，也就是稍微一运动就出现“满屏薄码”的现象。

- **VBR** 模式：该模式下画面比较清晰，但问题也非常明显，每秒输出的视频数据有可能有十兆级别。这种情况下直播的流畅性基本没法保证。

目前 RTMP SDK 选择了 CBR 模式，所以会出现运动场景下马赛克严重的现象。但如果您不追求最低的耗电量，可以考虑让 CPU 解决这个问题。对于 360\*480 或者 540\*960 两个级别的分辨率，软编码的资源消耗对于最近两年的手机而言还是可以轻松驾驭的，只是相比硬编码更加耗电。

所以，如果您纠结画质问题远大于耗电问题，推荐通过 TXLivePusher 的 [setHardwareAcceleration](https://www.qcloud.com/document/product/454/7885#step-7.3A-.E7.A1.AC.E4.BB.B6.E7.BC.96.E7.A0.81)  接口设置为 软编码模式 （false）, 之后再对比一下效果看看。

### Step6: 关闭网络自适应
**TXLivePushConfig** 中的 **AutoAdjustBitrate** 选项是网络自适应开关，开启后，当主播网络变差时，会通过降低画质来保证流畅性，但这一点 <font color='red'>并不适合</font> 美女秀场模式。

网络自适应是适合游戏直播场景的技术，因为游戏直播场景中观众对流畅性的追求高于画质，如果在战斗时间主播网络有波动，画质可以渣一点，但绝对不能卡，所以降低画质来保证流畅性（帧率）就是必选项了。

但美女秀场场景中，清晰度更加重要，不少客户反馈有些直播间画质很好，有些直播间画质很差，导致这个现象的一个高概率原因就是开启了网络自适应。

我们推荐关闭网络自适应，对于出现网络波动的情况，改用 [主动提示](https://www.qcloud.com/document/product/454/7946#4.2-.E9.92.88.E5.AF.B9.E6.80.A7.E4.BC.98.E5.8C.96.E6.96.B9.E6.A1.888) 的方式进行优化，这种方式更加釜底抽薪。




## 场景二：游戏直播
### Option1: 简单应对
在直播开始的界面上提供三种清晰度选项：标清、高清和超清，**让主播自己选择**，游戏主播一般相对比较偏专业，会自己摸索出适合自己当前在玩的游戏的效果，三种档位对应的配置如下：
![](//mc.qcloudimg.com/static/img/adff3641312721649a1e0d101fdd981f/image.png)

| 档位   | 分辨率（Resolution） | FPS（FPS） | 码率（Bitrate） |
|---------|---------|---------|---------|
| 标清 | VIDEO_RESOLUTION_TYPE_360_640 | 20 | 800kbps |
| 高清 | VIDEO_RESOLUTION_TYPE_540_960 | 20 | 1000kbps | 
| 超清 | VIDEO_RESOLUTION_TYPE_720_1280 | 20 | 1800kbps |

> 注意： 游戏直播场景，FPS 最低是 20 ，不能更低了，否则观众端的表现是卡顿感严重。

### Option2: 专业应对
根据不同的游戏设置不同的分辨率和码率，这就比较耗功夫和时间了，比如：
- **皇室战争** - 这类画面变化幅度不大的游戏，推荐选择 **960 * 540** 的分辨率，800kbps-1000kbps 的码率就可以输出不错的效果。

-  **捕鱼达人** - 这类画面变化幅度较大的游戏，推荐选择 **960 * 540** 的分辨率，码率相对要高一点，比如1200kbps - 1500kbps。

-  **神庙逃跑** - 这类画面变化幅度超大的游戏，推荐选择 **640 * 360** 的分辨率，码率也要很大，比如 2000kbps，否则妥妥的满屏马赛克。

## 音视频小科普

### Point1：720P一定更清楚吗？
如果限定一个码率，比如 800kbps，那么**分辨率越高就会让编码器越难做** 。

可以想象，编码器必须拆东墙补西墙，通过减少色彩信息或者引入马赛克这种“鱼目混珠”的手段来承载足够多的像素点。所以，同样的是2G的一个电影文件，1080p画质的版本可能不如720p画质的版本看起来更清晰。

同时，如果你的观众都是在小手机屏幕上观看视频，那么 **960 * 540 1000kbps**  同  **1280 * 720 1800kbps** 的差距其实也不明显，比如下面两张图片就是基于 airplay 技术的 iOS 录屏直播，您看得出左边和右边的清晰度差距吗？

![](//mc.qcloudimg.com/static/img/98135b33c574c1c70373df982d6ba179/image.png)
> 用 32 寸的 LCD 显示器全屏看，还是有差距的。

### Point2：帧率不要超过24！
如果限定一个码率，比如800kbps，那么帧率越高，编码器就必须加大对单帧画面的压缩比，也就是通过降低画质来承载足够多的帧数。如果视频源来自摄像头，24FPS已经是肉眼极限，所以一般20帧的FPS就已经可以达到很好的用户体验了。

有些玩过3D游戏的朋友可能会说：“游戏的帧率越高越流畅吗？比如 60FPS， 120FPS?” 

这里要注意一定不要混淆场景：游戏追求高帧率是**渲染帧率**，其目的是为了尽可能让3D模型渲染出来的运动效果更加接近真实运动轨迹，所以帧率越高越好。 

但采集帧率不需要这么高，比如手机摄像头，它采集的目标是真实世界的物体，真实世界的物体本来就是连续运动的，而不是用一阵阵画面刷新来模拟的，所以 20FPS 的采集就足以。

对于游戏直播，帧率达到 24FPS 当然最好，但也要考虑到系统编码开销，手机的温度和CPU占用等等，毕竟主播还要用同样的一台手机玩游戏呢。
 




