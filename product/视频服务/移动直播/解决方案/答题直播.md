## 效果体验

下载安装我们的 Demo 可以体验在线答题的演示效果，进入在线答题室，创建房间即可体验主持人一端的效果；进入房间即可体验观众端的效果。

- iOS 的 Demo 采用了企业签名方式，请先到“设置-通用-设备管理”里，添加信任证书。
- Demo 仅作演示之用，用来展示腾讯云的技术能力，不代表最终产品形态，接入还需认真阅读此文档。

![](https://mc.qcloudimg.com/static/img/a7c16cb7675a7f3ce7a34ee5759561b5/image.jpg)

| 移动平台 | 安装连接 | 安装二维码 |
|------------|------------|---------------|
| iOS       | [INSTALL](https://www.pgyer.com/liteAV)   | ![](https://mc.qcloudimg.com/static/img/9c2dbb1b70a810ab5635e1a4b268c949/image.jpg)    |
| Android | [INSTALL](http://dldir1.qq.com/hudongzhibo/xiaozhibo/LiteAVDemo_Smart_4.1.QARoom.apk)   |   ![](https://mc.qcloudimg.com/static/img/f754adbb0b78236b8f4bdec922280fa0/Android_QR.jpg)  |

<h2 id="SDK"> SDK下载</h2>

| 移动平台 | 下载链接 | 说明 |
|------------|------------|---------------|
| iOS       | [DOWNLOAD](http://dldir1.qq.com/hudongzhibo/xiaozhibo/TXLiteAVSDK_Smart_iOS_4.1.QARoom.zip)   | SDK 和 Demo 源码均在压缩包中    |
| Android | [DOWNLOAD](https://mc.qcloudimg.com/static/archive/3282f42a9c9c5c95de63d42a00cfca9d/LiteAVSDK_Smart_Android_4.1.3092.zip)   | SDK 和 Demo 源码均在压缩包中    |

> **注意：**
> 此版本为快速迭代版本，本周五（2018-01-12）还会更新经过系统测试的稳定版本。

## 我们的优势
- **精准的“音题画”同步**
腾讯云 SDK 和云端均支持在直播流中插入 **题目** 或 **时间同步信令**，可以实现声音、画面和题目弹出的完美同步。

- **超低的观众端延迟差**
腾讯云 SDK 的 [**极速播放模式**](https://cloud.tencent.com/document/product/454/7880#.E5.8D.A1.E9.A1.BF.26amp.3B.E5.BB.B6.E8.BF.9F) 所支持的延迟修正技术，可以让观众与观众之间延迟差在 1s 以内，从而让观众的答题同步性得到保证。

- **支持微信小程序接入**
腾讯云 SDK 已经默认打包在微信版本中，并以 [&lt;live-player&gt;](https://cloud.tencent.com/document/product/454/12519) 标签的形式对外提供，设置 mode 为 live 模式，并将 min-cache 和 max-cache 都设置为 1，即可实现非常低延迟的播放效果。

## 方案解读

### 方案一：题目透传方案
![](https://mc.qcloudimg.com/static/img/5dd5c76538079f65b4282bda56114d96/image.jpg)

#### 适用场景
如果您没有演播室场景，想要直接用手机来做直播，这套方案比较合适。或者您只是初期调试效果，那么这套方案也是比较容易理解。

#### 原理描述

- **消息发送**：
利用腾讯云 SDK 的 TXLivePusher 的 sendMessage，可以将一段buffer塞到RTMP流中，buffer的最大长度限制为10K。
```objectiveC
// iOS 示例代码
[_answerPusher sendMessage:[mesg dataUsingEncoding:NSUTF8StringEncoding]];
```
```java
//Android 示例代码
mTXLivePusher.sendMessage(questionInfo.getBytes("UTF-8"));
```

- **消息接收**：
利用腾讯云 SDK 的 TXLivePlayer 的 onPlayEvent（PLAY_EVT_GET_MESSAGE ： 2012）功能，可以在播放器播放到指定画面的时候，同步地将 MESSAGE 通知给您的 APP，从而将题目同步地扩散到海量的观众端。
```objectiveC
// iOS 示例代码
 -(void) onPlayEvent:(int)EvtID withParam:(NSDictionary *)param {
    [self asyncRun:^{
        if (EvtID == PLAY_EVT_GET_MESSAGE) {
            dispatch_async(dispatch_get_main_queue(), ^{
                if ([_delegate respondsToSelector:@selector(onPlayerMessage:)]) {
                    [_delegate onPlayerMessage:param[@"EVT_GET_MSG"]];
                }
            });
        }
    }];
}
```
```java
//Android 示例代码
    mTXLivePlayer.setPlayListener(new ITXLivePlayListener() {
        @Override
        public void onPlayEvent(int event, Bundle param) {
            if (event == TXLiveConstants.PLAY_ERR_NET_DISCONNECT) {
                roomListenerCallback.onDebugLog("[AnswerRoom] 拉流失败：网络断开");
                roomListenerCallback.onError(-1, "网络断开，拉流失败");
            }
            else if (event == TXLiveConstants.PLAY_EVT_GET_MESSAGE) {
                String msg = null;
                try {
                    msg = new String(param.getByteArray(TXLiveConstants.EVT_GET_MSG), "UTF-8");
                    roomListenerCallback.onRecvAnswerMsg(msg);
                } catch (UnsupportedEncodingException e) {
                    e.printStackTrace();
                }
            }
        }
        @Override
        public void onNetStatus(Bundle status) {
        }
		});
```


### 方案二：时间同步方案
![](https://mc.qcloudimg.com/static/img/c7f9687497710d6c65f79577e5248035/image.jpg)

#### 适用场景
您有专业的演播室环境，并且采用导播台推流到腾讯云。

#### 原理描述
1. 腾讯云会每隔 1s 在您的直播流中实时插入国际标准时间戳。
2. 演播室的导播员根据主持人的出题节奏，在合适的时间控制发题，发题系统会在每次下发的题目中带上当时的国际标准时间。
3. SDK 在播放这种打入时间戳的视频流的时候，会定时通知您的 APP 当前 SDK 所播放的画面是在什么时间录制下来的（因为导播台到云端一般都会有一个固定的延迟，需要您提前做一个误差校调）。
4. 您的 APP 可以根据 SDK 的时间通知（即当前画面是什么时间录制的），按需显示指定的题目即可。




## 接入攻略
由于当前各个直播平台都采用方案二，我们主要介绍方案二的接入攻略。

### 步骤一：联系我们完成配置
- 您需要开通腾讯云 [直播服务](https://cloud.tencent.com/document/product/267/13551)。
- 按照[快速入门](https://cloud.tencent.com/document/product/267/7977)，获取推流url地址，并在url之后添加参数"&txAddTimestamp=1"，向该url进行推流，并测试播放。

> 注:添加参数"txAddTimestamp=1"后，服务器会每隔1s向您的直播流中打入一个带有国际标准时间（误差在 100ms 以内）的时间戳。

### 步骤二：对接 SDK 播放器
1. 下载文档第二部分中列出的 [SDK](#SDK) 版本。

2. 参考接入文档（[iOS](https://cloud.tencent.com/document/product/454/7880) | [Android](https://cloud.tencent.com/document/product/454/7886)）完成播放器的接入。两个平台全部完成，大概需要 0.5 天的工作量。

3. **<font color='red'>修改默认配置</font>**
 由于 SDK 的默认配置为普通直播场景，所以需要修改配置，操作方法如下：
 ```objectiveC
//iOS源码
TXLivePlayConfig *config = [[TXLivePlayConfig alloc] init];
TXLivePlayer *player = [[TXLivePlayer alloc] init];
//
//开启消息接受,收不到消息的话就是没打开这个（默认:关）
config.enableMessage = YES;
//
//设置延迟平衡点为1s(考虑到云端和推流端引入的延迟，实际延迟为2s多，SDK推流：2s, obs推流：3-4秒)
config.bAutoAdjustCacheTime = YES;
config.maxAutoAdjustCacheTime = 1;
config.minAutoAdjustCacheTime = 1;
config.cacheTime = 1;
config.connectRetryCount = 3;
config.connectRetryInterval = 3;
config.enableAEC = NO;
//先setConfig再startPlay
[player setConfig:config];
``` 
```java
//Android源码
mTXLivePlayConfig = new TXLivePlayConfig();
mTXLivePlayer = new TXLivePlayer(context);
//
//开启消息接收,收不到消息的话就是没打开这个（默认:关）
mTXLivePlayConfig.setEnableMessage(true);
//
//设置延迟平衡点为1s(考虑到云端和推流端引入的延迟，实际延迟为2s多，SDK推流：2s, obs推流：3-4秒)
mTXLivePlayConfig.setAutoAdjustCacheTime(true);
mTXLivePlayConfig.setCacheTime(1.0f);
mTXLivePlayConfig.setMaxAutoAdjustCacheTime(1.0f);
mTXLivePlayConfig.setMinAutoAdjustCacheTime(1.0f);
//
//先setConfig再startPlay
mTXLivePlayer.setConfig(mTXLivePlayConfig);
```

4. 请务必使用 <font color='red'>**FLV**</font> 格式的播放地址，RTMP在高并发场景下容易出现卡顿问题。
![](https://mc.qcloudimg.com/static/img/64342b926e05da462a54b8ce4f8c526f/image.png)

### 步骤三：配置演播台
一般演播台的接入方式有两种：OBS Studio 推流或者编码盒推流，这两种推流工具均有比较成熟的设置接口。建议将 GOP（也叫关键帧间隔）设置为 **<font color='red'>1s</font>** ，这样可以让观众端的延迟差异非常小。

x264 的 gop 设置对编码效率的影响不是很大，但对延迟的影响非常大：gop越大，服务器缓存越多。由于 SDK 的延迟修正需要一个修正时间，如果 gop 太大，对于刚进入的观众会有很大的影响 。

如下是Obs Studio 设置关键帧间隔的图示：
![](https://mc.qcloudimg.com/static/img/9281e56f5091f45f13f67d8dcb76c638/image.jpg)

### 步骤四：发题系统
#### 1. 使用腾讯云（IM）通讯服务
- 开通腾讯云 [云通信](https://console.cloud.tencent.com/avc) 服务。
- 按照文档进行初始化[配置](https://cloud.tencent.com/document/product/454/7980)。
- 集成模式请使用 **独立模式**，我们可以提供生成UserSig签名的服务端程序，您可以自行部署。
- 可以使用 REST API 向客户端发题，并将题目优先级设置为 High（题目优先级应高于普通文本消息），需要用的关键 [API](https://cloud.tencent.com/document/product/269/1520) 有：
  
| API | 中文含义 | 用途 |
|---------|---------|---------|
| [v4/group_open_http_svc/create_group](https://cloud.tencent.com/document/product/269/1615) | 创建群组 | 一个直播间对应一个 IM 群组，在群组里的APP都能收到服务器推送的消息。请指定群组类型(Type)为 `AVChatRoom`。 |
|[v4/group_open_http_svc/send_group_msg](https://cloud.tencent.com/document/product/269/1629)|发送消息|可以将题目用这个 API 推送给群组里的每一个APP，需要指定消息优先级(MsgPriority) 为 <font color='red'>**High**</red> |
|[v4/openim_dirty_words/add](https://cloud.tencent.com/document/product/269/2397)|添加脏字|用于敏感字过滤，<font color='red'>题目答案也属于敏感字</font>。|

> **如下几点需要注意**
> - 云通信后台会对消息格式中的文本消息进行脏字过滤(TIMTextElem，参见[消息格式描述](https://cloud.tencent.com/document/product/269/2720))，如果您的题目或答案中可能包含敏感词，可以考虑使用自定义消息格式（TIMCustomElem， 参见[消息格式描述](https://cloud.tencent.com/document/product/269/2720))。有关敏感词的管理参见[云通信敏感词（脏字）过滤](https://cloud.tencent.com/document/product/269/4104#5.7)
>
>- 发送题目的时候请保证请求包中的`Random`字段不重复，五分钟数字相同认为是重复消息。
>
>- 如果您的APP同时需要弹幕服务, 可以同时使用这个群组发送弹幕。 请确保APP使用IM SDK发送弹幕消息的时候, 弹幕消息的优先级低于题目消息的优先级。
>
>- 客户端需要参考文档（[iOS](https://cloud.tencent.com/document/product/269/9147) | [Android](https://cloud.tencent.com/document/product/269/9227)）接入 IM SDK ，以便能够接收来自服务器发出的消息。


#### 2. 使用自己的消息下发系统
如果您使用自己的消息下发系统发题，请注意延迟预留的问题。
经过 **步骤二** 中的设置，腾讯云的直播服务延迟会达到 2s（使用腾讯云 SDK 进行推流）或 3s（使用 Obs Studio 进行推流）左右。如果您的消息下发系统延迟高于这个时间，需要提前下发题目，并通过提示板倒计时的方式辅助主持人把握好读题时间。

### 步骤五：答题系统
答题系统相对比较简单，因为都是每个观众把答案提交到服务器，所以只需要完成一个 CS 请求处理就可以了，只是实现过程需要注意解决瞬间高并发的请求压力。


### 步骤六：结果显示
一般题目出来一段时间以后，就会进入闭题状态。这时，答题系统会将结果进行统计汇总，并将汇总结果下发给观众，结果下发可以继续使用 **步骤四** 中的发题系统通道。


