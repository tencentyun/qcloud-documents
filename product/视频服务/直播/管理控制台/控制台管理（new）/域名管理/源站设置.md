如果您有自建源站和直播源内容，并且需要通过腾讯云进行直播播放，可以通过为云直播播放域名设置源站信息来回源拉取直播内容。配置成功后，您可通过云直播回源拉流并进行直播内容分发。本文档将指导您如何设置源站信息。

## 注意事项
-  配置好相关信息后，源站设置功能配置完成后约1小时生效。
- 开启源站配置功能后，该播放域名不支持通过 StreamName 匹配其他推流域名进行拉流，而且该域名无法使用水印、转码、录制、截图、鉴黄等功能。 

## 前提条件
- 已登录 [云直播控制台](https://console.cloud.tencent.com/live)。
- 已搭建直播源站。
- 已添加**播放域名**。

## 回源配置
若您需要修改域名源站基本信息、回源请求协议、回源 Host 头部等信息，可在回源配置部分进行相关操作。
1. 进入 [**域名管理**](https://console.cloud.tencent.com/live/domainmanage)，单击需配置的**播放域名**或右侧的 **管理** 进入域名详情页。
2. 在域名管理/域名旁，可打开或关闭 **回源模式** 。
3. 当回源模式开启时，可在回源配置中进行编辑。
![](https://qcloudimg.tencent-cloud.cn/raw/3279144e1b3877092c8310648d290034.png)

## 配置说明
### 源站信息
| 源站信息   | 说明                                                         |
| ---------- | ------------------------------------------------------------ |
| 回源协议   | 支持 RTMP、HTTP-FLV、HLS 格式协议。                          |
| HTTPS 回源  | 当回源协议为 FLV 和 HLS 时，可开启 HTTPS 回源。<br>开启 HTTPS 回源后，源站地址配置固定为443端口。默认支持重定向链接后 HTTPS 回源，重定向后 HTTPS 回源不限制端口。 |
| 主源站地址 | 支持主备源站，轮询回源。源站地址支持 IP 或域名形式。         |
| 备源站地址 | 备源站地址，可选填。                                         |

![](https://qcloudimg.tencent-cloud.cn/raw/082b53bdb309b7c539dff4ba965531c5.png)

### 源站 Host 头部
当回源协议为 FLV 或 HLS 时，可配置回源 HTTP Host 头部，即回源域名。腾讯云节点在回源时，访问的源站 IP 地址下具体的站点域名。

#### 配置说明
源站地址和回源 Host 头部的区别如下：
 - 源站地址：决定回源时请求到的具体 IP 地址。
 - 回源 Host 头部：决定回源请求访问到该 IP 地址上的具体站点。
 
#### 配置实例
1.  若源站配置如下，假设播放域名 `xx001.elementtest.org` 配置如下：
![](https://qcloudimg.tencent-cloud.cn/raw/35f704ac913fc8067b1eaacafe45013f.png)
2.  则用户访问路径如下：
用户访问资源 `http://xx001.elementtest.org/index.m3u8`，此时腾讯云节点尚未缓存该资源，则腾讯云节点回源是针对 `test001.com` 域名进行解析，得到源站服务器地址，假设为`1.1.1.1`，则访问`1.1.1.1`服务器，在其上的 Web 服务器 `test002.com` 路径下，找到 index.m3u8 文件，返回给用户。

### 转封装配置
回源协议为 RTMP 或 HTTP-FLV 时，支持开启 HLS 转封装。HLS 播放地址与 RTMP 和 HTTP-FLV 播放地址的对应关系：
- RTMP 格式：`rtmp://播放域名/AppName/StreamName`
- FLV 格式：`http://播放域名/AppName/StreamName.flv`
- M3U8 格式：`http://播放域名/AppName/StreamName.m3u8`

#### 配置说明
-  M3U8 文件包含分片数：默认为3个，可配置3个-10个。
-  HLS 分片时长：默认为3秒，可配置3秒-10秒，实际生成的分片时长不会小于 GOP 时长。

<img src="https://qcloudimg.tencent-cloud.cn/raw/db5ead5d168161f9c6e4f893f9621226.png" width=600>

### HTTP 相关配置
当回源协议为 HLS 时，可在高级设置中配置 HTTP 相关配置。

| HTTP 相关配置     | 说明                                                         |
| ---------------- | ------------------------------------------------------------ |
| 回源重定向       | 腾讯云节点不缓存301/302状态码。当源站返回301/302状态码后，腾讯云节点默认会主动跟随跳转，直至获取所需资源（最多可跟随10次），返回实际的资源给用户端，用户端无需跳转。<br>关闭回源重定向后，节点在回源时收到301/302状态码时将响应返回给用户端，由用户端重定向到对应的资源进行访问。 |
| 回源URL参数透传  | 回源默认不透传请求 URL 参数。开启参数透传后回源 URL 可能会增加腾讯云内部 URL 参数。 |
| 回源HTTP头部透传 | 回源默认不透传请求 HTTP 头部。暂不支持重复请求 HTTP 头部透传，不区分大小写。 |
| 响应HTTP头部透传 | 源站响应 HTTP 头部默认不透传到客户端。支持重复响应 HTTP 头部透传，区分大小写。 |

![](https://qcloudimg.tencent-cloud.cn/raw/f139c5b2cd6ef25fe06e03c693131d9e.png)

### 缓存配置
当回源协议为 HLS 时，可在高级设置中配置缓存配置。正常情况下，腾讯云节点成功从源站拉取到所请求的资源（200状态码）时，将按照索引缓存时间和分片缓存时间配置进行缓存处理。
<table id="setmess">
<tr><th width="14%">缓存配置</th><th>说明</th>
</tr><tr>
<td>索引缓存时间</td>
<td>源站返回200状态码时m3u8索引文件的缓存时间，默认1000ms，最大不超过60000ms。
</ul></td>
</tr><tr>
<td>分片缓存时间</td>
<td>源站返回200状态码时ts/m4s/mp4分片文件的缓存时间，默认1000ms，最大不超过60000ms。
</ul></td>
</tr><tr>
<td>状态码缓存时间</td>
<td>若源站无法迅速响应非200状态码，且不希望所有请求全部透传回源站，可通过配置状态码缓存过期时间，由腾讯云节点直接响应非200状态码，减轻源站压力。
<br>不区分文件类型，当前支持以下状态码：
<li>4XX：400、403、404、405。</li>
<li>5XX：500、503、504。</li>
</ul></td>
</tr></table>

![](https://qcloudimg.tencent-cloud.cn/raw/ad58822efba1424d8e4039bdd67b8320.png)

### 回源 URL 重写配置
当回源协议为 HLS 时，可在高级设置中配置回源URL重写配置。
若您需要将实际回源的 URL 修改为与源站匹配的 URL，腾讯云为您提供了回源 URL 重写配置功能。目前仅支持重写回源 URL 路径。

#### 配置说明
- **待重写回源 URL**：使用前缀匹配的方式，例如：待重写回源 URL 为 /test01，则将匹配 /test01 下路径下的所有请求。暂不支持正则匹配。
- **目的回源 URL**：使用前缀匹配的方式，例如：目的回源 URL 为 /test01/test02，则将 /test 下路径下的所有请求改写为 /test01/test02。暂不支持正则匹配。

![](https://qcloudimg.tencent-cloud.cn/raw/bb2fffb1731ba5ec45e01728f30c2470.png)

#### 配置约束
- 单个播放域名最多可添加10条重写规则。
- 重写规则不支持以下14个特殊字符：" ", "<", ">", """, "#", "{", "}", "|", "\", "^", "~", "[", "]", "&#96"。
- 多条规则支持调整优先级：顶部优先级大于底部。

### 其他配置
| 其他配置     | 说明                                                         |
| ------------ | ------------------------------------------------------------ |
| 超时时间     | 指 TCP 指 TCP 建连的超时时间，默认配置为10000ms，可配置2000ms-60000ms。回源超时时间较短的情况下，可能因偶发性的网络原因出现回源失败的情况，导致频繁切换源站。回源超时时间设置过长时，可能无法及时切换源站，导致客户端播放异常。建议您可以根据源站数据处理情况及网络情况，调整回源 TCP 连接超时时间，保障正常回源。 |
| 最大重试次数 | 指回源失败最大的重试次数。若配置多个源站地址，回源失败后会切换源站地址重试。 |
| 时间戳校正   | 当回源协议为 RTMP 和 FLV 时可在高级设置中配置时间戳校正。<Br>默认透传时间戳。开启时间戳校正后会与前一音视频帧的时间戳比较，当向前或往后跳变超过250ms时改为前一音视频帧的时间戳加10ms，可以防止出现较大的时间戳跳变。 |

![](https://qcloudimg.tencent-cloud.cn/raw/ee6e95f3a6d01991918029cf522ec99c.png)

