## 防盗链的计算

安全防盗链指的是推流和播放URL中的txSecret字段，它的作用是防止攻击者伪造您的后台生成推流URL或者非法盗取您的播放地址为进行谋利。

### 安全原理
为了不让攻击者可以伪造您的服务器生成推流和播放URL，您可以通过在直播管理控制台配置防盗链加密KEY（请勿轻易泄露，以防被攻击者获取），使得攻击者无法轻易为造出有效的推流和播放URL，如下图所示：
![](//mccdn.qcloud.com/static/img/4ea1512fd335f68f30cca0a01e902966/image.png)

### 计算过程
- **第一步：交换密钥**
首先，您需要在官网的控制台协商一个加密密钥，这个加密密钥用于在您的服务器上生成防盗链签名，由于腾讯云跟您持有同样的密钥，所以您生成的防盗链签名，腾讯云是可以进行解密确认的。

 加密密钥分为推流防盗链KEY和播放防盗链KEY，前者用于生成推流防盗链URL，后者用于生成播放防盗URL，目前在 [直播管理控制台](https://console.cloud.tencent.com/live) 上可以自助配置推流防盗链KEY，如图所示：
![](https://main.qcloudimg.com/raw/638fcbb8eac12cbbabc247fd6a1323f2.jpg)
关于播放防盗链KEY的相关信息，可以至文档最佳实践-直播播放综述查看。

- **第二步 ：生成txTime**
签名中明文部分为txTime，含义是该链接的有效期，比如当前的时间是2018-12-29 11:13:45，而且期望新生成的URL 是在3小时后即作废，那么txTime就可以设置为2018-12-29 14:13:45。

 不过这么长一串时间字符串放在URL 里显然不太合适，实际使用中我们是把2018-12-29 14:13:45转换成Unix时间戳，也就是1546064025（转换方式各种后台编程语言都由直接可用的时间函数来处理），然后转换成十六进制以进一步压缩字符长度，也就是txTime = 1546064025（十进制） = 5C271099（十六进制），当然，使用十进制也是支持的。
 
 我们建议客户设置的txTime过期时间不要太短也不要太短，当主播在直播过程中遭遇网络闪断时会重新恢复推流，如果过期时间太短，主播会因为推流URL过期而无法恢复推流。也不要太长，如果过期时间太长，可能会被盗推。

- **第三步：生成 txSecret**
txSecret的生成方法是 = MD5(KEY+ streamName + txTime)，这里的KEY就是您在第一步中配置的加密KEY，streamName（也叫流id，推荐用随机数字或者用户ID）在本例中为test，txTime为刚才计算的 5C271099，MD5 即标准的MD5单向不可逆哈希算法。
例如：KEY为e12c46f2612d5106e2034781ab261ca3，则txSecret = MD5（e12c46f2612d5106e2034781ab261ca3test5C271099） = f85a2ab363fe4deaffef9754d79da6fe

- **第四步：合成防盗链地址**
  符合腾讯云标准的推流 URL，它由下面四个部分组成：
	![](https://main.qcloudimg.com/raw/9e4f2dea21398af9412e3660af82c959.jpg)
	现在我们有推流（或播放）可以用来告知腾讯云该URL过期时间的txTime，只有腾讯云才能解密并且验证的 txSecret，streamName以及推流域名（假设为livepush.tcloud.com），那么我们就可以合作一条标准的URL。在本文档的例子中，推流URL为rtmp://livepush.tcloud.com/live/test?txSecret=f85a2ab363fe4deaffef9754d79da6fe&txTime=5C271099

### 示例代码
[【直播控制台】](https://console.cloud.tencent.com/)>【域名管理】，选中事先配置的推流域名，【管理】>【推流配置】页面下半部分有【推流地址示例代码】（PHP 和 Java 两个版本）演示如何生成防盗链地址。
