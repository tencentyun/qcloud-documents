安全防盗链指的是推流和播放 URL 中的 txSecret 字段，它的作用是防止攻击者伪造您的后台生成推流 URL 或者非法盗取您的播放地址为自己谋利。

### 安全原理
为了不让攻击者可以伪造您的服务器生成推流 URL，我们需要您现在直播管理控制台配置 防盗链加密 KEY，由于攻击者无法轻易获得加密 KEY，也就无法伪造出有效的推流 URL，如下图所示：
![](//mccdn.qcloud.com/static/img/4ea1512fd335f68f30cca0a01e902966/image.png)

### 计算过程
- **step1 ：交换密钥**
首先，您需要在官网的控制台协商一个加密密钥，这个加密密钥用于在您的服务器上生成防盗链签名，由于腾讯云跟您持有同样的密钥，所以您生成的防盗链签名，腾讯云是可以进行解密确认的。

 加密密钥分为推流防盗链 KEY 和播放防盗链 KEY，前者用于生成推流防盗链 URL，后者用于生成播放防盗链 URL，目前在 [直播管理控制台](https://console.cloud.tencent.com/live) 上可以自助配置推流防盗链 KEY，如图所示：
![](//mc.qcloudimg.com/static/img/b3b4641c0af4f9f5c17921cfe8320a01/image.png)
 >  **默认不开播放防盗链：**   
 > 由于播放防盗链 KEY 的配置需要同步到几千台 CDN 集群，同步周期一般都很长，不适合调试期频繁修改，如果您需要配置播放防盗链，可以通过客服电话联系我们，正常流程一般需要 1~3 天完成全集群的同步。

- **step2 ：生成 txTime**
签名中明文部分为 txTime，含义是该链接的有效期，比如当前的时间是 2016-07-29 11:13:45，而且期望新生成的 URL 是在 24 小时后即作废，那么 txTime 就可以设置为 2016-07-30 11:13:45。

 不过这么长一串时间字符串放在 URL 里显然不太经济，实际使用中我们是把 2016-07-30 11:13:45 转换成 Unix 时间戳，也就是 1469848425 （转换方式各种后台编程语言都由直接可用的时间函数来处理），然后转换成十六进制以进一步压缩字符长度，也就是 txTime = 1469848425（十进制） = 579C1B69（十六进制）。
 
 我们的客户一般会将 txTime 设置为当前时间 24 小时以后过期，过期时间不要太短，当主播在直播过程中遭遇网络闪断时会重新恢复推流，如果过期时间太短，主播会因为推流 URL 过期而无法恢复推流。

- **step3：生成 txSecret**
txSecret 的生成方法是 = MD5(KEY+ stream_id + txTime)，这里的 KEY 就是您在 step1 中配置的加密 KEY，stream_id 在本例中为 8888_test001，txTime 为刚才计算的 579C1B69，MD5 即标准的 MD5 单向不可逆哈希算法。

- **step4：合成防盗链地址**
  现在我们有推流（或者播放）URL，可以用来告知腾讯云该 URL 过期时间的 txTime，只有腾讯云才能解密并且验证的 txSecret，就可以拼合成一个防盗链的安全 URL。
	
### 示例代码
[【直播控制台】](https://console.cloud.tencent.com/)>【直播码接入（推荐）】>[【推流生成器】](https://console.cloud.tencent.com/live/livecodemanage)页面下半部分有【推流地址示例代码】（PHP 和 Java 两个版本）演示如何生成防盗链地址。
