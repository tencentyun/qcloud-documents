Digital Rights Management (DRM) is extremely important for online education, vocational training, etc. Video file disclosure may cause very serious economic losses.

Traditional video service providers use a variety of hotlink protection mechanisms to protect video contents. The basic principle of these mechanisms is as follows: The app server sends an exclusive video URL to the client. The CDN service verifies the request URL, request IP, HTTP header and other parameters. If the verification is passed, video data is returned. Otherwise, a 403 error code is returned.

However, for the video that needs to be paid for viewing, once a malicious user obtains its valid hotlink protection playback URL through one-time payment, he can download the video to the local and then perform secondary distribution. In such case, hotlink protection cannot protect the video copyright in an all-round way. To further enhance the protection of video content, we cannot just focus on the process of video distribution, but must encrypt the video data itself. After the video data is encrypted, even if a malicious user downloads the video to the local, the video is still encrypted. In this way, video encryption raises the bar of secondary distribution of video content for malicious users.

Tencent Cloud video encryption service is under internal trial. **To join the trial, submit a ticket**.

For more information on VOD video encryption DEMO, please see [here](http://demo.vod.qcloud.com/encryption/index.html) (login user name: test, password: 111111).

## Tencent Cloud VOD Video Encryption Solution

### Encryption Algorithm
VOD system supports the encryption solution specified in [HTTP Live Streaming](https://tools.ietf.org/html/draft-pantos-http-live-streaming-23), which can achieve the following security levels:
1. AES-128 is used to encrypt the video contents.
2. Multiple keys can be used for the encryption of a single video file, avoiding the leakage of the entire file caused by the leakage of an individual key.

To customize a video encryption solution, contact Tencent Cloud customer service.

### Player Adaptability
Tencent Cloud VOD video encryption solution supports all HLS players.

## Terminology

### Key Management Service (KMS)
KMS is a security management service for creating, encrypting and decrypting data keys. For more information, please see Tencent Cloud's [Key Management Service](https://cloud.tencent.com/product/kms).

### Data Key (DK)
DK is a key generated by the KMS system and used for symmetric encryption and decryption.

### Encrypted Data Key (EDK)
The DK encrypted by the KMS system can be used for public distribution. To obtain DK through EDK, you must call the KMS decryption API.

## Overall Architecture
![](//mc.qcloudimg.com/static/img/b88e3ed66a8d1856501554465454ccb7/image.png)

Video encryption process is implemented through transcoding, which does not generate a new FileID. Compared with general transcoding scenarios, video encryption transcoding has the following differences:
1. Encryption transcoding. That is, the video is encrypted after being transcoded.
2. After encryption transcoding is completed, if the video is played through a VOD player, the source file playback URL is not obtained.

## Preparations

### Building a Key Management Service (KMS)
KMS is used to manage video keys. The following steps in the video encryption process need to interact with the KMS system:

1. Step II of generating a data key for video encryption in the above architecture diagram. DK and EDK are returned in this step. In the following process, VOD transcoding service, app backend, and the end user whose identity validity is verified can access DK. EDK can be distributed to any user. However, to obtain DK through EDK, the user's identity must be verified by the App backend.
2. Step 4 of obtaining DK through EDK to play data in the above architecture diagram. After the user's identity is verified by the app backend, the KMS related APIs and EDK need to be used to get DK, as is in the step 5 shown above.

Tencent Cloud VOD system supports the following three key management services:

1. The built-in KMS of Tencent Cloud VOD: To minimize the developer's access costs, Tencent Cloud VOD service integrates KMS internally and provides the simplest APIs for users. If the built-in KMS of VOD is used, the App backend only needs to interact with KMS in step 5 of obtaining the decryption key (as shown in the architectural diagram) throughout video encryption.
2. Tencent Cloud KMS (available soon): After Tencent Cloud KMS is activated, you can grant the permission of generating a data key based on a master key to the VOD service. Then, the VOD system can be integrated into your key management system on the cloud.
3. Self-built KMS (available soon): If you have built your KMS, you can specify DK and EDK for each encryption operation to reach the most flexible level of key control.

### Building Authentication and Key Distribution Services

For the encrypted videos, only clients verified by the app backend can get the DKs. Therefore, when a customer obtains a key, authentication must be performed at the app backend. The business logic of this service is:
1. If a client requests to obtain the DK with an EDK (step 4 in the architecture diagram), the requestor's identity should be verified.
2. If the identity verification is passed, go to the KMS system to obtain the corresponding DK (step 5 in the architecture diagram), and return the DK to the client.

Advices:
1. Since a DK always corresponds to a specific EDK, the mapping relationship between an EDK and a DK can be cached (even permanently saved) in the app backend to reduce the number of calling the KMS system (step 5 in the architecture diagram).
2. HTTP cache control parameters (such as Cache-Control) can be added to the response that the app backend gives to the client, to reduce the number of the operation that a client obtains DK from the app backend (step 4 in the architecture diagram).

### Configuring Video Encryption Templates
To ensure that VOD backend performs a correct encryption operation, you need to configure a video encryption template. For more information, please see [Video Encryption Parameter Template](https://cloud.tencent.com/document/product/266/9645).

## Business Process

## Video Upload
You can upload the existing video files to the VOD platform by means of server upload, client upload, console upload, recording upload and URL pulling upload.

## Video Encryption

Video encryption consists of the following four steps:

### I. The App backend initiates video encryption

You can initiate video encryption using API [ProcessFile](https://cloud.tencent.com/document/product/266/9642). Only HLS files can be encrypted.

The following example indicates:

1. Transcode video files. The target output templates of transcoding are 210, 220, 230 and 240. Converting from low bitrate video to high bitrate video is not allowed.
2. During transcoding, encryption template 10 is used for encryption.
3. Event notification mode: An event notification is initiated after the entire event is completed.

<pre>
https://vod.api.qcloud.com/v2/index.php?Action=ProcessFile
&transcode.definition.0=210
&transcode.definition.1=220
&transcode.definition.3=230
&transcode.definition.4=240
&transcode.disableHigherBitrate=1
&transcode.drm.definition=10
&amp;notifyMode=Finish
&COMMON_PARAMS
</pre>

### II. VOD platform obtains encryption keys
VOD platform reads the key acquisition method based on the encryption parameter template specified by the caller. The end user obtains the URL (assumed to be `https://getkey.example.com`) of the decryption key, and then obtains the video encryption key DK and EDK from the specified KMS system.

### III. VOD platform initiates video encryption transcoding

When performing video encryption, VOD transcoding platform not only encrypts the target output file using the specified encryption algorithm and key, but also writes the URL for obtaining the decryption key into the video file. For example, the URL of HLS is written to the EXT-X-KEY tag in the m3u8 file. However, before writing, the transcoding platform adds three parameters to the QueryString of the URL:

1. fileID: ID of the encrypted file.
2. keySource: KMS type. One of the following three types can be chosen:
   (1) VodBuildInKMS: Tencent Cloud VOD built-in KMS.
   (2) QCloudKMS: Tencent Cloud KMS system (not supported for now).
   (3) PrivateKMS: Used for a user's own KMS system (not supported for now).
3. edk: The EDK corresponding to DK.

After the above parameters are added, the URL to be written into the transcoding target video file may be

<pre>
https://getkey.example.com?fileId=123456&keySource=BuildInKMS&edk=abcdef
</pre>


This URL is also the one that the client eventually access when obtaining the decryption key during video playback.

### IV. VOD Platform initiates encryption and completes callback
When the status of the task flow that includes encryption operation changes (or the task flow is completed), VOD platform triggers [Notification for Task Flow Status Changes](https://cloud.tencent.com/document/product/266/9636).

## Media Asset Management
After an video is encrypted, its encryption information can be obtain using the API [GetVideoInfo](https://cloud.tencent.com/document/product/266/8586).
API GetVideoInfo returns the video playback URLs of all transcoding specifications under the video ID, including the playback URL of the source file. Since the source file is not encrypted, The app server can filter the playback URL of the source file and only provide the playback URL of the encrypted video to the client. The parameter "definition" of the source file obtained by GetVideoInfo is 0, which can be used to filter the video playback URL of the source file.

## Video Playback Overview

Only the customer whose identity is verified can obtain the video decryption key. Therefore, how to verify the user's identity information is of top importance during playback.

During playback, the player accesses the URL identified by the EXT-X-KEY tag in m3u8 file to obtain the key. The player needs to carry the viewer's identity verification information in this step and two methods can be used to pass this information to the app authentication service:

1. Append the user identity information as parameters to the URL, and pass the URL to the app authentication service. This solution is applicable to all HLS players. For more information, please see video playback solution 1: passing identity verification information via QueryString.
2. Pass the user identity information to the app authentication service via Cookie. This solution is more secure, but is only applicable to the player that carries Cookie when accessing the URL identified by the tag EXT-X-KEY. For more information, please see video playback solution 2: passing identity verification information via Cookie.

## Video Playback Solution 1: Passing Identity Verification Information via QueryString

This solution is applicable to all HLS players.

### 1. Log in and distribute Token for identity verification
Only the customer whose identity is verified can obtain the video decryption key. Therefore, the client must log in before playing videos. Then the app server distributes the client a signature containing the identity verification information, which is called Token.

### 2. Obtain multi-bitrate playback URL containing key hotlink protection signature
<!--Tencent Cloud VOD web video player supports multi-bitrate playback, which means you can obtain a multi-bitrate playback URL of a video according to FileID. If you use other players, you must obtain the multi-bitrate playback URL yourself.-->
You can obtain the multi-bitrate playback URL of an encrypted video using either the callback notification of the encryption transcoding API ProcessFile or the API GetVideoInfo.

After the multi-bitrate playback URL is obtained, the client needs to add the user's identity information to the playback URL. To add a user's identity information to a URL, add `voddrm.token.<Token>` before the **file name** in the URL.

For example, suppose the user's identity information is identified as ABC123, and the playback URL of a certain bitrate is

<pre>
http://example.vod2.myqcloud.com/path/to/a/video.m3u8
</pre>

The final URL is

<pre>
http://example.vod2.myqcloud.com/path/to/a/voddrm.token.ABC123.video.m3u8
</pre>


### 3. Obtain video content (encrypted)

When the player accesses the URL that carries the user's identity information as described in the previous step, the VOD backend automatically appends the Token information as a QueryString to the URL identified by the EXT-X-KEY tag in the original m3u8 file.

For example, suppose an encrypted video URL of a certain bitrate is

<pre>
http://example.vod2.myqcloud.com/path/to/a/video.m3u8
</pre>

In this file, the URL for obtaining the video decryption key identified by the EXT-X-KEY tag is

<pre>
https://getkey.example.com?fileId=123456&keySource=BuildInKMS&edk=abcdef
</pre>

When the player accesses the playback URL carrying the Token information, that is

<pre>
http://example.vod2.myqcloud.com/path/to/a/voddrm.token.ABC123.video.m3u8
</pre>

The URL for obtaining the video decryption key identified by the EXT-X-KEY tag is replaced with

<pre>
https://getkey.example.com?fileId=123456&keySource=BuildInKMS&edk=abcdef&token=ABC123
</pre>

Now, when the player obtains the decryption key DK, it carries the Token distributed in step 1.

### 4/5. Obtain the video decryption key (carrying identify verification Cookie)

When the player obtains the video index file (m3u8 file), it automatically performs step 4 before video file playback.

After the app backend receives the client's request, it first verifies the Token in QueryString. If the user's identity is invalid, the app backend directly rejects the request. If the user's identity is valid, the app backend obtains the DK from the KMS system according to the parameters of fileId, keySource and edk in the URL, and returns it to the client.

After the above steps are completed, the client can obtain the video decryption key and perform video decryption and playback.

## Video Playback Solution 2: Passing Identity Verification Information via Cookie

This solution is only applicable to the H5/Flash player on iOS/PC platform. The player on this platform carries Cookie when accessing the URL identified by the EXT-X-KEY tag.

Note: According to the test, H5 player on Android does not carry Cookie when accessing the URL identified by the EXT-X-KEY tag, so only solution 1 is applicable on Android.

### 1. Log in and distribute Cookie for identity verification
Only the customer whose identity is verified can obtain the video decryption key. Therefore, the client must log in before playing videos. Then the app server distributes the client a signature. For example, the client logs in using the account and password through login.example.com. After the app backend verifies the identity, it sends the cookie of 'example.com` domain to the client to identify the user's identity.

### 2. Obtain the multi-bitrate playback URL of a specified video
Tencent Cloud VOD web video player supports multi-bitrate playback, which means you can obtain a multi-bitrate playback URL of a video according to FileID. If you use other players, you must obtain the multi-bitrate playback URL yourself.

### 3. Obtain video content (encrypted)
The video player automatically performs this step when it starts playing a video.

When the video player starts playing a video, it requests video data files from the VOD CDN edge server. For videos in HLS format, the player obtains the video decryption key according to the EXT-X-KEY tag in m3u8 file. For example, suppose the URL for obtaining the video decryption key in the EXT-X-KEY tag is

<pre>
https://getkey.example.com?fileId=123456&keySource=BuildInKMS&edk=abcdef
</pre>

When the player obtains the decryption key dk, it carries the cookie of `example.com` domain distributed by the app backend in step 1.

### 4/5. Obtain the video decryption key (carrying identify verification Cookie)

When the player obtains the video index file (m3u8 file), it automatically performs step 4 before video file playback.

After the app backend receives the client's request, it first verifies the identifier in the Cookie. If the user's identity is invalid, the app backend directly rejects the request. If the user's identity is valid, the app backend obtains the DK from the KMS system according to the parameters of fileId, keySource and edk in the URL, and returns it to the client.

After the above steps are completed, the client can obtain the video decryption key and perform video decryption and playback.

## FAQ

### 1. What are the differences between encrypted HLS and common HLS?
According to the HLS specifications, HLS encryption is to encrypt media files (TS files). m3u8 file describes how a player decrypts TS files. The m3u8 file with encrypted HLS contains a `#EXT-X-KEY` tag with the attributes of `METHOD` and `URI`. `METHOD` describes the encryption algorithm such as `AES-128`, while `URI` describes the URL for obtaining the decryption key, which can be accessed by the player to obtain key data for decryption. If URI is

<pre>
http://www.test.com/getdk?fileId=123&edk=14cf
</pre>

The player sends an http request to this URI when resolving the m3u8 file, and obtains the key data from the returned packet.

### 2. What information is required to enable VOD encryption?
To enable VOD encryption, getkeyurl (`URI` in the `#EXT-X-KEY` tag) is required. The app server needs to deploy the HTTP service which obtains key data when the client plays encrypted video. When encrypting a video, the VOD service sets the `URI` of the `#EXT-X-KEY` tag in the m3u8 file of the encrypted video to getkeyurl. To obtain the key and manage it conveniently, parameters fileId, edk, and keySource are added after getkeyurl. fileIdId represents the video Id. edk represents the encrypted key. keySource represents the source of a key. If an encrypted file of the VOD built-in KMS system is used, keySource is set to VodBuildInKMS. When the player requests a decryption key, the QueryString of the HTTP request received by the app server contains fileId, edk and other parameters. The app server returns dk to the player according to fileId, edk and other parameters.

### 3. Where does the player obtain the decryption key when playing an encrypted video?
When playing an encrypted video, the player requests to obtain the key based on the URI (getkeyurl provided by the app to VOD) of #EXT-X-KEY in the m3u8 file. Note that it is not the VOD server to which the player sends the request to obtain the key. The app server encrypts the video using VOD ProcessFile API. After that, The app server obtains the key using the API [DescribeDrmDataKey](https://cloud.tencent.com/document/product/266/9643) and keeps it well. When the player requests the key, the key is returned according to the request parameters of the player.

### 4. How does the app server return the key to the player?
When the player requests to obtain the key from the app server, the app server needs to return the key data in 16-byte binary to the player. However, the key obtained via the API [DescribeDrmDataKey](https://cloud.tencent.com/document/product/266/9643) is a Base64-encoded string. Therefore, the string should be converted to binary data before it is returned to the player.
For example, dkData is Base64-encoded key data

java

```java
  import java.util.Base64;
  byte[] dkBin = Base64.getDecoder().decode(dkData);
```  

php

```php
$dkBin = base64_decode($dkData);
```




