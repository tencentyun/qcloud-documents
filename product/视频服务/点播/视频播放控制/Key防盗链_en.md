## Feature Overview
* Specify the expiration time in the video URL to prevent other people from transferring the video URL to other sites for long-term use.
* Specify the trial duration in the video URL to implement the trial mode.
* The developer can use the key (KEY) to create a video URL signature and put it into the URL. As long as the user key is not disclosed, other users cannot forge the video URL.
* The CDN node controls the video playback requests by checking the parameters and signatures in the video URL. If the request fails to pass the check, the 403 error will be returned.

## Configuration Wizard
Tencent Cloud VOD "Console" -> "Global Settings" -> "Domain Name Settings" -> "Hotlink Protection Settings".

![Image](https://mc.qcloudimg.com/static/img/cf5a076e57d3287852bf4ab3fe609bbe/image.png)

"Enable Key Hotlink Protection" -> "Generate KEY" -> "OK".

![Image](https://mc.qcloudimg.com/static/img/12e25bcc2cd7dd87aec2067a5c2910a3/image.png)

After the configuration is saved, it takes about 5 minutes for the configuration to take effect on all CDN nodes.

## How to Generate Hotlink Protection URL
* The developer sets an **original video URL** for each video in the Tencent Cloud VOD system. If the hotlink protection is not enabled, the original video URL can be used to play the video.
* After the Key hotlink protection is enabled, the original video URL can no longer be used for video playback, and a **hotlink protection URL** of the video needs to be generated.

A hotlink protection URL is generated by adding the hotlink protection parameters at the end of the original URL in the form of QueryString, such as:

<pre>http://example.vod2.myqcloud.com/dir1/dir2/myVideo.mp4?t=[t]&us=[us]&exper=[exper]&sign=[sign]</pre>

The hotlink protection parameters in QueryString must be stitched in the order of `t`, `exper`, `us`, `sign`. Here are descriptions and values of the parameters in a hotlink protection URL.

#### Hotlink Protection Parameters
| Parameter Name | Required | Description |
| --- | --- | --- | --- |
| KEY | Yes | The key filled in when enabling the Key hotlink protection. It must consist of uppercase and lowercase letters (a-Z) or numbers (0-9), with a length of 8-20 characters. It is recommended to click the "Generate KEY" on the console button to generate the key. |
| Dir | Yes | The remaining part of the PATH in the original video URL after the file name is removed. If the original URL is `http://example.vod2.myqcloud.com/dir1/dir2/myVideo.mp4`, the playback path is `/dir1/dir2/`. |
| t | Yes | The expiration timestamp of the playback address, in the form of hexadecimal lowercase Unix time. If expired, the URL will be invalid, and the 403 error will be returned. The expiration timestamp must be long enough for the video playback to complete. |
| exper | No | The trial duration in seconds (decimal). If it is left empty or 0, the trial mode is disabled (a complete video is returned). The trial duration must be shorter than the original video duration, otherwise the playback may fail. |
| us | No | The link ID. It is used to randomize a hotlink protection URL in order to improve the uniqueness of the link. It is recommended to specify a random us value when generating a hotlink protection URL each time. |
| sign | Yes | The hotlink protection signature. It is a hexadecimal number with a length of 32 characters, and is used to verify the validity of the hotlink protection URL. The 403 error will be returned if the URL fails to pass the signature verification. Here is the signature calculation formula. |

### Signature Calculation Formula
<pre>
sign = md5(KEY + Dir + t + exper + us)
</pre>

`+` in the formula represents the string concatenation. The optional parameters can be empty strings.

## Generating a Hotlink Protection URL Example
* Assume that a developer has a video in Tencent Cloud VOD, and the original playback URL of the video is `http://example.vod2.myqcloud.com/dir1/dir2/myVideo.mp4`.
* The developer enabled the Key hotlink protection, and the generated key is `24FEQmTzro4V5u3D5epW`.
* The developer wants to generate a hotlink protection URL for this video, and the expiration time of the URL is 20:00 on Jan 31, 2018 (1517400000 in Unix time).
* The trial duration is the first 5 minutes of the video (The original video duration is longer than 5 minutes).
* A random string `72d4cd1101` is generated while generating the hotlink protection URL.

Using the assumption above, we will describe how to generate the hotlink protection URLs for two scenarios: "Hotlink Protection Validity Period Control" and "Video Allowable Playback Duration Control".

### Example 1: Hotlink Protection Validity Period Control
#### Step 1: Choose Hotlink Protection Parameters
At first, choose the hotlink protection parameters except `sign`.

| Parameter Name | Value | Description |
| --- | --- | --- | --- |
| KEY | `24FEQmTzro4V5u3D5epW` | The key selected by the developer when enabling the Key hotlink protection |
| Dir | `/dir1/dir2/` | The remaining part of the PATH in the original video URL after `myVideo.mp4` is removed |
| t | `5a71afc0` | The hexadecimal form of the expiration timestampe 1517400000 |
| us | `72d4cd1101` | The generated random string |

#### Step 2: Calculate Signatures
Get the signature result according to the signature calculation formula.
<pre>
sign = md5("24FEQmTzro4V5u3D5epW/dir1/dir2/5a71afc072d4cd1101") = "3d8488faeb37d52d6bf63b63c1b171c3"
</pre>

#### Step 3: Generate Hotlink Protection URL
Stitch the hotlink protection parameters into the QueryString of the original video URL to generate the video hotlink protection URL:
<pre>
http://example.vod2.myqcloud.com/dir1/dir2/myVideo.mp4?t=5a71afc0&us=72d4cd1101&sign=3d8488faeb37d52d6bf63b63c1b171c3
</pre>

### Example 2: Video Allowable Playback Duration Control
#### Step 1: Choose Hotlink Protection Parameters
At first, choose the hotlink protection parameters except `sign`.

| Parameter Name | Value | Description |
| --- | --- | --- | --- |
| KEY | `24FEQmTzro4V5u3D5epW` | The key selected by the developer when enabling the Key hotlink protection |
| Dir | `/dir1/dir2/` | The remaining part of the PATH in the original video URL after `myVideo.mp4` is removed |
| t | `5a71afc0` | The hexadecimal form of the expiration timestampe 1517400000 |
| exper | `300` | The trial duration is the first 5 minutes, namely 300 seconds |
| us | `72d4cd1101` | The generated random string |

#### Step 2: Calculate Signatures
Get the signature result according to the signature calculation formula.
<pre>
sign = md5("24FEQmTzro4V5u3D5epW/dir1/dir2/5a71afc030072d4cd1101") = "547d98c4b91e81b5ea55c95cef63223f"
</pre>

#### Step 3: Generate Hotlink Protection URL
Stitch the hotlink protection parameters into the QueryString of the original video URL to generate the video hotlink protection URL:
<pre>
http://example.vod2.myqcloud.com/dir1/dir2/myVideo.mp4?t=5a71afc0&exper=300&us=72d4cd1101&sign=547d98c4b91e81b5ea55c95cef63223f
</pre>

## Key Hotlink Protection Generation and Verification Tools
VOD provides the Key Hotlink Protection URL generation and verification tools for developers to quickly and accurately generate and verify the hotlink protection URLs.

* [Key Hotlink Protection URL Generation Tool](https://video.qcloud.com/referer/gen_video_url.html)
* [Key Hotlink Protection URL Verification Tool](https://video.qcloud.com/referer/check_sign.html)

## Notes
* This feature is optional and disabled by default.
* After the Key hotlink protection is enabled, the original video URL can no longer be used for video playback, and a valid hotlink protection URL needs to be generated according to the rules.
* The KEY must consist of uppercase and lowercase letters (a-Z) or numbers (0-9), with a length of 8-20 characters.
* If the hotlink protection URL expires or the signature fails to pass the verification, the video cannot be played and the 403 error will be returned.
* The parameters in QueryString of the hotlink protection URL must appear in the order of `t`, `exper`, `us`, `sign`. If the order is incorrect, the video cannot be played.
* In view of the possible time difference between machines, the actual expiration time of a hotlink protection URL is generally 5 minutes longer than the specified expiration time, that is, an additional 300-second tolerance time is allowed.
* To use the trial feature, make sure that the trial duration is shorter than the video duration, otherwise the video cannot be played.
* There are strict restrictions on video formats in trial mode (only H264 is supported, and the video meta-information must be in the header of the video file, etc.). Exceptions will occur when playing an original video that does not meet the format requirements in trial mode. It is recommended to transcode such videos using the VOD transcoding feature, and then set the trial mode for the transcoded videos (the transcoded formats meet the trial format requirments).

