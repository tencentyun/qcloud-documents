## Interfacing Process

- **Short video recording**:
Capture the camera image and microphone sound, process the image and sound, implement encoding and compression, and finally generate an MP4 file with the desired definition.

- **Short video publishing**:
Upload an MP4 file to Tencent Video Cloud, and get the URL for online watching. Tencent Video Cloud supports the nearby scheduling, instant broadcasting, dynamic acceleration, overseas access and other requests of video watching, so as to ensure a high-quality watching experience.

![](//mc.qcloudimg.com/static/img/283c8d7fe0a5a316097ae687a2bf6c5a/image.png)

* Step 1: Use the API TXUGCRecord to record a short video. When the record is finished, a short video file (MP4) is generated and returned to the user.

* Step 2: Your App applies for an upload signature from your business server. The upload signature is a "license" which allows the App to upload MP4 file to Tencent Cloud Video Distribution Platform. To ensure safety, these uploaded signatures are issued by your business server and cannot be generated by the terminal App.

* Step 3: Use the API TXUGCPublish to publish video. Once successful, the SDK returns the playback URL to you.

## Note

- App must not include the SecretID and SecretKey used to calculate the upload signature in its client code. Exposing these critical information may cause potential safety issues such as allowing attackers to use your traffic and storage service for free once they have cracked your App and obtained the information.

- The proper practice is to use the SecretID and SecretKey on your server to generate an one-off upload signature, and then provide the signature to the App. Generally, servers are difficult to crack, so this can ensure safety.

- Be sure to pass the correct Signature field when you publish short videos, or else the publish operation may fail.

- When calling the video recording APIs startRecord and stopRecord, make sure they're called in pairs.

- Video recording length is determined by your code. To ensure an optimal performance and a good user experience, it is recommended that you keep the recording length within 60 seconds.


## API Description 
Tencent Cloud UGC SDK provides relevant APIs used to record and publish short videos. These APIs are described below:

|  API File |  Feature |
| ------| --------|
| `TXUGCRecord.h` | Record short videos |
| `TXUGCPublish.h` | Upload/publish short videos |
| `TXUGCRecordListener.h` | Record callback and publish callback for short videos |
| `TXUGCRecordEventDef.h` | Record event callback for short videos |
| `TXUGCRecordTypeDef.h` | Basic parameter definitions |
| `TXUGCPartsManager.h` | Video fragment management class, used for multi-fragment recording and deletion |

## Interfacing Guide

![](//mc.qcloudimg.com/static/img/6b21b033259c1b5124648b73e88fb243/image.png)


### 1. Video Preview
TXUGCRecord (located in TXUGCRecord.h) is used to record short videos. Our first task is to realize the video preview feature. The startCamera function is used to launch preview. You need to open the camera and microphone when launching preview, thus you may receive a permission prompt.

```ObjectiveC
UIView *    preViewContainer;                    //Prepare a view used for previewing camera image
TXUGCSimpleConfig *config = [[TXUGCSimpleConfig alloc] init];
//config.videoQuality = VIDEO_QUALITY_LOW;       // For 360p, a video of 10 seconds is around 0.75 MB
config.videoQuality   = VIDEO_QUALITY_MEDIUM;    // For 540p, a video of 10 seconds is around 1.5 MB  (encoding parameters are the same with Wechat iOS short videos)
//config.videoQuality = VIDEO_QUALITY_HIGH;      // For 720p, a video of 10 seconds is around 3 MB
config.frontCamera    = YES;                     //Whether to use front camera. Use  switchCamera to switch camera
config.minDuration    = 5;                       //The minimum length of video recording
config.maxDuration    = 60;                      //The maximum length of video recording
[TXUGCRecord shareInstance].delegate = self;     //The API TXVideoPublishListener is implemented by "self"
[[TXUGCRecord shareInstance] startCamera:param preview:preViewContainer];
```

### 2. Special Effect
You can use the special effect switches in TXUGCRecord to add certain special effects to your video or control the camera (either before or during a recording process).

```ObjectiveC
//////////////////////////////////////////////////////////////////////////
                        Supported special effects are shown below (1.9.1 version or above).
//////////////////////////////////////////////////////////////////////////

// Set video recording proportion: 3:4; 9:16; 1:1
[[TXUGCRecord shareInstance] setAspectRatio:videoRatio];

// Sets global watermark
// waterMark            Global watermark image
// normalizationFrame   The normalization frame of watermark relative to the video image
[[TXUGCRecord shareInstance] setWaterMark:waterMark  normalizationFrame:normalizationFrame];

// Switch between front and rear cameras. isFront: whether to use the front camera (default is front camera)
[[TXUGCRecord shareInstance] switchCamera:YES];

// Configure beautifying and whitening effect levels.
// beautyDepth     : Available value range for beautifying level: 0-9. 0 means to disable beautifying. A higher value means a stronger effect.
// whiteningDepth  : Available value range for whitening level: 0-9. 0 means to disable whitening. A higher value means a stronger effect.
[[TXUGCRecord shareInstance] setBeautyDepth: 7 WhiteningDepth: 1];

// Configure color filter: romantic, fresh, artistic, tender, vintage...
// image: Specify the color lookup table used by the filter. Note: Be sure to use PNG format.
The filter lookup table image used in the Demo is located in RTMPiOSDemo/RTMPiOSDemo/resource/FilterResource.bundle
   setSpecialRatio: Used to configure the effect level of the filter (0-1). A higher value means a stronger effect. Default is 0.5.
[[TXUGCRecord shareInstance] setFilter: filterImage];
[[TXUGCRecord shareInstance] setSpecialRatio: 0.5];

// Whether to enable flashlight
[[TXUGCRecord shareInstance] toggleTorch: YES];

// Adjust the focal distance (1-5). 1 means the farthest viewing angle (normal lens) and 5 means the closest viewing angle (enlarging lens). The maximum value is recommended to be 5. If it is set to a value larger than 5, the video data may become blurred and indistinct.
[[TXUGCRecord shareInstance]setZoom:1.0];

//////////////////////////////////////////////////////////////////////////
//                             Background music related
//////////////////////////////////////////////////////////////////////////

// Set background music file
[[TXUGCRecord shareInstance] setBGM:path];

// The playback of background music starts only after the recording is enabled. The playback of background music before recording will be available soon.
[[TXUGCRecord shareInstance] playBGMFromTime:startTime
             toTime:endTime
    withBeginNotify:beginNotify
 withProgressNotify:progressNotify
  andCompleteNotify:completeNotify];

// Stop background music
[[TXUGCRecord shareInstance] stopBGM];

// Pause background music
[[TXUGCRecord shareInstance] pauseBGM];

// Resume background music
[[TXUGCRecord shareInstance] resumeBGM];

// Set the microphone volume to control the microphone volume when playing the mixed background music.
// volume: Normal volume is 1. The recommended value is 0-2. If you need to turn up the volume, you can set it to a larger value.
[[TXUGCRecord shareInstance] setMicVolume:1.0];

// setBGMVolume: Set the background music volume to control the background music volume when playing the mixed background music.
// volume: Normal volume is 1. The recommended value is 0-2. If you need to turn up the background music volume, you can set it to a larger value.
[[TXUGCRecord shareInstance]setBGMVolume:1.0];

//////////////////////////////////////////////////////////////////////////
//                       The following special effects are only supported by the VIP edition
// (These effects use the intellectual properties of YouTu team and are supported only by the VIP SDK edition. We cannot provide them for free)
//////////////////////////////////////////////////////////////////////////

// Set eye enlargement level (0-9)
[[TXUGCRecord shareInstance] setEyeScaleLevel: 0];

// Set face slimming level (0-9)
[[TXUGCRecord shareInstance] setFaceScaleLevel: 0];

// Set V-shaped face level (0-9)
[[TXUGCRecord shareInstance] setFaceVLevel:0];

// Set chin stretching or contracting level (-9-9) 
[[TXUGCRecord shareInstance] setChinLevel:0];

// Set short face level (0-9)
[[TXUGCRecord shareInstance] setFaceShortLevel:0];

// Set nose narrowing level (0-9)
[[TXUGCRecord shareInstance] setNoseSlimLevel:0];

// Set motion effect sticker tmplName - material name   tmplDir - path of the material package
[[TXUGCRecord shareInstance] selectMotionTmpl: tmplName inDir: tmplDir];

// Configure green screen effect. Green screen material is an MP4 file with an aspect ratio of 9:16 (for example, 368*640, 540*960, 720*1280)
[[TXUGCRecord shareInstance] setGreenScreenFile: file]; 
```


### 3. Video Recording
Call the startRecord function in TXUGCRecord to start recording process, and call the stopRecord function to stop recording process. Be sure to call these two functions in pairs.

```ObjectiveC
[[TXUGCRecord shareInstance] startRecord];
[[TXUGCRecord shareInstance] stopRecord];
``` 

The feedback of the recording process and result is provided via the API TXVideoRecordListener (defined in TXUGCRecordListener.h):

- "onRecordProgress" is used to provide the feedback of the recording progress. The parameter "millisecond" indicates record length (in ms):

```ObjectiveC
@optional
-(void) onRecordProgress:(NSInteger)milliSecond;
``` 

- "onRecordComplete" provides the feedback of the recording result. The fields "retCode" and "descMsg" indicate error code and error message. "videoPath" is the path of the recorded short video file. "coverImage" is the first frame image of the short video (automatically captured, this image can be used when you publish the video).

```ObjectiveC   
@optional
-(void) onRecordComplete:(TXRecordResult*)result;
``` 
    
### 4. Multi-fragment Recording and Deletion  
```ObjectiveC
 // A video fragment is generated after pauseRecord is performed, which can be obtained in TXUGCPartsManager. 
[[TXUGCRecord shareInstance] pauseRecord];

 // resumeRecord is used to resume video recording
[[TXUGCRecord shareInstance] resumeRecord];

//Get fragment management object
@property (nonatomic, strong, readonly) TXUGCPartsManager *partsManager; 

//Get the total duration of all current video fragments
[_partsManager getDuration];

//Get the paths of all video fragments
[_partsManager getVideoPathList];

// Delete the last video fragment
[_partsManager deleteLastPart];

// Delete a specified video fragment
[_partsManager deletePart:1];

// Delete all video fragments
[_partsManager deleteAllParts];
```

### 5. Preview File
Use [Video Playback](https://cloud.tencent.com/document/product/584/9372) to preview the generated MP4 file. When calling startPlay, you need to specify playback type as [PLAY_TYPE_LOCAL_VIDEO](https://cloud.tencent.com/document/product/584/9372#step-3.3A-.E5.90.AF.E5.8A.A8.E6.92.AD.E6.94.BE6).

### 6. Obtain Signature
To publish the generated MP4 file onto Tencent Cloud, App needs to get a short-term valid upload signature for uploading files. For more information, please see [Server End Integration - Signature Distribution](https://cloud.tencent.com/document/product/584/9371).

### 7. Publish File
TXUGCPublish (located in TXUGCPublish.h) is used to publish MP4 files onto the Tencent Cloud Video Distribution Platform to satisfy the requirements for video playback such as nearby scheduling, instant broadcasting, dynamic acceleration, and overseas access.

```ObjectiveC
TXPublishParam * param = [[TXPublishParam alloc] init];

param.signature = _signature;                                // You need to enter the upload signature calculated in step 4.

// You can obtain the path of the generated video file from the onRecordComplete callback of TXVideoRecordListener.
param.videoPath = _videoPath;  
// You can obtain the first-frame preview image of the generated video file from the onRecordComplete callback of TXVideoRecordListener. It can be configured as nil.
param.coverPath = _coverImage; 

TXUGCPublish *_ugcPublish = [[TXUGCPublish alloc] init];
// Breakpoint resume is used during file publishing by default.
_ugcPublish.delegate = self;                                 // Configure TXVideoPublishListener callback
[_ugcPublish publishVideo:param];
``` 

The feedback of the publishing process and result is provided via the API TXVideoPublishListener (defined in the TXUGCRecordListener.h header file):

- "onPublishProgress" provides the feedback of the file publishing progress. Parameter "uploadBytes" indicates the bytes already uploaded. Parameter "totalBytes" indicates the total bytes to be uploaded.
```ObjectiveC 
@optional
-(void) onPublishProgress:(NSInteger)uploadBytes totalBytes: (NSInteger)totalBytes;
```

- "onPublishComplete" provides the feedback of publishing result. The fields "errCode" and "descMsg" of TXPublishResult indicate error code and error message. "videoURL" is the VOD address of the short video. "coverURL" is the cloud storage address of the video cover image. "videoId" is the cloud storage ID of the video file, which can be used to call VOD [Server APIs](https://cloud.tencent.com/document/product/266/1965).
``` C 
@optional
-(void) onPublishComplete:(TXPublishResult*)result;
```

### 8. Publish Result
Confirm the publishing result of short videos via [Error Code](https://cloud.tencent.com/document/product/584/10176).

