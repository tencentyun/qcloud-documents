## Interfacing Process

- **Short video recording**:
  Capture the camera image and microphone sound, process the image and sound, implement encoding and compression, and finally generate an MP4 file with the desired definition.

- **Short video publishing**:
  Upload an MP4 file to Tencent Video Cloud, and get the URL for online watching. Tencent Video Cloud supports the nearby scheduling, instant broadcasting, dynamic acceleration, overseas access and other requests of video watching, so as to ensure a high-quality watching experience.

![](//mc.qcloudimg.com/static/img/283c8d7fe0a5a316097ae687a2bf6c5a/image.png)

* Step 1: Use the API TXUGCRecord to record a short video. When the record is finished, a short video file (MP4) is generated and returned to the user.

* Step 2: Your App applies for an upload signature from your business server. The upload signature is a "license" which allows the App to upload MP4 file to Tencent Cloud Video Distribution Platform. To ensure safety, these uploaded signatures are issued by your business server and cannot be generated by the terminal App.

* Step 3: Use the API TXUGCPublish to publish video. Once successful, the SDK returns the playback URL to you.

## Note

- App must not include the SecretID and SecretKey used to calculate the upload signature in its client code. Exposing these critical information may cause potential safety issues such as allowing attackers to use your traffic and storage service for free once they have cracked your App and obtained the information.

- The proper practice is to use the SecretID and SecretKey on your server to generate an one-off upload signature, and then provide the signature to the App. Generally, servers are difficult to crack, so this can ensure safety.

- Be sure to pass the correct Signature field when you publish short videos, or else the publish operation may fail.

- When calling the video recording APIs startRecord and stopRecord, make sure they're called in pairs.

- Video recording length is determined by your code. To ensure an optimal performance and a good user experience, it is recommended that you keep the recording length within 60 seconds.


## API Description 
Tencent Cloud UGC SDK provides relevant APIs used to record and publish short videos. These APIs are described below:

| API File                     | Feature                       |
| ------------------------ | ------------------------ |
| `TXUGCRecord.java`       | Record short videos               |
| `TXUGCPublish.java`      | Upload/publish short videos               |
| `TXRecordCommon.java`    | Basic parameter definitions, including short video recording callback API and publishing callback API |
| `TXUGCPartsManager.java` | Video fragment management class, used for multi-fragment recording and deletion    |
| `ITXVideoRecordListener.java` | Recording callback for short videos                  |

## Interfacing Guide

![](http://mc.qcloudimg.com/static/img/6b21b033259c1b5124648b73e88fb243/image.png)


### 1. Video Preview
TXUGCRecord (located in TXUGCRecord.java) is used to record short videos. Our first task is to realize the video preview feature. The startCameraSimplePreview function is used to launch preview. You need to open the camera and microphone when launching preview, thus you may receive a permission prompt.

```java
mTXCameraRecord = TXUGCRecord.getInstance(this.getApplicationContext());
mTXCameraRecord.setVideoRecordListener(this);					//Configure recording callback
mVideoView = (TXCloudVideoView) findViewById(R.id.video_view);	//Prepare a view used for previewing camera image
mVideoView.enableHardwareDecode(true);
TXRecordCommon.TXUGCSimpleConfig param = new TXRecordCommon.TXUGCSimpleConfig();
//param.videoQuality = TXRecordCommon.VIDEO_QUALITY_LOW;		// 360p
param.videoQuality = TXRecordCommon.VIDEO_QUALITY_MEDIUM;		// 540p
//param.videoQuality = TXRecordCommon.VIDEO_QUALITY_HIGH;		// 720p
param.isFront = true;           //Whether to use front camera.
param.minDuratioin = 5000;	//The minimum length of video recording (in ms)
param.maxDuration = 60000;	//The maximum length of video recording (in ms)
mTXCameraRecord.startCameraSimplePreview(param,mVideoView);
```

### 2. Special Effect
You can use the special effect switches in TXUGCRecord to add certain special effects to your video or control the camera (either before or during a recording process).

```java
//////////////////////////////////////////////////////////////////////////
//                      Supported special effects are shown below (1.9.1 version or above).
//////////////////////////////////////////////////////////////////////////
//
// Switch between front and rear cameras. The parameter mFront indicates whether to use front camera. Default is front camera.
mTXCameraRecord.switchCamera(mFront);

// Configure beautifying and whitening effect levels.
// beautyDepth     : Available value range for beautifying level: 0-9. 0 means to disable beautifying. A higher value means a stronger effect.
// whiteningDepth  : Available value range for whitening level: 0-9. 0 means to disable whitening. A higher value means a stronger effect.
mTXCameraRecord.setBeautyDepth(beautyDepth, whiteningDepth);

// Configure color filter: romantic, fresh, artistic, tender, vintage...
// Bitmap     : Specify the color lookup table used by the filter. Note: Be sure to use PNG format.
// The filter lookup table used in the Demo is located in RTMPAndroidDemo/app/src/main/res/drawable-xxhdpi/.
// setSpecialRatio: Used to configure the effect level of the filter (0-1). A higher value means a stronger effect. Default is 0.5.
mTXCameraRecord.setFilter(filterBitmap);
mTXCameraRecord.setSpecialRatio(0.5);
// Set the normalization value of the global watermark TXRect-watermark relative to the video image. SDK automatically calculates the height according to the aspect ratio of watermark.
// For example, the size of a video image is (540,960). The three parameters of TXRect are set to 0.1, 0.1, 0.1
// The actual pixel coordinates of watermark are (540*0.1, 960*0.1, 540*0.1)
// 540 * 0.1 * watermarkBitmap.height / watermarkBitmap.width)
setWatermark(watermarkBitmap, txRect)
// Set the green screen file: The formats available in Android system are supported. That is, images in jpg/png and videos in mp4/3gp are supported.
setGreenScreenFile(path, isLoop);
// Set the beautifying style: Smooth, natural, and hazy
setBeautyStyle(style);

// Whether to enable flashlight. The parameter mFlashOn indicates whether to enable flashlight. Flashlight is disabled by default.
mTXCameraRecord.toggleTorch(mFlashOn);
// Get the maximum focal length supported by the camera
mTXCameraRecord.mTXCameraRecord();
// Set the focal length
mTXCameraRecord.setZoom(value);

//////////////////////////////////////////////////////////////////////////
//                      Background music related
//////////////////////////////////////////////////////////////////////////
// Set the background music playback callback API TXRecordCommon.ITXBGMNotify
setBGMNofify(notify);
// Play background music
mTXCameraRecord.playBGM(path);
// Stop background music
mTXCameraRecord.stopBGM();
// Pause background music
mTXCameraRecord.pauseBGM();
// Resume background music
mTXCameraRecord.resumeBGM();
// Set the microphone volume to control the microphone volume when playing the mixed background music.
// Normal volume is 1. The recommended value is 0-2. If you need to turn up the volume, you can set it to a larger value.
mTXCameraRecord.setMicVolume(x);
// Set the background music volume to control the background music volume when playing the mixed background music.
// Normal volume is 1. The recommended value is 0-2. If you need to turn up the background music volume, you can set it to a larger value.
setBGMVolume(x);

//////////////////////////////////////////////////////////////////////////
//                       The following special effects are only supported by the VIP edition
// (These effects use the intellectual properties of YouTu team and are supported only by the VIP SDK edition. We cannot provide them for free)
//////////////////////////////////////////////////////////////////////////

// Configure motion effect stickers. The motion effect file motionTmplPath is located in: An empty string "" means to disable motion effect.
mTXCameraRecord.setMotionTmp(motionTmplPath);
// Set the green screen file: The formats available in Android system are supported. That is, images in jpg/png and videos in mp4/3gp are supported.
mTXCameraRecord.setGreenScreenFile();
// Set eye enlargement effect (0-9)
mTXCameraRecord.setEyeScaleLevel(eyeScaleLevel);
// Set face slimming effect (0-9)
mTXCameraRecord.setFaceScaleLevel(faceScaleLevel);
// Set V-shaped face effect (0-9)
mTXCameraRecord.setFaceVLevel(level)
// Set chin stretching or contracting effect (0-9)
mTXCameraRecord.setChinLevel(scale)
// Set face contracting effect (0-9)
mTXCameraRecord.setFaceShortLevel(level)
// Set nose narrowing effect (0-9)
mTXCameraRecord.setNoseSlimLevel(scale)

```


### 3. Record File
Call the startRecord function in TXUGCRecord to start recording process, and call the stopRecord function to stop recording process. Be sure to call these two functions in pairs.
```java
mTXCameraRecord.startRecord();
mTXCameraRecord.stopRecord();
```

The feedback of the recording process and result is provided via the API TXRecordCommon.ITXVideoRecordListener (defined in TXRecordCommon.java):

- "onRecordProgress" is used to provide the feedback of the recording progress. The parameter "millisecond" indicates record length (in ms):
```java
@optional
void onRecordProgress(long milliSecond);
```

- "onRecordComplete" provides the feedback of the recording result. The fields "retCode" and "descMsg" indicate error code and error message. "videoPath" is the path of the recorded short video file. "coverImage" is the first frame image of the short video (automatically captured, this image can be used when you publish the video).
```java   
@optional
void onRecordComplete(TXRecordResult result);
```

- "onRecordEvent" recording event callback includes the event ID and event-related parameter (key, value) formats.

```java   
@optional
void onRecordEvent(final int event, final Bundle param);
```



### 4. Multi-fragment Recording and Deletion

```java
// A video fragment is generated after pauseRecord is performed, which can be obtained in TXUGCPartsManager. 
mTXCameraRecord.pauseRecord();
// Resume video recording
mTXCameraRecord.resumeRecord();
// Get fragment management object
mTXCameraRecord.getPartsManager();
// Get the total duration of all current video fragments
mTXUGCPartsManager.getDuration();
// Get the paths of all video fragments
mTXUGCPartsManager.getPartsPathList();
// Delete the last video fragment
mTXUGCPartsManager.deleteLastPart();
// Delete a specified video fragment
mTXUGCPartsManager.deletePart(index);
// Delete all video fragments
mTXUGCPartsManager.deleteAllParts();
```

### 5. Preview File

Use [Video Playback](https://cloud.tencent.com/document/product/584/9373) to preview the generated MP4 file. When calling startPlay, you need to specify playback type as [PLAY_TYPE_LOCAL_VIDEO](https://cloud.tencent.com/document/product/584/9373#step-3.3A-.E5.90.AF.E5.8A.A8.E6.92.AD.E6.94.BE.E5.99.A86).

### 6. Obtain Signature
To publish the generated MP4 file onto Tencent Cloud, App needs to get a short-term valid upload signature for uploading files. For more information, please see [Server End Integration - Signature Distribution](https://cloud.tencent.com/document/product/584/9371).

### 7. Publish File
TXUGCPublish (located in TXUGCPublish.java) is used to publish MP4 files onto the Tencent Cloud Video Distribution Platform to satisfy the requirements for video playback such as nearby scheduling, instant broadcasting, dynamic acceleration, and overseas access.

```java
mVideoPublish = new TXUGCPublish(TCVideoPublisherActivity.this.getApplicationContext());
// Breakpoint resume is used during file publishing by default.
TXUGCPublishTypeDef.TXPublishParam param = new TXUGCPublishTypeDef.TXPublishParam();
param.signature = mCosSignature;						// You need to enter the upload signature calculated in step 4.
// You can obtain the path of the generated video file from the onRecordComplete callback of ITXVideoRecordListener.
param.videoPath = mVideoPath;
// You can obtain the first-frame preview image of the generated video file from the onRecordComplete callback of ITXVideoRecordListener.
param.coverPath = mCoverPath;
mVideoPublish.publishVideo(param);
```

The feedback of the publishing process and result is provided via the API TXRecordCommon.ITXVideoPublishListener (defined in the TXRecordCommon.java header file):

- "onPublishProgress" provides the feedback of the file publishing progress. Parameter "uploadBytes" indicates the bytes already uploaded. Parameter "totalBytes" indicates the total bytes to be uploaded.
```java
void onPublishProgress(long uploadBytes, long totalBytes);
```

- "onPublishComplete" provides the feedback of publishing result. The fields "errCode" and "descMsg" of TXPublishResult indicate error code and error message. "videoURL" is the VOD address of the short video. "coverURL" is the cloud storage address of the video cover image. "videoId" is the cloud storage ID of the video file, which can be used to call VOD [Server APIs](https://cloud.tencent.com/document/product/266/1965).
```java 
void onPublishComplete(TXPublishResult result);
```

### 8. Publish Result
Confirm the publishing result of short videos via [Error Code](https://cloud.tencent.com/document/product/584/10176).

If no error message or callback response is returned, it may be caused by an integration error. For more information, please see [Integration Error](https://cloud.tencent.com/document/product/584/11631). 

