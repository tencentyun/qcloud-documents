# Android 应用使用腾讯云 MobileLine 的移动推送

由于众所周知的原因，Google官方的 [FCM](https://firebase.google.com/docs/cloud-messaging/?hl=zh-cn) 在国内无法使用，再加上国内各种各样的定制化 ROM，我们不得不选择一款成熟的第三方平台做我们的推送服务。现在市场上的推送平台很多，比如极光推送、小米推送、阿里云推送、百度云推送等，由于自己的项目中使用的是腾讯云 MobileLine 的移动推送，所以我就简单介绍下使用 MobileLine 移动推送的流程。

## 腾讯移动推送（信鸽）

MobileLine 移动推送服务背后依赖的是腾讯的信鸽服务，但就 Android SDK 而言，相比信鸽的 SDK，简化了集成流程，而且还能和 MobileLine 其他的移动端服务一起使用，打通各个服务间的数据。

腾讯移动推送（信鸽）是一款专业的移动 App 推送平台，支持百亿级的通知/消息推送，秒级触达移动用户，同时支持 Android 和 iOS 两大主流平台。开发者只要在终端集成 SDK，通过 API 调用或者 Web 端可视化操作，实现对特定用户推送，大幅提升用户活跃度，有效唤醒沉睡用户，并实时查看推送效果。

简单说，腾讯移动推送的优势在于：

1. 消息到达率高，秒级到达还是很牛逼的；
2. 支持控制台可视化操作；
3. 可以全面监控推送到达率和转化率；
4. 在 Android 平台上针对进程保活、网络心跳保活等问题，做了很多的优化工作；
5. SDK 集成流程非常简单；
6. 控制台、Android 和 iOS 的文档比较齐全。

## 消息的发送流程

消息的发送流程大概是这样的，这里截取一下官网的一个流程图：

![](http://developer.qq.com/wiki/xg/imgs/20151029163904_73066.png)

## 一些概念

#### 设备

设备是指一个独立的中断。移动推送为每个设备会分配一个 Token 作为唯一的标识。

#### 账号

账号是指应用设置的用户标识，可能是用户体系中的账号，也可能是三方登录系统中的用户标识。

#### 标签

通常是指给某个或某一群用户打上标签。自定义标签可以通过客户端或服务端调用进行设置，之后在前台进行使用。

## 集成流程

### 1. 创建 腾讯云 开发者账号

首先当然是创建 [腾讯云](https://cloud.tencent.com) 账号，如果你已经有开发者账号了，跳过这步。

### 2. 开通 MobileLine 服务

在腾讯云的控制台开通 MobileLine 服务即可，然后进去应用管理控制台，创建项目和应用，并且按照引导，下载配置文件并放到项目工程中。

### 3. 应用集成 SDK

和市面上其他的推送服务 SDK 相比，MobileLine 移动服务集成 SDK 非常的方便，只需要添加一句依赖搞定：

```
dependencies {
    compile 'com.tencent.tac:tac-messaging:1.0.0'
}
```

### 4. 启动服务

代码中启动服务很简单，只需要在 `Application` 的 `onCreate` 里面调用 `start` 即可：

![](http://ww1.sinaimg.cn/large/62f68aebgy1fpkhef6jclj218e0niae4.jpg)

推送服务是会单独启动一个独立进程的。因为我的app开启了多进程，所以需要判断下当前是否是主进程，以免启用多个服务进程：

![](http://ww1.sinaimg.cn/large/62f68aebgy1fpkhet3499j21ei0li79d.jpg)


### 5. 注册回调

然后就是注册 `Receiver` 了，消息到达之后，会回调 `Receiver` 的对应方法：

![](http://ww1.sinaimg.cn/large/62f68aebgy1fpki0uddexj21540eiwgo.jpg)

`Receiver` 可以直接继承与 `TACMessagingReceiver`，然后在具体的回调方法里面写自己的逻辑。

![](http://ww1.sinaimg.cn/large/62f68aebgy1fpki5zonn6j21z40lin2a.jpg)

比如收到了通知栏消息，那么 `onNotificationShowed` 方法就会自动调用了。

## 控制台推送

手机上运行app，然后就可以测试推送效果了。

登录MobileLine 控制台，进入移动推送，可以非常方便的创建一条通知栏推送消息了。

![](http://ww1.sinaimg.cn/mw690/62f68aebgy1fpkj01exflj221o1eq13g.jpg)

推送还支持单播和广播。因为现在是测试状态，我这里选的是广播，如果app上线了，还是选择单播比较安全~

然后过了几秒，手机端就收到推送消息了。

![](http://ww1.sinaimg.cn/mw690/62f68aebgy1fpkj34zw3zj20u01hc0xa.jpg)

## 推送效果监控

控制台上可以实时监控推送的发送量，展示量也就是达到率，还有用户的点击率，帮助产品更好的运营，方便评估推送的效果。

![](http://ww1.sinaimg.cn/mw690/62f68aebgy1fpkjkjc2kqj221g0tsjv4.jpg)


几个重要的数据指标的意思是这样的：

* Android-有效推送量：是指发送给当前在线设备（与服务器有连接的设备）的推送量。若消息设置了离线保存，随着时间的推移和用户的上线动作，有效推送量会有数值上的增加，即表示新上线的用户也收到了该条推送。

* iOS-有效推送量：是指成功发送给苹果服务器的推送量。信鸽负责将消息成功推送给苹果服务器，但由于苹果服务器限制，抵达量无法统计。

* 抵达量：本条推送成功推送的用户数，实时数据有5分钟左右延迟。

* 抵达率：抵达量/推送量×100%

* 点击量：成功的推送中，本条推送消息被点击次数的总计，点击量要求终端调用特定函数上报。

* 点击率：点击量/抵达量×100%

## 其他高级功能

除了普通的通知栏消息，移动推送服务还支持：

1. 消息也可以以应用内消息的形式发送，这样就直接做成app的消息中心了，自由度比推送通知栏消息更高。当然应用内消息就需要我们自己处理了，而不会直接显示出来。
2. Android 可以定制消息的样式，同时支持在控制台和应用上配置样式，主要在两端保持一样的 id 即可。再就不用担心所有消息都是千篇一律的了。

## 一些踩的坑

这里列一些联调过程中踩到的坑，避免大家也跟我犯一样的错误。如果有问题，还是直接翻看官方的开发者文档吧。

#### 1. 注册服务有没有成功

实际上，如果因为网络原因等导致注册服务失败，消息是肯定收不到的，所以最好在 logcat 里面看到有获取 token 成功的日志，或者收到成功的回调之后再测试。可以这样拿到注册结果的回调：

![](http://ww1.sinaimg.cn/large/62f68aebgy1fpkk138pqkj21cm0ni0xc.jpg)

其中的token就是设备的唯一标识啦，Android Token长度为40位。

#### 2. 消息延时

在Android平台下，推送服务和大多数互联网服务一样，受限于包括网络服务质量、运营商政策或用户需求差异等因素的影响，所以有可能出现延时。另外，如果 service 被系统或者安全软件杀死，也会有收不到或延时情况。目前，在某些定制的系统（如MIUI）或被安全软件禁止自启动后，只有用户再次打开APP才能重启推送service。

推送service何时能够启动由系统调度确定。在锁屏触屏、网络切换、安装APP、系统重启等条件，SDK 会主动尝试启动service。


#### 3. 排查方法

* 设备是否正常联网？

* 配置文件是否已经集成到工程中？MobileLine 平台创建应用之后会下发一个配置文件的压缩包，里面有两个json，需要把`tac_service_configurations.json` 文件放到 assets 里面，否则推送就无法注册了。

* 当前APP包名是否与前台注册的一致？如果不一致，请在控制台选中“使用多包名”选项。

* 设备是否注册成功？是否已经拿到token？

* 前台下发通知时，“时段控制”选项里的时间段是否符合终端设备当前时间？

#### 4. 控制台的历史明细并不会有单播的记录

单播的时候，历史明细是没有记录的，无法实时看到那条推送。。。但其实是可以推送成功的，可以耐心再等等。
