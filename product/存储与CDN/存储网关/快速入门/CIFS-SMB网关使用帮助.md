在客户本地网络环境中或公有云环境中部署 CIFS/SMB 网关后，可以使用 CIFS/SMB 协议来读写海量云端数据、拓展本地存储，在保持了对热数据访问的低延时的同时，不仅为用户节省大量主数据存储费用，还在最大程度上减小了对于本地存储扩展的需求。

## 创建网关

### 安装前注意事项
1. 安装网关的机器可以是 **CVM 主机**，也可以是用户本地环境的 **VMware 虚拟主机**，主机配置需要满足如下要求：

|                     网关类型                     |                 最低机器配置                  |               推荐机器配置               |        磁盘配置        |
| :-----------------------------------------: | :--------------------------------------: | :--------------------------------------: | :--------------------: |
|             NFS 网关、CIFS/SMB 网关              | 4 核 CPU、<br />16GB 内存、<br />4 Mbps 带宽  | 8 核 CPU<br />32GB 内存<br />10Mbps 带宽 | 最少2 块10 GB 以上磁盘 |
| 高 IO 版网关（高速上传、适合于有专线连接的情况） | 8 核 CPU、<br />64GB 内存、<br />400Mbps 带宽 |                    -                     |      无需配置磁盘      |
>!
>- 如果系统低于最低机器配置要求，存储网关可能无法正常运行。</span>
>- 更多机器配置、磁盘及内存限制请参考 [系统限制及注意事项](https://cloud.tencent.com/document/product/581/9775)。
>
2. 登录存储网关控制台的机器（发起激活）必须与安装存储网关的机器（被激活）可以网络互通（内网/外网均可）；**如果使用的是 CVM 部署 CSG， 请使用 CVM 的外网 IP 进行激活**。
3. 为了可以正常激活以及保障存储网关的通讯，请为安装存储网关的机器开启下列要求的端口：

| 端口                                  | 协议 | 用途                                   | 开放建议                                                     |
| ------------------------------------- | ---- | -------------------------------------- | ------------------------------------------------------------ |
| 22 端口                               | TCP  | 使用该端口通过 SSH 访问并管理 CSG 主机 | 可以选择性对内部网络内的主机开放                             |
| 80 端口                               | TCP  | 使用该端口激活网关                     | 需要对 登录腾讯云控制台执行激活存储网关操作的主机 开放（如果是使用腾讯云 CVM ，只需要使用外网 IP 激活即可） |
| 111，662，892，2049，8082，32803 端口 | TCP  | 使用该端口连接文件系统                 | 对需要挂载文件系统的客户端开放                               |
| 111，662，892，2049，32769 端口       | UDP  | 使用该端口连接文件系统                 | 对需要挂载文件系统的客户端开放                               |

4. 网络带宽设置
存储网关的带宽设置需要满足 "每日可上传数据量" > "每日写入数据量"。请根据您业务每天写入的数据量来为存储网关分配出口带宽及限速。例如，每日往存储网关 A 写入 500GB 数据，若全天不限速（上传时间为 24小时 \* 60分 \* 60秒），则最小出口带宽设置为 50Mbps。
5. 上传缓冲区与缓存区磁盘配置
为保护您的读写操作正常运行，系统要求上传缓冲区与缓存区容量比例需要符合 **3:2** 的比例。
 - 当 **缓存区:上传缓冲区 < 3:2** 时，会导致系统无法正常工作，此时还需要用户继续添加缓存区的存储。
 - 当 **缓存区:上传缓冲区 >= 3:2** 时，系统会自动将两个区域的容量实际使用比例调节成 3:2。因此，若比例大于 3:2 时，缓存区会有部分容量空闲，此时您可以继续增加上传缓冲区来利用空闲的缓存区容量。

>! 本地磁盘一旦设置用途后不允许更改（仅可新增或者删除）。若在本地磁盘列表中未找到自己的磁盘，请单击**刷新**。
>


### 开始部署网关 
进入 CSG 控制台之后， 在列表左上角单击**创建网关**，进入创建向导。
![](https://mc.qcloudimg.com/static/img/3295699467ef5535cda16c00be82c812/image.png)	


### 选择地区
由于不同地区的网关跟云服务器之间无法之间互通，建议您根据业务主要分布的地区选择网关所在地区。单击**下一步**。
![](https://mc.qcloudimg.com/static/img/8736746c1bbf9f3e10e3d1ca3247db47/image.png)
>! 创建时，设置网关所在地区后将无法修改。
>

### 选择网关类型及网关性能
根据您的业务使用场景，在页面中选择 "NFS 网关" 或 "CIFS/SMB 网关" 。
- NFS 网关：提供 NFS v3.0、 NFS v4.0 访问协议，数据只能通过存储网关来读写。
- CIFS/SMB 网关：提供 CIFS/SMB 访问协议，数据只能通过存储网关来读写。


### 选择网关运行的平台
网关支持运行于 VMware 及 CVM 的 Linux 下。如果您需要在本地环境中创建网关，请下载并部署网关 VM，然后激活网关。如果您需要在 CVM 实例上创建网关，请在 CVM 镜像市场中选中包含网关 VM 镜像并启动运行，然后激活网关。
![](https://mc.qcloudimg.com/static/img/54779ae228dbc53e2480262c06fcc1a7/image.png)

>! "NFS 网关" 与 "CIFS/SMB 网关" 与 "卷网关" 共用 "[腾讯云存储网关（CSG）镜像 - 卷网关](https://market.cloud.tencent.com/products/4276?productId=4276&_ga=1.138077944.992563734.1509872671#)" 的镜像。
>

### 在 VMware 上部署 CSG 网关
在当前页面下载带有 VM 镜像的压缩包。
![](https://mc.qcloudimg.com/static/img/d02d40b2e99351111f2c4bf4fc3059c9/image.png)

#### 将网关 VM 部署到 VMware 主机

- 连接到您的管理程序主机
通过 Windows 上的 VMware vSphere 客户端，输入该主机的 IP 和密码后登录。
 ![](https://mc.qcloudimg.com/static/img/a19a562c204e25069182276b3adb6931/image.png)
- 打开 OVF 模板部署向导
 在 vSphere 客户端的 "文件" 菜单上，单击**部署 OVF 模板**。
 ![](https://mc.qcloudimg.com/static/img/b937e1adc501d883799963e7540dc308/image.png)
- 选中网关镜像文件
  在 "源" 窗格中，选择刚刚解压后存储网关 CSG.ova 文件所在的路径，然后单击**下一步**。
  ![](https://mc.qcloudimg.com/static/img/a0c8389fbf39c3c231beb922ecdb9752/image.png)
- 输入名称
  在 "名称和位置" 窗口中，输入 VM 的名称，然后单击**下一步**。
  ![](https://mc.qcloudimg.com/static/img/21058d668eec84f00a56a03c6e9412f5/image.png)
- 设置数据存储 
  当您的主机仅有一个数据存储时，则直接进入下一步。
  当您的主机有多个数据存储时，您需要在列表中选择要从中部署 VM 的数据存储，然后单击**下一步**。
  ![](https://mc.qcloudimg.com/static/img/17f78509150cd43543ac8947f24df245/image.png)
- 设置磁盘格式 
  在磁盘格式设置窗口中，选择 "厚置备延迟置零" 或者 "厚置备置零"，然后单击**下一步**。
  说明：设置厚置备格式为网关正常运行提供足够的磁盘。
  ![](https://mc.qcloudimg.com/static/img/86c76c3f0c01a7ab03ca3c84917ba1fa/image.png)
- 完成设置 
按照上述设置步骤，完成 VM 的配置。
![](https://mc.qcloudimg.com/static/img/e18dba4da68619e611e8c17c5012e373/image.png)	

>! 为了防止来自公网的 iscsi 连接，建议网关所在机器将 22 端口及 80 端口全部开放，3260 端口只对内网 IP 开放。
>

### 设置 VM 时间、与主机时间同步	

- 在 vSphere 客户端中选择**编辑设置**。
![](https://mc.qcloudimg.com/static/img/253856bf215be43d5c882c02a5e44ac7/image.png)
- 在 "选项" 选项卡中选择 "VMware Tools"。勾选 "同步客户机时间与主机时间" 选项。
![](https://mc.qcloudimg.com/static/img/cc7744baf1e40d70f30affc2a6cc9555/image.png)
- 设置主机时间与 NTP 服务器同步。
  1. 在**时间设置**中选择**属性**。
  ![](https://mc.qcloudimg.com/static/img/34ebfd4dfb03630ac2e4ccccf1356750/image.png)
  2. 在弹出的时间设置窗口中设置时间和日期。
  ![](https://mc.qcloudimg.com/static/img/81ee7d4b67d8b9d85d5dacc940e5bc77/image.png)
  3. 单击上面窗口的**选项**，在弹窗中单击添加 NTP 服务器 IP 或 完整域名，您可以输入 pool.ntp.org 的域名。
  ![](https://mc.qcloudimg.com/static/img/4021ee87b962df50eaf76846f5da1142/image.png)
  4. 在**常规**单击**启动**以启动服务，再单击**确认**。
  ![](https://mc.qcloudimg.com/static/img/9dbdf6b3b03a7a452551138edf8ad19a/image.png)

###  为网关 VM 预配置本地磁盘存储	

创建完成后，需要从本地磁盘、DAS 或 SAN 存储中为网关 VM 分配 "上传缓冲区" 及 "缓存" 磁盘。 
**缓存区：上传缓冲区至少要达到 3:2，否则网关将无法正常运行。**
- **上传缓冲区**：用于存储待上传数据，推荐容量为业务 "每日写入数据量" 的120%。例如，每日写入数据为300GB，则上传缓冲区容量至少为360GB。 
>! 存储网关分配的上传网络带宽最少可使每天写入的数据顺利上传至云端。
>
- **缓存**：用于缓存频繁读取的热数据，由业务所需频繁读取数据量决定。例如，每天产生100GB数据，一个月之内数据会频繁读写，一个月之前的数据很少读取。则用户需要准备100 * 30GB约3TB的空间作为缓存区。

而缓存区容量更大，因此上传缓冲区为缓存区的2/3，即：
**缓存区= 3TB**
**上传缓冲区=缓存区（3TB）/1.5= 2TB**

请按照下列步骤为网关 VM 预配置本地磁盘。
1. 单击**编辑设置**。
![](https://mc.qcloudimg.com/static/img/c543d185cce324d9bd78ba91fde45c24/image.png)	
2. 在弹出窗口中，单击**添加**，并选择 "硬盘"。
![](https://mc.qcloudimg.com/static/img/ddba7eb592d7e6a6e8fd4f6545a0b1ae/image.png)
3. 在弹出窗口中，选择 "创建新的虚拟磁盘".
![](https://mc.qcloudimg.com/static/img/30e9f45df99906c35348b6e6cd6f1104/image.png)
4. 设置磁盘大小（需要大于10 GB）和磁盘置备为 "厚置备延迟置零" 或者 "厚置备置零"。
![](https://mc.qcloudimg.com/static/img/4e18ebc34b0b96b351e5afa918405f84/image.png)
5. 完成磁盘创建。
![](https://mc.qcloudimg.com/static/img/ce566e05137128e2d60a68d1e450db81/image.png)

#### 配置磁盘 ID
由于网关需要通过磁盘 ID 来挂载，还需要为上面步骤创建的磁盘添加 ID 信息。
	
1. 在 "选项" 选项卡中选择 "常规"。单击**同配置参数**。
![](https://mc.qcloudimg.com/static/img/d47ce35e66d0583d0da3a2c4caae75ea/image.png)
2. 在弹出的窗口内，单击**添加行**。然后在增加的行内，名称栏填入 "disk.EnableUUID", 值栏填入 "true"。单击**确认**，并退出。
![](https://mc.qcloudimg.com/static/img/e05d02f29ccef723753bba137496a2c2/image.png)

### 在 CVM 上部署 CSG 网关
在创建网关的第三步，选择 "去 CVM 上部署"。从 CSG 控制台页面，跳转到 CVM 购买页。或者，也可以在 CVM 处直接创建新的主机。
![](https://mc.qcloudimg.com/static/img/8aa870b2527a0d51d281f99fd6d8a05f/image.png)

#### 选择 CVM 地域与机型
跳转到 CVM 购买页后，选择计费模式、地域、可用区、系列及机型。
>! 部署网关的 CVM 可以与 CSG 分布在不同的地域，但是跨地域访问会产生相应的网络流量。同时，为了保证网关正常运行， 请根据本篇第一章要求选择合适的主机配置。若选择低于该配置的主机，存储网关将无法正常启动。
>

![](https://mc.qcloudimg.com/static/img/b744953d0eeb21f02ba8666a0716958c/image.png)

#### 选择 CSG 镜像
若是从 CSG 的控制台跳转到 CVM 购买页，则此处仅需确认镜像为 CSG 镜像即可。
![](https://mc.qcloudimg.com/static/img/f37783fc72d541b7e7e7f63d6434cf2f/image.png)

若是直接购买 CVM，则需要选择 "服务市场" 选项，在弹出的窗口中搜索 "存储网关" 并选择所需要的网关类型。
>! "NFS 网关" 与 "CIFS/SMB 网关" 与 "卷网关" 共用 "[腾讯云存储网关（CSG）镜像 - 卷网关](https://market.cloud.tencent.com/products/4276?productId=4276&_ga=1.138077944.992563734.1509872671#)"的镜像。
>

![](https://mc.qcloudimg.com/static/img/d87443a2452c4ee76f05bea4b0d491df/image.png)
>? CSG 镜像包含的系统为 CentOS 7.2 版本。
>

#### 选择存储与网络
为存储网关配置存储及网络。在购买 CVM 流程中**不用选择数据盘（数据盘设置为 0GB）**。 
![](https://mc.qcloudimg.com/static/img/4e1de73e91cb3b4eab390e142d09af59/image.png)

#### 设置服务器相关信息并购买机器
为该存储网关设置主机名称及安全组。 端口开放需求请参考 [存储网关安全组要求](https://cloud.tencent.com/document/product/581/9775#.E7.BD.91.E7.BB.9C.E5.8F.8A.E7.BD.91.E5.85.B3.E5.AE.89.E5.85.A8.E7.BB.84)，设置完成后确认购买机器。
![](https://mc.qcloudimg.com/static/img/4cf0544a1d410861d032f05ba61b464e/image.png)

>? 出于安全原因考虑，运行存储网关的云服务器暂不提供 root 权限（即使此处配置了 root 也无效。请使用下面用户名/密码进行登录到存储网关主机并维护。

```
Username: csguser
Password: csg123
```

#### 为服务器增加磁盘
购买完云服务器后，需要回到 [CVM 控制台](https://console.cloud.tencent.com/cvm)。 在 CVM 控制台新建至少 2 块 10GB 以上的云硬盘并挂载到该主机上（网关正常运行至少需要 2 块以上磁盘，请根据业务需要选择缓存/上传缓冲磁盘/元数据磁盘大小，磁盘后期还可根据需要自行添加）。
![](https://mc.qcloudimg.com/static/img/92c386037e4aeff1dfcf91a1d6fc6994/image.png)
>! 为了保障卷网关、磁带网关的读写性能，缓存磁盘的容量必须为上传缓冲磁盘容量的 1.5 倍以上。
>

### 连接到网关
在网关控制台上输入网关所在主机 IP， 单击**连接到网关**，激活过程将网关与您的腾讯云账户关联。您的网关 VM 必须正在运行才能成功激活。
- 网关运行于本地主机
  从网关 VM 本地控制台或管理程序客户端获取 IP 地址。
- 网关运行在 CVM 实例上
  从腾讯云 CVM 控制台获取 IP 地址。

![](https://mc.qcloudimg.com/static/img/0900a37d4650a2a6d8c0bd4ead88f356/image.png)

>? 若激活失败，请检查您输入的 IP 地址是否正确。如果该 IP 地址正确，则请确认已将网络设置为 "允许浏览器访问" 。
>

### 激活网关
配置网关时区、填写网关名称及时区以激活网关。 在此处可以选择数据写入模式，即，
- 高速模式：数据先写入内存，然后从内存写入磁盘。**说明：该模式数据写入速度较快，但如果遇到异常掉电等情况可能会造成内存中缓存数据丢失。**
- 稳定模式：数据直接写入磁盘。**说明：该模式数据写入后稳定性高，异常掉电等情况也可以从磁盘中进行数据恢复。

![](https://mc.qcloudimg.com/static/img/4012fdd301ee6ed62a30a92ec54f12b7/image.png)

### 配置本地磁盘并完成创建  
在获取本地磁盘信息后，请根据业务情况将各个磁盘分别设置为 "上传缓冲区" 或 "缓存"。设置完毕后，单击**完成**并退出网关创建向导。
>? 本地磁盘一旦设置用途后不允许更改（仅可新增或者删除）。若在本地磁盘列表中未找到自己的磁盘，请单击**刷新**。
>

- 上传缓冲区：用于存储待上传数据，推荐容量为业务 "每日写入数据量" 的120%。例如，每日写入数据为300GB，则上传缓冲区容量为 360GB。
>! 存储网关分配的上传网络带宽最少可使每天写入的数据顺利上传至云端。
>
- 缓存区：用于缓存频繁读取的热数据，由业务所需频繁读取数据量决定。例如，每天产生100GB数据，一个月之内数据会频繁读写，一个月之前的数据很少读取。则用户最少需要准备100 * 30GB约3TB的空间作为缓存区。

而缓存区容量更大，因此上传缓冲区为缓存区的2/3或更小，即 
- 缓存区= 3TB
- 上传缓冲区=缓存区（3TB）/1.5= 2TB

![](https://mc.qcloudimg.com/static/img/74499026483883fb7244b8bf391cefdc/image.png)
>! 网关正常运行，**至少需要配置一个 "上传缓冲区" 和 一个 "缓存" 磁盘，且缓存磁盘容量必须是上传缓冲区容量的 1.5 倍及以上**。 若您没有在创建时为网关分配本地磁盘，网关将处于 "待配置" 状态，需要等待配置本地磁盘后才能正常运行，请参照 [管理磁盘配置](https://cloud.tencent.com/document/product/581/9485) 进行配置。
>


## 创建 CIFS/SMB 文件系统
完成网关的创建之后，您需要为该网关分配云端的存储空间（即文件系统），用于存储用户上传的数据。
在 "CSG 控制台-网关" 页面或 "文件共享 >文件系统" 页面， 单击**创建文件系统**或 **新建**。
![](https://mc.qcloudimg.com/static/img/1d5c0529709738e1a6527e6a63e77d11/image.png)
![](https://mc.qcloudimg.com/static/img/63321f86e1e25578a3b55e1c349bfa04/image.png)

在弹出的窗口中进行相关设置：

* 选择网关：选择需要创建文件系统网关。一旦创建之后，无法修改文件系统所属的网关。
* 文件协议：根据网关类型，自动显示该文件系统支持的访问协议为 NFS 或者 CIFS/SMB。
* 名称（挂载目录）：该名称和网关 IP 为文件系统 mount target 名称的组成部分（例如， 10.10.10.19:/filesysname)。
  注意：名称要求 1-64 位的数字或英文字母，同一个网关下名称不能重复。名称一旦创建后，不支持修改。
* 允许访问地址：设置来访 IP 或网段的白名单，允许这些客户端挂载并访问该文件系统。该字段留空会允许所有客户端访问。同时，如果是多 IP 主机，请填写该主机的内网 IP。
>! 同一个 SMB 网关下的多个文件系统共享该来访白名单，因此此处会显示该网关的白名单信息，若修改该允许来访地址名单时，会同时影响其他该网关下的文件系统来访信息。
>

 ![](https://mc.qcloudimg.com/static/img/0dfe1fb6f83853ec41c25d547e5e41cf/image.png) 

## 使用 CIFS/SMB 文件系统
创建文件系统后，请在其他服务器或客户端上按照如下指引进行配置，挂载该文件系统并使用。SMB 网关支持 CIFS、 SMB2.0 及 SMB 3.0。

>! 若在 CVM 上使用网关，建议将网关部署在各来访客户端的 VPC 下；如果在不同 VPC 时，请使用 [对等连接](https://cloud.tencent.com/document/product/215/5000) 方法实现网络互通。
>

###  在 Windows 上使用 SMB 文件系统
#### 创建 SMB 用户并分配权限
在存储网关控制台创建用来访问文件系统的用户，设置用户名及密码，并为该用户分配文件系统权限。
![](https://mc.qcloudimg.com/static/img/26b6ad3bfa669ad01dc0852cd810df26/image.png)

#### 添加访问白名单
在文件系统处，添加来访客户端的 IP 到 "允许访问地址" 中以获得访问权限 。如果使用 CVM 来访，建议将外网地址和内网地址都添加到来访地址中（可以到 CVM 控制台获取内网和外网 IP ）。
![](https://mc.qcloudimg.com/static/img/ba1f23f1ceaec7a46e47a25594960b39/image.png)


#### 打开 "映射网络驱动器"
登录到需要挂载文件系统的 Windows 上，在 "开始" 菜单中找到 "计算机"，单击鼠标右键出现菜单，单击菜单中的 "映射网络驱动器"。 
![](https://mc.qcloudimg.com/static/img/5696d66a83d4e9b35196274f89e07dfc/image.png)
![](https://mc.qcloudimg.com/static/img/6eeb1c0838e6aab185ed8b76dc736912/image.png)

#### 输入访问路径
在弹出的设置窗口中设置 "驱动器" 盘符名称及文件夹（即在 SMB 文件系统中看到的挂载目录）。
![](https://mc.qcloudimg.com/static/img/004ef32b0b934ed6d666405a38fff999/image.png)

#### 输入用户名密码
单击**完成**后，在弹出的窗口中输入第一步创建的用户名密码，单击确认完成挂载。
![](https://mc.qcloudimg.com/static/img/27f2f6fdcb2f75ea974ef96bdb90ef28/image.png)

>! 请勿从多台客户端主机上使用相同用户名密码访问同一文件系统，该操作会被系统自动识别为非法（文件系统会锁住）。
>


#### 验证读写
确认后，页面直接进入到已经挂载的文件系统中。可以右键新建一个文件来验证读写的正确性。
![](https://mc.qcloudimg.com/static/img/60b9388885536ec7d81b1cf7f76c39d5/image.png)

#### 断开文件系统
要断开已经挂载的文件系统，只需鼠标右键单击磁盘，再出现的菜单中单击**断开**选项，即可断开文件系统的连接。
![](https://mc.qcloudimg.com/static/img/376cd0547aa64f4d519e5444c5a58f93/image.png)


## 管理 CIFS/SMB 用户

登录控制台后，可以到 "文件共享 >CIFS/SMB用户" 菜单下管理 CIFS/SMB 网关的用户。
![](https://mc.qcloudimg.com/static/img/1844afdea6b5c428eb5e5cb204e52025/image.png)

### 查看用户信息

单击列表中 “用户名” 可以进入用户详情页面，查看用户详细信息。
![](https://mc.qcloudimg.com/static/img/eb6ea81fd40aec4aed6a056846467e1b/image.png)


### 编辑用户信息

在用户详细信息页面，单击编辑图标修改用户详情和文件系统权限。
>! 若有客户端正使用该用户挂载或访问文件系统，此时修改密码或文件系统权限可能导致正在使用的文件系统因为失去权限而不可用。另，若使用 Linux 挂载 SMB 文件系统，由于协议限制，修改用户权限或密码后需要重启客户端才能生效。
>
![](https://mc.qcloudimg.com/static/img/aaf0bd8aa9ace5c98df757ca7f792ff9/image.png)
![](https://mc.qcloudimg.com/static/img/188df01176ce3697658675abf43e2ea1/image.png)

### 禁用/启用用户

当需要禁用用户账户时，可以从 CIFS/SMB 用户列表的 “操作” 栏中找到**禁用**或**启用**。在弹窗中单击**立即禁用**或者**立即启用**来改变用户状态。
>! 若有客户端正使用该用户挂载或访问文件系统，此时修改密码或文件系统权限可能导致正在使用的文件系统因为失去权限而不可用。另，若使用 Linux 挂载 SMB 文件系统，由于协议限制，修改用户权限或密码后需要重启客户端才能生效。
>
![](https://mc.qcloudimg.com/static/img/00ccf74c97a308ca95f7eef325f2ebd6/image.png)
![](https://mc.qcloudimg.com/static/img/55a2f0e5cd77217355f00fd845e27665/image.png)

### 删除用户

当需要删除用户时，可以从 CIFS/SMB 用户列表的 “操作” 栏中找到**删除**。在弹窗中单击**立即删除**删除该用户。
![](https://mc.qcloudimg.com/static/img/3e79cdb1989efa6d68c86b0151cda0c5/image.png)


## CIFS/SMB 网关使用常见问题

### CIFS/SMB 文件系统挂载时目录被锁

若从多台机器使用相同用户名/密码访问同一文件系统，系统会视这一类操作行为为非法，因而会拒绝访问。若有需要，请分别使用不同的用户名及密码登录不同主机来访问同一个文件系统。

