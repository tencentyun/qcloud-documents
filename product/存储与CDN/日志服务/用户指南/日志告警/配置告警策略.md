## 操作场景

基于日志的监控告警场景，可以通过配置告警策略来完成。本文主要介绍如何在日志服务控制台上配置告警策略。


## 前提条件

- 日志已上传到某个日志主题。
- 日志主题已 [配置索引](https://cloud.tencent.com/document/product/614/50922)。

## 操作步骤

### 步骤1：创建告警策略

1. 登录 [日志服务控制台](https://console.cloud.tencent.com/cls/monitor)。
2. 在左侧导航栏中，单击【监控告警】>【告警策略】，进入告警策略管理页面。
3. 单击【新建】，创建告警策略。

### 步骤2：配置监控对象和监控任务

 - 监控对象
选择需要监控的日志主题，并配置相应的分析语句及查询时间范围，详细参考以下：
 <table>
	<tr><th>名称</th><th>描述</th><th>示例</th></tr>
	<tr>
		<td>日志主题</td>
		<td>需要配置监控告警的目标日志主题</td>
		<td>例如，nginx 日志主题</td>
	</tr>
	<tr>
		<td>分析语句</td>
		<td>作用于日志主题的分析语句，分析语法参考</td>
		<td>例1，统计出现 error 状态的日志条数<br>status:error ｜ select count(*) as ErrCount<br>例2，统计域名（url:aaa.com）的平均请求延时情况<br>url:"aaa.com" | select avg(request_time) as Latency</td>
	</tr>
	<tr>
		<td>查询时间范围</td>
		<td>每次运行分析语句的数据时间范围</td>
		<td>例1，统计近5分钟出现 error 状态的日志条数<br>例2，统计近1分钟请求的平均延时</td>
	</tr>
	</table>
 - 监控周期
表示监控任务的执行频率，日志服务提供如下两种周期配置方式：
 <table>
		<tr>
		<th>周期配置方式</th>
		<th>说明</th>
		<th>示例</th>
	</tr>
	<tr>
		<td>固定频率</td>
		<td>按固定的时间间隔执行一次监控任务<br>时间间隔：1～1440 分钟，粒度：分钟级</td>
		<td>每隔5分钟执行一次监控</td>
	</tr>
	<tr>
		<td>固定时间</td>
		<td>按固定的时间点执行一次监控任务<br>时间点范围：00:00～23:59，粒度：分钟级</td>
		<td>每天02:00点执行一次监控</td>
	</tr>
 </table>
 
###  步骤3：配置告警策略
 
 - 触发条件：判断是否满足触发告警的条件表达式，当满足条件时进行告警。
 日志服务提供 `$N.keyname `的方式引用分析结果，其中`$N` 表示当前告警策略中的第`N`个监控对象（详情参考 [如何查看编号](#number)），`keyname` 表示对应的字段名称，例如`$1.status>500` 表示编号为1的查询的 `status `字段大于500时触发告警，更多表达式语法参考 [触发条件表达式语法](https://cloud.tencent.com/document/product/614/51756)。
 - 告警频率：当持续满足触发条件达到一定次数（默认为1，有效值范围：1 - 10）以后，日志服务根据告警频率进行通知触达；通过配置持续周期的阈值可以避免一些不重要的偶发情况。例如，配置持续5个周期满足触发条件，表示累计触发次数达到5次以后，再进行通知触达。当修改了触发条件表达式，或计算过程中不满足表达式条件，累计次数会清零。
 - 通知收敛：通过设置两次通知的时间间隔，避免频繁发送告警通知。当某次监控执行的结果满足触发条件，所持续累积的触发周期满足阈值，且离上次发送的通知时间满足通知间隔，则发送通知。例如，每15分钟告警一次，表示15分钟内只会收到一次告警通知。

### 步骤4：测试监控任务

配置告警策略完成后，单击【测试监控任务】，验证分析语句和触发条件语法是否正确。
![](https://main.qcloudimg.com/raw/4cbab0e7fd609cfb5f8fd5630ec23829.png)

返回类似如下结果，即表示语法正确：
![](https://main.qcloudimg.com/raw/d0b6cd92a0af197ab4ef0b46875a361e.png)


### 步骤5：告警通知

- 通知渠道组
通过关联通知渠道组，设置发送通知的方式及对象，支持短信、邮件、电话、微信、企业微信、自定义回调接口（webhook） 等通知方式。详情参考 [管理通知渠道组](https://cloud.tencent.com/document/product/614/59661)。
- 通知内容
用户可以通过在通知内容加入预设的变量，第一时间了解告警的具体内容。具体变量列表和说明请参考 [通知内容变量](https://cloud.tencent.com/document/product/614/59436)。
![](https://main.qcloudimg.com/raw/4134a020c1fafb8b5e0017c805d06359.png)
- 自定义接口回调配置
如果用户选中的通知渠道组里包含自定义回调接口，则会出现自定义回调接口配置的输入框。具体变量列表和说明请参考 [自定义接口回调变量](https://cloud.tencent.com/document/product/614/60332)。这里的变量与上面的 【通知内容变量】有重复的部分，但不完全相同，使用时以文档中列出的变量清单为准。
![](https://main.qcloudimg.com/raw/b1333de5e34689beb7aded682f3d2a3c.png)
- 多维分析
用户点击【添加多维分析】可以在告警通知中增加`字段TOP5及占比统计`或`自定义检索分析语句`的多维分析内容。目前每条告警只支持配置最多3个多维分析。
![](https://main.qcloudimg.com/raw/8b1178464f42e88f3d66b4a52340077c.png)
多维分析的作用范围是告警【执行语句】规定的【查询时间范围】内的日志。如果某告警策略有多条【执行语句】，以其中最大的【查询时间范围】为准。例如，如果下图的告警策略被触发，则多维分析的作用范围是第二条【执行语句】的【近15分钟】。
![](https://main.qcloudimg.com/raw/d2a5d1dc940e2cd91e97a308df562f31.png)
选中`字段TOP5及占比统计`后，用户要选择需要分析的`字段`（此处只能选择当前日志主题下开启了索引的字段）。
![](https://main.qcloudimg.com/raw/02325bdbcda422677335e91b8bdfb7e6.png)
多维分析会展示在查询范围内的所有日志中，目标字段下出现最多的5个内容。
<img src="https://main.qcloudimg.com/raw/7973c1892575e165a3f0f9eb11118086.png" style="width: 40%" /></br>
如果用户需要更灵活的内容配置，可以选择`自定义检索分析语句`，格式和告警的分析语句一致。
![](https://main.qcloudimg.com/raw/6a9e6774bd652db2831f0c10273f650a.png)
最终网页通知的展示效果如图所示：
<img src="https://main.qcloudimg.com/raw/4b19b4b9cc1e795a45bffd313ff65e03.png" style="width: 40%" /></br>
完成配置后，单击【预览效果】预览各渠道的展示效果。
  

## 常见问题

<span id="number"></span>
#### 如何查看编号？

在监控对象左侧显示当前查询的编号。第1个监控对象的查询编号为1，第2个监控对象的查询编号为2，以此类推。
![](https://main.qcloudimg.com/raw/c8356f8246fb821bd57e619c9827b17c.png)
