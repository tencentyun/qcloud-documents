## 操作场景

单行-完全正则模式适用于日志文本中每行内容为一条原始日志，且每条日志可按正则表达式提取为多个 key-value 键值的日志解析模式。若不需要提取 key-value，请参阅 [单行全文格式](https://cloud.tencent.com/document/product/614/17421) 进行配置。
配置单行-完全正则模式时，您需要先输入日志样例，再自定义正则表达式。配置完成后，系统将根据正则表达式中的捕获组提取对应的 key-value。
如下内容将为您详细介绍如何采集单行-完全正则模式日志。

## 前提条件

假设您的一条日志原始数据为：
```
10.135.46.111 - - [22/Jan/2019:19:19:30 +0800] "GET /my/course/1 HTTP/1.1" 127.0.0.1 200 782 9703 "http://127.0.0.1/course/explore?filter%5Btype%5D=all&filter%5Bprice%5D=all&filter%5BcurrentLevelId%5D=all&orderBy=studentNum" "Mozilla/5.0 (Windows NT 10.0; WOW64; rv:64.0) Gecko/20100101 Firefox/64.0"  0.354 0.354
```

配置的自定义正则表达式为：
```
(\S+)[^\[]+(\[[^:]+:\d+:\d+:\d+\s\S+)\s"(\w+)\s(\S+)\s([^"]+)"\s(\S+)\s(\d+)\s(\d+)\s(\d+)\s"([^"]+)"\s"([^"]+)"\s+(\S+)\s(\S+).*
```

系统根据`()`捕获组提取对应的 key-value 后，您可以自定义每组的 key 名称如下所示：
```
body_bytes_sent: 9703
http_host: 127.0.0.1
http_protocol: HTTP/1.1
http_referer: http://127.0.0.1/course/explore?filter%5Btype%5D=all&filter%5Bprice%5D=all&filter%5BcurrentLevelId%5D=all&orderBy=studentNum
http_user_agent: Mozilla/5.0 (Windows NT 10.0; WOW64; rv:64.0) Gecko/20100101 Firefox/64.0
remote_addr: 10.135.46.111
request_length: 782
request_method: GET
request_time: 0.354
request_url: /my/course/1
status: 200
time_local: [22/Jan/2019:19:19:30 +0800]
upstream_response_time: 0.354
```

## 操作步骤

### 登录控制台

1. 登录 [日志服务控制台](https://console.cloud.tencent.com/cls)。
2. 在左侧导航栏中，单击【日志主题】，进入日志主题管理页面。

### 新增日志主题

1. 单击【创建日志主题】。
2. 在弹出的对话框中，将“日志主题名称”填写为“test-whole”，单击【确定】，即可新增日志主题。如下图所示：
<img src="https://main.qcloudimg.com/raw/4d05c31c3dd86f7f3c2cd94f5afb6f99.png" style="width: 60%"/>


### 机器组管理

1. 日志主题创建成功后，进入该日志主题管理页面。
2. 选择【采集配置】页签，单击您需要采集的日志数据源格式。如下图所示：
<img src="https://main.qcloudimg.com/raw/2087ed61862dda08451f8a374acd77f4.png"/>
3. 在“机器组管理”页面，勾选需要与当前日志主题进行绑定的机器组，单击【下一步】。
即可进入采集配置阶段，更多详情请参阅 [管理机器组](https://cloud.tencent.com/document/product/614/17412)。
<img src="https://main.qcloudimg.com/raw/23da84d071d4cc21deeac91629998a5a.png"/>

### 采集配置

#### 配置日志文件采集路径

在“采集配置”页面，根据日志采集路径格式，填写“采集路径”。如下图所示：
**日志采集路径格式**：`[目录前缀表达式]/**/[文件名表达式] `。
<img src="https://main.qcloudimg.com/raw/d18fdc6631d5c76fa86593b2c3d673f9.png" alt="屏幕快照 2021-01-21 下午12.45.01" style="zoom:50%;" />
填写日志采集路径后，LogListener 会按照**[目录前缀表达式]**匹配所有符合规则的公共前缀路径，并监听这些目录（包含子层目录）下所有符合**[文件名表达式]**规则的日志文件。其参数详细说明如下：

| 字段     | 说明                                                         |
| -------- | ------------------------------------------------------------ |
| 目录前缀 | 日志文件前缀目录结构，仅支持通配符 \* 和 ? <ul style="margin: 0;"><li>\* 表示匹配多个任意字符</li><li>? 表示匹配单个任意字符</li></ul> |
| /\*\*/     | 表示当前目录以及所有子目录                                   |
| 文件名   | 日志文件名，仅支持通配符 \* 和 ? ，<ul style="margin: 0;"><li>\* 表示匹配多个任意字符</li><li>? 表示匹配单个任意字符</li></ul> |

常用的配置模式如下：
- [公共目录前缀]/\*\*/[公共文件名前缀]\*
- [公共目录前缀]/\**/*[公共文件名后缀]
- [公共目录前缀]/\*\*/[公共文件名前缀]\*[公共文件名后缀]
- [公共目录前缀]/\*\*/\*[公共字符串]\*

填写示例如下：

| 序号 | 目录前缀表达式 | 文件名表达式 | 说明                                                         |
| ---- | -------------- | ------------ | ------------------------------------------------------------ |
| 1.   | /var/log/nginx | access.log   | 此例中，日志路径配置为`/var/log/nginx/**/access.log`，LogListener 将会监听`/var/log/nginx`前缀路径下所有子目录中以`access.log`命名的日志文件 |
| 2.   | /var/log/nginx | *.log        | 此例中，日志路径配置为 `/var/log/nginx/**/*.log`，LogListener 将会监听`/var/log/nginx`前缀路径下所有子目录中以 `.log` 结尾的日志文件 |
| 3.   | /var/log/nginx | error*       | 此例中，日志路径配置为`/var/log/nginx/**/error*`，LogListener 将会监听`/var/log/nginx`前缀路径下所有子目录中以`error`开头命名的日志文件 |

> !
> - Loglistener 2.3.9及以上版本才可以添加多个采集路径。
> - 暂不支持上传的日志内容中含有多种文本格式，可能会导致写入失败，例如 key:"{"substream":XXX}"。
> - 建议配置采集路径为 `log/*.log`，rename日志轮转后的老文件命名为 `log/*.log.xxxx`。
> - 默认情况下，一个日志文件只能被一个日志主题采集。如果一个文件需要对应多个采集配置，请给源文件添加一个软链接，并将其加到另一组采集配置中。

#### 配置单行-完全正则模式

1. 在“采集配置”页面，将“提取模式”设置为【单行-完全正则】，并在“日志样例”文本框中，输入日志样例。如下图所示：
![](https://main.qcloudimg.com/raw/50b124254762fb1781a7df9f1e511f25.png)
2. 根据如下规则，定义正则表达式。
系统有**手动模式**和**自动模式**两种方式定义正则表达式。您可手动输入表达式提取 key-value 进行验证，也可单击【正则表达式自动生成】切换为自动模式。系统会根据您选择的模式以及定义好的正则表达式，提取 key-value 进行正则表达式的验证。
 - **手动模式**：
 ![](https://main.qcloudimg.com/raw/b2658f49a92516005b5ee3e67763fa5b.png)
    1. 在“正则表达式”的文本框中，输入正则表达式。
    2. 单击【验证】，系统将判断日志样例与正则表达式是否匹配。
 - **自动模式** （单击【正则表达式自动生成】进行切换）：
    1. <span id="stap_a"></span>在弹出的“正则表达式自动生成”模态视图中，根据实际的检索分析需求，选中需要提取 key-value 的日志内容，并在弹出的文本框中，输入键(key)名，单击【确认提取】。如下图所示：
	![](https://main.qcloudimg.com/raw/601f34827a4ebd93da594295befd5203.png)
   系统将自动对该部分内容提取一个正则表达式，【自动提取结果】会出现在 key-value 表格中。如下图所示：
  ![](https://main.qcloudimg.com/raw/14847d959b7b34387be8b8e6dec70e47.png)
    2. 重复 [步骤 a](#stap_a)，直到提取完所有的 key-value 对。 如下图所示：
	 ![](https://main.qcloudimg.com/raw/dd1518136681e1f8753de4cca2bc4ecc.png")
    3. 单击【确定】，系统将根据提取好的 key-value 对自动生成完整的正则表达式。

>? 无论选择自动模式还是手动模式，正则提取模式均在完成定义并验证通过后，将提取结果展示在“抽取结果”中。您只需定义每一组 key-value 对的 key 名称，即可将该名称用于日志检索分析。 
>

#### 手动验证

1. 当您的日志数据复杂时，可以将“手动验证”设置为 <img src="https://main.qcloudimg.com/raw/d7ba8412e263386b627369741b457f2e.png" />，即可开启手动验证。
2. 输入多个日志样例，单击【验证】。系统将验证样例正则表达式的通过率。
<img src="https://main.qcloudimg.com/raw/3d6315e4afa3f99b3b7c5fdd9b2f440f.png" alt="屏幕快照 2021-01-21 下午4.04.34" style="zoom:50%;" />

#### 配置采集时间

- 日志时间单位为：毫秒。
- 日志的时间属性有如下方式：
 - 采集时间：默认作为日志的时间属性。
 ![](https://main.qcloudimg.com/raw/ad5c7be2ea33f1273cee3f42b1c22974.png)
 - 原始时间戳：将“使用采集时间”设置为 <img src="https://main.qcloudimg.com/raw/b4558d9e42043de2669e1b071103836b.png" />，并填写原始时间戳的时间键以及对应的时间解析格式。
 时间解析格式请参见 [配置时间格式](https://cloud.tencent.com/document/product/614/38614)。
 ![](https://main.qcloudimg.com/raw/bccc00097bcdb00f3d951ade9c121e13.png)
- 采集时间：日志的时间属性由日志服务 CLS 采集该条日志的时间决定。
- 原始时间戳：日志的时间属性由原始日志中时间戳决定。

时间格式解析规则填写的示例如下：
- 示例1：
日志样例原始时间戳：`10/Dec/2017:08:00:00.000`，解析格式为：`%d/%b/%Y:%H:%M:%S.%f`。
- 示例2：
日志样例原始时间戳：`2017-12-10 08:00:00.000`，解析格式为：`%Y-%m-%d %H:%M:%S.%f` 。
- 示例3：
日志样例原始时间戳：`12/10/2017, 08:00:00.000`，解析格式为：`%m/%d/%Y, %H:%M:%S.%f`。

>! 日志时间支持以毫秒为单位，若时间格式填写错误日志时间将以采集时间为准。
>

  
#### 配置采集策略

- 全量采集：Loglistener 采集文件时，从文件的开头开始读。
- 增量采集：Loglistener 采集文件时，从距离文件末尾1M处开始读取（若文件小于1M，等价全量采集）。



#### 配置过滤器条件

过滤器旨在您根据业务需要添加日志采集过滤规则，帮助您筛选出有价值的日志数据。过滤规则为 Perl 正则表达式，所创建的过滤规则为命中规则，即匹配上正则表达式的日志才会被采集上报。

完全正则采集时，需要根据所自定义的键值对来配置过滤规则。例如，样例日志使用完全正则模式解析后，您希望 status 字段为400或500的所有日志数据被采集，那么 key 处配置 status，过滤规则处配置 400|500。

>! 多条过滤规则之间关系是"与"逻辑，若同一 key 名配置多条过滤规则，规则会被覆盖。
>

### 索引配置

1. 单击【下一步】，进入“索引配置”页面。
2. 在“索引配置”页面，设置如下信息。
 - 索引状态：确认是否开启。
 - 全文索引：确认是否需要设置大小写敏感。
 - 全文分词符：默认为“@&()='",;:<>[]{}/ \n\t\r”，确认是否需要修改。
 - 键值索引：默认开启，您可根据 key 名按需进行字段类型、分词符以及是否开启统计分析的配置。若您不需要开启键值索引，可将 <img src="https://main.qcloudimg.com/raw/d7ba8412e263386b627369741b457f2e.png" /> 设置为 <img src="https://main.qcloudimg.com/raw/bd22396a4acfbf6d96def87060207a46.png" />。
5. 单击【提交】，完成采集配置。如下图所示：
![屏幕快照 2021-01-21 下午4.27.24](https://main.qcloudimg.com/raw/73b15c4ef3fbd49ff7c015e72c3cb541.png)

## 相关操作

### 检索日志

1. 登录 [日志服务控制台](https://console.cloud.tencent.com/cls)。
2. 在左侧导航栏中，单击【检索分析】，进入检索分析页面。
3. 根据实际需求，选择地域、日志集与日志主题，单击【检索分析】，即可开始按照设定的查询条件检索日志。
>! 检索必须开启索引配置，否则无法检索。
>
![屏幕快照 2021-01-21 下午5.40.59](https://main.qcloudimg.com/raw/aa7ca102db15eeafe757295a3ca02190.png)


