## 简介
日志服务提供将日志投递至对象存储 COS 的功能，帮助用户持久化存储日志数据。用户只要在控制台完成相关配置即可实现日志按照一定的时间间隔、文件大小，投递路径，过滤规则投递至对象存储。 

## 使用流程
### 前提条件

1. 开通日志服务，创建日志集与日志主题，并成功采集到日志数据。
2. 开通腾讯云对象存储服务（COS），并且在待投递的日志集的地域已创建存储桶。
3. 确保当前操作账号拥有配置投递的权限，子账号/协作者投递权限问题请参考 [子账号配置投递](https://cloud.tencent.com/document/product/614/33098)。

### 设置步骤
1. 登录 [日志服务控制台](https://console.cloud.tencent.com/cls)。
2. 在左侧导航栏中，单击【日志集管理】。
3. 单击需要设置投递任务的日志集 ID/名称，进入日志集详情页。
![](https://main.qcloudimg.com/raw/b4560b57c179e20441fa56bd65803971.png)
4. 找到需要投递的日志主题，单击【管理配置】>【投递对象存储配置】，进入投递配置页面。
![](https://main.qcloudimg.com/raw/df645d270b696a380253435e079a8949.png)
5. 单击【添加投递配置】，进入**投递至 COS** 配置页面，依次填写配置信息并单击【下一步】。配置项详细说明参见 [配置项说明](#config)。
![](https://main.qcloudimg.com/raw/c588bcb6e91bb9849003532968edac44.png)
6. 进入高级配置，选择投递格式、是否压缩投递、压缩格式和投递过滤。
如选择 json 投递格式，将配置如下图中的信息：
![](https://main.qcloudimg.com/raw/3711401cfd70d3f583bb82dae1970331.png)
如选择 csv 投递格式，需指定 key 内容，分隔符、转义符、无效字段内容、是否首行写入等。
![](https://main.qcloudimg.com/raw/a83f64cd3434e7fd894249e4dea0eb10.png)
 - key：写入 csv 文件的 key 字段。
 - 分隔符：csv 文件中各字段间的分隔符。
 - 转义符：若正常字段内出现了分隔符的字符，需用转义符包裹该字段。
 - 无效字段内容：若配置的 csv 键值字段为无效 key，则会用无效字段进行填充。
 - 首行 Key 写入：将键值名称（key）首行写入 csv 文件，默认不写入。
7. 最后，检查投递状态是否开启。
![](https://main.qcloudimg.com/raw/14e70eec382e5dab3803a71752ffd62c.png)

<a id="config"></a>
### 配置项说明
#### 目录前缀（可选）
日志服务支持自定义目录前缀，日志文件会投递至对象存储 Bucket 的该目录下。目前默认是直接放在存储桶下，文件路径为 `{COS 存储桶}{目录前缀}{分区格式}_{random}_{index}.{type}` ,其中`{random}_{index}`是一个随机数。

#### 分区格式（必填）
将投递任务创建时间按照 strftime 的语法自动生成目录 ，其中斜线`/`表示一级 COS 目录 。以投递至 bucket_test 存储桶，目录前缀为`logset/`，投递时间 2018/7/31 17:14 为例。

| 存储桶名称  | 目录前缀 | 分区格式    | cos 文件路径                                       |
| ----------- | -------- | ----------- | ------------------------------------------------- |
| bucket_test | logset/ | %Y/%m/%d    | bucket\_test:logset/2018/7/31\_{random}\_{index}    |
| bucket_test | logset/ | %Y%m%d/%H  | bucket\_test:logset/20180731/14\_{random}\_{index} |
| bucket_test | logset/ | %Y%m%d/log | bucket\_test:logset/20180731/log\_{random}\_{index} |

#### 压缩投递（可选）
用户可以选择是否对日志文件进行压缩后投递，在投递时的未压缩文件大小上限为10GB 。目前支持的压缩方式有 gzip 和 lzop。

#### 投递文件大小（必填）
指定在该投递时间间隔中**未压缩的投递文件**上限，意味着在该时间间隔中，日志文件最大将为您设置的值，超过该上限，将被分成多个日志文件，上限支持**100MB到10GB**。 

#### 投递间隔时间（必填）
指定投递的时间间隔，**支持1分钟至1小时**。假设您设置投递时间间隔为5分钟，那么意味着您的日志数据将每5分钟产生一个日志文件，每隔一段时间（半小时内），多个日志文件会一起投递至您的存储桶。 


#### 高级选项（可选）
日志投递还支持您根据日志内容进行过滤投递，您可以打开高级选项进行配置。您可以指定一个 key，对该键值所对应的值进行正则提取，并设定提取出的部分需要匹配的值。只有当日志数据匹配您的配置后，该日志可以投递。没有匹配的日志不进行投递。如下图所示，指定 action 字段，该字段为 write 时，日志进行投递。投递过滤规则最多支持5条。 
![](https://main.qcloudimg.com/raw/fa774d5a865c2129f707465c55e416c7.png)

>!对于单行全文和多行全文的检索，默认的 key 值为 **\_CONTENT_** 。
