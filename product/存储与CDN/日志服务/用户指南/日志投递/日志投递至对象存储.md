## 简介
日志服务提供将日志投递至对象存储（COS）的功能，帮助用户持久化存储日志数据。用户只要在控制台完成相关配置即可实现日志按照一定的时间间隔、文件大小，投递路径，过滤规则投递至对象存储。 

## 使用流程
### 前提条件

1. 开通日志服务，创建日志集与日志主题，并成功采集到日志数据。
2. 开通腾讯云对象存储服务（COS），并且在待投递的日志集的地域已创建存储桶。
3. 确保当前操作账号拥有对您指定的存储桶有 **写操作权限** 。若您以协作者身份配置日志投递，请先确认您的主账号下的该存储桶已经授权日志服务有 **写操作权限**，否则将投递失败。 

### 设置步骤
1. 登录 [日志服务控制台](https://console.cloud.tencent.com/cls)，进入左侧菜单栏【日志集管理】，选择需要设置投递任务的日志集，单击日志集ID/名称 进入日志集详情页。
![](https://main.qcloudimg.com/raw/b4560b57c179e20441fa56bd65803971.png)
2. 找到需要投递的日志主题，单击【管理配置】>【投递对象存储配置】进入投递配置页面。
![](https://main.qcloudimg.com/raw/df645d270b696a380253435e079a8949.png)
3. 单击【添加投递配置】，进入 **投递至 COS** 信息填写页面，依次填写配置信息并单击【确定】。配置项详细说明参见 [配置项说明](#config)。
![](https://main.qcloudimg.com/raw/b6a605b37631fbde4953c142c4f4c306.png)
4. 最后，检查投递状态是否开启。
![](https://main.qcloudimg.com/raw/bf469f1b5cafb4c2445ff00a9b2da2ed.png)

<a id="config"></a>
### 配置项说明
#### 目录前缀（可选）
日志服务支持自定义目录前缀，日志文件会投递至对象存储 Bucket 的该目录下。目前默认是直接放在存储桶下，文件路径为 `{COS 存储桶}{目录前缀}{分区格式}_{random}_{index}.{type}` ,其中`{random}_{index}`是一个随机数。

#### 分区格式（必填）
将投递任务创建时间按照 strftime 的语法自动生成目录 ，其中斜线 / 表示一级 COS 目录 。以目录前缀为 `bucket_test/` ,投递时间 2018/7/31 17:14 为例。

| 存储桶名称  | 目录前缀 | 分区格式    | cos 文件路径                                       |
| ----------- | -------- | ----------- | ------------------------------------------------- |
| bucket_test | logset/ | %Y/%m/%d    | bucket\_test:logset/2018/7/31\_{random}\_{index}    |
| bucket_test | logset/ | %Y%m%d/%H  | bucket\_test:logset/20180731/14\_{random}\_{index} |
| bucket_test | logset/ | %Y%m%d/log | bucket\_test:logset/20180731/log\_{random}\_{index} |

#### 压缩投递（可选）
用户可以选择是否对日志文件进行压缩后投递，在投递时的未压缩文件大小上限为 10GB 。目前支持的压缩方式有 gzip 和 lzop。

#### 投递文件大小（必填）
指定在该投递时间间隔中 **未压缩的投递文件**上限，意味着在该时间间隔中，日志文件最大将为您设置的值，超过该上限，将被分成多个日志文件，上限支持 **100MB 到 10GB**。 

#### 投递间隔时间（必填）
指定投递的时间间隔，**支持 1 分钟至 1 小时**。假设您设置投递时间间隔为 5 分钟，那么意味着您的日志数据将每五分钟产生一个日志文件，每隔一段时间（半小时内），多个日志文件会一起投递至您的存储桶。 


#### 高级选项（可选）
日志投递还支持您根据日志内容进行过滤投递，您可以打开高级选项进行配置。您可以指定一个 key，对该键值所对应的值进行正则提取，并设定提取出的部分需要匹配的值。只有当日志数据匹配您的配置后，该日志可以投递。没有匹配的日志不进行投递。如下图所示，指定 action 字段，该字段为 write 时，日志进行投递。投递过滤规则最多支持 5 条。 
![](https://main.qcloudimg.com/raw/fa774d5a865c2129f707465c55e416c7.png)

> **注意：**
对于单行全文和多行全文的检索，默认的 key 值为 **\_CONTENT_**。
