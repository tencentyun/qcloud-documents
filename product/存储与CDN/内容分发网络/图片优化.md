
## 配置场景
在使用腾讯云 CDN 进行海量图片分发时，可通过开启图片优化，对符合要求的图片请求，自动进行 webp、guetzli、tpg 格式图片压缩，可有效降低因图片产生的下行流量，降低成本。 

## 配置指南
登录 [CDN 控制台](https://console.cloud.tencent.com/cdn)，在菜单栏里选择**域名管理**，单击域名右侧**管理**，即可进入域名配置页面，源站为 COS 对象存储时，可看到**图片优化**菜单栏：
- 源站为 COS 对象存储且版本为 COS V5 时，才可进行相关配置。
- 若您尚未开通数据万象服务，可在此页面一键开通数据万象服务，而后进行图片处理的相关配置。
- 若您已开通数据万象服务，可直接进行配置开启。

>?[数据万象](https://cloud.tencent.com/product/ci) 是腾讯云提供的安全、稳定、高效的云端数据处理服务，Webp、Guetzli、TPG 等图像处理会产生一定的数据万象费用，单击 [查看计费说明](https://cloud.tencent.com/product/ci/pricing)。

### Webp 自适应
开启了 Webp 自适应图片压缩功能后，满足以下条件的请求，将直接返回 Webp 处理后的图片，若不满足下述条件，仍返回原图：
- HTTP 请求头中 accept 头部包含 image/webp。 
- 图片后缀为 jpg、jpeg、bmp、gif、png。

>! 
>- Webp 图片压缩产生的费用归属于数据万象-基础图片处理费用。
>- 处理图片的原图大小不能超过20MB、宽高不超过30000像素且总像素不超过1亿像素，处理结果图宽高设置不超过9999像素。
>- 针对动图，原图宽 * 高 * 帧数不超过1亿像素，GIF 帧数限300帧。

### Guetzli 自适应
Guetzli 图片压缩是数据万象推出的视觉无损压缩服务，能够对 JPG 图像进行高比例压缩，为使用者节省下载流量，并加快用户下载速度，提升体验。它利用人眼对于部分色域及图片细节的不敏感性，在不影响视觉效果的前提下有选择地丢弃细节信息，使得在相同视觉效果下比原图节省约35% - 50%的图片流量。

开启了 Guetzli 自适应图片压缩功能后，满足以下条件的请求，将直接返回 Guetzli 处理后的图片：
- HTTP 请求头中 accept 头部包含 image/guetzli。
- 图片后缀为 jpg、jpeg。

> !
> - Guetzli 图片压缩产生的费用归属于数据万象-Guetzli 压缩费用。
> - 开启 Guetzli 后，首次访问图片会返回普通 JPG 原图，同时启动异步 Guetzli 处理，处理完成后再次请求该图片会得到压缩后的结果图。
> - 当前 Guetzli 图片压缩服务仅对质量 q>70、像素小于400万像素的 JPG 图片做处理。

### TPG 自适应

TPG 压缩是腾讯云数据万象提供的高级图片压缩功能。通过该功能可将指定格式图片转码为 TPG 格式，大幅减小图片大小，从而显著降低图片流量，提升页面加载速度。

开启了 TPG 自适应图片压缩功能后，满足以下条件的请求，将直接返回 TPG 处理后的图片：
- HTTP 请求头中 accept 头部包含 image/tpg。
- 图片后缀为 jpg、jpeg、bmp、gif、png、webp。

> !TPG 图片压缩产生的费用归属于数据万象-高级图片压缩费用。

## 注意事项
开启自适应图片压缩功能后，访问 URL 的缓存键会发生变化，但**缓存配置 - 缓存键规则配置**处缓存键规则的优先级更高。
例如，若 jpg 类型文件开启了图片优化，则请求 URL `http://www.test.com/a.jpg?colour=red` 会变更为 `http://www.test.com/a.jpgxxxxxx?colour=red`，若**缓存配置 - 缓存键规则配置**处已配置：全部文件 - 忽略全部参数，优先级更高，则忽略全部参数会生效，请求 URL 最终变更为 `http://www.test.com/a.jpgxxxxxx`。




