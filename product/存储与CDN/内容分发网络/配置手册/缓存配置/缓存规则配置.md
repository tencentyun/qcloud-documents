
## 配置场景

腾讯云 CDN 缓存资源为触发式，当用户发起针对某资源的访问，若请求触达的 CDN 节点未缓存该资源，则回用户源站拉取资源，成功拉取到资源（2XX状态码）后，在节点进行缓存并返回给用户。

您无法直接对 CDN 节点上缓存的资源进行管理，若担心源站资源可能发生变化而 CDN 节点仍缓存旧资源返回给用户，可通过配置节点缓存规则来进行一定程度的控制。

>! 若您的加速域名服务区域为全球加速，【缓存规则配置】会全球生效，不支持境内、境外差异化配置。

## 配置指南

### 查看配置

登录 [CDN 控制台](https://console.cloud.tencent.com/cdn)，在左侧菜单栏选择【域名管理】，单击域名操作列的【管理】，进入域名配置页面，切换Tab至【缓存配置】，即可找到【缓存规则配置】。

接入加速域名时：

- 若选择静态加速业务类型，常规动态文件（如 php、jsp、asp、aspx）默认缓存时间为0秒（即不缓存），其他所有文件类型默认缓存时间为30天。
- 若选择下载加速、流媒体点播加速业务类型，默认所有文件缓存过期时间为30天。

![](https://main.qcloudimg.com/raw/2a1b53ba28e0de9b2262048751a6aa9a.png)

### 新增规则

您可按需添加缓存规则，分为基础模式和高级模式，默认为基础模式。

>!按高级模式配置提交后将全面升级，不可恢复至基础模式。

### 基础模式

每一个 CDN 节点上的缓存资源都有“过期时间”的概念，若请求到的缓存资源已到期，即便节点仍有缓存，也会判定为无效，进行再次回源拉取。基础模式支持指定某文件类型配置在节点的缓存时间。
<img src="https://main.qcloudimg.com/raw/5a3d0ab3635c241e3e800d80a338077e.png" height="299" width="439" />


#### 平台策略

当用户请求您某一业务资源时，源站对应的 HTTP Response Header 中存在 Cache-Control 字段，此时默认平台策略如下：

- Cache-Control 字段为 Max-Age，对该资源的缓存时间以配置的节点缓存过期时间为主，不继承 Max-Age 指定时间。
- Cache-Control 字段为 no-cache 、 no-store 或 private，此时 CDN 节点对此资源不做缓存。
- 无 Cache-Control 字段，当请求命中 CDN 缓存时，CDN 会默认添加：`Cache-Control:max-age = 600`头部。

#### 高级缓存过期配置

开启高级缓存过期配置，用户可通过调整源站 HTTP Response Header Cache-Control 中 Max-Age 值进行节点缓存时间的动态调整。

开启后 CDN 会对比已经配置好的节点缓存时间与 Max-Age 值，取较小的作为实际生效的节点缓存时间：

- 用户源站配置`/index.html`的 Max-Age 为200秒，CDN 对应配置的缓存时间为600秒，则文件在节点的实际过期时间为200秒。
- 用户源站配置`/index.html`的 Max-Age 为800秒，CDN 对应配置的缓存时间为600秒，则文件在节点的实际过期时间为600秒。

> !开启高级缓存过期配置，若源站没有返回 Last-Modified 字段，CDN 会默认添加 Last-Modified 字段，每10分钟变一次。

### 高级模式

高级模式支持指定某文件类型配置更多的节点缓存行为：

- 遵循源站：遵循源站的 Cache-Control 头部。
- 缓存：配置资源在节点的缓存时间。支持增加配置是否强制缓存，即是否忽略源站的 Cache-Control: no-store/no-cache/private。
- 不缓存：即回源获取资源。

<img src="https://main.qcloudimg.com/raw/d1513ea3dd6f515462d32fba82af9099.png" height="275" width="439" />


#### 配置约束

- 单个域名至多可添加20条缓存规则。
- 多条规则支持调整优先级：底部优先级大于顶部。
- 文件类型/文件夹/全路径文件至多可输入100组内容。
- 基础模式&高级模式：缓存时间不可超过365天。
- 高级模式：缓存行为选择为“缓存”时，若强制缓存选择“是”，则 CDN 根据配置的缓存规则进行缓存；若强制缓存选择“否”，则当源站为 Cache-Control: no-store/no-cache/private 时，CDN 不会缓存资源至节点，回源获取资源。

### 修改规则

对已添加的缓存规则，可进行修改。单击缓存键规则操作列的【修改】即可

### 删除规则

可删除已添加的缓存规则。单击缓存规则操作列的【删除】即可。





## 配置示例

若加速域名`www.test.com`的【缓存规则配置】如下：

![](https://main.qcloudimg.com/raw/d20eef1466f92b72b8d63a4d58cd4c17.png)

则实际缓存情况如下：

- `www.test.com/abc.jpg`资源节点缓存时间为10天。
- `www.test.com/def.php`资源不会缓存至节点。



