
如果您的文件以静态大文件为主，开启分片回源能够帮助提升回源文件响应速度，提升大文件的分发效率。

## 功能介绍
分片回源即 Range 请求回源，Range 是 HTTP 请求头部之一，用于获取指定范围内的文件，使用 Range 请求可以向服务器请求部分文件内容，例如：请求时携带 HTTP 头部：range：bytes=0-999，则返回文件的前1000个字节给用户。
在腾讯云 CDN 内，开启分片回源配置后，将默认携带 range 回源请求，假如用户请求的部分文件在节点上未缓存或缓存已过期，CDN 会根据用户请求进行分片回源，仅拉取用户需要的部分文件至节点缓存，同时返回给用户；如果关闭分片回源配置的情况下，如果用户请求中未携带 range 请求，则 CDN  在回源时仍会拉取整个文件。
针对较大的文件类型如 APK 安装包、音视频文件，通过 range 请求可以有效提高大文件分发效率，提升响应速度，降低源站压力。

## 注意事项
1. 开启分片回源配置时，需要确认源站已经支持 Range 请求(腾讯云 COS 默认支持)，否则可能会导致回源失败；
2. 开启分片回源配置后，资源在节点上分片缓存，但所有分片的缓存过期时间保持一致，按照用户指定的缓存过期规则。
3. 若您的资源都是静态小文件，或源站为 COS 源站且已使用数据处理类功能（例如：图片处理），不建议开启分片回源，开启后会影响回源。
4. 若您的资源都是静态大文件，且源站已支持 Range 请求，或源站为 COS 源站且未使用数据处理类功能（例如：图片处理），建议开启分片回源，提升分发效率和响应速度。

## 配置说明

### 域名管理内配置
1. 登录 [CDN 控制台](https://console.cloud.tencent.com/cdn)；
2. 单击左侧菜单内的**域名管理**，进入域名管理列表；
3. 选择需要配置的域名，单击**管理**进入域名配置页面；
4. 单击**回源配置**，切换至回源配置标签页，在标签页中，即可看到分片回源配置项；
![](https://qcloudimg.tencent-cloud.cn/raw/8f1bf154bceece9e5465f4a3ed3e1206.png)
5. 在分片回源配置中，默认为所有文件关闭分片回源，您可以根据需求自定义对文件新增多条规则，支持根据文件后缀、文件目录、全路径文件进行匹配分片回源规则。

|配置项|	说明|
|--|--|
|类型	|支持对全部文件、指定的文件后缀、文件目录、全路径文件进行配置：<br><br>全部文件：所有文件使用应用该分片回源规则，默认规则，不可删除。<br>文件后缀：按照文件的后缀应用分片回源规则。<br>文件目录：按照指定文件目录应用分片回源规则。<br>全路径文件：可指定某个路径文件应用分片回源规则。|
|内容|	根据选择不同的文件类型，内容输入约束如下：<br>类型为文件后缀时：支持输入文件后缀名匹配，多个以“;”为间隔；<br>类型为文件目录时：支持输入如 /test;/a/b/c 的文件目录，不能以“/”结尾，多个以“;”分隔<br>类型为全路径文件时：支持输入如 /index.html;/test/\*.jpg 的文件路径，文件路径支持\* 匹配，多个以“;”分隔|
|分片回源|	支持开启/关闭：<br>开启：当开启分片回源时，回源请求时将使用 range 回源请求。开启后，当用户请求未携带 range 请求时，如果请求文件大于4M，CDN 节点将按照1M的分片大小回源分片请求，如果文件小于4M，则CDN节点将回源拉取完整文件。当用户请求携带 range 请求时，将按照携带的 range 请求进行回源请求。<br>关闭：当关闭分片回源时，当用户请求携带 range 请求时，在 CDN 没有缓存的情况下，回源请求仍会使用 range 回源请求。|

### 推荐配置
当您的文件大小大于 4M 时，推荐针对该文件类型开启分片回源，若您的文件只有部分为大文件，推荐按照文件类型/文件目录/全路径文件来匹配部分大文件开启分片回源，其余文件配置不使用分片回源。

### 配置约束
分片回源配置最多支持配置20条规则，规则优先级为最下方的规则优先级最高，最上方的最低，用户请求文件时，将按照规则优先级进行依次匹配，匹配成功则优先按照优先级最高的规则执行。

## 配置示例

**示例一**
若全部文件都需要开启 range 回源，域名 `cloud.tencent.com` 的分片回源配置如下：
![](https://qcloudimg.tencent-cloud.cn/raw/f92b47292686b3de34eb5338bd9ac015.png)
用户 A 请求资源：`http://cloud.tencent.com/test.ap`k，节点收到请求后，发现缓存的 test.apk 文件已过期，此时发起回源请求，因为当前规则为全部文件开启分片回源，则节点回源使用 Range 请求，分片获取资源并缓存。若此时用户 B 向同一节点发起的同一文件请求，并且也是 Range 请求，当节点上存储的分片已满足 Range 中指定的字节段，则会直接返回给用户，无需等所有分片获取完毕。

**示例二**
若您当前只有部分文件需要使用分片回源，域名 `cloud.tencent.com` 的分片回源配置如下：
![](https://qcloudimg.tencent-cloud.cn/raw/83f6b1983afeefca6cc0d5ec8b352a88.png)
用户 A 请求资源：`http://cloud.tencent.com/test.apk`，由于下方的规则优先级高于上方的规则，所以该请求在节点资源未命中或缓存已过期的情况下，将使用分片回源。若用户B请求资源：`http://cloud.tencent.com/test.jpg`，该规则只匹配全部文件，则该请求出现回源的情况下，不使用分片回源请求。


