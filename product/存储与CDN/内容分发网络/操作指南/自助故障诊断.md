CDN 为您提供了自助故障诊断工具，当发现某 URL 出现访问异常时，本工具能够帮助您进行自助检测，自助检测过程包括了接入域名的 DNS 解析探测、链路质量探测、节点状态探测、源站探测、数据访问一致性等一系列诊断项，帮助您定位问题，并给您提供解决建议。

>! 诊断的资源 URL 需要是您的账号下接入的状态为**已启动**的域名。诊断中产生的带宽将计入计费带宽，我们建议您诊断的目标资源不超过200MBytes。



## 故障诊断
### 诊断流程

当发现某个资源  URL 出现访问异常时，您可以通过**故障诊断**发起检测。步骤如下：
1. 登录 [CDN 控制台](https://console.cloud.tencent.com/cdn)，在左侧菜单中，单击【诊断工具】>【自助故障诊断】。
2. 在“故障诊断”页面中，输入您需要诊断的异常 URL，URL 需输入 ```http://``` 或 `https://`前缀。
 ![](https://main.qcloudimg.com/raw/85de28335bf2fe801e42526eefca43c2/diagnose1.png)
3. 输入 URL 后，单击【生成诊断链接】，页面将出现诊断链接地址。
 ![](https://main.qcloudimg.com/raw/1069bfb78be59fe452e412206e91b39b/diagnose2.png)
4. 单击诊断链接后，将会新打开诊断页面，并开始收集诊断信息（请不要在诊断过程中关闭检测页面，诊断结束后可以手动关闭此页面）。
  ![](https://main.qcloudimg.com/raw/c18f789338712abb37dd63495993c7b8.png)
5. 您也可以将诊断链接发送给他人进行本地故障检测，检测完成后，需要手动关闭浏览器页面。

>!
- 每一条 URL 生成的诊断链接有效时间为24小时，最多可以单击10次故障诊断。
- 可以在"诊断报告"页面重新复制已经生成的可用诊断链接。

## 诊断报告
### 报告查看
1. 诊断完成后，单击【诊断报告】进入页面，可以看到已经产生的诊断报告按时间顺序展示在表格中，列表依次展示了：
 - 生成诊断链接的 URL。
 - URL 对应的诊断链接。
 - 诊断链接的生成时间。
 - 诊断链接的失效时间。
 - 诊断链接可用诊断次数。
![](https://main.qcloudimg.com/raw/3118676991d4e8a805985df957db5530/diagnose3.png)

2. 在操作栏单击【展开】，可以查看每一次诊断产生的报告及其结果。
![](https://main.qcloudimg.com/raw/b19edb9de8b792a3a3ba8b30ca50ef93/diagnose4.png)

3. 根据每一个步骤的检测，诊断报告会整体判定为：
 - 正常。
 - 异常。
 - 诊断页面异常关闭（大多为诊断未完成时关闭诊断页面导致）。
4. 单击右侧【查看报告】，可以看到更多诊断详情，以及异常情况的处理建议。

### 报告解读
1. 报告的第一部分，用于展示诊断信息，包含：
 - 诊断报告 ID。
 - 需要诊断的 URL。
 - 触发诊断的时间。
![](https://main.qcloudimg.com/raw/1e1117ffc01e57ac8f481ab5e2c4c626/diagnose5.png)

2. 报告的第二部分，针对诊断流程及每一个模块的结果进行了概览介绍，可以直观的发现异常模块，诊断模块包含：
 - 客户端信息检测结果。
 - DNS 检测结果。
 - CNAME 检测结果。
 - 网络链路检测结果。
 - 访问节点检测结果。
 - 回源节点检测结果。
 - 源站检测结果。
![](https://main.qcloudimg.com/raw/cbe32c5c202ce902316f32ffc9b16fdb/diagnose6.png)

3. 报告的第三部分针对诊断结果进行了详细说明：
 #### 第一项：客户端信息
获取的客户端 IP 信息、对应的省份/运营商，以及发起 Http/Https 请求的 User-Agent、Referer、Request Mode 等信息。若未成功获取客户端信息，则后续部分检测将无法进行。
![](https://main.qcloudimg.com/raw/ae317826bef6070dd6da62a7c0b0735d/diagnose7.png)

 #### 第二项：DNS 检测
获取客户端本地 DNS IP，通过客户端 IP 与 DNS IP 归属是否一致，可判定是否由于本地 DNS 配置异常，导致无法调度至最优加速节点。
![](https://main.qcloudimg.com/raw/ebfe238ab7cc50bcc04af9fb2c695f41/diagnose8.png)

 #### 第三项：CNAME 检测
获取检测域名 CNAME 配置，域名的 CNAME 解析需要配置为正确的 *.cdn.dnsv1.com（默认）后缀域名，否则请求将无法到达 CDN 节点。
![](https://main.qcloudimg.com/raw/7e2be6762595049b2073a042e3748672/fb71f6db1c7c48214b4275c55d81b539.png)
>!CNAME 配置未检查通过，请求不会到达节点，将不会进行后续检测。

 #### 第四项：网络链路检测
通过客户端本地探测多个互联网站点，获取客户端网络状态。若由于本地代理等配置导致站点无法访问，会导致网络链路检测失败，无法进行后续检测。
![](https://main.qcloudimg.com/raw/49e938c70f66e86ae692860f7f0619d7.png)

 #### 第五项：访问节点探测
客户端发起请求后，到达的 CDN 节点信息采集，包含节点 IP、节点省份/运营商、以及节点返回的状态码、命中状态及资源 MD5：
 - 若节点已缓存此资源，将直接命中，不会进行回源节点检测。
 - 若节点未命中，继续进行后续回源节点检测。
 - 若 URL 反馈的状态码为301、302、504 时，无法正常获取节点检测信息，无法进行后续检测。
 - 若域名配置访问控制策略，访问节点会直接返回403，命中情况为**已命中**。
![](https://main.qcloudimg.com/raw/a4296e85ad8d27350425352f34ea6c7e/diagnose9.png)

 #### 第六项：回源节点检测
 1. 当资源由 CDN 节点直接返回，此时访问节点与回源节点的命中状态均为**已命中**，CDN 会继续进行源站检测，方便校验源站返回状态码及内容是否与节点保持一致。
![](https://main.qcloudimg.com/raw/fed165f59474d52b25b6eedaef173406/diagnose10.png)
 2. 当资源不由 CDN 节点直接返回，此时访问节点与回源节点状态均为**未命中**，此时内容由源站返回：
![](https://main.qcloudimg.com/raw/bc140f9d8257208785910d0a5c452adc/diagnose11.png)
 3. 此时若产生异常状态码，您可以通过对比源站状态码、文件 MD5 与访问节点模块返回的状态码、文件 MD5，判断异常是由 CDN 节点产生还是由源站产生，进行修复。

>?若诊断报告无法解决您的问题，我们建议您 [提交工单](https://console.cloud.tencent.com/workorder/category)，或联系腾讯云技术人员排查问题。

