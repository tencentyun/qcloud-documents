## 背景

元数据加速器是由腾讯云对象存储（Cloud Object Storage，COS）服务提供的高性能文件系统功能。元数据加速器底层采用了云 HDFS 卓越的元数据管理功能，支持用户通过文件系统语义访问对象存储服务，系统设计指标可以达到2.4Gb/s带宽、10万级 QPS 以及 ms 级延迟。存储桶在开启元数据加速器后，可以广泛应用于大数据、高性能计算、机器学习、AI 等场景。有关元数据加速器的详细介绍，请参见 [元数据加速器](https://cloud.tencent.com/document/product/436/56971)。

腾讯云提供了多种方式让用户通过 HCFS（Hadoop Compatiable File System）语义访问对象存储服务。目前腾讯云提供了两种工具：
- 通过 Hadoop-COS 工具（COSN 工具）访问
- 通过 CHDFS 客户端访问

根据工具调用的访问协议和访问`Schema`的差异，共计提供了 4 种不同的访问方式。详细对比可参见如下 [不同客户端工具对比](#1)。

## 改造阶段

COS 由于低成本、海量弹性的优势，非常适合作为大规模数据集的存储底座。HDFS 文件系统作为当前大数据存储服务的主流服务，腾讯云 COS 一直致力于让用户可以平滑得将这部分业务数据迁移上云。在兼容 HDFS 的产品发展中，主要经历了如下阶段：
1. 客户端改造阶段：
这一阶段主要提供 Hadoop-COS 工具（COSN 工具）用于协议转换，在客户端侧将 HDFS 协议转换成 COS 协议。这种模式下，用户本质上还是通过 COS API 来访问 COS 服务，会受限于原生对象存储服务扁平式文件键值结构的性能限制。
2. 服务端改造阶段
 - **阶段一**：这一阶段基于云 HDFS 服务的元数据管理能力，在 COS 服务基础上提供了元数据加速能力，同时利用云 HDFS 客户端供用户以原生 HDFS 协议访问存储服务。这种模式下开启元数据加速能力后，服务端会自动映射出来一个云 HDFS 文件系统 ID，用户通过访问对应的文件系统 ID 可以在公有云上享受到和本地 HDFS 一致的体验。但该模式对业务侵入性较强，需要变更业务的访问 Schema。
 - **阶段二**：这一阶段在服务端改造阶段（1）进行了进一步改进，在客户端的访问协议层面进行了融合改造，用户在这一阶段无需理解文件系统 ID 这一个概念，使用习惯和原生 COS 的 Hadoop-COS 客户端基本一致。但这一阶段仍然需要变更业务的访问 Schema，存在一定改造量。
3. 客户端 + 服务端改造阶段
这一阶段在客户端和服务端均进行了优化，用户可以通过原生 COS 的 Hadoop-COS 客户端和访问 Schema 来访问 COS 服务，并且可以在客户端中自主决定使用 COS 协议或者 HDFS 协议。这一模式对业务无任何侵入性，在性能和体验层面均是长期演进方案。

<span id="1"></span>
## 不同客户端工具对比

上述不同产品发展阶段提供了不同的客户端工具，这些客户端工具的对比说明如下：

|对比项|COSN 工具</br>（< 8.1.4版本）| COSN 工具</br>（≥ 8.1.4版本）| CHDFS 客户端</br>（< 1.0.4版本）| CHDFS 客户端</br>（≥ 1.0.4 版本）|
| --- | --- | --- | --- | --- |
| 访问协议 | COS API | COS API/HDFS | HDFS |  HDFS |
| 访问 Schema | `cosn://<bucketname-appid>` |`cosn://<bucketname-appid>` |   `ofs://<filesytemid>` | `ofs://<bucketname-appid>` |
| 优势 | <ol  style="margin: 0;"><li>无需独立维护鉴权服务，复用公有云鉴权</li><li>使用体验和原生对象存储完全一致，深度集成 EMR 大数据平台</li></ol> |  <ol  style="margin: 0;"><li>支持两种不同协议访问，在配置中切换</li><li>无需独立维护鉴权服务，复用公有云鉴权</li></ol> | 支持全兼容 HDFS 协议访问 |  支持全兼容 HDFS 协议访问 |
| 劣势 | <ol  style="margin: 0;"><li>不支持原生 HDFS 语义接口，例如 List/Rename</li><li>文件请求性能较差</li></ol> |   暂未集成所有版本 EMR 计算平台 |<ol  style="margin: 0;"><li>需要独立维护 Ranger 鉴权服务</li><li>访问 schema 与原生 COS 不一致，对业务侵入性强</li></ol> |  <ol  style="margin: 0;"><li>需要独立维护 Ranger 鉴权服务</li><li>访问 schema 与原生 COS 不一致，对业务侵入性强</li></ol> |

从长期演进角度考虑，我们推荐使用 COSN 工具（≥ 8.1.4版本），这一客户端对业务基本上没有侵入性，兼具产品性能表现和使用体验。但在具体业务使用过程中，计算业务可能已经使用了历史版本的客户端，此时可能存在部分改造工作量。因此针对不同版本，我们的使用推荐如下：
1. 使用 COSN 工具（< 8.1.4版本）：如果您的计算业务性能要求不高，并且没有原子性的 list/rename 等文件操作需求，您可以选择维持现状。否则，推荐您在控制台新建存储桶并开启元数据加速能力，将业务数据搬迁到具备元数据加速能力的存储桶中。
2. 使用 CHDSF 客户端（< 1.0.4版本）：如果您已经基于该版本构建了计算业务，并且 HIVE 表等管理服务中已经填入了数据 schema 信息，同时不存在 COS 协议访问的需求，那么您可以维持现状。否则，推荐您升级到最新版本 COSN 客户端，同时更新 HIVE 表等关联的管理服务。
3. 使用 CHDSF 客户端（≥ 1.0.4 版本）：如果您已经基于该版本构建了计算业务，并且 HIVE 表等管理服务中已经填入了数据 schema 信息，同时不存在 COS 协议访问的需求，那么您可以维持现状。否则，推荐您升级到最新版本 COSN 客户端，同时更新 HIVE 表等关联的管理服务。
