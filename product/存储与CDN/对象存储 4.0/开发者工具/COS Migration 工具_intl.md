## Feature Description
COS Migration is an all-in-one tool integrating COS data migration features. You can migrate data from source address to COS after simple configurations. COS Migration has the following features:
- Various data sources
   - Local data: Supports migrating local data to COS.

   - Other cloud storage services: Supports migrating data from AWS S3, Alibaba Cloud OSS and Qiniu Cloud to COS. More cloud storage services will be supported in the future.

   - URL list: Supports downloading and migrating data from a given URL list to COS.
   
   - Bucket Replication: Supports replicating data from one bucket to another in COS as well as cross-region and cross-account data replication.

- Resuming upload from breakpoint

- Multipart upload 

- Parallel upload

- Migration Verification

## Operating Environment
### System Environment
Linux/Windows

### Software Dependencies
- JDK1.7 or later. For more information on the installation and configuration of JDK, please see [Install and Configure Java](https://cloud.tencent.com/document/product/436/10865).

## How to Use
### 1. Obtain Migration Tool
Download link: [COS Migration Tool](https://github.com/tencentyun/cos_migrate_tool_v5)

### 2. Decompress Toolkit
#### Windows
 Decompress and save it to a directory, such as
<pre>
C:\Users\Administrator\Downloads\cos_migrate
</pre>

#### Linux
Decompress and save it to a directory
<pre>
unzip cos_migrate_tool_v5-master.zip && cd cos_migrate_tool_v5-master
</pre>

#### Directory Structure of Migration Tool
After decompression, the directory structure of COS Migration tool is as follows:
<pre>
COS_Migrate_tool
|--conf  #Directory where the configuration file locates
|   |--config.ini  #Configuration file for migration
|--db    #Record of successful migration
|--dep   #Jar package compiled and generated by main program logic
|--log   #Logs generated when using the tool
|--opbin #Scripts used for compiling
|--src   #Source code of the tool
|--tmp   #Temporary file storage directory
|--pom.xml #Project configuration file
|--README  #Instruction documentation
|--start_migrate.sh  #Launch script for migration in Linux
|--start_migrate.bat #Launch script for migration in Windows
</pre>

>**Notes:**
 - db directory is used to record the identifiers of the files that have been migrated successfully. Whenever a file is to be migrated, check whether its identifier is recorded in db directory. If yes, skip the file. Otherwise, you can migrate the file.
 - log directory is used to record all logs generated during migration. If any error occurs in migration, check error.log in this directory.

### 3. Modify Configuration File config.ini
Before executing the launch script for migration, you need to modify config.ini (path: `./conf/config.ini`), including the followings:

#### 3.1 Configure Migration Type
type, indicating migration type, is filled in by users according to their needs. For example, to migrate local data to COS, users need to configure `type=migrateLocal` for `[migrateType]`.
<pre>[migrateType]
type=migrateLocal
</pre>

Supported migration types are as follows:

| migrateType | Description |
| ------| ------ |
| migrateLocal | Migrate local data to COS |
| migrateAws | Migrate data from AWS S3 to COS |
| migrateAli | Migrate data from Alibaba Cloud OSS to COS |
| migrateQiniu | Migrate data from Qiniu to COS |
| migrateUrl | Download and migrate data from URLs to COS |
| migrateBucketCopy | Copy data from source bucket to destination bucket |

#### 3.2 Configure Migration Task
Users can configure the migration according to their needs, including configuration of migration to destination COS and migration tasks.
<pre>
# Users can configure destination COS account in this common configuration section. 
[common]
secretId=AKIDXXXXXXXXXXXXXXXXX
secretKey=GYYYYYYYYYYYYYYYYYYYYYYYYYYYYY
bucketName=mybcket-1251668577
region=ap-guangzhou
storageClass=Standard
cosPath=/
https=off
tmpFolder=./tmp
smallFileThreshold=5242880
smallFileExecutorNum=64
bigFileExecutorNum=8
entireFileMd5Attached=on
daemonMode=off
daemonModeInterVal=60
executeTimeWindow=0,24
</pre>

| Name | Description | Default Value |
| ------| ------ |----- |
| secretId | SecretId for user key. For more information, please see [Cloud API Key Console](https://console.cloud.tencent.com/cam/capi). | - |
| secretKey | SecretKey for user key. For more information, please see [Cloud API Key Console](https://console.cloud.tencent.com/cam/capi). | - |
| bucketName | Destination bucket name. Bucket is named in a format of {name}-{appid}, which means a bucket name must contain APPID, such as movie-1251000000 | - |
| region | Region information of the destination bucket. For information on COS region abbreviations, please see [Available Regions](https://cloud.tencent.com/document/product/436/6224) | - |
| storageClass | Storage class: Standard - COS Standard, Standard_IA - COS Infrequent Access | Standard |
| cosPath | COS path to which files are migrated. **/**: Migrate to the root path of the bucket. **/aaa/bbb/**: Migrate to /aaa/bbb/ of the bucket. Path /aaa/bbb/ will be created automatically if it does not exist. | / |
| https | Whether to transfer via HTTPS. on :Yes, off: No. Transfer via HTTPS is rather slow and is suitable for scenarios that demand high security. | off |
| tmpFolder | The directory to store temporary files generated in the migration from other Cloud Storage to COS, which will be deleted after the migration. The directory should be in the format of an absolute path.<br>The separator used in Linux is a forward slash, such as /a/b/c.<br>Double backslashes are used in Windows, such as E:\\a\\b\\c.<br>Default is the tmp directory under tool path | ./tmp |
| smallFileThreshold | Byte threshold for small files. Default is 5 MB. Files greater than or equal to this threshold are uploaded via multipart upload. Otherwise, simple upload is used. | 5242880 |
| smallFileExecutorNum | Concurrency for uploading small files (smaller than smallFileThreshold) via simple upload. Decrease the concurrency if the files are uploaded to COS via public network with small bandwidth. | 64 |
| bigFileExecutorNum | Concurrency for uploading large files (greater than or equal to smallFileThreshold) via multipart upload. Decrease the concurrency if the files are uploaded to COS via public network with small bandwidth. | 8 |
| entireFileMd5Attached | MD5 for the entire file, which is calculated by the migration tool and stored in the custom header x-cos-meta-md5 for follow-up verification. Because the etag of the large file uploaded to COS via multipart upload is different from the MD5 for the entire file. | on |
| daemonMode | Whether to enable damon mode. on: Yes, off: No. Synchronization is executed repeatedly in damon mode. The interval between two synchronizations is set by damonModeInterVal parameter. | off |
| daemonModeInterVal | The interval between two synchronizations (in sec) | 60 |
| executeTimeWindow | Execution time window, which describes the time period when the migration tool is executed. The time granularity is hour. For example,<br>parameter 3,21 indicates that the migration is executed between 3:00 to 21:00. During other time, migration goes into sleep mode, and it is suspended with migration progress retained. | 0,24 |

#### 3.3 Configure Data Source Information
Configure each section according to the migration type described in `[migrateType]`. For example, if the configuration item of `[migrateType]` is `type=migrateLocal`, users only need to configure `[migrateLocal]` .

**3.3.1 Configure local data source - migrateLocal**
To migrate local data to COS, users should configure this section. Configuration items are as follows:
<pre>
# Configuration section for migrating local data to COS
[migrateLocal]
localPath=E:\\code\\java\\workspace\\cos_migrate_tool\\test_data
exeludes=
</pre>

| Configuration Item | Description |
| ------| ------ |
| localPath | Local path, which should be in the format of an absolute path.<br>The separator used in Linux is a forward slash, such as /a/b/c.<br>Double backslashes are used in Windows, such as E:\\a\\b\\c. |
| exeludes | Absolute path of the directory or file to be excluded, which means some directories or files under localPath will not be migrated. Multiple absolute paths are separated by semicolons. If the item is left empty, it means to migrate all files under localPath. |

**3.3.2 Configure Alibaba Cloud OSS data source - migrateAli**

To migrate data from Alibaba Cloud OSS to COS, users should configure this section. Configuration items are as follows:
<pre># Configuration section for migrating data from Alibaba Cloud OSS to COS
[migrateAli]
bucket=mybucket-test
accessKeyId=xxxxxxxxxx
accessKeySecret=yyyyyyyyyyy
endPoint= OSS -cn-shenzhen.aliyuncs.com
prefix=
proxyHost=
proxyPort=
</pre>

| Configuration Item | Description |
| ------| ------ |
| bucket | Name of Alibaba Cloud OSS bucket |
| accessKeyId | accessKeyId for user key |
| accessKeySecret | accessKeySecret for user key |
| endPoint | Endpoint in Alibaba Cloud |
| prefix | Prefix of the path from which files are migrated. Prefix should be left empty if all data under bucket is to be migrated. |
| proxyHost | Proxy IP address that should be entered to access via proxy. |
| proxyPort | Proxy port |

**3.3.3 Configure AWS data source - migrateAws**

To migrate data from AWS to COS, users should configure this section. Configuration items are as follows:
<pre># Configuration section for migrating data from AWS to COS
[migrateAws]
bucket=aws-emr-test
accessKeyId=xxxxxxxxxx
accessKeySecret=yyyyyyyyyyyyyyyy
endPoint=s3.us-east-1.amazonaws.com
prefix=
proxyHost=
proxyPort=
</pre>

| Configuration Item | Description |
| ------| ------ |
| bucket | Name of AWS COS bucket |
| accessKeyId | accessKeyId for user key |
| accessKeySecret | accessKeySecret for user key |
| endPoint | Endpoint in AWS |
| prefix | Prefix of the path from which files are migrated. Prefix should be left empty if all data under bucket is to be migrated. |
| proxyHost | Proxy IP address that should be entered to access via proxy. |
| proxyPort | Proxy port |
 
**3.3.4 Configure Qiniu data source - migrateQiniu**
To migrate data from Qiniu to COS, users should configure this section. Configuration items are as follows:
<pre># Configuration section for migrating data from Qiniu to COS
[migrateQiniu]
bucket=mybuckettest
accessKeyId=xxxxxxxxxx
accessKeySecret=yyyyyyyyyyyyyyyy
endPoint=wwww.bkt.clouddn.com
prefix=
proxyHost=
proxyPort=
</pre>

| Configuration Item | Description |
| ------| ------ |
| bucket | Name of Qiniu COS bucket |
| accessKeyId | accessKeyId for user key |
| accessKeySecret | accessKeySecret for user key |
| endPoint | Download address for Qiniu data, corresponding to downloadDomain |
| prefix | Prefix of the path from which files are migrated. Prefix should be left empty if all data under bucket is to be migrated. |
| proxyHost | Proxy IP address that should be entered to access via proxy. |
| proxyPort | Proxy port |

 
**3.3.5 Configure URL list data source - migrateUrl**
To migrate data from URL list to COS, users should configure this section. Configuration items are as follows:
<pre>
# Configuration section for downloading and migrating data from URL list to COS
[migrateUrl]
</pre>
     
| Configuration Item | Description |
| ------| ------ |
| urllistPath | URL list path, which should be in the format of an absolute path.<br>The separator used in Linux is a forward slash, such as /a/b/c.<br>Double backslashes are used in Windows, such as E:\\a\\b\\c.<br> If a directory is entered, all files under the directory will be scanned and migrated as urllist files. |
 
**3.3.6 Configure bucket replication - migrateBucketCopy**
To migrate data from URL list to COS, users should configure this section. Configuration items are as follows:
<pre>
# Configuration section for migrating data from source bucket to destination bucket
[migrateBucketCopy]
srcRegion=ap-shanghai  
srcBucketName=mysrcbucket-1251668555
srcSecretId=xxxxxxxxxxx
srcSecretKey=yyyyyyyyyyyyyyyy
srcCosPath=/
</pre>

| Configuration Item | Description |
| ------| ------ |
| srcRegion | Region information of the source bucket. For more information, please see [Available Regions](https://cloud.tencent.com/document/product/436/6224) |
| srcBucketName | Source bucket name. Bucket is named in a format of {name}-{appid}, which means a bucket name must contain APPID, such as movie-1251000000. |
| srcSecretId | SecretId for the key of the source bucket user. For more information, please see [Cloud API Key](https://console.cloud.tencent.com/cam/capi). For data migration under the same user account, SecretId described in srcSecretId should be the same as that in common. Otherwise, the migration is cross-account bucket replication. |
| srcSecretKey|  secret_key for the key of the source bucket user. For more information, please see [Cloud API Key](https://console.cloud.tencent.com/cam/capi). For data migration under the same user account, secretId described in srcSecretId should be the same as that in common. Otherwise, the migration is cross-account bucket replication. |
| srcCosPath | COS path under which files are to be migrated to the destination bucket |


### 4. Run Migration Tool
#### Windows
Double-click **start_migrate.bat** to run the migration tool.

#### Linux
1. Read configurations from config.ini by execute the following command:
<pre>
sh start_migrate.sh
</pre>
2. Configurations of some parameters need to be read from the command line. Execute the command as follows:
<pre>
sh start_migrate.sh -Dcommon.cosPath=/savepoint0403_10/
</pre>

>**Notes**
> - Configuration items can be read by two methods: reading from the command line or reading from the configuration file.

> - The command line has higher priority than the configuration file, which means that the use of parameters in the command line is preferred if the command line and configuration file have the same configuration items.

> - Reading configuration items from the command line makes it easy for users to run two different migration tasks at the same time, provided that the key configuration items (such as bucket name, COS path, and source path) in the two tasks are not exactly the same. Concurrent migration can be achieved because different migration tasks are written to different db directories. For more information on db, please see the directory structure of COS Migration Tool above.
    
> - Configuration items are in a format of **-D{sectionName}.{sectionKey}={sectionValue}**. sectionName is the section name of the configuration file. sectionKey is the name of the configuration item in the section. sectionValue is the value of the configuration item in the section. COS path to which data is migrated should be in a format of **-Dcommon.cosPath=/bbb/ddd**.

## Migration Mechanism and Process
### Migration Mechanism
COS migration tool is stateful. Successful migrations will be recorded in the format of KV in leveldb file under db directory. Before each migration, check whether the path to which data is migrated has been recorded in db directory. If yes and its attribute is the same as that in db, this migration will be skipped. Otherwise, the migration will be executed. The attribute for determining whether to migrate varies depending on the type of migration. For local migration, mtime determines whether to migrate. For migration from other cloud storage services and bucket replication, etag and length of the source file determines whether to migrate. That's the reason why we search records of successful migration in db instead of COS. If a file is deleted or modified via COSCMD or console rather than the migration tool, the file will not be re-migrated because it is not changed in the perspective of the migration tool.

### Migration Process
1. Read configuration files. Read each configuration section according to the type of migration, and check the parameters.

2. Scan and compare with the identifier of the file to be migrated under db based on the migration type, and then determine whether the upload is allowed.

3. Execution result is printed in the process of migration. inprogress: in migration, skip: migration skipped, fail: migration failed, ok: migration succeeded. You can check detailed failure information in error logs in log directory. The execution process is as shown below:
 ![](https://i.imgur.com/oojIbOm.png)

4. Migration data such as cumulative success count, failure count, skip count and the time used for migration are printed after the migration. The migration tool will skip the migrated files and leave those failed to be migrated. You can check the error logs of the files that failed to be migrated or execute the migration again. Migration results are as follows:
![](https://i.imgur.com/NkoddI5.png)


## FAQs
#### 1. What to do if COS Migration exits abnormally during migration? 
COS Migration supports resuming upload from breakpoint. If the upload for large files is suspended due to abnormal exit or service failure, you can execute the tool again and resume the upload from the breakpoint.

#### 2. If I delete the files migrated to COS via console or other methods, will these files be uploaded again by COS Migration?
No. All the migrated files are recorded in db. COS Migration scans db directory before each migration and files recorded in db will not be uploaded again. For more information, please see [Migration Mechanism and Process](#.E8.BF.81.E7.A7.BB.E6.9C.BA.E5.88.B6.E5.8F.8A.E6.B5.81.E7.A8.8B).

#### 3. What to do if the migration failed and 403 Access Deny displays in the log?
Check whether the key, bucket, and region are correct and ensure that you have operation permissions. Sub-account needs to be authorized by its parent account. Write-read permission to bucket is required to migrate data locally or from other cloud storage services. Write permission to source bucket is required for bucket replication.

#### 4. What to do if the migration from other cloud storage services to COS failed and Read timed out displays?
This error occurs when downloading from other cloud storage services timed out due to insufficient bandwidth. For example, when you migrate overseas data from AWS to COS, if the bandwidth is insufficient and causes high latency, the prompt of "Read timed out" may appear. To solve this problem, please increase network bandwidth and test download speed with wget before migration.

#### 5. What to do if the migration failed and 503 Slow Down displays in the log?
This error occurs when frequency control is triggered. The upper limit for a single account is 800 QPS in COS. You are recommended to decrease the concurrency for small files in configuration. Run the tool again and the migration will be executed.

#### 6. What to do if the migration failed and 404 NoSuchBucket displays in the log?
Check whether the key, bucket and region are correct.

#### 7. Others
Run the migration tool again. If the failure persists, please package the configuration information (with key information hidden) and the log directory, and [submit a ticket](https://console.cloud.tencent.com/workorder/category).

