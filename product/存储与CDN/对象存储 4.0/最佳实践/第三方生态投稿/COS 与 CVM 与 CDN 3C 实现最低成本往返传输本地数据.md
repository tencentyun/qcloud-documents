## 背景
例如有如下需求，客户是专门做影视的，渲染服务器在国内，拍摄组分布在欧洲各地，每天产生的数据高达500G，需要传到云服务器进行转码渲染，处理后数据差不多300G，然后再传回本地做备份。
![](https://qcloudimg.tencent-cloud.cn/raw/b2f2b17081b44c0ab201d2795969a9f1.png)

或者是客户对 CVM 成本敏感，带宽方面紧张，没有开通公网带宽，如何从内网低成本传出与公网隔离的 CVM 实例的文件？

## 问题
- 公网传统的办法就是利用 FTP，或者远程桌面直接传输。
- 这样的缺点非常明显，不支持断点续传，也不支持文件校验，同时效率非常低，遇到丢包延迟时甚至无法顺畅传输。
- 部分公司可能会使用网盘的方式进行传输，但同样存在缺点，数据不可控，有可能因为协议变更或资源敏感导致客户的数据无故删除，造成极大风险。或是速度无法达标造成效率低下。

若服务器没有公网地址，以上方法均无法正常进行。

- 若服务器存在公网，考虑到公网带宽的成本，按量付费的100Mbps 就得25块每小时，可参见 [公网网络定价](https://buy.cloud.tencent.com/price/idc)。按照100Mbps 带宽全部跑满的情况下，300G 数据大约要6小时，差不多一天需要150元。
- 如果是按流量计费的带宽，以成都区为例，每G0.8元的费用，若每天300G 则每天为240元，费用较高。
- 考虑到境外拍摄组传输的问题，直连到国内的服务器的效率不会很高，面临丢包，断连的问题。
- 对于后者无公网 IP 的，内网似乎没有任何办法直接传输回本地，只能借助其他工具。例如内网传到一台有公网的机器上，但是如此一来又回到了第一个客户的问题。

如上所有问题，对于一家注重成本或者刚起步的客户，该如何解决？

## 梳理思路
### 重复流量
对于以上场景，从服务器传出来的数据，从本地传入服务器的数据，或多或少都会产生流量费用，中途遇到断连等不可抗因素时，重新传输又会进一步造成费用的产生。所以要考虑的不仅仅是数据传输流程，还要考虑稳定性。

如果需要来回传输很多次的，建议所有资源保持一个地域和一个内网，传输的时候不走公网，提高效率减少成本。

### 稳定性
如上文所述，遇到不可抗因素时，不支持断点续传、分片传输的话，就只能从0开始，既浪费时间又浪费流量。

如果文件量大的，建议使用对象存储 COS，支持到50T 的分片上传，并且最好走内网，提高效率。

### 生态
- COS，CDN，CVM 统一使用腾讯云的产品，在同一个账户下控制台可以直接管理，免去了切换平台和切换账号之间的麻烦。
- COS 与 CDN、CVM 在腾讯云内同一地域统一走内网。

## 场景优化
### 对象存储 COS 侧
同地域下，对象存储与 CVM 默认走内网通道，即使没有开通公网，也能直接对数据进行操作，省去了公网带宽的费用。同时内网流量是完全免费的，详情请参见 [内网域名](https://cloud.tencent.com/document/product/436/56556?from=10680)。
![](https://qcloudimg.tencent-cloud.cn/raw/6ab76399c9b1bac8a66a230240edd379.png)

如此一来，从服务器传入传出到对象存储的数据，只收流量之外的费用，而这部分费用可以忽略不计（小于0.001元）。

由于是内网通道，相对公网来说更加稳定，速率更高，腾讯云 CVM 最低内网带宽为2.5Gbps，还有更高内网带宽的机型。而且对象存储产品支持分片上传，断点续传。

本文只讨论流量费用，由于对象存储是作为临时传输用的，1天内会删除，存储费用不考虑在内。

### 内容分发网络 CDN 侧
由于服务器与对象存储在国内，直接从境外上传与下载的体验不是那么好，有可能会遇到高延迟和丢包的情况，这时候可以借助 CDN 进行加速。

COS 中的 CDN 适用于以下场景：

- 对响应延时和下载速度有较高要求的场景。
- 需跨地区、国家、大洲传输数 GB 至数 TB 数据的场景。
- 需高密集地反复下载相同内容的场景。

同样 CDN 到 COS 之间的流量走的也是内网，流量费用按照未通过 CDN 直接访问源站产生的公网流量费用+ CDN 访问的费用进行收费。
![](https://qcloudimg.tencent-cloud.cn/raw/9ef93d97b8154ef91b0cecd7addcddf5.png)

按流量计费的价格，详情请参见 [COS-CDN 计费说明](https://cloud.tencent.com/document/product/228/37849?from=10680)。
>?相较于 COS 在欧洲地区的0.5-0.9元/GB，CDN 只需要0.31元/GB，每 GB 省下了最多0.5元，成本直接减半。上述案例中300G 数据通过 COS 直接下载的价格为150元，而通过 CDN 只需要93元。

## 对比方案
以下数据均为按量付费（按日或小时计费），CVM 带宽100Mbps：

- 1GB=1024MB，1T=1024GB，1MB/s=8Mbps
- 其中，CVM 所在地域为中国大陆，COS 与 CVM 同地域，CDN 在欧洲。
- CVM 按带宽计算计费价格公式：数据量*1024/(带宽/8)/3600*带宽费，单位为（GB,Mbps）。
<table ><thead ><tr>
<th ><p>数据量 GB</p>

</th><th ><p>CVM 流量费用</p>

</th><th ><p>CVM 带宽费用</p>

</th><th ><p>COS 流量费用</p>

</th><th ><p>CDN 流量费用</p>

</th></tr>

</thead><tbody ><tr>
<td><p>20</p></td>
<td><p>16</p></td>
<td><p>11.37777778</p></td>
<td><p>10</p></td>
<td><p>6.2</p></td>
</tr>

<tr>
<td><p>100</p></td>
<td><p>80</p></td>
<td><p>56.88888889</p></td>
<td><p>50</p></td>
<td><p>31</p></td>
</tr>

<tr>
<td><p>500</p></td>
<td><p>400</p></td>
<td><p>284.4444444</p></td>
<td><p>250</p></td>
<td><p>155</p></td>
</tr>

<tr>
<td><p>1024</p></td>
<td><p>819.2</p></td>
<td><p>582.5422222</p></td>
<td><p>512</p></td>
<td><p>317.44</p></td>
</tr>

<tr>
<td><p>5120</p></td>
<td><p>4096</p></td>
<td><p>2912.711111</p></td>
<td><p>2560</p></td>
<td><p>1331.2</p></td>
</tr>

<tr>
<td><p>10240</p></td>
<td><p>8192</p></td>
<td><p>5825.422222</p></td>
<td><p>5120</p></td>
<td><p>2252.8</p></td>
</tr>

</tbody>
</table>

通过上述数据综合得出，CDN 的费用是最低最划算的，单价在所列举的产品中均为最低单价。若使用资源包，COS 与 CDN 流量费用还能进一步折扣。

## 操作步骤
整个方案的结构如下：
![](https://qcloudimg.tencent-cloud.cn/raw/3ac134e88cb35f41f7b76c2068861bed.png)
### 开通相关服务
进入对象存储 COS，云服务器 CVM，内容分发网络 CDN 控制台，首次打开会要求开通授权，根据指引操作即可。

### 创建存储桶
详情请参见 [创建存储桶](https://cloud.tencent.com/document/product/436/13309)。

>?创建存储桶时，地域要与 CVM 所在地域一致，否则将会通过公网收取费用。

存储桶权限建议设置为私有读写。

### 创建 CDN 服务
详情请参见 [从零开始配置 CDN](https://cloud.tencent.com/document/product/228/3149)。

>?CDN 源站选择 COS 源，建议选择 https 回源，开启私有存储桶访问保证安全。加速类型选择大文件下载或根据业务场景选择。

其余配置根据文档指引与业务需要进行配置。

### CVM 内建议配置
- 如无公网需要，建议不开通公网，从内网仍然可以访问到对象存储。

- 若系统为 Windows，建议使用浏览器或 COSCMD 工具访问对象。通过浏览器直接访问对象地址即可在 CVM 进行下载，可参见 [COSCMD 工具](https://cloud.tencent.com/document/product/436/10976) 指引。

- Linux 系统建议直接使用 [COSFS 工具](https://cloud.tencent.com/document/product/436/6883) 挂载到本地进行操作。

### 对象存储的本地数据上传
此外还可以使用 CosBrowser 工具完成 CosBrowser 操作。

对象存储上传会分片上传，极大提升了稳定性，减少了资源内存的占用。且相较于 FTP，对象存储支持断点续传，即使遇到断网的情况，恢复网络后依然能继续上传。

### CVM 上传数据至对象存储
可参见 COSCMD 操作 [上传对象](https://cloud.tencent.com/document/product/436/13321) 。

若使用 Windows 服务器，可以安装图形化管理软件 **COSBrowser**。
![](https://qcloudimg.tencent-cloud.cn/raw/cddabe2ff044c4939b7aeb8982d2c708.png)

## 总结
- 由于业务环境复杂，这种方式仅能节省成本，但额外增加了操作的时长。
- 一般的 FTP，RDP 等 P2P 的文件传输，可能会因为断网等不可控因素导致数据中途丢失，只能从头传输，增加了风险。使用文章上述的方法更安全可靠。
- 通过 COS 连接 CVM，全部走内网通道，速率，稳定，安全性可以达到最高，同时流量费为0，请求费可以忽略不计。
- 除了传输数据，对象存储还提供了高安全性可靠的数据保障，如果本地文件损坏时，对象存储也能提供一份备份以防万一。如开头所说，客户在本地的备份同样也可以使用对象存储进行备份操作。
- 通过 CDN，能让在 COS 里的数据更快速稳定地传输到本地，同时也能节省直接从 COS 下载的流量费用，一举两得的好方法。
随着流量的增多，节省的费用将会越来越多，如下表格为理论上能够节省的费用：
<table>
<thead>
<tr>
<th width=10%>数据量 GB</th>
<th width=10%>CVM 流量费用</th>
<th width=10%>CDN 流量费用</th>
<th width=10%>CDN 节省率</th>
</tr>
</thead>
<tbody>
<tr>
<td>20</td>
<td>16</td>
<td>6.2</td>
<td>61.25%</td>
</tr>
<tr>
<td>50</td>
<td>40</td>
<td>15.5</td>
<td>61.25%</td>
<tr>
<td>100</td>
<td>80</td>
<td>31</td>
<td>61.25%</td>
<tr>
<td>500</td>
<td>400</td>
<td>155</td>
<td>61.25%</td>
<tr>
<td>1024</td>
<td>819.2</td>
<td>317.44</td>
<td>61.25%</td>
<tr>
<td>5120</td>
<td>4096</td>
<td>1331.2</td>
<td>67.50%</td>
<tr>
<td>10240</td>
<td>8192</td>
<td>2252.8</td>
<td>72.50%</td>
</tr>
</tbody>
</table>
可以看到，CDN+COS 对比直接从 CVM 出网，能节省50%以上的费用。
