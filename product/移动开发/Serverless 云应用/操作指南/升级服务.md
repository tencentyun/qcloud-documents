本文为您介绍当云托管中的服务已经部署完成并已经有流量后，如何在控制台进行升级。

## 基本概念

云托管目前支持两种升级方式：


|                |                      新建版本升级                       |     原版本编辑配置并重新部署     |
| :------------: | :-----------------------------------------------------: | :------------------------------: |
| 升级前后 IP 不变 |                   否，每个版本 IP 不同                    |       是，版本不变则 IP 不变       |
|    调用方式    |                      通过域名调用                       |     通过域名调用或通过 IP 调用     |
|      回滚      |              支持，流量导回旧版本即可回滚               | 支持，用历史配置重新部署实现回滚 |
|    灰度升级    | 支持，新旧版本按百分比（随机）或 URL参数（定向）分配流量 |              不支持              |
|   多版本并行   |                          支持                           |              不支持              |



## 新建版本升级

每次升级服务都新建一个版本，部署成功后逐步将流量从旧版本导向新版本。通过域名调用不强依赖固定 IP，更符合云原生理念。

### 全量升级

升级完成后，全部流量直接导向新版本。

#### 操作步骤

1. 登录 [云托管控制台](https://console.cloud.tencent.com/tcb/service)，按需要切换到指定的环境。
   ![](https://main.qcloudimg.com/raw/38110b543ebe9c38b0e25370b1dfaf3a.png)
2. 进入需要升级的服务详情。
   选择您需要升级的服务，单击服务名称进入服务详情页面。
   ![](https://main.qcloudimg.com/raw/0549eee11a609f62ef5a95f77e6d969b.png)
3. 单击【新建版本】。
   您应当至少已有一个服务版本在运行中。
   ![](https://main.qcloudimg.com/raw/74b7c4c1c429fe3bdf22d91609d7cb46.png)
4. 配置版本。
   填写升级所需的版本配置信息，并在“流量策略”中选择“部署完成后自动开启100%流量”。
   <img src="https://main.qcloudimg.com/raw/7e39b6a407b4bcc6f6ae0fc5f0f6e6da.png" width="60%"></img>
5. 开始部署。
 - 在新建版本窗口中，填写完版本配置信息后，单击【开始部署】。
 - 版本初始为“创建中”。部署成功则状态变为“正常”，且流量变为100%。若有报错，会变为具体的错误状态。
 - 单击错误状态查看，可以获取错误详情和处理建议。
   ![](https://main.qcloudimg.com/raw/42a8b25f4a9cadf973286f93c6c60d30.png)
6. 访问服务。
 - 完成升级后，您可能希望能够快速访问自己的服务查看升级后的效果。
 - 云托管自动为您的服务分配了一个默认域名，您可以直接单击【访问服务】，通过这个默认域名访问您的服务页面。



### 灰度升级/蓝绿发布

升级完成后，先将部分流量（定向或随机）引向新版本，新旧版本并行一段时间并观测新版本运行状况，待新版本稳定后再将全部流量导向新版本。

#### 操作步骤

1. 单击【新建版本】。
   您应当至少已有一个服务版本在运行中。
   ![](https://main.qcloudimg.com/raw/74b7c4c1c429fe3bdf22d91609d7cb46.png)
2. 配置版本。
   填写升级所需的版本配置信息，并在“流量策略”中选择“部署完成后保持流量为0，稍后手动配置流量”。
   ![](https://main.qcloudimg.com/raw/2cc55d5e3c892a8255ff1be5b729767a.png)
3. 开始部署。
 - 在新建版本窗口中，填写完版本配置信息后，单击【开始部署】。
 - 版本初始为“创建中”。部署成功则状态变为“正常”，且流量为0%。若有报错，会变为具体的错误状态。
 - 单击错误状态查看，可以获取错误详情和处理建议。
   ![](https://main.qcloudimg.com/raw/42a8b25f4a9cadf973286f93c6c60d30.png)
4. 配置流量。
   - **方式一：按百分比（随机）分配流量**：
	 - 单击【流量配置】。
	 - 模式采用默认【按百分比】。
	 - 选中刚部署完的最新版本和当前运行中的旧版本，并为每个版本指定流量百分比。所有百分比加起来需要等于100%或0%，否则无法完成。未在流量配置窗口中添加的版本，将统一将流量百分比变为0%。
	 - 单击【完成】，系统立刻开始按百分比随机分配流量，将部分流量从旧版本引向新版本。
		 <img src="https://main.qcloudimg.com/raw/2f261e8fdfc319094173fda7b37a8f76.png" width="90%"></img>
		 成功后，可以看到对应版本的流量百分比已经变化。
		 ![](https://main.qcloudimg.com/raw/5e4ece25ca29fa06229762d3f7a24c53.png)
 - **方式二：按URL参数（定向）分配流量**：
	 - 单击【流量配置】。
	 - 模式选择【按URL参数】。
	 - 添加部署完的最新版本，设定URL参数key和value(支持Globe)。符合条件的请求将路由到新版本。
	 - 再添加当前运行中的旧版本和对应的URL参数。
	 - 将旧版本设置为默认版本。
	 - 在“匹配结果预测”中输入URL参数模拟请求，点击【预测】查看对应版本，调试配置。
	 - 单击【完成】，系统立刻开始将部分流量从旧版本引向新版本。
		 <img src="https://main.qcloudimg.com/raw/fa1c4ab59e9848576dd898f2e3042f36.png" width="90%"></img>
		 成功后，可以看到对应版本的流量条件已经变化。
		 <img src="https://main.qcloudimg.com/raw/a402a953872d4f96115a34202449c27b.png" width="100%"></img>
5. 访问服务。
 - 完成升级后，您可能希望能够快速访问自己的服务查看升级后的效果。
 - 云托管自动为您的服务分配了一个默认域名，您可以直接单击【访问服务】，通过这个默认域名访问您的服务页面。
 - 因为您采用的是灰度升级，请求将按百分比随机或按URL参数定向分配到新旧版本。这可能影响您访问服务时看到的现象。
6. 全量切换。
   待新版本稳定后，结束灰度，将所有流量都切换到新版本。
	- 单击【流量配置】。
	- 模式采用默认【按百分比】。
	- 选中新版本，将百分比设置为100%。
	- 单击【完成】，系统立刻开始将全部流量导向新版本。
		<img src="https://main.qcloudimg.com/raw/146dd823ad6f018fa1637e94db8892fa.png" width="90%"></img>
		成功后，可以看到对应版本的流量百分比已经变化。
		![](https://main.qcloudimg.com/raw/97cbcb42b1b1c97f47619e5f5f93f7cc.png)



## 原版本编辑配置并重新部署

不新建版本，在已有版本中编辑配置信息，然后重新部署。此方式下不支持灰度升级。

#### 操作步骤

1. 登录 [云托管控制台](https://console.cloud.tencent.com/tcb/service)，再按需要切换到指定的环境。
   ![](https://main.qcloudimg.com/raw/38110b543ebe9c38b0e25370b1dfaf3a.png)
2. 进入需要升级的服务详情。
   选择您需要升级的服务，单击服务名称进入服务详情页面。
   ![](https://main.qcloudimg.com/raw/0549eee11a609f62ef5a95f77e6d969b.png)
3. 选择需要升级的版本，在“操作”-“更多”下拉菜单中，选择【编辑配置并重新部署】。
   您应当至少已有一个服务版本在运行中。
   ![](https://main.qcloudimg.com/raw/f19a8e60b1c5fdf85bd0ddf77438183b.png)
4. 配置版本。
   填写升级所需更新的版本配置信息。
	- 不支持选择流量策略，请在重新部署成功后手动配置流量。
	- 若需更新镜像/代码，请单击【更新镜像信息】，并填写表单。提交新的镜像信息并不会立刻开始部署，需要等其余配置信息也编辑完毕后触发。
	![](https://main.qcloudimg.com/raw/146a0181c54774566c01a58ecd1c21c5.png)
5. 开始部署。
 - 单击【保存并重新部署】
 - 版本状态变为“更新中”。部署成功则状态变为“正常”，流量保持不变。若有报错，会变为具体的错误状态。
 - 单击错误状态查看，可以获取错误详情和处理建议。
   ![](https://main.qcloudimg.com/raw/42a8b25f4a9cadf973286f93c6c60d30.png)
> ! 若更新失败，版本状态将变为“部署失败”，并自动回滚到升级前的版本配置以保障业务正常运行，因此您在“配置信息”中看到的字段将不会更新。只有重新部署成功，版本状态变为“正常”，配置信息才会更新。
6. 访问服务。
 - 完成升级后，您可能希望能够快速访问自己的服务查看升级后的效果。
 - 云托管自动为您的服务分配了一个默认域名，您可以直接单击【访问服务】，通过这个默认域名访问您的服务页面。


## 相关操作

- [部署服务](https://cloud.tencent.com/document/product/1243/46127)
- [回滚服务](https://cloud.tencent.com/document/product/1243/46129)
