## 功能描述

DBbrain 数据库自治服务支持自动限流与 KILL 功能，开启自治服务后，当数据库发生 SQL 大量并发、缓存透穿、数据库（性能差 SQL、问题 SQL）占用大量资源时，自治中心会根据情况，自动触发相应自治事件，解决数据库异常问题，全程无需人工干预。

> ?
> - 目前仅支持云数据库 MySQL。
> - 目前仅支持自动限流与 KILL 功能，更多自治功能后续将逐步支持。
> - 自治是基于阈值触发，基于智能测算类型将在下个版本支持。

## 整体概览

登录 [DBbrain 控制台](https://console.cloud.tencent.com/dbbrain/analysis)，在左侧导航选择**诊断优化**，在上方选择对应数据库，然后选择**自治中心**页。
![](https://qcloudimg.tencent-cloud.cn/raw/e9f96a62e6ef455581dff654ba3ace23.png)

## 配置自治功能 

1. 登录数据库账号进行验证。
   配置自治功能需要您先登录数据库，未登录用户，只能查看自治数据，不能做配置修改。
   ![](https://qcloudimg.tencent-cloud.cn/raw/3505e5dc0658114bfe1cb236000c7651.png) 
2. 单击右上角的**自治配置**，进入自治中心配置页。
    <img src="https://qcloudimg.tencent-cloud.cn/raw/4cb4d0c5e257b36883ea8cd075a74cfe.png" style="zoom:67%;" />
3. 首次开启自治服务，需要先配置事件通知，以便在后续触发自治操作时及时通知给用户。  
   - 自治服务的事件通知采用内置策略模板，内置模板是自治实例首次配置自治策略时自动载入的模板，因此无法修改实例信息，只能修改接收人、通知方式、发送频率。如果用户需要修改策略中的更多内容，可复制内置策略后重新进行自定义。
   - 数据库实例的自治服务关闭后，对应实例的自治事件通知也不会再触发。
     ![](https://qcloudimg.tencent-cloud.cn/raw/8972daaf24ff04a9a280cb67850d391b.png)  
  - 自定义策略，在**事件通知** > **发送策略** > **自治策略**中，复制内置模板策略，然后按照自定义需求配置关联实例、规则等信息。
    ![](https://qcloudimg.tencent-cloud.cn/raw/1e6f27309588b600d0822939796be462.png)
4. 设置自治参数后单击**保存**。
    ![](https://qcloudimg.tencent-cloud.cn/raw/a32c5a58db40154379d64961bfbfa6e1.png)
 - 自动限流与 KILL：勾选后将自动触发符合条件的线程和 KILL 会话。
 - 限流场景：当前仅支持**阈值触发**。
 - 阈值配置：设置阈值触发的条件。
    - CPU 及会话数：CPU使用率 + 数据库会话数，支持“并且”和“或者”为判断原则。 
    - 触发条件：CPU 及会话数中的事件持续多少时间以上，触发操作。
    上图示例效果为，CPU 达到60%，并且数据库活跃会话达到15，该事件持续2分钟触发限流。
 - 异常 SQL KILL：勾选后将自动对异常 SQL 进行 KILL 操作（如需指定 KILL 规则，可前往高级规则进行设置）。
 - 可限流时段与并发：设置限流时段、限流最大并发度、限流最大持续时间。限流最大并发度如果设置为“0”，表示限制所有的 SQL 执行。
 - 高级规则：高级规则中主要设置对指定关键字进行限流或 KILL 操作，或者对指定关键字进行放行。非必要情况，不建议开启，否则可能会出现您设置的关键词，或 KILL 条件，正好是异常量大的 SQL，影响自治任务效果。
5. 配置完成后，默认会开启自治功能。在首页可看到，数据库自治按钮已点亮。
![](https://qcloudimg.tencent-cloud.cn/raw/fd723fa922a6e847409a048dfbfd8fd8.png)

## 查看自治功能

### 查看实时监控

开启自治功能后，可观察实时的自治监控图，如下图所示，选择时间段后可获取对应时段的自治事件触发情况。单击对应的触发事件，也可直接打开自治任务详情。
![](https://qcloudimg.tencent-cloud.cn/raw/f45aab4f980c86bee4061ad84de2db63.png)

### 查看自治事件时间轴

1. 根据选择的时段，展示所选周期内的自治触发事件列表。
![](https://qcloudimg.tencent-cloud.cn/raw/6547446fae379198e5e204c26df444e2.png)
2. 单击展开某个自治事件，可以看到该事件内，触发了哪些自治任务。
3. 单击**详情**可查看事件记录。
![](https://qcloudimg.tencent-cloud.cn/raw/499ae9cfe537ec79f248ee36734710f0.png)
4. 进入详情页，可以查看自治现场的会话快照、监控参考、执行的 SQL 记录。
![](https://qcloudimg.tencent-cloud.cn/raw/bf55cb815b03da275e4ae8df39787384.png)
5. 对于自治中的事件，用户如果不再需要自治干预，可以进行终止。
如下图所示，当某个自治事件触发后，有不同层级的“终止”按钮操作，**一键终止**，可终止当前自治事件下的所有自治任务，详情后的**终止**按钮，可以单独终止某个自治任务。
![](https://qcloudimg.tencent-cloud.cn/raw/e4a303384cb8ea5f9dc1be20a9854c9f.png)
同时，也可以进入详情页，在详情页单击**停止任务**进行终止操作。
![](https://qcloudimg.tencent-cloud.cn/raw/5fdad726cd8929bbcf9d01f2e0ee4753.png)
6. 在弹出的对话框中单击**确定**。
   终止仅针对正在运行中的自治事件，后续自治事件还是会正常触发。
<img src="https://qcloudimg.tencent-cloud.cn/raw/534bfa64093f746cf5d47d5e1d1b375e.png" style="zoom:50%;" />

### 查看自治任务分布

当您开启对应的自治事件后，分布图中对应的自治项将自动进行统计。
图形会根据您选择的时段，自动刷新并统计该范围内触发的自治任务数，以及自治任务占比。
![](https://qcloudimg.tencent-cloud.cn/raw/eb4b78d0fe292c2ab3e75e5b22b39d2a.png)

