## 功能描述
索引优化是数据库优化的重要一环，一个最优的索引可提升整个实例的查询效率。DBbrain 针对 MongoDB 数据库运维特点，推出索引推荐功能，帮您轻松提升实例全局索引效率。

索引推荐通过实时日志慢查信息的收集，进行自动分析，推出全局最优索引，并按照性能影响进行排列，推荐值越大操作后性能提升越显著。同时，索引推荐为您呈现和推荐索引相关联的慢查和性能指标供您检阅。还可以展示无效索引，告知无效索引起因。

您只需根据推荐的索引信息，一键操作即可，操作进度可查，操作安全有保障。

## 开启索引推荐功能
1. 登录 [DBbrain 控制台](https://console.cloud.tencent.com/dbbrain)，在左侧导航选择**诊断优化**，在上方选择 MongoDB 对应数据库实例，然后选择**索引推荐**页。
2. 如图所示，阅读数据隐私风险和功能，勾选同意使用按钮后，单击**解锁该功能**。
> ?
> - 首次开启索引推荐，以当前时间点开始计算，可能无法立刻获得所有数据，开启一段时间后，数据信息会充盈。
> - 开启索引推荐后，对数据库性能基本无影响，请放心使用（每天处理数据量在亿级的大表，数据库规格为4核8GB，开启索引推荐功能后，采样周期持续10分钟，大概消耗0.3个 CPU）。
> 
![](https://qcloudimg.tencent-cloud.cn/raw/2b9a462cf8c84b9819f3e3e104ca4258.png)

## 查看推荐索引信息
1. 查看实例整体优化级别
   DBbrain 通过对源实例的索引数据评估，给出 SQL 优化的推荐级别，提供 SABC 四个优化级别，S 表示数据库的性能最优，C 表示数据库的性能最差，需要紧急优化。
   ![](https://qcloudimg.tencent-cloud.cn/raw/6903cc0c7d68c0f3c5d6821706a4ba38.png)
2. 查看推荐集合列表
   DBbrain 根据检测到的索引数据进行推荐汇总，并按照推荐值排序，推荐值越大的，表明该集合存在急需优化的索引，优化后数据库性能提升最显著。
   ![](https://qcloudimg.tencent-cloud.cn/raw/583f753eee1a0085255cdf8b9b7032d7.png) 
3. 单击不同的集合名，右侧会展示不同集合内的索引推荐情况。
   - 推荐索引：展示慢查过多需要添加的索引。同样，按照推荐值排序，推荐值越大的添加后性能提升越明显。 
     ![](https://qcloudimg.tencent-cloud.cn/raw/4cc8fe35fe5d03b0912ed6ceff3afb92.png)  
   - 已有索引（无效）：展示生产无效建议删除的索引。

## 根据推荐添加索引 
1. 在**推荐索引**页签， 单击不同的索引信息，右侧呈现该索引对应的慢查分析和记录信息。
   ![](https://qcloudimg.tencent-cloud.cn/raw/f8d5ac9314a7437bdd774287ea67d744.png)
2. 单击如下图红框位置，可放大慢查询窗口，更清晰的检阅索引对应的慢查信息，同时支持下载慢查信息。
   ![](https://qcloudimg.tencent-cloud.cn/raw/431d297aa9f5cef82189c14b3e29f0d8.png)
3. 在**自动生成执行语句**模块，单击**创建索引**。
   执行索引操作，需要先登录数据库，进行权限验证。
   ![](https://qcloudimg.tencent-cloud.cn/raw/caa5d4e064b702dfa79f7262695c8ffc.png)
4. 创建方式有**默认方式**与**指定 Option 创建**两种，按照您的需要进行选择，DBbrain 会根据您的选择自动生成创建语法。  
   <img src="https://qcloudimg.tencent-cloud.cn/raw/30f89ec990d05d7994ee028e725aa0e1.png" style="zoom:50%;" />
5. 创建中的索引，可展示创建完成进度，也可以在该集合的操作记录中，查看此集合的操作列表。
   ![](https://qcloudimg.tencent-cloud.cn/raw/c3645d5a733bc782eb2e2d8472ad9b02.png)
   操作列表中，可以查看该集合索引历史添加或删除情况，并能对正在处理中的索引进行终止操作。  
> !为了生产数据库稳定性的保障，如果该集合中有正在创建或删除的索引，您再次进行此集合内其他索引的添加或删除是无法操作的，系统也会对您进行提示，需要等处理中的索引完成后，才可以再次进行其他索引的添加或删除操作。

## 根据推荐删除无效索引
在**已有索引（无效）**页签，查看无效索引并删除。当您的数据库中存在无效索引时，索引推荐系统会告知您，该索引的无效原因，并生成删除命令，根据提示可对无效索引进行一键删除。
<img src="https://qcloudimg.tencent-cloud.cn/raw/3ce506ae2c8b1cb5de33050475fd4e40.png" style="zoom:50%;" />

## 查看索引历史和添加索引效果
1. 在推荐集合列表右侧的**历史操作**，或者优化统计下的**查看详情**，都可以查看当前实例整体索引操作的历史索引优化信息。
   ![](https://qcloudimg.tencent-cloud.cn/raw/a0cde45b1b65afbe20764439f52066a7.png) 
2. 单击**历史操作**后，在**操作**列单击**对比**，可查看优化前后的对比效果。
   ![](https://qcloudimg.tencent-cloud.cn/raw/a5094ea856cbdaf84fbd9bda3b66f9cb.png)
