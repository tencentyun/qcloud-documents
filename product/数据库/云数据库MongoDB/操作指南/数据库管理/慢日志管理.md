云数据库 MongoDB 控制台支持查看数据库运行过程中产生的慢日志，分析慢日志以优化数据库性能。 

## 背景信息
- 在 MongoDB 中慢日志经常作为优化业务操作的依据。关于慢日志的更多信息请参考 [官方文档](https://docs.mongodb.com/manual/tutorial/manage-the-database-profiler/)。 
- 系统为您提供两种查询方式，分别详述如下：
  - 抽象查询：根据时间段查询慢日志， 查询结果以 command（操作）类型进行的聚合查询分析 。
  - 具体查询：指定具体的操作命令来查询慢日志，查询结果以列表的形式列举操作命令的耗时时间，以及日志详情。

## 版本说明
当前 MongoDB 4.2、4.0、3.6和3.2版本均支持对慢日志进行管理。

## 使用须知
-  系统会记录执行时间超过100毫秒的操作。
-  慢日志保留时间为7天，单次查询时间跨度不超过1天 。
-  查询仅限前1万条慢日志，若查询结果缓慢，请缩小查询时间范围。

## 前提条件
- 已 [申请云数据库 MongoDB 实例](https://cloud.tencent.com/document/product/240/3551)。
- 云数据库 MongoDB 副本集实例或分片实例的状态为**运行中**。

## 操作步骤
### 查询慢日志
1. 登录 [MongoDB 控制台](https://console.cloud.tencent.com/mongodb)。
2. 在左侧导航栏**MongoDB**的下拉列表中，选择**副本集实例**或者**分片实例**。副本集实例与分片实例操作类似。
3. 在右侧实例列表页面上方，选择地域。
4. 在实例列表中，找到目标实例。
5. 单击目标实例 ID，进入**实例详情**页面。
6. 选择**数据库管理**页签，再选择**慢日志查询**页签。
7. 在**慢日志查询**页面，选择**查询方式**查询慢日志。
  - **抽象查询**：选择**查询时间段**，并设置**耗时时间**阈值，单击**查询**。
  - **具体查询**：
    1. 在**查询命令**选择需查询的具体的执行命令。
    2. 选择**查询时间段**，并设置**耗时时间**阈值，单击**查询**。
8. 查看慢日志，并分析。
  - **抽象查询**结果包含四个字段：
    - **查询方式**：抽象查询。
    - **样例语句**：以 command 类型为聚合维度而输出的语句，用户排查问题时主要参考 command。
    - **平均执行时间（MS）**：以 command 类型为维度聚合的操作的平均执行时间，单位是毫秒。
    - **总次数**：以 command 类型为维度聚合的操作的次数统计。
![](https://main.qcloudimg.com/raw/22d11adf400e7979d7265640a281f2ac.png)
  - **具体查询**结果包含三个字段：
    - **查询方式**：具体查询。
    - **耗时**：业务命令的执行时间，单位为毫秒。
    - **日志详情**：业务命令详情。
![](https://main.qcloudimg.com/raw/92677b740930ae24f6b0ce25bc28138e.png)

### 慢日志管理
#### 查看慢日志请求语句
1. 在**慢查询管理**页面，可以查看慢日志的请求语句。
2. 在右上角搜索框，输入查询信息可以进行搜索。
<table>
<thead><tr><th>参数名称</th><th>参数信息</th></tr></thead>
<tbody><tr>
<td>Query 语句</td><td>查询语句</td></tr>
<tr>
<td>Op 类型</td><td>操作类型</td></tr>
<tr>
<td>节点位置</td><td>执行操作所在的节点</td></tr>
<tr>
<td>命令空间</td><td>数据库表的命名空间</td></tr>
<tr>
<td>已执行时间</td><td>耗时时间</td></tr>
<tr>
<td>详情</td><td>执行语句详情信息</td></tr>
</tbody></table>

#### 批量 Kill
1. 在**慢查询管理**页面，选择需清理的慢日志请求语句。
2. 单击列表上方的**批量Kill**，准备清理。
3. 在**提示**对话框，认真阅读提示信息。
4. 单击**确定**。

### 下载慢日志文件
1. 在**慢日志下载列表**页面，可以查看当前的慢日志文件。
2. 找到需下载的文件，在其**操作**列，单击**下载**。

## 相关 API
| API 接口                 | API 描述                                                      |
| ----------------------- | ------------------------------------------------------------ |
| DescribeSlowLogs        | [获取慢日志信息](https://cloud.tencent.com/document/api/240/43596) |
| DescribeSlowLogPatterns | [获取慢日志统计信息](https://cloud.tencent.com/document/api/240/43597) |

