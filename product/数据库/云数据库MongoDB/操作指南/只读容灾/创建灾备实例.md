云数据库 MongoDB 支持在控制台创建容灾实例，并进行管理。

## 背景信息
云数据库 MongoDB 支持用户创建一个或者多个灾备实例，针对业务连续服务和数据可靠性有强需求或是监管需要的场景，帮助用户以较低的成本提升业务连续服务的能力，同时提升数据的可靠性。
>?
>- 由于数据同步有延迟，灾备实例数据同步的实时性可能无法保证。各灾备实例与主实例之间的同步时延可在控制台查看。
>- 在灾备实例生命周期内，灾备实例只能读，不能进行数据写入更新操作。
>- 当灾备实例跟主实例同步断开，或用户手动在控制台提升灾备实例为主实例时，灾备实例即转为普通实例，可以正常读写。

## 实现机制 
云数据库 MongoDB 采用主从热备架构，通过 oplog 将主实例的更改同步到灾备实例。当主实例发生故障时，服务会自动切换到备节点，主从切换时可能会有10秒左右闪断，请业务做好自动重试。

1. 当发生意外致使主节点不可达时，集群内部会自动选举出新的主节点。
2. 如果故障的是主节点，重新拉起时，它会变身成一个从节点。如果拉起失败会补充新节点进入集群，以达到用户所选择的集群规模。
3. 同样当任一从节点不可达时，也会尝试拉起节点或者补充新节点。
![](https://main.qcloudimg.com/raw/305362f26be05bf5e7bf9ceb8f8beb8e.png)

## 版本说明
当前仅3.2、3.6、4.0版本的副本集实例支持创建容灾实例。

## 使用限制 
- 一个主实例最多可以创建3个灾备实例。
- 备份回档：不支持备份和回档功能。
- 数据迁移：不支持数据迁移至只读实例。
- 数据库管理：不支持创建、删除数据库。
- 帐号管理：不支持创建、删除帐号、修改帐号密码、帐号授权。
- 灾备实例与主实例的引擎保持一致。
- 由于网络的隔离性，金融专区与普通地域之间不能互相创建灾备实例。

## 前提条件
- 已 [申请云数据库 MongoDB 实例](https://cloud.tencent.com/document/product/240/3551)。
- 副本集实例状态运行正常。

## 操作步骤 
您可以在控制台查看灾备实例、新建灾备实例、调整实例配置、给实例续费、设置自动续费等操作。

### 查看容灾实例
1. 登录 [MongoDB 控制台](https://console.cloud.tencent.com/mongodb/sharding)。
2. 在左侧导航栏，选择**NoSQL** > **MongoDB**。
3. 在 **MongoDB** 的下拉列表中，选择**副本集实例**或者**分片实例**。副本集与分片集群操作类似。
4. 在右侧实例列表页面上方，选择地域。
5. 在实例列表中，找到目标实例。
6. 单击目标实例 ID，进入**实例详情**页面。
7. 选择**只读容灾**页签，再选择**灾备实例**页签。
8. 查看当前实例下新增的容灾实例。

### 新建容灾实例
1. 在**灾备实例**页签，单击**新建**。
2. 在**云数据库 MongoDB 灾备实例**购买页面，确认**主实例信息**，选择所需配置。
3. 单击**立即购买**，购买后可返回灾备实例页管理灾备实例。
![](https://main.qcloudimg.com/raw/aa27a4f27d031c09f424d35678cf36c6.png)

### 调整灾备实例配置
1. 在**灾备实例**页签，找到需调整配置的灾备实例。
2. 在其**操作**列，单击**配置调整**。
3. 在**配置调整**页面，可以重新调整节点规格、节点容量、Oplog容量。
4. 在**切换时间**选项中，选择切换实例规格的具体时间。
   - 选择**调整完成时**，立即执行调整实例规格任务。
   - 选择**维护时间**，在维护时间段内执行切换实例规格任务。
> !**维护时间**一般设置在业务低峰期，需要对实例进行定期维护。选择**调整完成时**立即调整实例配置，可能涉及节点迁移或者主从切换，主从切换时间点将不可控，强烈建议调整实例配置在**维护时间**内进行。更多信息，请参见 [设置实例维护时间](https://cloud.tencent.com/document/product/240/19910)。
5. 单击**计费详情**，可查看计费项目、计费公式，确认**费用**。
6. 确认无误，单击**提交**。

### 给灾备实例续费
1. 在**灾备实例**页签，找到需续费的灾备实例。
2. 单击实例列表上方的**续费**，在**续费所选实例**对话框，选择续费时长。
3. 确认续费总费用，单击**确定**。

### 设置自动续费
1. 在**灾备实例**页签，找到需设置自动续费的灾备实例。
2. 单击实例列表上方的**设置自动续费**，在**设置自动续费**对话框，确认自动续费项与续费到期时间。
3. 确认续费总费用，单击**确定**。

### 取消自动续费
1. 在**灾备实例**页签，找到需取消自动续费的灾备实例。
2. 单击实例列表上方的**取消自动续费**，确认实例信息。
3. 单击**确定**。

## 相关 API
| API 接口              | API 解释                                                      |
| -------------------- | ------------------------------------------------------------ |
| DescribeDBInstances  | [查询云数据库实例列表](https://cloud.tencent.com/document/api/240/38568) |
| RenameInstance       | [修改实例名称](https://cloud.tencent.com/document/api/240/38563) |
| RenewDBInstances     | [续费云数据库实例](https://cloud.tencent.com/document/api/240/43595) |
| ModifyDBInstanceSpec | [调整云数据库实例配置](https://cloud.tencent.com/document/api/240/38565) |

