云数据库 Redis 支持同地域下跨多个可用区部署副本，相对单可用区实例（主节点和副本节点在同一可用区），多可用区实例具有更高的可用性和容灾能力。
- 单可用区：主机、机架级容灾能力。
- 多可用区：主机、机架、可用区级容灾能力。

## 部署架构
![](https://main.qcloudimg.com/raw/855cfa6d9f004b589c708eeb12de1518.png)
架构说明：
- LB（负载均衡）：Redis 的标准架构和集群架构都有 Proxy，且 Proxy 的数量 >= 3，因此需要通过 LB 来均衡访问。
- VIP：多 AZ（可用区）的实例只有一个 VIP，这个 VIP 在整个 Region 都可以访问，Redis 的 HA（Highly Available）并不会导致 VIP 变化。
- Proxy：每个实例至少有3个 Proxy，标准架构的 Proxy = 3 + (副本数 - 1)，集群架构的 Proxy = 分片数 * 副本数。
- Master（Group）：Redis 的主节点或是所有分片的主节点被称为 Master（Group）。
- Replica（Group）：Redis 的副本节点或是集群实例的多个分片中的一个副本组成的集合被称为副本或者副本组 Replica（Group），集群架构的副本组是将一个分片的多个副本分到不同的组，以便于将不同的副本组部署到不同的可用区。
- 主可用区：主节点所在的可用区被称为主可用区，除非手动在控制台变更，否则主可用区将始终保持不变，主节点故障后可能会导致主节点切换到副本可用区，这个状态是临时的，HA 系统将在满足条件的前提下，在数分钟内将主节点迁回到主可用区，迁移过程是无损，除非您的业务使用了阻塞命令，如 blpop、blpush。

## 故障切换机制（HA）
- 故障判断：Redis 标准架构和集群架构采用的是 Redis Cluster 原生的集群管理机制，依靠集群内节点之间的 Gossip 协议来进行节点状态的判断，节点故障判断的时效性取决于 cluster-node-timeout，默认值是15ms，建议不要更改该参数。节点故障的判断请参考 [Redis Cluster 原生设计](https://redis.io/topics/cluster-tutorial)。
- 主节点选举：相对原生的 Cluster Failover 机制，腾讯云 Redis 引入了主可用区优先切换的逻辑，以保障主可用区业务的访问时延，具体机制如下：
 - 数据最新的节点优先选主。
 - 数据相同，主可用区的副本优先选主。

## 跨可用区访问
### 未开副本只读
未开启副本只读（读写分离）的实例，读写请求都会经过本可用区的 Proxy 路由到主节点，保障数据的一致性，同时保障最多仅有一次的 AZ 穿越。

### 开启副本只读
开启副本只读（读写分离）的实例，写请求将路由到主节点，读请求将路由到本可用区的副本节点，满足业务就近访问的诉求。

## 部署推荐
采用一主两副本，主 AZ 一主一副本，副本 AZ 一个副本，这种部署模式可以最大限度保障业务的可用性，及降低主机故障带来的延迟影响，因为在主 AZ 部署一个副本，主节点故障后，主可用区有一个副本可以优先选主，保障主可用区的访问延迟不会因为主节点切换到备可用区而受到影响。
![](https://main.qcloudimg.com/raw/2a37b9c9346ac86111073e14000cf5f0.png)
 
## 相关操作
- 云数据库 Redis 支持通过控制台配置多可用区和查看多可用区信息，请参见 [配置多可用区](https://cloud.tencent.com/document/product/239/51113)。
- 云数据库 Redis 支持通过控制台开启和关闭读写分离功能，请参见 [开关读写分离](https://cloud.tencent.com/document/product/239/19543)。
