云数据库 Redis 支持在控制台新建复制组，并在复制组添加主实例或者只读实例，实现复制组内一主或者多主架构数据同步的一致性。 

>?如需使用全球复制功能，请 [提交工单](https://console.cloud.tencent.com/workorder/category) 申请。

## 基本概念
- **实例角色：**复制组中的实例需分配不同的角色，包括：**主实例**与**只读实例**。
  - **主实例：**提供数据读写权限，用于业务数据写入。
  - **只读实例：**提供数据只读权限，用于数据只读或者数据容灾。
- **IP 地址：**复制组内每个实例拥有独立的 IP 地址，可以独立进行访问。
- **主备切换：**每个实例内部主节点和副本节点之间拥有自动主备故障切换能力，但是不会在主实例和只读实例之间进行自动故障切换。

## 版本说明
- 全球复制仅支持4.0标准架构、4.0集群架构、5.0标准架构、5.0集群架构实例。
- 全球复制当前版本仅支持单可用区部署的实例，后续将支持多可用区部署的实例。

## 使用须知
### 规格限制
-  全球复制组中的集群架构实例，最大支持64分片。
-  创建复制组时，必须指定复制组的主实例。
-  全球复制组目前最多支持添加4个实例，您可以选择1主3只读，或者4个主实例，或者2主2只读的部署方案。

### 地域限制
全球复制支持在腾讯云全球任意地域之间进行数据复制，不限制复制组内实例的部署位置，您可以在同可用区或者多可用区之间进行数据复制。
当前仅以下地域和可用区支持全球复制功能：

| 地域 | 可用区 | 
|---------|---------|
| 弗吉尼亚 | 弗吉尼亚二区 | 
| 北京 | 北京五区 | 
| 上海 | 上海五区 | 
| 中国香港 | 香港三区 | 
| 广州 | 广州六区 | 
| 新加坡 | 新加坡二区 | 
| 南京 | 南京三区 | 
  
### 命令说明
- **FLUSHDB** 或 **FLUSHALL** 命令会被同步到复制组内的所有实例，请谨慎操作。
- **Pub** 和 **Sub** 命令族不会被同步，如需实现跨域通知的消息复制，建议通过 Stream 数据结构来实现。
- 同步 **RESTORE** 命令时，如果目标子实例具备相同的 Key，则不会被执行。

## 计费说明
- 复制组内的实例未跨地域，将不会产生新的费用。
- 复制组内的实例跨地域复制，将收取跨地域复制数据的带宽费用。具体信息，请参见 [腾讯云对等连接定价](https://cloud.tencent.com/document/product/553/18833)。

## 新建全球复制组
### 前提条件
- 已 [创建云数据库 Redis 实例](https://cloud.tencent.com/document/product/239/30871)，且实例状态为**运行中**。
- 复制组的云数据库 Redis 主实例数据已清空。 

### 操作步骤
1. 登录 [Redis 控制台](https://console.cloud.tencent.com/redis)。
2. 在左侧导航栏，选择**全球复制**。
3. 在右侧 **Redis - 全球复制**页面，单击**新建复制组**。
4. 在**新建复制组**对话框，配置如下表的参数，单击**确定**。
<table width="100">
<thead><tr><th width="15%">参数</th><th width="55%">参数解释</th><th width="15%">是否必选</th><th width="15%">示例</th></tr></thead>
<tbody>
<tr>
<td>名称</td>
<td>给新建的复制组的命名，请您根据界面提示要求命名。</td>
<td>是</td>
<td>test</td></tr>
<tr>
<td>备注</td>    
<td>对复制组进行简要描述，可输入任意字符，便于您区分不同复制组的功能。</td>
<td>否</td>
<td>创建复制组测试</td></tr>
<tr>
<td>主实例地域</td> 
<td>选择复制组中主实例所在的地域。</td>
<td>是</td>
<td>广州</td></tr>
<tr>
<td>主实例选择</td> 
<td>选择复制组中的主实例，主实例必须为空实例。选择主实例之后，将提示实例的版本架构与内存容量，请您确认规格是否满足需求。</td>
<td>是</td>
<td>test-XXX</td></tr>
</tbody></table>
> !创建复制组指定的主实例需升级为全球复制版本的 Redis 内核，升级结束时会持续约5秒内的一次或者多次连接闪断。
> 
5. 返回 **Redis - 全球复制**页面，在复制组列表，您可查看到新创建的复制组。
单击复制组名称前面的<img src="https://qcloudimg.tencent-cloud.cn/raw/3a815073e7ccf4206decf7b522a40ccd.png" style="zoom: 67%;" />，展开复制组中的实例列表，可以查看复制组的主实例状态，等待系统升级全球复制内核，即可使用。
![](https://qcloudimg.tencent-cloud.cn/raw/49d3e0d7055e53744dd755456b6fa144.png)

## 给复制组添加实例
创建复制组之后，您可以根据实际需求向复制组添加同地域或者跨地域的实例，并分配实例角色为复制组的主实例或者只读实例，实现数据同步。

### 注意事项
- 目前不支持多可用区实例加入到复制组，后续支持将会公告。
- 一个复制组，最大支持添加**4**个实例，且实例数据必须为空，否则添加失败。后续将会支持存量有数据的实例加入复制组。
- 新添加的实例将从组内的主实例节点同步数据，在全量数据同步完成之前新加入的实例不可操作和访问。
- 实例加入复制组，将对实例进行内核版本升级，在升级结束时会有一段时间内的一次或者多次连接闪断。

### 前提条件
- 已创建全球复制组，且复制组状态为**运行中**。
- 已创建预加入复制组的实例，其兼容 Redis 的版本与架构版本必须与创建复制组时指定的主实例保持一致，内存容量务必大于等于创建复制组时指定的主实例的已使用容量，且实例状态为**运行中**。
- 如果预添加实例指定为主实例，最少有2个副本节点。
- 预加入复制组的实例，无论是主实例还是只读实例，请务必清空数据。

### 操作步骤
1. 在 **Redis - 全球复制**页面的 [实例列表](https://console.cloud.tencent.com/redis/replication) 中，选择需要添加实例的复制组。
2. 在复制组**操作**列，单击**添加实例**。
3. 在**添加实例**对话框，认真阅读注意事项，配置如下参数，单击**确定**。
  - **地域**：选择添加实例所属的地域。
  - **实例选择**：选择需添加的实例。
  - **实例角色**：给添加的实例分配角色，可以设置为复制组中的**只读实例**或者**主实例**。
> ? 给复制组添加实例，实例角色无限制，请您根据实际场景分配实例角色为只读实例或者为主实例。
> 
4. 返回 **Redis - 全球复制**页面，在复制组列表，单击复制组名称前面的<img src="https://qcloudimg.tencent-cloud.cn/raw/3a815073e7ccf4206decf7b522a40ccd.png" style="zoom: 67%;" />，展开复制组中的实例列表，可以查看新添加的实例。
![](https://qcloudimg.tencent-cloud.cn/raw/893341b5299627bf0813d3d1354c79a7.png)
添加实例之后，即可以进行复制组内实例的数据同步。您可以根据实际需求添加多个实例进行数据复制。

## 相关可用性说明
### 跨地域容灾
在一个复制组内，加入一个主实例和一个只读实例，搭建跨地域容灾系统。该系统不会自动执行灾备切换，您需通过控制台（或者通过云 API）进行切换。具体操作，请参见可 [切换实例角色](https://cloud.tencent.com/document/product/239/67318#qhsljs)。

### 复制异常情况
不论复制组内有一个主实例还是有多个主实例，当复制中断时，系统将不会设置主实例为只读实例或者进行其他操作，等待实例恢复后，将自动恢复增量日志的回放。建议您设置复制异常的告警，在复制异常（例如复制断开的场景）时，将主实例设置为只读实例来保证数据的一致性。

