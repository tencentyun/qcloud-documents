## 背景
云数据库 PostgreSQL 于2021年05月11日对实例 [监控功能](https://cloud.tencent.com/document/product/409/7564) 进行了升级，对老的部分监控策略进行了优化，新增了大量指标，并且全量支持5秒级监控。其中部分指标的采集数据和最大阈值会与旧的采集数据发生较大变化，本文主要介绍优化变动的细节。

## 指标采集数据变化
- **CPU 利用率指标**：指标将固定为100%作为最大值，当实例出现闲时超用也不会超过100%。用户设置告警阈值请以100%作为基准进行设置。

- **已用存储空间** ：旧指标采集数据仅计算了数据文件空间，未将实例的日志文件等其他文件计算在内。但实际磁盘用量是根据实例所有文件总和来进行计算的。
对于此，为避免用户使用和功能上的偏差，特将已用存储空间标准化为：数据文件（datafile）、重做日志文件（xlog/wal）、数据库运行日志文件（pg_log）、数据库程序文件等所有文件所占用的存储空间总和。所以用户在监控指标中查看到的已用存储空间会发生一个较大的跳变。
- **存储空间使用率** ： 此指标同已用存储空间指标类似，当前数据计算方案为：**已用存储空间/实例购买的存储空间 * 100%**。
- **每秒查询率 QPS** ： 此指标的中文名将修改为 **QPS**，旧的中文名描述存在歧义，实际的采集单位是**次/秒**。
- **请求数**： 此指标旧的单位为“次/分钟”，因为支持了秒级监控后，此指标含义将发生变化，指每一个采集周期内的总请求数，所以此指标单位将修改为“次”。而一分钟粒度和五分钟粒度的聚合方式以前采用的是平均值，所以本次也统一修改为求和。但是在功能发布之后旧的监控指标值将无法再进行查看。
- **读请求数**：此指标旧的单位为“次/分钟”，因为支持了秒级监控后，此指标含义将发生变化，指每一个采集周期内的总请求数，所以此指标单位将修改为“次”。而一分钟粒度和五分钟粒度的聚合方式以前采用的是平均值，所以本次也统一修改为求和。但是在功能发布之后旧的监控指标值将无法再进行查看。
- **写请求数**：此指标旧的单位为“次/分钟”，因为支持了秒级监控后，此指标含义将发生变化，指每一个采集周期内的总请求数，所以此指标单位将修改为“次”。而一分钟粒度和五分钟粒度的聚合方式以前采用的是平均值，所以本次也统一修改为求和。但是在功能发布之后旧的监控指标值将无法再进行查看。
- **其他请求数**：此指标旧的单位为“次/分钟”，因为支持了秒级监控后，此指标含义将发生变化，指每一个采集周期内的总请求数，所以此指标单位将修改为“次”。而一分钟粒度和五分钟粒度的聚合方式以前采用的是平均值，所以本次也统一修改为求和。但是在功能发布之后旧的监控指标值将无法再进行查看。
- **主备 XLOG 同步差异** ：此指标中文名将修改为**备库日志发送与回放位置差异**，此指标表示重做日志从主库发送至备库与备库回放完成之间的大小差异，主要反映了备库日志应用的速度，通过此指标可查看出备库的性能，以及网络传输的速度。且此指标只有主实例有，只读实例无此指标。
- **主备时间差异**：此指标中文名将修改为**备库日志落盘时间延迟**，此指标反映了日志从主库发送至备库与备库接收到日志并落盘之间的时间差异，且只有10.x以上版本的主实例才有此指标。
- **idle 的连接数** ：此指标中文名修改为**空闲连接数**。
- **活跃的连接数** ：此指标中文名修改为**活跃连接数**。
- **空闲的事务数量**：此指标中文名修改为**空闲事务数**。
- **等待会话**：此指标中文名修改为**等待会话数**。
- **超过5秒的空闲事务**：此指标中文名修改为**超过5秒的空闲事务数**。
- **超过5秒未提交的2PC事务**：此指标中文名修改为**超过5秒未提交的2PC事务数**。

## 新增指标
- **每秒索引扫描回表记录数** ：平均每秒通过索引扫描的 tupe 数量。	
- **每秒全表扫描记录数** ：平均每秒全表扫描的 tupe 数量。	
- **死锁数** ：在一个采集周期内的所有死锁数。		
- **每秒更新记录数** ：平均每秒更新的 tupe 数量。	
- **每秒插入记录数** ：平均每秒插入的 tupe 数量。
- **每秒删除记录数** ：平均每秒删除的 tupe 数量。	
- **主备数据同步延迟**：对于主实例而言，此指标可以反映出故障切换的时长。在只读实例中，此指标名为**与主实例数据同步延迟**，表示只读实例在多少时间后，能够查询到在主库进行写入的数据。
