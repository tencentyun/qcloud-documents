## 读写容量模式概述
TcaplusDB 使用读写容量模式来计算表的读写请求量。

### 容量单元（CU，Capacity Unit）
指访问资源的最小请求单位，是请求数据读和请求数据写的最小统计单元。

### 读容量单元（RCU，Read Capacity Unit）
读容量单元是读取请求的最小单元，一次请求所产生的数据响应容量可能包含多个读容量单位，一个读容量单位最大值为4KB，即一个读取请求单位表示对大小最多为4KB的项目执行一次读取请求。如果需要对大于4KB的数据进行读取请求，则需要额外的请求单位。

读容量单元的基数为4KB。未满4KB的单次请求以4KB计算，超过4KB的请求以4KB的倍数算，余数均向4取整为4KB。
消耗 RCU 数 = 请求 CU + 响应 CU + 返回 CU

示例如下：
- **未命中的读请求**
用户发送了一个请求，需要查询的内容共10KB，但是内存中并未缓存此数据，数据库需要将磁盘中50KB的数据读取到内存中进行响应，然后从中获取需要的数据，将其返回给用户。此时请求量为1KB，为1CU；响应的数据为50KB，响应的 CU 数为13；返回量为10KB，为3CU。
- **命中的读请求**
用户发送了一个请求，需要查询的内容共10KB，且内存中存在此数据，此时数据库将直接返回此10KB数据给用户。此时请求量为1KB，为1CU；响应的数据为10KB，响应的 CU 数为3；返回量为10KB，为3CU。
- **未命中的读操作消耗 CU 数**
产生了1CU（请求大小1KB）+ 13CU（内存从磁盘中读取50KB）+ 3CU（返回的10KB）= 17RCU
- **命中的读操作消耗 CU 数**
产生了1CU（请求大小1KB）+ 3CU（内存返回10KB）+ 3CU（返回的10KB）= 7RCU


### 写容量单元（WCU，Write Capacity Unit）
写容量单元是写入请求的最小单元，一次写请求所产生的数据写入容量可能包含多个写容量单元，单个写容量单元最大值为4KB，即每写入4KB的数据则记作一次写请求单位。

写容量单元的基数是4KB，单次请求写入容量不超过4KB的以4KB计算。超过4KB的写入请求，小数均向上取整。
消耗 WCU 数 = 请求 CU + 占用内存的 CU + 写磁盘的 CU + 返回 CU

示例如下：
- **写请求**
一个用户发送了一个请求，需要更新5KB的内容，后台将需要更新的数据所在的记录从磁盘读取到内存（共50KB），
然后更新相关记录，完成更新后，将50KB内容刷新到磁盘当中。
如果用户开启了写操作返回记录，将返回5KB的内容给用户。
- **开启写操作返回**
产生了1CU（请求大小1KB）+ 13CU（内存占用50KB）+ 13CU（50KB写盘）+ 2CU（返回的5KB）= 29WCU
- **未开启写操作返回**
产生了1CU（请求大小1KB）+ 13CU（内存占用50KB）+ 13CU（50KB写盘）+ 1CU（返回的0.1KB）= 28WCU

### 预置模式
如果您选择预置模式，则需要根据访问变化调整表的预置读写容量。此操作可帮助您控制对 TcaplusDB 的使用，使之保持或低于定义的请求速率，以便获得成本可预测性。

为了更好地配置预置容量，您需要对应用程序流量进行提前预估。

#### 预留读
指对表格进行读取容量单元的预配置，每日计费时将根据表格配置的预置读取容量单元进行统计计算。

#### 预留写
指对表格进行写入容量单元的预配置，每日计费时将根据表格配置的预置写入容量单元进行统计计算。

#### 预留容量
指对表格进行占用磁盘容量的预配置。

#### 请求限制与超出配额
针对用户因 RCU 或者 WCU 配置得过低，又因突然增长的访问请求场景，TcaplusDB 将对超过预配置 RCU 和预配置 WCU 40%的请求进行限制，此限制并非限制请求无法访问，而是对请求进行排队，降低访问频率，程序可能会出现超时现象。用户可通过监控告警功能得知当前请求数超过预配置能力40%。

限制会阻止您的应用程序消耗太多容量单位。当请求受到限制时，请求将失败并出现代码 HTTP 400 (Bad Request)，您无需自行编写此逻辑。

您可以使用 TcaplusDB 表格监控监视实际读写容量单元，并在必要时修改表格配额。
