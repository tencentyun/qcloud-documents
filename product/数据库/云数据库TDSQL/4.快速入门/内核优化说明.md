## 1. 内核优化概述

腾讯云 MariaDB/Percona 在社区版本基础上，做了大量内核优化，除了一部分性能、稳定性、可靠性优化外，还有一部分功能是用户可见的。这些功能大多是在腾讯在海量运维和业务需求基础上实现的。这里为大家介绍逐一介绍部分可见功能。

## 2. 主从复制相关功能
### 2.1 概述
为了防止从机复制执行过慢，MariaDB默认使用row格式的binlog复制。而MySQL（含MariaDB、Percona等分支）的一个update/delete语句如果更新/删除了很多行，复制到从机时，则需要使用索引扫描或者全表扫描来找到这个行，导致复制效率变得非常慢，这将导致严重的从机数据延迟，进而引入大量问题。为了避免这些问题的引入，我们支持“自动增加主键”和“禁止create table/alter table语句产生无主键的表”等功能，详见下文。

### 2.2 自动增加主键

顾名思义，该功能主要是在用户创建表（且未定义主键时），自动在表中添加一列自增列作为主键。为此，我们新增了`reject_table_no_pk`这个参数，该参数设置为 1 时，自动增加主键功能生效。而该参数默认设置为`reject_table_no_pk=1`。

### 2.3 禁止create table/alter table语句产生无主键的表

当“自动增加主键”功能关闭时（即`reject_table_no_pk=0`），如果`create table`语句没有创建主键和唯一索引的子句，那么系统将返回建表错误，错误码为“1173”，提示信息为“This table type requires a primary key”。

如果`alter table`语句删除了主键或者唯一索引，导致这个表没有了主键和唯一索引，也会返回这个错误。

**该功能无效的情况：**
	
- 	对于从机无效，以便防止因用户配置疏忽导致主从上面这个功能的开关变量配置不同，进而导致从机无法复制。
- 	对系统数据库(`xa, sys, mysql, information_schema, performance_schema,sysdb`)中的表无效。

### 2.4 禁止远程用户修改sql_log_bin
主从架构高可用时，集群时刻都依赖replication完成主从复制同步。主从复制对高可用集群来说总是必须的。为避免误操作关闭了`sql_log_bin`，导致主从复制异常，我们禁止TCP/IP连上来的用户来修改`sql_log_bin`变量。（但仍可以通过公有云后台控制系统chitu来调整）

## 3. 事务一致性保障
### 3.1 概述
由于历史遗留问题，已有的应用、组件等仍然会创建和使用MyISAM。由于MyISAM不支持事务，将集群存在很大的数据一致性风险。我们建议用户尽量不使用MyISAM，虽然对此我们不做限制，目前我们做了如下功能

### 3.2 将建表语句中指定的存储引擎替换为默认存储引擎

某些SQL显式指定使用MyISAM，为了既能让这些组件正确工作又不使用MyISAM等非事务存储引擎，我们开发了这个功能，目前该功能仅在**Percona引擎中生效**。

使用该功能，用户需要设置字符串变量，例如 `converted_storage_engines='myisam,memory,heap'`合法值是目前系统支持的存储引擎名称字符串，用逗号隔开。如果建表语句使用的是这个列表里面的某个存储引擎，那么转而使用`default_storage_engine`变量所指定的存储引擎`DEF-SE`来建表。如果`DEF-SE`需要的某些配置项在建表语句不存在，那么使用其默认值；

>这一段有点拗口，没看懂。



### 3.3 禁止创建MyISAM表
对于`converted_storage_engines`是空值的情况，则禁止用户创建MyISAM表。如果`create table/alter table`语句导致目标表创建了MyISAM表，数据库将返回错误，服务器端错误号是10001，错误信息：“Can not create tables in myisam storage engine in user databases, controled by reject_create_table_myisam variable.” 

**该功能无效的情况：**
- 对于从机无效，以便防止因用户配置疏忽导致主从上面这个功能的开关变量配置不同，进而导致从机无法复制。
- 对于系统数据库(`xa, sys, mysql, information_schema, performance_schema,sysdb`)中的表无效。该功能在`reject_create_table_myisam=ON`时候生效，该变量默认是ON。

>这一段有点拗口，没看懂。

## 4 SQL语句执行规模控制
### 4.1 概述
某个SQL语句开销过大会严重增加系统负载，降低系统的TPS，甚至影响系统可用性。有时候，某些SQL开销过大并不是用户需求，可能只是人为错误，甚至SQL注入等。因此，腾讯在数据库内核中可以限制SQL语句执行的规模。即通过限制临时表的大小，或强制`delete/update/select`增加`limit`子句。**该功能仅在MariaDB中支持，且默认都是关闭的。**

### 4.2 限制临时表大小
对于创建在myisam上面的临时表，用户可以设置全局变量 `max_temp_table_size`来限定临时表的大小，该值默认是0，表示没有限制。
例如，可以设置`max_temp_table_size=16K`，当查询执行过程中任意一个临时表的`temp_table_size`大于这个限定值时候，查询直接返回失败，服务器端错误号：1114，错误字符串是：“The table 'xxx' is full。”

> 这一段有点拗口，没看懂。这个变量具体怎么设置呢？没举例。后面一段删除了，得看看意思是否表达完整。

### 4.3 强制delete/update/select语句增加limit子句
用户可以设置`select_rows_limit/delete_rows_limit/update_rows_limit ` 3个动态的全局变量，来强制添加用户必须显示指定limit子句来做规模限制。当然，开启变量后，用户也可以显示指定`NO_LIMIT`关键字，来避免这个限制。


> 这一段有点拗口，没看懂。这个变量具体怎么设置呢？没举例。

### 4.4 限制事务的binlog写入量
通过参数`XXXXXXXXXXXXXX`限制一个事务中写入的binlog总量，当达到配置的最大值时候，当前DML语句返回错误，并在数据库中回滚该事务。检查在DML执行时即做，而不是在事务提交时刻。控制binlog写入量是主要是为了，
- 防止超大事务导致锁表；
- 防止同步超时，binlog量过大会导致强同步等待超时
- 异常操作导致事务错误，比如用户误操作无条件删表等


**该功能无效的情况：**

- 从机写入binlog量不受限制，防止主机上面放行的事务在从机上面被卡住。
 
> 这一段有点拗口，没看懂。这个变量具体怎么设置呢？没举例。这里有个放行，怎么放行。

## 5 系统安全机制
### 5.1 概述
基于一些信息安全要求，我们对数据库内核也做了大量优化

### 5.2 禁止直接访问mysqld服务器文件系统
为了确保mysqld服务器文件系统的安全，对于tcp/ip登录的用户，即使该账号有权限，也禁止如下操作：

** 1. 禁止用户通过以下SQL语句在mysqld运行的服务器上面创建或者打开文件**
```
	select ... into dump file；
	select ... into outfile；
	load data infile ...
```
** 2．禁止写入"路径变量不是正常路径，而是由字符串组成的 “真值”，或“变量”" 这样的语法来读写路径变量的值。** 这是为了防止非法用户得知服务器的目录结构后，采用“目录穿越攻击”等方案。

根据大量的入侵案例和报告中，非法用户经常通过`select into out file`来把其本地的攻击程序传输到服务器端，或采用目录穿越攻击（Path Traversal攻击）随意地打开、查看，甚至执行网站内的文件。有了这些禁止措施，用户将无法通过TCP/IP连接的客户端在mysqld服务器上面创建或打开任意文件，用户创建的文件只有数据表文件等完全受mysqld掌控的文件。用户只能传输DDL/DML等SQL语句字符串以及得到它们的查询结果。

### 5.3 防止用户误删除和修改元数据
只允许 unix socket 连接且具有权限的用户删除系统数据库 `mysql, information/performance_schema, xa, sys, sysdb`及其中的表，并且禁止非 unix socket 连接或不具有权限的用户 `alter/truncate` 表，或更新、删除这些表中的行。

某些案例中，有一些非法用户通过可能通过一些未知的业务系统漏洞去修改系统表，进而提权、做破坏或放开更多漏洞，禁止这种方式后可有效避免类似情况发生；也有用户误删除了系统数据库或表，然后试图挽回于是自己重新创建了一个系统表，可想而知，其他地方copy过来的系统表，与原系统表会有差异，结果导致各种系统异常。

### 5.4 阻止远程用户安装插件
MySQL提供了标准的接口允许用户实现自定义的功能（安装插件），这个机制虽然灵活，但也是巨大的安全隐患。如果被非法用户利用，就可以在mysqld服务器上面以linux用户的身份执行任意代码。所以，我们禁止通过TCP/IP连接上来的用户执行`INSTALL PLUGIN`语句安装插件。

### 5.5 阻止远程用户修改和读取安全开关变量
为在灵活性与安全性中间予以平衡，上述安全机制都有开关控制（默认打开），我们将禁止远程用户修改和读取这些开关变量，防止非法用户关闭上述安全措施。

## 6. 其他优化
1. 禁止用户设置 `binlog_format=statement` 和 `tx_isolation=read-committed` 的组合,因为这将导致insert语句失败。
2. 允许用户不需要SUPER权限就可以修改session级别的 `binlog_format`，因为有时候用户不得不暂时修改`binlog_format`以便避免产生了海量的binlog导致无法执行DML语句，或者因为历史原因原有的某些数据表没有主键和唯一索引导致某些update/delete语句在从机上面执行太慢等场景。不过需要注意的是，当您`set session binlog_format=statement`后，MariaDB或Percona强同步机制中非常重要的**“闪回”**就无法正确工作了，请在使用该功能后，尽快将`binlog_format`改回`row`格式。
3. 当用户执行`drop table`或者`alter table ... drop partition `时，innodb不再立刻删除表空间文件，而是将这些文件重命名并且在后台逐步缩小这些文件并最终删除。这样做是为了避免一次性删除巨大的表空间文件给服务器的文件系统带来突增的IO负载，导致系统的TPS/QPS和响应时间出现波动。如果用户执行`drop database`，那么不再慢速删除，而是立刻删除所有表。同理，对于`purge binary logs to`命令也会做同样的慢速删除操作。
 
> 腾讯修复的mysql的bug，都以回馈社区，上报官方并提供了patch。