本文介绍使用 DTS 数据迁移功能从 SQL Server 迁移数据至腾讯云数据库 SQL Server 的操作指导。

## 注意事项 
- DTS 在执行全量数据迁移时，会占用一定源端实例资源，可能会导致源实例负载上升，增加数据库自身压力。如果您的数据库配置过低，建议您在业务低峰期进行迁移。
- 全量迁移过程通过有锁迁移来实现，锁表过程中会短暂（秒级）阻塞写入操作。

## 前提条件
- 已 [创建云数据库 SQL Server](https://cloud.tencent.com/document/product/238/36822)。
- 源数据库和目标数据库符合迁移功能和版本要求，请参见 [数据迁移支持的数据库](https://cloud.tencent.com/document/product/571/58686) 进行核对。
- 已完成 [准备工作](https://cloud.tencent.com/document/product/571/59968)。
- 源数据库所在的服务要开放文件共享端口445。
- 源数据库必须得设置为“完全恢复模式”，且在迁移前建议用户自己做下全量备份。
- 源数据库所在本地磁盘空间需要足够大，剩余空闲空间能放下要迁移库的大小。 
- 当源实例非腾讯云 SQL Server 实例（公网/CVM 自建实例、其他云厂商实例）或腾讯云单节点（原基础版） SQL Server 实例时，目标端需使用具有 sysadmin 权限的帐号进行迁移，且需要能够运行 xp_cmdshell 存储过程，当源实例为腾讯云双节点（原高可用版/集群版） SQL Server 时，目标端帐号无权限限制。
- 迁移源端的 SQL 服务启动账号需要改为内置账户 Local System 启动，源端迁移的数据库账号无限制，但是需要有 sysadmin 权限。
![](https://qcloudimg.tencent-cloud.cn/raw/20d71b4aecb2e260cbc544f47ea3c533.png)
如图所示，迁移源端的 SQL 服务启动，启动配置中的**登录身份**，选择**内置账户**，并修改为 Local System 启动。
>!修改账号后需要重启 SQL server 服务。

## 应用限制
- 同一源实例同一时间只能发起一个迁移任务。
- 当前中国大陆及中国香港地域可以支持跨地域迁移，其他地域不支持跨地域迁移。
- 只支持库粒度迁移，即在迁移过程中，只支持将库的所有对象一起迁移，不支持单个表的迁移。
- 不支持迁移实例级别的 login、job agent、触发器、db link （link server）。

## 操作限制
- 迁移过程中，请勿修改、删除源数据库和目标数据库中用户信息（包括用户名、密码和权限）和端口号，否则会导致迁移任务失败。
- 增量同步的过程中，不能进行事务日志备份，否则会截断事务日志，导致事务日志不能连续。
- 如果仅执行全量数据迁移，请勿在迁移过程中向源实例中写入新的数据，否则会导致源和目标数据不一致。针对有数据写入的场景，为实时保持数据一致性，建议选择全量 + 增量数据迁移。
- 针对全量 + 增量数据迁移，当单击**完成**，任务状态为**完成中**时，请勿向源数据库中写入新的数据，建议在单击**完成**前至少2分钟停写新的数据，否则可能会导致源和目标库的数据不一致。

## 支持的 SQL 操作
| 操作类型 | 支持的 SQL 操作                                              |
| -------- | ------------------------------------------------------------ |
| DML      | INSERT、UPDATE、DELETE、REPLACE                              |
| DDL      | TABLE：CREATE TABLE、ALTER TABLE、DROP TABLE、TRUNCATE TABLE、RENAEM TABLE <br>VIEW：CREATE VIEW、ALTER VIEW、DROP VIEW<br>INDEX：CREATE INDEX、DROP INDEX <br>DATABASE：CREATE DATABASE、ALTER DATABASE、DROP DATABASE |

## 环境要求
>?如下环境要求，系统会在启动迁移任务前自动进行校验，不符合要求的系统会报错。如果用户能够识别出来，可以参考 [校验项检查要求](https://cloud.tencent.com/document/product/571/58685) 自行修改，如果不能则等系统校验完成，按照报错提示修改。

| **类型**       | **环境要求**                                                 |
| :------------- | :----------------------------------------------------------- |
| 源数据库要求   | <li>源实例所在的服务需要开放文件共享端口445。<br><li>源库和目标库网络能够连通。<br/><li>源库所在的服务器需具备足够的出口带宽，否则将影响迁移速率。 |
| 目标数据库要求 | <li>仅支持单节点（原基础版）迁移到双节点（原高可用版/基础版），且目标实例的版本号需要大于或等于源实例的版本号。<br/><li>目标库不能有和源库同名的库。<br/><li>目标库所在的磁盘空间要大于源库大小，要为源库的1.5倍。<br/><li>目标库不能有访问，不能有负载业务进行，否则会导致迁移失败。</li> |

## 操作步骤
1. 登录 [DTS 控制台](https://console.cloud.tencent.com/dts/migration)，在左侧导航选择**数据迁移**页，单击**新建迁移任务**，进入新建迁移任务页面。
2. 在新建迁移任务页面，选择迁移的源实例类型和所属地域，目标实例类型和所属地域，规格等，然后单击**立即购买**。
<table>
<thead><tr><th>配置项</th><th>说明</th></tr></thead>
<tbody><tr>
<td>源实例类型</td>
<td>请根据您的源数据库类型选择，购买后不可修改。本场景选择“SQL Server”。</td></tr>
<tr>
<td>源实例地域</td>
<td>选择源数据库所属地域。如果源库为自建数据库，选择离自建数据库最近的一个地域即可。</td></tr>
<tr>
<td>目标实例类型</td>
<td>请根据您的目标数据库类型选择，购买后不可修改。本场景选择“SQL Server”。</td></tr>
<tr>
<td>目标实例地域</td>
<td>选择目标数据库所属地域。</td></tr>
<tr>
<td>规格</td>
<td>根据业务情况选择迁移链路的规格，不同规格的性能和计费详情请参考<a href="https://cloud.tencent.com/document/product/571/18736">计费概述</a>。</td></tr>
</tbody></table>
3. 在设置源和目标数据库页面，完成任务设置、源库设置和目标库设置，测试源库和目标库连通性通过后，单击**新建**。
>?如果连通性测试失败，请根据提示和 [修复指导](https://cloud.tencent.com/document/product/571/58685) 进行排查和解决，然后再次重试。
>
<table>
<thead><tr><th width="10%">设置类型</th><th width="20%">配置项</th><th width="70%">说明</th></tr></thead>
<tbody>
<tr>
<td rowspan=3>任务设置</td>
<td>任务名称</td>
<td>设置一个具有业务意义的名称，便于任务识别。</td></tr>
<tr>
<td>运行模式</td>
<td><ul><li>立即执行：完成任务校验通过后立即启动任务。</li><li>定时执行：需要配置一个任务执行时间，到时间后启动任务。</li></ul></td></tr>
<tr>
<td>标签</td>
<td>标签用于从不同维度对资源分类管理。如现有标签不符合您的要求，请前往控制台管理标签。</td></tr>
<tr>
<td rowspan=6>源库设置</td>
<td>源库类型</td><td>购买时选择的源库类型，不可修改。</td></tr>
<tr>
<td>所属地域</td><td>购买时选择的源库地域，不可修改。</td></tr>
<td>接入类型</td><td>请根据您的场景选择，本场景以“云数据库”为例，不同接入类型的准备工作请参考 <a href="https://cloud.tencent.com/document/product/571/59968">准备工作概述</a>。
<ul><li>公网：源数据库可以通过公网 IP 访问。</li>
<li>云主机自建：源数据库部署在 <a href="https://cloud.tencent.com/document/product/213">腾讯云服务器 CVM</a> 上。</li>
<li>专线接入：源数据库可以通过 <a href="https://cloud.tencent.com/document/product/216">专线接入</a> 方式与腾讯云私有网络打通。</li>
<li>VPN 接入：源数据库可以通过 <a href="https://cloud.tencent.com/document/product/554">VPN 连接</a> 方式与腾讯云私有网络打通。</li>
<li>云数据库：源数据库属于腾讯云数据库实例。</li>
<li>云联网：源数据库可以通过 <a href="https://cloud.tencent.com/document/product/877">云联网</a> 与腾讯云私有网络打通。</li>
</ul>对于第三方云厂商数据库，一般可以选择公网方式，也可以选择 VPN 接入，专线或者云联网的方式，需要根据实际的网络情况选择。</td></tr>
<tr>
<td>数据库实例</td><td>选择源库的实例 ID。</td></tr>
<tr>
<td>帐号</td><td>源库 SQL Server 的数据库帐号，帐号权限需要满足要求。</td></tr>
<tr>
<td>密码</td><td>源库 SQL Server 的数据库帐号的密码。</td></tr>
<tr>
<td rowspan=6>目标库设置</td>
<td>目标库类型</td><td>购买时选择的目标库类型，不可修改。</td></tr>
<tr>
<td>所属地域</td><td>购买时选择的目标库地域，不可修改。</td></tr>
<tr>
<td>接入类型</td><td>根据您的场景选择，本场景选择“云数据库”。</td></tr>
<tr>
<td>数据库实例</td><td>选择目标库的实例 ID。</td></tr>
<tr>
<td>帐号</td><td>目标库的数据库帐号，帐号权限需要满足要求。</td></tr>
<tr>
<td>密码</td><td>目标库的数据库帐号的密码。</td></tr>
</tbody></table>
4. 在设置迁移选项及选择迁移对象页面，设置迁移类型、对象，单击**保存**。
<img src="https://main.qcloudimg.com/raw/6654049f9b211e28515d6f4fba0ac7f3.png"  style="zoom:80%;">
<table>
<thead><tr><th>配置项</th><th>说明</th></tr></thead>
<tbody><tr>
<td>迁移类型</td>
<td>请根据您的场景选择。<ul><li>全量迁移：迁移整个数据库，迁移数据仅针对任务发起时，源数据库已有的内容，不包括任务发起后源库实时新增的数据写入。</li><li>全量 + 增量迁移：迁移数据包括任务发起时源库的已有内容，也包括任务发起后源库实时新增的数据写入。如果迁移过程中源库有数据写入，需要不停机平滑迁移，请选择此场景。</li></ul></td></tr>
<tr>
<td>指定对象</td>
<td>只支持库粒度迁移，即指定库的所有对象需要一起迁移。在源库对象中选择待迁移的库，然后将其移到已选对象框中。</td></tr>
</tbody></table>
5. 在校验任务页面，进行校验，校验任务通过后，单击**启动任务**。[](id:BZ5)
    如果校验任务不通过，可以参考 [校验不通过处理方法](https://cloud.tencent.com/document/product/571/58685) 修复问题后重新发起校验任务。
 - 失败：表示校验项检查未通过，任务阻断，需要修复问题后重新执行校验任务。
 - 警告：表示检验项检查不完全符合要求，可以继续任务，但对业务有一定的影响，用户需要根据提示自行评估是忽略警告项还是修复问题再继续。
![](https://main.qcloudimg.com/raw/bc3d1fd2be94fd7848ce805bc2f52399.png)
6. 返回数据迁移任务列表，任务进入准备运行状态，运行1分钟 - 2分钟后，数据迁移任务开始正式启动。[](id:BZ6)
   - 选择**全量迁移**：任务完成后会自动结束，不需要手动结束。
   - 选择**全量 + 增量迁移**：全量迁移完成后会自动进入增量数据同步阶段，增量数据同步不会自动结束，需要您手动单击**完成**结束增量数据同步。
      - 请选择合适时间手动完成增量数据同步，并完成业务切换。
      - 观察迁移阶段的状态为**准备完成**，将源库停写几分钟，之后再手动完成增量同步。
7. （可选）如果您需要进行查看任务、删除任务等操作，请单击对应的任务，在**操作**列进行操作，详情可参考 [任务管理](https://cloud.tencent.com/document/product/571/58674)。
8. 当迁移任务状态变为**任务成功**时，即可对业务进行正式割接，更多详情可参考 [割接说明](https://cloud.tencent.com/document/product/571/58660)。

## 迁移前校验任务检查项
- 迁移参数检查 
- 迁移网络检查 
- 源库连接性检查 
- 目的库连接性检查 
- 硬盘空间检查
- 字符集检查
- 数据库版本检查
- 用户权限检查
- 源库存在性检查
- 目的库存在性检查

[](id:JYQJYSB)
## 迁移前校验失败错误详情及解决方案
在上述操作 [步骤5](https://cloud.tencent.com/document/product/238/50268#BZ5)，进行校验时，有检查项校验失败，可单击**查看详情**了解导致校验失败的原因以及处理建议。
![](https://qcloudimg.tencent-cloud.cn/raw/ee9e0c02198df528885ceb22055e538c.png)
下表为您列举校验失败的错误详情及对应解决建议。

| 序号 | 错误详情 | 建议 |
|---------|---------|---------|
| 1 | 迁移的数据库在目标实例中已经存在。 | 请更换源实例中迁移的数据库或者请将目标实例上和迁移数据库重名的库删除。 |
| 2 | 提供的迁移账号无法登录 | 1. 请检查源实例是否已经处于运行中状态。<br>2. 请检查源实例端口是否被防火墙安全组阻止访问。<br>3. 请检查源实例端口是否填写错误。<br>4. 请检查源实例的账号和密码是否填写错误。 |
| 3 | 迁移的数据库名称不符合规范，数据库名称只允许由“字母”/“数字”/“_”组成，必须由字母开头。 | 请更换源实例中迁移的数据库或者请将源实例中迁移的数据库按照命名提示规范重命名，之后再进行迁移。 |
| 4 | 迁移的数据库名称长度至少是1个字符。 | 请更换源实例中迁移的数据库或者请将源实例中迁移的数据库按照命名提示规范重命名，之后再进行迁移。 |
| 5 | 迁移的数据库名称长度最长不超过64个字符。 | 请更换源实例中迁移的数据库或者请将源实例中迁移的数据库按照命名提示规范重命名，之后再进行迁移。 |
| 6 | 迁移的数据库名称中包含敏感字符。 | 请更换源实例中迁移的数据库或者请将源实例中迁移的数据库进行重命名，去掉非法字符后再进行迁移。 |
| 7 | 等待网络检查。 | 请等待网络检查，无需操作处理。 |
| 8 | 网络检查失败。 | 请 [提交工单](https://console.cloud.tencent.com/workorder/category?level1_id=10&level2_id=99&source=14&data_title=%E4%BA%91%E6%95%B0%E6%8D%AE%E5%BA%93SQLServer&step=1)，获取解决方案。 |
| 9 | 检查数据传输服务器是否能连通源数据库。 | 1. 请检查源实例的 SQL 服务启动账号是否是使用内置账户 Local System 启动的，需要将启动配置中的“登录身份”选择“内置账户”并修改为 Local System 账户启动。<br>2. 请检查源实例是否开启了 xp_cmdshell，需要将 xp_cmdshell 开启。<br>3. 请检查迁移账号需要有 sysadmin 权限。 |
| 10 | 迁移账号权限不足，无法完成迁移。 | 1. 请检查源实例的 SQL 服务启动账号是否是使用内置账户 Local System 启动的，需要将启动配置中的“登录身份”选择“内置账户”并修改为 Local System 账户启动。<br>2. 请检查源实例是否开启了 xp_cmdshell，需要将 xp_cmdshell 开启。<br>3. 请检查迁移账号需要有 sysadmin 权限。 |
| 11 | 检查目的服务器硬盘空间是否足够。 | 请检查目标实例购买的磁盘空间大小，建议目标实例的磁盘空间不小于源实例的磁盘空间，尽量为源实例磁盘空间大小的1.5倍，可通过控制台的 [调整实例规格](https://cloud.tencent.com/document/product/238/67863) 功能扩容目标实例的磁盘空间大小。 |
| 12 | 检查字符集是否一致。 | 请检查字符集是否一致，如不一致，请将源数据库和目的数据库的字符集调整为一致。 |
| 13 | 检查数据库版本号是否一致。 | 请检查源实例及目标实例的数据库版本，高版本实例不能向低版本实例迁移，例如：源实例2012版本不能迁移到目标实例2008版本。目标实例的版本必须要大于或等于源实例的版本才可进行迁移，可以通过控制台的 [调整实例版本](https://cloud.tencent.com/document/product/238/67862) 功能升级目标实例的版本。 |
| 14 | 检查目标实例权限是否存在。 | 请 [提交工单](https://console.cloud.tencent.com/workorder/category?level1_id=10&level2_id=99&source=14&data_title=%E4%BA%91%E6%95%B0%E6%8D%AE%E5%BA%93SQLServer&step=1)，获取解决方案。 |
| 15 | 检查源数据库是否存在。 | 在源实例中未找到待迁移的数据库，请确定待迁移的数据库在源实例是否存在。 |
| 16 | 检查目标数据库是否存在。 | 迁移的数据库在目标实例已经存在，请把目标实例上和迁移数据库重名的数据库删除或重命名后再进行重试。 |
| 17 | 连不上源服务器，请检查账号密码是否正确。 | 1. 请检查源实例的 SQL 服务启动账号是否是使用内置账户 Local System 启动的，需要将启动配置中的“登录身份”选择“内置账户”并修改为 Local System 账户启动。<br>2. 请检查源实例是否开启了 xp_cmdshell，需要将 xp_cmdshell 开启。<br>3. 请检查迁移账号需要有 sysadmin 权限。 |
| 18 | 检查数据传输服务器是否能连通目标数据库。 | 请 [提交工单](https://console.cloud.tencent.com/workorder/category?level1_id=10&level2_id=99&source=14&data_title=%E4%BA%91%E6%95%B0%E6%8D%AE%E5%BA%93SQLServer&step=1)，获取解决方案。 |

[](id:JYZRWSB)

## 迁移中的迁移步骤流程
1. 禁止备份作业。
2. 备份数据库。
3. 传输备份文件。
4. 恢复数据库。
5. 部署实时同步。

## 迁移中任务失败错误详情及解决方案
在上述操作 [步骤6](https://cloud.tencent.com/document/product/238/50268#BZ6)，迁移任务正式启动后，如出现任务失败，可单击**错误信息**了解导致任务失败的原因，单击**错误详情**了解处理建议。
![](https://qcloudimg.tencent-cloud.cn/raw/d152307ba7a36db531da61ec036a3bad.png)
下表为您列举迁移中任务失败的错误信息及处理建议。

| 序号 | 错误信息 | 建议 |
|---------|---------|---------|
| 1 | 任务失败！请提交工单，获取解决方案。 | 请 [提交工单](https://console.cloud.tencent.com/workorder/category?level1_id=10&level2_id=99&source=14&data_title=%E4%BA%91%E6%95%B0%E6%8D%AE%E5%BA%93SQLServer&step=1)，获取解决方案。 |
| 2 | 在源实例中未找到待迁移的数据库。 | 在源实例中未找到待迁移的数据库，请确认待迁移的数据库在源实例是否存在。 |
| 3 | 源实例无法执行迁移初始化操作。 | 源实例无法执行迁移初始化操作：<br>1. 请检查源实例的 SQL 服务启动账号是否是使用内置账户 Local System 启动的，需要将启动配置中的“登录身份”选择“内置账户”并修改为 Local System 账户启动。<br>2. 请检查源实例是否开启了 xp_cmdshell，需要将 xp_cmdshell 开启。<br>3. 请检查迁移账号需要有 sysadmin 权限。 |
| 4 | 高版本实例不能向低版本实例迁移。 | 高版本实例不能向低版本实例迁移，例如：源实例2012版本不能迁移到目标实例2008版本。目标实例的版本必须要大于或等于源实例的版本才可进行迁移，可以通过控制台的 [调整实例版本](https://cloud.tencent.com/document/product/238/67862) 功能升级目标实例的版本。 |
| 5 | 源实例的备份作业无法禁止。 | 请 [提交工单](https://console.cloud.tencent.com/workorder/category?level1_id=10&level2_id=99&source=14&data_title=%E4%BA%91%E6%95%B0%E6%8D%AE%E5%BA%93SQLServer&step=1)，获取解决方案。 |
| 6 | 源库创建全量备份文件失败。 | 源库创建全量备份文件失败：<br>1. 请在源实例的 cmd 终端执行 net share，查看名字是 bakcup 的共享文件夹是否存在。<br>2. 请检查源实例共享文件夹里的备份文件是否生成。<br>3. 请检查源实例磁盘空间是否不足以创建备份。 |
| 7 | 源实例传送备份文件失败。 | 源实例传送备份文件失败：<br>1. 请检查源实例文件共享服务是否启动。<br>2. 请检查源实例中以“ls” 开头的系统账号是否正确创建。<br>3. 请在源实例的 cmd 终端执行 net share，查看名字是 bakcup 的共享文件夹是否存在。<br>4. 请检查以 “ls”开头的系统账号对共享文件夹是否有完全控制权限。 |
| 8 | 在目标实例通过备份文件恢复数据库失败。 | 在目标实例通过备份文件恢复数据库失败：<br>1. 请检查源实例文件共享服务是否启动。<br>2. 请检查源实例中以“ls”开头的系统账号是否正确创建。<br>3. 请在源实例的 cmd 终端执行 net share，查看名字是 bakcup 的共享文件夹是否存在。<br>4. 请检查以 “ls” 开头的系统账号对共享文件夹是否有完全控制权限。 |
| 9 | 部署增量同步失败。 | 请 [提交工单](https://console.cloud.tencent.com/workorder/category?level1_id=10&level2_id=99&source=14&data_title=%E4%BA%91%E6%95%B0%E6%8D%AE%E5%BA%93SQLServer&step=1)，获取解决方案。 |
| 10 | 同步增量日志失败。 | 同步增量日志失败：<br>1. 同步中的网络连接异常，无法共享增量文件，请重新进行迁移。<br>2. 增量迁移过程中事务日志被截断，请停止源实例上的日志备份作业，重新进行迁移。 |
| 11 | 同步结束后，数据存在不一致。 | 同步结束后，数据存在不一致。当前已完成全量备份数据的同步，请手动检查迁移后的数据，如数据差异较大，需要注意：<br>1. 点击“完成”时，源实例需要停机，然后重试迁移。<br>2. 增量迁移过程中事务日志被截断，请停止源实例上的日志备份作业，重新进行迁移。 |


