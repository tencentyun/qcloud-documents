## 操作场景
DTS 支持多对一、一对多、联级单向、双向同步、联级双向同步等复杂拓扑结构，在复杂拓扑结构中，多个节点同时进行数据写入，可能会发生主键冲突问题，DTS 支持对主键冲突进行检测，并提供如下主键冲突的处理机制。

| **主键冲突策略** | **说明**                                                     | **冲突处理时 SQL 语句改写**                                    |
| ---------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 冲突报错         | 同步任务中，源库插入（INSERT）主键数据与目标库存在冲突时，任务报错并暂停，需要用户手动处理后才能继续。 | <li>INSERT 不改写<li>UPDATE 不改写<li>DELETE 不改写           |
| 冲突忽略         | 同步任务中检测到源库的主键插入（INSERT）数据与目标库发生冲突时，忽略源库的主键插入数据，以目标库的内容为准。 | <li>INSERT > INSERT IGNORE  <li>UPDATE 不改写<li>DELETE 不改写 |
| 冲突覆盖         | 同步任务中检测到源库的主键更新（INSERT 和 UPDATE）数据与目标库发生冲突时，用源库的主键数据覆盖目标的主键数据。 | <li>INSERT > REPLACE INTO<li> UPDATE > DELETE + REPLACE INTO<li>DELETE 不改写 </li> |

## 冲突策略应用示例

下图构建 A > B 的单向同步，ID 为主键数据。INSERT 主键后，数据同步到 B 上引起冲突，DTS 按照设置的冲突策略进行干预处理。

<img src="https://qcloudimg.tencent-cloud.cn/raw/4442109fe39774e4c567a4653130f668.png" style="zoom:45%;" />

1. 初始状态，A 只有库表结构，无数据，B 为空。
2. 构建单向同步任务 A > B。
3. 在 B 中 INSERT 数据（ID=1, Price=10）
4. 在 A 中 INSERT 同样的主键数据（ID=1, Price=20）。

最终同步后 B 上的结果，DTS 会根据设置的冲突策略进行干预。
- 冲突报错：任务报错，B 上的数据保持不变 （ID=1, Price=10）。
- 冲突忽略：忽略 A 的主键数据，B 上的数据保持不变（ID=1, Price=10）。
- 冲突覆盖：用 A 的主键数据覆盖 B 上的主键数据，B 上的结果为 （ID=1, Price=20）。

## 冲突策略与数据一致性

在两地三中心，异地多活等复杂数据架构中，会有三个或三个以上节点需要同时进行数据写入，保证多个节点的一致性至关重要。许多用户误以为可以通过主键冲突策略来保证数据以某一个节点为准进行更新，这是不合理。

DTS 仅对 INSERT 主键冲突和 UPDATE 主键冲突进行干预，其他不冲突的场景不干预。并且干预的数据针对的是发生主键冲突当时的数据，应用冲突策略后可以使任务报错提醒给用户或者继续运行。

例如在下图的双向同步场景中，A > B，B > A 都设置为冲突覆盖，在 A，B 节点上同时 INSERT 主键为1的数据，最终的结果是 A、B 上主键1的数据发生交换。
<img src="https://qcloudimg.tencent-cloud.cn/raw/83aa82449a752e49824793cb713cb2f1.png" style="zoom:45%;" />

对正常的 UPDATE 操作（如下示例），DTS 是不会干预的，因为没有冲突。下图 UPDATE 主键后，数据同步到 B 上无冲突，无论设置什么冲突策略，DTS 都不会干预。最终按照正常的 UPDATE 操作进行，B 上的结果都以 A 的更新为准。

<img src="https://qcloudimg.tencent-cloud.cn/raw/4be9f2a54b8999bfe432925873d425a7.png" style="zoom:45%;" />

综上，我们可以看出，冲突策略仅对 INSERT 主键冲突和 UPDATE 主键冲突时，让同步任务能报错提醒用户，或者按照设置的策略干预，让任务继续进行下去，没有主键冲突的场景，DTS 不会干预。

实际场景中要实现多节点数据一致性，一般通过划分主键分区，引入额外的协调机制（比如给数据增加版本号，实现按版本号覆盖的机制）等方法，单独靠冲突策略无法达到这一诉求。 
