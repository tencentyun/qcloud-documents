## 操作场景
云数据库跨账号实例间数据同步，指源库和目标库都属于腾讯云数据库实例，但所属不同的主账号名下，这种数据库实例之间的数据同步。本章节介绍通过 DTS 数据同步功能实现从其他账号腾讯云数据库实例同步数据至本账号下云数据库实例。

## 支持范围
支持腾讯云数据库实例 MySQL 系的同步，具体请参见 [数据同步支持的数据库](https://cloud.tencent.com/document/product/571/58672) 中的表信息**跨账号同步**列。

## 注意事项
本操作中涉及多处账号信息配置，如下列出了主要配置逻辑，以方便用户理解和正确配置。
- 数据同步方向：源数据库（其他账号的数据库实例）> 目标数据库（本账号的数据库实例）。
- 执行同步任务的账号可以是目标库的主账号，也可以目标库的子账号/协作者。
   - 目标数据库属于主账号名下，使用主账号执行同步任务。操作任务前，需要使用源数据库账号登录腾讯云控制台，给执行同步任务的主账号进行角色授权，使主账号可以访问源数据库。
   - 目标数据库属于子账号/协作者名下，使用子账号/协作者执行同步任务。操作任务前，需要先使用源数据库账号登录腾讯云控制台，给目标库所属主账号进行角色授权，然后再使用目标数据子账号/协作者登录腾讯云控制台，对子账号/协作者进行策略授权，使子账号/协作者可以访问源数据库。
- 为避免配置过程中混淆账号，建议在执行任务前先整理如下信息到本地。

| 其他账号（源数据库）                                         | 本账号（目标数据库）                                         |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| <li>源数据库所属主账号 ID 和登录密码，ID 示例10xxxxxxxx58。<li>源数据库实例 ID，账号/密码。 | <li>目标数据所属主账号 ID 和登录密码，ID 示例10xxxxxxxx37。<li>如果目标数据库属于子账号/协作者名下，则需要子账号/协作者名称和登录密码。<li>目标数据库实例 ID，账号/密码。</li> |

## [授权账号](id:sqzh)
**使用主账号执行同步任务，请操作步骤1 - 6，使用子账号/协作者执行同步任务，请操作步骤1 - 11。**

1. 使用源数据库所属的腾讯云账号（不限主账号或者子账号）登录 [访问管理控制台](https://console.cloud.tencent.com/cam/role)。
2. 左侧导航单击**角色**，进入角色管理页面，然后单击**新建角色**。
3. 在选择角色载体页面，选择**腾讯云账户**方式。
<img src="https://qcloudimg.tencent-cloud.cn/raw/b5fd492a4790c8ece15f4830b85e2df1.png" style="zoom:40%;" />
4. 在**输入角色载体信息**页面，配置相关信息，单击**下一步**。
![](https://qcloudimg.tencent-cloud.cn/raw/33617c62891531013942e82ce179499d.png)
 - 云账号类型：选择**其他主账号**。
   - 账号 ID：填入目标数据库所属的腾讯云主账号 ID，主账号 ID 可在 **[账号信息](https://console.cloud.tencent.com/cam)** > **所属账号** 中查看。目标数据库实例属于子账号名下时，此处也填写主账号 ID。
 - 外部 ID：可依据情况，选择性开启。  
>?如果使用了外部 ID，请用户自行记录和保存该 ID。无法通过 DTS 服务查询到该 ID。
5. 在**配置角色策略**页面，输入 QcloudDTSReadOnlyAccess，选中 **QcloudDTSReadOnlyAccess** 预设策略，单击**下一步**。
![](https://qcloudimg.tencent-cloud.cn/raw/a70b000b9f51652c472fe223711d04d4.png)
6. 在**审阅**页面，设置角色名称，单击**完成**后该角色创建完成。
>?角色名称不要有下划线 `_`，配置后记录该名称，后续创建同步任务时需要输入。
>
![](https://qcloudimg.tencent-cloud.cn/raw/ec0db9b0e1dc4a48c02054d116de57f5.png)
>?如果执行同步任务的账号为主账号，授权步骤到此结束；如果为子账号/协作者，还需要进行如下策略授权。
7. （可选）使用目标数据库所属的腾讯云子账号登录 [访问管理控制台](https://console.cloud.tencent.com/cam/role)，在左侧导航单击**策略**，然后在右侧单击**新建自定义策略**，并选择**按策略语法创建**。
<img src="https://qcloudimg.tencent-cloud.cn/raw/98feaf82b12346e6b106864be12c929e.png" style="zoom:40%;" />      
8. （可选）选择**空白模板**，然后单击**下一步**。
![](https://qcloudimg.tencent-cloud.cn/raw/22f37e1ed65e7394c3b0d32b73a8d724.png)  
9. （可选）创建一个策略，策略的名称以及描述可以根据自己的需求填写，策略内容复制示例代码后，将红框中的内容替换成对应的信息。<br>
<img src="https://qcloudimg.tencent-cloud.cn/raw/0b516baa18d7b242160f99ffb844681a.png" style="zoom:50%;" />
<br>策略语法示例：  
```
   {
    "version": "2.0",
    "statement": [
    {
        "effect": "allow",
        "action": ["name/sts:AssumeRole"],
  "resource": ["qcs::cam::uin/100*******58:roleName/DTS-role"]
    }
 ]
   }
```
10. （可选）单击**完成**后返回到策略列表页，在列表页中单击**关联用户/组**。
![](https://qcloudimg.tencent-cloud.cn/raw/a61a3c28aa711662db854e8963024d56.png) 
11. （可选）选择目标数据库实例所属子账号（即执行同步任务的子账号），单击**确定**，如下图所示。
<img src="https://qcloudimg.tencent-cloud.cn/raw/5a56dd3c69f3c2688bc9c36ddead59e5.png" style="zoom:80%;" />

## 创建同步任务
1. 使用目标数据库实例所属腾讯云账号，登录 [DTS 控制台](https://console.cloud.tencent.com/dts/overview)。
2. 单击 **数据同步** > **新建同步任务**，购买一个新的同步任务。
3. 购买完成后，返回数据同步列表，单击**操作**列的**配置**，进入配置同步任务页面。
4. 在设置源和目标数据页面，配置源库和目标库信息。下面以 MySQL 到 MySQL 的同步为例进行介绍。
![](https://qcloudimg.tencent-cloud.cn/raw/87b6e9567d9e5ea078d144640498ee0d.png)
跨账号关键参数配置如下：
 - 接入类型：选择**云数据库**，表示源数据库属于腾讯云数据库实例。
 - 是否跨账号：选择**跨账号**。
 - 跨腾讯云账号 ID： 填入源数据库所属的主账号 ID。
 - 跨账号授权角色名称。即前文 [授权账号](#sqzh) 步骤6中创建的**角色名称**。您可以通过 [角色](https://cloud.tencent.com/document/product/598/19420) 以及 [跨账号角色](https://cloud.tencent.com/document/product/1312/48171) 了解更多关于角色的概念。
 - 外部角色 ID：这个选项可选。这个参数可以通过前文获得。您可以通过 [角色](https://cloud.tencent.com/document/product/598/19420) 以及 [跨账号角色](https://cloud.tencent.com/document/product/1312/48171) 了解更多关于角色的概念。
>?完成上述配置后，选择对应的**所属地域**，即可获取到跨账号下的实例列表，如果获取实例出现报错，则可能为配置错误，或者未授权，请参考 [常见问题](#cjwt) 进行处理。
5. 在设置同步选项和同步对象页面，对数据初始化选项、数据同步选项、同步对象选项进行设置，在设置完成后单击**保存并下一步**。
6. 在校验任务页面，完成校验并全部校验项通过后，单击**启动任务**。
如果校验任务不通过，可以参考 [校验不通过处理方法](https://cloud.tencent.com/document/product/571/61639) 修复问题后重新发起校验任务。
7. 返回数据同步任务列表，任务开始进入**运行中**状态。
>?选择**操作**列的**更多** > **结束**可关闭同步任务，请您确保数据同步完成后再关闭任务。

## [常见问题](id:cjwt)
#### 1. 跨账号拉取实例列表报错：role not exist[InternalError.GetRoleError]
请确认**跨腾讯云账号 ID**（应该为源数据库的主账号 ID）和**跨账号授权角色名称**（应该为 [授权账号](#sqzh) 步骤6中创建的**角色名称**）配置是否正确。

#### 2. 跨账号拉取实例列表报错：you are not authorized to perform operation (sts:AssumeRole) ，resource (qcs::cam::uin/12345:roleName/xxxx) has no permission
![](https://main.qcloudimg.com/raw/16dee616c668dde14d10b892918d42a1.png)
**出错原因**：您当前创建同步任务使用的账号是子账号/协作者，并且当前子账号/协作者没有 sts:AssumeRole 权限。
**解决方法**：
- 使用主账号来创建同步任务。
- 参考 [授权账号](#sqzh) 对子账号/协作者授权，策略语法中的 resource，填写报错框中蓝色字段部分。
![](https://main.qcloudimg.com/raw/d978acb50ab95f7b8091854f8b8e17f7.png)
