## 操作场景
腾讯云容器镜像服务 TCR 企业版现提供镜像按需加载功能。该功能可提前预缓存容器镜像，使用时按需加载，可将大规模镜像分发速度提升5 - 10倍，满足海量容器应用快速启动需求。本文介绍如何通过控制台配置按需加载容器镜像。

## 前提条件

- 已成功 [创建集群](https://cloud.tencent.com/document/product/457/32189)。当前按需加载功能仅面向腾讯云容器服务提供适配支持，且需集群具备以下配置：
  - 集群版本在1.16及以上。
  - 集群运行时为 containerd，且版本为1.4.3。已创建的集群可修改运行时配置至 containerd 1.4.3，调整后添加的节点默认为此版本运行时。
  - 集群操作系统为 CentOS7.6 及以上。
- 已成功 [购买企业版实例](https://cloud.tencent.com/document/product/1141/51110)。按需加载容器镜像功能仅限**高级版实例**开启使用。
- 已开通 [文件系统 CFS](https://cloud.tencent.com/product/cfs) 服务。

## 操作步骤
### 开启镜像加速
1. 登录 [容器镜像服务](https://console.cloud.tencent.com/tcr) 控制台，选择左侧导航栏中的**镜像加速**。
2. 在“镜像加速”页面选择需要开启镜像加速的实例地域和实例 ID，查看当前实例镜像加速的状态及镜像加速规则列表。
3. 单击**开启镜像加速**，在“开通镜像加速服务”窗口中，参考以下提示进行配置。如下图所示：
![](https://main.qcloudimg.com/raw/5abc5a40b1805388acdc396250a38a46.png)
 - **所属实例**：当前已选择实例。
 - **加速模式**：默认为“基于CFS按需挂载加速”。
 - **缓存配置**：
    - **可用区**：创建文件系统 CFS 所在的可用区，需选择支持购买性能存储的可用区。
    - **存储类型**：镜像加速暂时仅支持使用性能存储，以保证镜像数据分发速度。
    - **私有网络**：文件系统归属的私有网络，请选择与之配套使用的容器集群的同一个私有网络。如有其他私有网络 VPC 内集群需要访问本实例，请 [使用云联网](https://cloud.tencent.com/document/product/877/18768) 打通所需的 VPC。
    - **权限组**：选择文件系统的权限组配置，详情请参见 [权限管理](https://cloud.tencent.com/document/product/582/10951)。
4. 单击**确定**即可为当前实例开启镜像加速功能。

### 添加镜像加速规则
1. 单击**添加镜像加速规则**，在“新建镜像加速规则”窗口中，参考以下提示进行规则配置。如下图所示：
![](https://main.qcloudimg.com/raw/38167da8002943ea02c50d00f9adbc89.png)
 - **名称**：规则名称。
 - **描述**：规则描述，支持中文。
 - **触发规则**：
    - **触发实例**：当前所选实例即为触发实例。
    - **命名空间**：当前实例内需要加速分发的命名空间，暂不支持选择全部命名空间。
    - **仓库名称**：加速的仓库，支持正则表达式筛选。不填写则默认为命名空间内全部仓库。
    - **版本Tag**：加速的版本，支持正则表达式筛选。不填写则默认为符合条件的仓库内所有版本。
 - **验证规则**：输入需要加速的镜像地址，验证当前规则下该镜像是否满足加速规则。
2. 单击**确定**即可为当前实例添加镜像加速规则。


### 管理镜像加速规则
成功添加规则后，可在“镜像加速”页面查看已添加的镜像加速规则，您可执行以下操作管理镜像加速规则。如下图所示：
![](https://main.qcloudimg.com/raw/e1d9ab50a6cc939acd1b37b8ec98a8ea.png)
- **修改规则状态**：<img src="https://main.qcloudimg.com/raw/d31873587cb976e1429768b2dc2b0e16.png" style="margin:-6px 0px">表示规则启用，<img src="https://main.qcloudimg.com/raw/5ba06490364505efc4d698e3adb1064e.png" style="margin:-6px 0px">表示规则关闭。新建的镜像加速规则默认为启用状态，您可自行调整。
- **配置**：重新配置镜像加速规则。
- **删除**：删除该实例镜像加速规则。

#### 指定镜像配置加速
镜像加速规则在创建完成后自动生效，新推送的镜像若符合加速规则，将自动生成加速后的镜像。您也可在**容器镜像服务控制台** > **[镜像仓库](https://console.cloud.tencent.com/tcr/repository)**中选择实例 ID，在“版本管理”页面手动为指定镜像配置加速。如下图所示：
![](https://main.qcloudimg.com/raw/1ec4263fa26dfadba6657c3c72bbb29a.png)


### 在容器服务中使用加速镜像
容器服务 TKE 是腾讯云官方提供的 Kubernetes 托管服务，与容器镜像服务 TCR 紧密结合，您可在已有集群中安装 TCR 专属插件，并开启镜像加速功能。

#### 配置 TCR 插件

<dx-alert infotype="notice" title="">
如果集群已安装过 TCR 插件，请删除插件并重新配置及安装。
</dx-alert>


1. 登录 [容器服务控制台](https://console.cloud.tencent.com/tke2)，选择左侧导航栏中的**集群**。
2. 在“集群管理”页面单击需要使用镜像加速分发功能的集群 ID，进入集群详情页。
3. 选择左侧菜单栏中的**组件管理**，进入“组件列表”页面。
4. 在“组件列表”页面中选择**新建**，并在“新建组件”页面中勾选 TCR。
5. 选择“参数配置”，在弹出的“TCR组件参数设置”窗口中配置相关参数。
 - 关联实例：选择与集群同地域，且已开启镜像加速的实例。
 - 镜像加速配置：勾选启用镜像加速，并配置加速生效的命名空间，默认仅在 default 命名空间内启用加速拉取，可使用 “default,sa1,sa2” 指定多个命名空间，暂不支持指定全部命名空间。
6. 单击**确定**即可创建插件。
 更多信息可参见 [TKE 集群使用 TCR 插件内网免密拉取容器镜像](https://cloud.tencent.com/document/product/1141/48184)。






#### 配置集群节点
集群节点默认不支持使用加速镜像，节点若需优先使用加速镜像，您可通过命令行或容器服务控制台为集群节点添加镜像加速标签。

<dx-tabs>
::: 通过命令行添加镜像加速标签
您可执行以下命令为集群节点添加镜像加速标签：
```
kubectl label node xxx cloud.tencent.com/apparate=true
```
:::
::: 通过控制台添加镜像加速标签
1. 登录 [容器服务控制台](https://console.cloud.tencent.com/tke2)，选择左侧导航栏中的**集群**。
2. 在“集群管理”页面单击需要使用镜像加速分发功能的集群 ID，进入集群详情页。
3. 设置节点 Label 的集群 ID/名称，进入集群详情。
4. 在左侧导航栏中，选择 “节点管理” > “节点”，进入“节点列表” 页面。
5. 选择需要设置 Label 的节点行，单击**更多** > **编辑标签**。
6. 在弹出的 “编辑 Label” 窗口中，编辑 Label 为 `cloud.tencent.com/apparate=true`，单击**提交**。
:::
</dx-tabs>






#### 使用加速镜像
新建工作负载时选择实例内镜像，仅当符合以下条件时，集群将实现加速拉取镜像：
- 工作负载所在命名空间已在 TCR 插件配置中标记为生效空间。
- 工作负载 Pod 被调度到的节点已添加使用镜像加速的标签。

您可在 [镜像仓库](https://console.cloud.tencent.com/tcr/repository) 中查看镜像是否被加速。
- 如该镜像已被加速，即以 `getting-started:latest` 镜像为例，镜像仓库内将存在 `getting-started:latest-apparate` 加速镜像。
- 如当前镜像尚未被加速，符合以上条件的 Pod 启动时将拉取原有镜像。
