
## 操作场景
腾讯云容器镜像服务（Tencent Container Registry，TCR）支持在不同地域的不同实例间同步容器镜像及 Helm Chart，可实现单点推送及全球自动同步分发，方便企业在全球多个地域快速部署更新容器业务。

实例同步功能允许用户自定义创建同步规则，可指定某个实例内的部分资源同步至另一个实例内的指定位置。例如，用户可选择同步资源类型（容器镜像、Helm Chart 或是全部同步）、可过滤同步资源路径，通过正则表达式过滤仓库及版本、可选择是否覆盖已有的同名镜像，避免历史数据覆盖丢失。目前实例同步功能已支持跨主账号间的实例同步，同步源侧的用户可以根据同步目标侧用户提供的实例 ID、账号 ID 和访问凭证来创建同步规则。

## 前提条件

在创建并管理 TCR 企业版实例的同步配置前，您需要完成以下准备工作：
- 已成功 [购买企业版实例](https://cloud.tencent.com/document/product/1141/51110)，且实例规格为标准版或高级版。
- 如果使用子账号进行操作，请参考 [企业版授权方案示例](https://cloud.tencent.com/document/product/1141/41417) 提前为子账号授予对应实例的操作权限。

## 操作步骤
### 创建同步规则
1. 登录 [容器镜像服务](https://console.cloud.tencent.com/tcr) 控制台，选择左侧导航栏中的**同步复制** > **实例同步**。
2. 在“实例同步”页面中选择地域及实例名称，并单击**新建**。
3. 在“新建实例同步规则”弹窗中，参考以下提示进行规则配置。如下图所示：
![](https://main.qcloudimg.com/raw/6868524038ad5ccc3d27a794855052d4.png)
 - **名称**：实例规则名称，支持小写字母、数字及（`-`、`.`、` _`）三种符号，且需以字母或数字开头。
 - **描述**：规则描述，支持中文。
 - **同步源**：
    - **源实例**：当前所选实例即为源实例，可返回“实例同步”页面修改。
    - **命名空间**：当前实例所需要同步的命名空间，暂不支持选择全部命名空间。
    - **仓库名称**：同步的仓库，不填写则默认是命名空间内全部仓库。
    - **版本Tag**：同步的版本，不填写则默认是符合条件的仓库内所有版本。
    - **仓库类型**：同步资源的类型，可同时同步容器镜像及 Helm Chart，或只同步其中一种资源。
 - **同步目标**：选择是否开启跨主账号实例同步。 
<dx-tabs>
::: 关闭
开关关闭，则创建同一主账号内的实例同步规则，配置以下字段。如下图所示：
![](https://main.qcloudimg.com/raw/9f11dc5805f4fd7e5e8ec0ef0ec458b8.png)
- **目标实例**：数据同步的目标实例，可选择该主账号内的任一实例。
- **命名空间**：仓库同步至目标实例后所在的命名空间，不填写则默认是与源实例中同名的命名空间，如果没有命名空间将新建。
:::
::: 开启
开关打开，则创建跨主账号的实例同步规则，根据目标账号提供的信息配置以下字段，如下图所示：
![](https://main.qcloudimg.com/raw/437bd4830e2b8727bcb31946eeafc461.png)
- **目标实例**：数据同步的目标实例 ID，前往 [实例管理](https://console.cloud.tencent.com/tcr) 即可获得。
- **命名空间**：仓库同步至目标实例后所在的命名空间，不填写则默认是与源实例中同名的命名空间，如果没有命名空间将新建。
- **账号ID**：同步目标的账号 ID，前往 [账号信息](https://console.cloud.tencent.com/developer) 即可获得。
- **访问凭证**：目标账号提供的访问凭证，目标用户可参考 [获取实例访问凭证](https://cloud.tencent.com/document/product/1141/41829) 进行获取。
<dx-alert infotype="notice" title="">
1. 请使用长期访问凭证，避免同步规则出现不可用的情况。同步规则的生命周期与该目标账号下最新添加的同步规则的访问凭证的生命周期保持一致。
2. 请注意越权风险。访问凭证拥有的权限与创建该凭证的子账号拥有的权限保持一致。建议目标账号新建一个专用于跨主账号实例同步的子账号，仅给该子账号授予推送镜像的权限，详情可参考 [企业版授权方案示例](https://cloud.tencent.com/document/product/1141/41417)。
</dx-alert>
:::
</dx-tabs>
 - **镜像覆盖**：可选择是否覆盖目标实例内已有同名的容器镜像，建议不覆盖。
3. 单击**确定**即可创建同步规则。
 
### 管理同步规则
成功创建后即可在“实例同步”页面查看已创建的同步规则，您可执行以下操作管理同步规则。如下图所示：
![](https://main.qcloudimg.com/raw/42e856df81f0702a8adb0e71c370d19a.png)
- **查看同步日志**：单击实例规则名称，即可查看该规则触发日志，详情请参见 [查看同步日志](#CheckLog)。
- **修改规则状态**：<img src="https://main.qcloudimg.com/raw/d31873587cb976e1429768b2dc2b0e16.png" style="margin:-6px 0px">表示规则启用，<img src="https://main.qcloudimg.com/raw/5ba06490364505efc4d698e3adb1064e.png" style="margin:-6px 0px">表示规则关闭。新建的实例同步规则默认为启用状态，您可自行调整。
- **触发同步**：手动触发同步，将扫描实例内所有符合规则的仓库并进行同步。
- **配置**：重新配置实例同步规则，可配置全部参数。
- **删除**：删除该实例同步规则。

### 查看同步日志[](id:CheckLog)
单击指定实例同步规则名称，即可查看该规则的触发日志。如下图所示：
![](https://main.qcloudimg.com/raw/45d656d202beaecb5ab8e2ac36ba4935.png)
- **任务ID**：实例内唯一的同步任务 ID。
- **创建时间**：同步任务创建的时间。
- **任务耗时**：完成全部同步任务消耗的时间。
- **成功比例**：资源同步完成比例，单次同步任务可能同时同步多个仓库。
- **同步仓库数**：当前任务需要同步的仓库数量。
- **同步状态**：任务完成状态。如果单次同步任务所需同步的容器镜像及 Helm Chart 较多，可能同步状态会较长时间保持在 “InProgress”（同步中）状态。




## 相关文档

您还可以使用 ManageReplication 接口管理实例同步。详细信息请参见 [管理实例同步 API 文档](https://cloud.tencent.com/document/product/1141/41572)。


