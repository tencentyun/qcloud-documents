## 操作场景
腾讯云容器镜像服务（Tencent Container Registry，TCR）企业版支持内网访问控制，可基于内网访问链路限制私有网络内的客户端访问实例。在容器计算的实际生产场景中，通过内网拉取容器镜像可有效提升拉取速度，并避免公网带宽成本。TCR 支持将用户的私有网络接入至企业版实例中，以实现内网访问及网络访问控制。
本文档介绍如何在 TCR 企业版实例中配置内网访问控制。

## 前提条件

在配置 TCR 企业版实例的内网访问控制前，您需要完成以下准备工作：
- 已成功 [创建企业版实例](https://cloud.tencent.com/document/product/1141/40716)。
- 如使用子账号进行操作，请参考 [企业版授权方案示例](https://cloud.tencent.com/document/product/1141/41417) 提前为子账号授予对应实例的操作权限。
- 已开通 [私有网络 VPC](https://console.cloud.tencent.com/vpc) 服务，并在企业版实例所在地域具有可用的私有网络及子网。

## 操作步骤
### 新建访问链路
1. 登录 [容器镜像服务](https://console.cloud.tencent.com/tcr) 控制台，选择左侧导航栏中的【访问控制】>【内网访问】。
2. 在“内网访问”页面中，单击【新建】。
3. 在弹出的“新建内网访问链路”窗口中，配置私有网络及子网信息。如下图所示：
![](https://main.qcloudimg.com/raw/bcf49249476e4759fb3eebd5e5ab36b2.png)
 - **所属实例**：开启内网访问策略的目标实例，可在“内网访问”页面顶部的“实例名称”下拉框中修改。
 - **私有网络**：
    1. 接入的私有网络。请选择希望接入的私有网络，下拉列表中为当前实例所在地域可用的私有网络。
    2. 私有网络内任一子网。请选择该私有网络下内网 IP 仍有空余的子网。新建私有网络访问链路将占用该子网内的一个内网 IP 地址，并作为实例域名的内网解析目标地址。该子网仅用于分配内网访问地址，链路创建完成后，该私有网络下任意子网内云服务器均可通过该链路访问 TCR 企业版实例。
4. 配置完成并点击【确定】，该内网访问链路将启动新建。
等待“访问链路状态”转变为**链路正常**时，且“内网解析IP” 不为空时，则说明该内网访问链路已创建成功。
![](https://main.qcloudimg.com/raw/3ad7fc5f43d17c04789365512738b615.png)

### 配置内网解析
内网访问链路建立完成后，关联的私有网络 VPC 内云服务器访问该内网解析 IP ，即可通过内网访问该实例。默认情况下，实例默认域名（如 tcr-demo.tencentcloudcr.com）及内网域名（如 tcr-demo-vpc.tencentcloudcr.com）在该私有网络内不会自动解析至该内网解析 IP，可采用 [使用 TCR 插件自动配置](#TCR) 或 [使用私有域解析 VPCDNS 自动配置](#VPCDNS) 实现内网域名解析。

#### 使用 TCR 插件自动配置（推荐）<span id="TCR"></span>
如果当前您正在使用容器服务 TKE，请参考 [使用 TCR 企业版实例内容器镜像创建工作负载](https://cloud.tencent.com/document/product/457/45624) 在 TKE 集群中安装 TCR 插件，该插件可自动为集群内节点配置关联 TCR 实例的内网解析，可实现内网免密拉取实例内镜像。如下图所示：
![](https://main.qcloudimg.com/raw/ac01c58b0e50f2c2001f0abe50a361e3.png)

#### 使用私有域解析 VPCDNS 自动配置（Beta）<span id="VPCDNS"></span>
>? 腾讯云 DNS 解析 DNSPod 产品提供了 VPC 私有域解析功能，支持在指定 VPC 内实现私有域解析。当前该功能已支持北京、上海、广州、硅谷地域试用。
>
您可 [提交工单](https://console.cloud.tencent.com/workorder/category) 申请试用该功能，并提供需要开通该功能的私有网络 VPC 列表。服务开通后，可在创建内网访问链路后，配置该实例在关联私有网络 VPC 内的自动解析，并可选使用默认域名或私有域名。如下图所示：
![](https://main.qcloudimg.com/raw/0339896f9cfe78536193aba2535d2aa4.png)

#### 手动配置云服务器 Host 
此方案适用于需要临时访问企业版实例的云服务器或在私有网络自建 Kubernetes 集群的节点。
以 Linux 云服务器为例，登录至云服务器，并执行以下命令：
```
echo '172.21.17.69 demo.tencentcloudcr.com' >> /etc/hosts
```
`172.21.17.69` 及 `demo.tencentcloudcr.com` 请替换为您实际使用的内网解析 IP 及 TCR 实例域名。
