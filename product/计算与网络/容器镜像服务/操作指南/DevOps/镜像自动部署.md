## 操作场景

腾讯云容器镜像服务（Tencent Container Registry，TCR）基于腾讯云 CODING DevOps 提供了镜像构建及交付流水线功能，满足容器用户快速配置并应用持续集成及持续部署的需求。如需使用更加灵活强大的持续编译、构建、交付流水线功能，请了解并使用 [容器 DevOps]( https://console.cloud.tencent.com/coding/container-devops)。

目前 TCR 企业版及个人版服务均支持交付流水线功能，用于自动部署容器镜像至指定容器集群。该功能支持指定镜像仓库，在该仓库内新推送镜像时，筛选符合部署规则的镜像版本，自动部署至容器集群内。当前支持部署至 容器服务 TKE，弹性容器服务 EKS，边缘容器服务 Edge。可参考最佳实践文档 [使用交付流水线实现容器 DevOps](https://cloud.tencent.com/document/product/1141/48186) 快速上手本功能。


## 前提条件

在进行配置镜像自动构建前，您需要完成以下准备工作：
- 已成功 [购买企业版实例](https://cloud.tencent.com/document/product/1141/51110)，或已初始化个人版实例。
- 已开通 CODING DevOps 服务，并完成授权操作。详情请参见 [开通服务](https://cloud.tencent.com/document/product/1115/37268)。
- 如果使用子账号进行操作，请参考 [企业版授权方案示例](https://cloud.tencent.com/document/product/1141/41417) 或 [个人版授权方案示例](https://cloud.tencent.com/document/product/1141/41409) 提前为子账号授予对应实例的操作权限。

## 操作步骤

### 创建交付流水线
1. 登录 [容器镜像服务控制台](https://console.cloud.tencent.com/tcr)，选择左侧导航栏中的**交付流水线**。
在“交付流水线”页面即可查看当前实例内的交付流水线列表。如需切换实例，请在页面上方的“实例名称”下拉列表中进行选择。
2. 单击**新建**，在“新建交付流水线”页面，参考以下提示进行配置。
 - **基本信息**：配置流水线名称及描述，描述支持输入中文。该信息可在创建后编辑。
 ![](https://qcloudimg.tencent-cloud.cn/raw/7a72fb301ba50aa0da86231ef3c98c55.png)
 - **镜像配置**：配置绑定的镜像仓库及需要部署的镜像过滤规则。
 ![](https://qcloudimg.tencent-cloud.cn/raw/fe577d9d676c35d8dce0c00fce1d0a8a.png)
      - 镜像仓库：选择企业版或个人版实例内已有的镜像仓库。
      - 镜像版本过滤：指定需要部署的镜像。支持 “直接部署任意版本”，“仅部署指定名称版本”，“仅部署指定规则版本”。其中指定规则为正则表达式输入。
      - 镜像来源：可选择平台构建镜像或本地推送镜像。如该镜像仓库尚未配置镜像自动构建，可选择使用平台构建镜像。如需使用自建的 CI 服务构建镜像或手动打包镜像，可选择本地推送镜像。
 -  **应用部署**：配置镜像部署环境。
      -  部署平台：支持 容器服务 TKE，弹性容器服务 EKS，边缘容器服务 TKE Edge。
      -  部署地域：集群所在地域。
      -  部署集群：选择目标集群。
      -  命名空间：集群内的命名空间。
      -  工作负载类型：支持 Deployment，StatefulSet，DaemonSet。
      -  工作负载：选择该命名空间下已有工作负载。暂不支持新建工作负载。
      -  Pod容器：工作负载内指定的容器，将更新该容器内镜像。
3. 单击**确定**即可创建镜像构建规则。

如上述配置参数不满足需求，请直接前往 CODING DevOps 平台使用**持续构建**功能。

### 管理交付流水线
完成交付流水线创建后，即可在 **交付流水线** 列表页查看已有交付流水线，选择指定交付流水线，可对当前交付流水线进行以下管理操作：
![](https://qcloudimg.tencent-cloud.cn/raw/a3eb1792343f5c7700c79418320a0b96.png)
1. 列表页
    - **启动**：主动触发流水线部署，可选择指定的镜像版本。
    - **编辑**：编辑流水线配置。
    - **删除**：删除流水线。
2. 详情页
   - **查看执行记录**
进入 “执行记录” 页签，即可查看当前交付流水线的执行记录，并可查看详细日志，删除记录。
   - **查看流水线信息**
进入 “流水线信息” 页签，即可查看当前交付流水线的详细信息，包含基本信息，镜像配置，应用部署。
   
### 触发部署并查看详情
配置交付流水线后，当有符合触发规则的镜像推送操作时，即可触发自动部署镜像。也可主动触发部署，选择指定的镜像版本。启动部署任务后，可单击该交付流水线，进入执行记录页，查看执行日志，并展看查看执行详情。
![](https://qcloudimg.tencent-cloud.cn/raw/bce60d7f49149643e3912c6b6d2555fd.png)

## 异常处理
在使用交付流水线功能时若发生以下异常问题，请参考对应方法重新尝试，若异常仍未解决则请提交 [工单](https://console.cloud.tencent.com/workorder/category) 进行咨询。

### 镜像部署失败
请前往容器集群查看该工作负载的具体日志信息，如报错信息为镜像拉取失败，请检查是否已正常配置该集群可访问镜像仓库，并检查访问凭证配置。详情见 [TKE 集群使用 TCR 插件内网免密拉取容器镜像](https://cloud.tencent.com/document/product/1141/48184)。





