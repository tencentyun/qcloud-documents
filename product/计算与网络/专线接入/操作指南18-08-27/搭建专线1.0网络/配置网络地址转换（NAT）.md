在混合云连接场景中，若专线两端 IP 发生冲突，可以通过 NAT 型的 VPC 专线网关配置网络地址转换功能来解决，即在 IP 数据包通过路由器或防火墙时重新配置报文头部的源 IP 地址、目的 IP地址、端口等信息。本文将介绍如何配置 IP 转换和 IP 端口转换，并提供相关示例帮助您了解。

## 前提条件
您已创建 NAT 型专线网关，具体操作请参见 [创建 VPC 专线网关](https://cloud.tencent.com/document/product/216/48823)。

## 配置 IP 转换
配置 IP 转换需要分别配置本端 IP 转换和配置对端 IP 转换。

### 配置本端 IP 转换
本端 IP 转换指私有网络内原 IP 映射为新 IP（映射 IP），并以新 IP 身份与专线对端互访。本端 IP 转换不限制网络请求的方向，可以是私有网络主动访问专线对端，也可以是专线对端主动访问私有网络。
![](https://main.qcloudimg.com/raw/77f940ecea61658b36d9e7aeebda3ecb.png)

#### 配置示例
若私有网络内的 IP A  ` 192.168.0.3`  作为原 IP，通过本端 IP 转换，映射为 IP B `10.100.0.3`，则：
- IP A 对专线对端的主动访问网络包原 IP 将自动修改为 `10.100.0.3`。
- 所有专线对端访问的 `10.100.0.3` 的网络包将自动指向 IP A `192.168.0.3`。

#### 规则限制
- 原 IP 必须在私有网络 CIDR 范围内。
- 原 IP 不支持广播地址（255.255.255.255）、D 类地址（224.0.0.0 - 239.255.255.255）、E 类地址（240.0.0.0 - 255.255.255.254）。
- 映射 IP 不可以在专线网关所在私有网络 CIDR 范围内。
- 原 IP 和映射 IP 具有唯一映射关系，即私有网络内1个 IP 只能唯一映射为1个新 IP，不支持多个 IP 映射为同一个新 IP。
- 专线网关的本端 IP 转换最大支持100个 IP 映射，每个 IP 映射最大支持20条 ACL 规则（如需提升配额，请提交 [工单申请](https://console.cloud.tencent.com/workorder/category)）。
- 系统默认为本端 IP 转换规则配置了 ACL 规则，您可以按需修改。网络地址转换规则仅对符合 ACL 限制的网络请求生效。

#### 操作步骤
1. 登录 [专线接入控制台](https://console.cloud.tencent.com/dc/dc)，在左侧导航栏中单击【专线网关】。
2. 在专线网关列表中单击“网关类型”为“ NAT 型”专线网关 ID，进入详情页。
  ![](https://main.qcloudimg.com/raw/61ed3ea77cf82597f5bd525fee500dad.png)
3. 在专线网关详情页中，单击【本端 IP 转换】页签。
4. 在“本端 IP 转换”页签中单击【新增】。
  ![](https://main.qcloudimg.com/raw/272179c4b42889d1135b425b1d258262.png)
5. 在“新增本端 IP 映射”对话框中，输入原 IP、映射 IP 及备注，然后单击【确定】。
  ![](https://main.qcloudimg.com/raw/42172589f8ebd012cc9f2a6a3eec556a.png)
6. （可选）修改本端 IP 转换的 ACL 规则。
新增本端 IP 映射时，默认添加了允许所有进出流量通过的 ACL 规则，即本端 IP 转换对所有专用通道生效。若需改变本端 IP 转换的适用范，请编辑本端 IP 转换的 ACL 规则。
> ?
> - 当专线网关同时配置对端 IP 转换时，本端 IP 转换 ACL 规则的**目的 IP** 需要填写**对端 IP 转换的映射 IP** 。
> - 本端 IP 转换 ACL 规则支持配置协议（支持 TCP 或 UDP）、源端口、目的 IP、目的端口，其中，端口、IP 不填代表 ALL；当协议选择 ALL 时，端口和 IP 默认均选择 ALL。
> 
   1. 在“本端 IP 转换”页面，目标 IP 映射右侧“操作”列的【编辑 ACL 规则】。
   2. 在 ACL 规则底部单击【添加】，并配置 ACL 规则，然后单击【保存】。
      ![](https://main.qcloudimg.com/raw/510896b02aaf4cac483d135e3082732a.png)
   3. （可选）若需修改或删除 ACL 规则，有以下两种方式：
      - 在 ACL 规则编辑状态下，单击目标 ACL 规则右侧的【修改】/【删除】，然后单击【保存】。
      - 在 ”IP 映射池“页面，单击<img src="https://main.qcloudimg.com/raw/b2347f733a56962b935f57d086824290.png" style="margin:-3px 0px;width:15px">展开 IP 映射规则，并在目标规则右侧操作列单击【修改】/【删除】，并确认操作。
        ![](https://main.qcloudimg.com/raw/286d67a50a7bd5b88ba7ea2d2ae1f4b7.png)
7. （可选）修改本端 IP 映射。
   1. 若需修改本端 IP 映射，可在 IP 映射页中，单击 IP 映射所在行右侧的【修改 IP 映射】，即可修改本端 IP 映射的原 IP、映射 IP 和备注，单击【确定】后，IP 映射生效。
      ![](https://main.qcloudimg.com/raw/3c494598938fed7c420eca5fb8bed248.png)
   2. 若需删除本端 IP 映射，可在 IP 映射页中，单击 IP 映射所在行右侧的【删除】，并确认操作。IP 映射删除后将联动删除该 IP 映射下的 ACL 规则。

### 配置对端 IP 转换

对端 IP 转换指用户 IDC 内原 IP 映射为新 IP，并以新 IP 身份与私有网络内 IP 互访。对端 IP 转换不限制网络请求的方向，可以是私有网络主动访问专线对端，也支持专线对端主动访问私有网络。对端 IP 转换不支持网络 ACL 限制，因此，一旦配置了对端 IP 转换规则，将对所有专用通道对端生效。
![](https://main.qcloudimg.com/raw/461790e7eff146ac46aabec4ec4ebb31.png)

#### 配置示例
专线对端 IP D `10.0.0.3` 作为原 IP，通过对端  IP 转换，映射为 IP C `172.16.0.3`，则：
- IP D `10.0.0.3`主动访问私有网络的网络包原 IP ，将自动修改为 IP C `172.16.0.3`。
- 所有私有网络访问 IP C `172.16.0.3`的网络包，将自动指向专线对端 IP D `10.0.0.3`。

#### 规则限制
- 原 IP 不支持广播地址（255.255.255.255）、D 类地址（224.0.0.0 - 239.255.255.255）、E 类地址（240.0.0.0 - 255.255.255.254）。
- 映射 IP 不可以在专线网关所在私有网络 CIDR 范围内。
- 原 IP 和映射 IP 具有唯一映射关系，即私有网络内1个 IP 只能唯一映射为1个新 IP，不支持多个 IP 映射为同一个新 IP。
- 专线网关的对端 IP 转换最大支持100个 IP 映射（如需提升配额，请提交 [工单申请](https://console.cloud.tencent.com/workorder/category)）。

#### 操作步骤
1. 登录 [私有网络控制台](https://console.cloud.tencent.com/vpc/vpc?rid=1)，在左侧导航栏中单击【专线网关】。
3. 在专线网关列表中单击“网关类型”为“ NAT 型”专线网关 ID，进入详情页。
![](https://main.qcloudimg.com/raw/61ed3ea77cf82597f5bd525fee500dad.png)
4. 在专线网关详情页中，单击【对端 IP 转换】页签。
4. 在“对端 IP 转换”页签中单击【新增】。![](https://main.qcloudimg.com/raw/b19fdd3168a490a73ad2ed5e1fa1b494.png)
5. 在“新增对端 IP 映射”对话框中输入原 IP、映射 IP 及备注，单击【确定】。
  ![](https://main.qcloudimg.com/raw/362404885ef7e18b2ae2d3af7883f779.png)
6. （可选）修改对端 IP 映射。
  1. 若需修改对端 IP 映射，则在 IP 映射页中，单击 IP 映射所在行右侧的【修改 IP 映射】，即可修改对端 IP 映射的原 IP、映射 IP 和备注，单击【确定】后，对端 IP 映射生效。
     ![](https://main.qcloudimg.com/raw/7d9190677c7b27476bc5219fc3fe2089.png)
  2. 若需删除对端 IP 映射，则在 IP 映射页中，单击 IP 映射所在行右侧的【删除】，并确认操作即可。

## 配置 IP 端口转换
配置 IP 端口转换需要分别配置本端 IP 端口转换和配置对端 IP 端口转换。

### 配置本端源 IP 端口转换
本端源 IP 端口转换指私有网络内 IP 通过专线网关主动外访时，以指定 IP 池内随机 IP 的随机端口访问专线对端的用户 IDC。本端源 IP 端口转换支持配置 ACL 规则，只有符合 ACL 规则的网络出访问才会匹配地址池转发规则。通过为地址池配置不同的 ACL 规则，您可以灵活配置多个第三方接入时的网络地址转换规则。
>?当本端 IP 转换和本端源 IP 端口转换冲突时，优先匹配本端 IP 转换。
>
![](https://main.qcloudimg.com/raw/236a2f1417f75ec8c1cbe0d8c2335129.png)

#### 配置示例
私有网络 C 网段为 `172.16.0.0/16`， 通过专线连接第三方银行 A 和 B，其中银行 A 对端网段为`10.0.0.0/28`，要求对接网段为 `192.168.0.0/28`；银行 B 对端网段为 `10.1.0.0/28`，要求对接网段为`192.168.1.0/28`。则可以按照下面配置 A、B 两条本端源 IP 端口转换：
<table>
<thead>
<tr>
<th colspan="2">配置</th>
<th>本端源 IP 端口转换 A</th>
<th>本端源 IP 端口转换 B</th>
</tr>
</thead>
<tbody><tr>
<td colspan="2">映射 IP 池</td>
<td><code>192.168.0.1 - 192.168.0.15</code></td>
<td><code>192.168.1.1 - 192.168.1.15</code></td>
</tr>
<tr>
<td rowspan="5">ACL 规则</td>
<td>协议</td>
<td>ALL</td>
<td>ALL</td>
</tr>
<tr>
<td>源 IP</td>
<td><code>172.16.0.0/16</code></td>
<td><code>172.16.0.0/16</code></td>
</tr>
<tr>
<td>源端口</td>
<td>—</td>
<td>—</td>
</tr>
<tr>
<td>目的 IP</td>
<td><code>10.0.0.0/28</code></td>
<td><code>10.1.0.0/28</code></td>
</tr>
<tr>
<td>目的端口</td>
<td>—</td>
<td>—</td>
</tr>
</tbody></table>
完成配置后，私有网络 C 内主动访问银行 A、B 的网络请求，会根据对应的 ACL 规则分别转换为对应映射 IP 池的随机端口，访问对应的专用通道。

#### 规则限制
 - 映射 IP 池不可以在专线网关所在私有网络的 CIDR 范围内。
 - 多个映射 IP 池的 ACL 规则不可以重叠，否则会导致网络地址转换冲突。
 - 多个映射 IP 池之间 IP 不可以重叠。
 - 映射 IP 池仅支持单 IP 或连续 IP，且连续 IP 的 /24 网段需保持一致，即支持“192.168.0.1 - 192.168.0.6”，不支持“192.168.0.1 - 192.168.1.2”。
 - 映射 IP 池不支持广播地址（255.255.255.255）、D 类地址（224.0.0.0 - 239.255.255.255）、E 类地址（240.0.0.0 - 255.255.255.254）。
 - 本端源 IP 端口转换最大支持100个映射 IP 池，每个映射 IP 池支持最大20条 ACL 规则（如需提升配额，请提交 [工单申请](https://console.cloud.tencent.com/workorder/category)）。
 - 本端源 IP 端口转换仅支持私有网络端主动发起的网络访问请求，如果专线对端需要主动访问私有网络内的 IP 端口，需要额外配置本端目的 IP 端口转换配置。本端源 IP 端口转换私有网络主动发起的网络请求为有状态连接，不用考虑网络回包问题。

#### 操作步骤
1. 登录 [私有网络控制台](https://console.cloud.tencent.com/vpc/vpc?rid=1)，在左侧导航栏中单击【专线网关】。
2. 在专线网关列表中单击“网关类型”为“ NAT 型”专线网关 ID，进入详情页。
  ![](https://main.qcloudimg.com/raw/61ed3ea77cf82597f5bd525fee500dad.png)
3. 在专线网关详情页中，单击【本端源 IP 端口转换】页签。
4. 在“本端源 IP 端口转换”页签中单击【新增】。
  ![](https://main.qcloudimg.com/raw/51e5c340f4cbbc6d8027763eb2fef678.png)
5. 在“新增映射 IP 池”对话框中，输入映射 IP 池（支持 IP 或 IP 段，IP 段格式为 “A - B”）和备注，单击【确定】。
  ![](https://main.qcloudimg.com/raw/d6eb837b6e564195a2baab5eb77696ff.png) 
6. 编辑 ACL 规则。
新增映射 IP 池的 ACL 规则为拒绝所有进出流量通过，需要重新编辑 ACL 规则才可以实现网络转换。
   > ?
   > - 当专线网关同时配置对端 IP 转换时，本端源 IP 端口转换 ACL 规则的**目的 IP** 需要填写**对端 IP 转换的映射 IP**。
   > - 本端源 IP 端口转换 ACL 规则支持配置协议（支持 TCP 或 UDP）、源 IP、源端口、目的 IP、目的端口。
   > 
    1. 在“映射 IP 池“页面，单击映射 IP 池所在行右侧的【编辑 ACL 规则】。
    2. 在已有 ACL 规则底部，单击【+新增一行】，并编辑 ACL 规则，然后单击【保存】。
     ![](https://main.qcloudimg.com/raw/8190fbfe5346034a60d754c28a3162e5.png)
    3. （可选）若需删除或修改 ACL 规则，有以下两种方式：
       - 在 ACL 规则编辑状态下，单击目标 ACL 规则右侧的【修改】/【删除】，并单击【保存】。
       - 在‘“映射 IP 池”“页面，单击<img src="https://main.qcloudimg.com/raw/b2347f733a56962b935f57d086824290.png" style="margin:-3px 0px;width:15px">展开映射 IP 池规则，单击规则所在行右侧的【修改】或【删除】，并确认操作。
         ![](https://main.qcloudimg.com/raw/54b9b05b41baecd4bfa74edf1c1c3d29.png)
7. （可选）修改映射 IP 池。
 1. 若需修改映射 IP 池，则在映射 IP 池页中，单击映射 IP 池所在行右侧的【修改映射 IP 池】，即可修改该映射 IP 池的 IP 和备注。
    ![](https://main.qcloudimg.com/raw/a315499745732682f666a353a1ad7d65.png)
  2. 若需删除映射 IP 池，则在映射 IP 池页中，单击映射 IP 池所在行右侧的【删除】并确认操作，即可删除该映射 IP 池，映射 IP 池删除后，将自动删除映射 IP 池关联的 ACL 规则。



### 配置本端目的 IP 端口转换
本端目的 IP 端口转换是专线对端主动访问私有网络的一种方法，将私有网络内指定 IP 的指定端口映射为新的 IP 和端口，专线对端则只可以通过访问映射后 IP 端口来与私有网络内指定 IP 端口通信，其他 IP 端口则不对专线对端暴露。
![](https://main.qcloudimg.com/raw/3c70c23e29e3a74baa9b67270edf3ab3.png)

#### 配置示例
私有网络 C 的网段为 `172.16.0.0/16`，仅希望开放部分端口给专线对端主动访问，则可以按照下面方案配置 A、B 两条本端目的 IP 端口映射：
- 本端目的 IP 端口映射 A：原 IP 端口 `172.16.0.1:80`，映射后 IP 端口 `10.0.0.1:80`。
- 本端目的 IP 端口映射 B：原 IP 端口 `172.16.0.0:8080`，映射后 IP 端口 `10.0.0.1:8080`。
完成配置后，专线对端可以主动访问 `10.0.0.1:80`、`10.0.0.1:8080` 端口，实现对私有网络 C 内`172.16.0.1:80`、`172.16.0.0:8080` 两个端口的主动访问。

#### 规则限制
- 原 IP 必须在专线网关所在私有网络 CIDR 范围之内。
- 原 IP 和映射 IP 不支持广播地址（255.255.255.255）、D 类地址（224.0.0.0 - 239.255.255.255）、E 类地址（240.0.0.0 - 255.255.255.254）。
- 原 IP 端口和映射 IP 端口具有唯一映射关系，即私有网络内同一 IP 端口只能唯一映射为一个新 IP 端口，不支持多个 IP 端口映射为同一个新 IP 端口。
- 映射 IP 端口不可以在私有网络 CIDR 范围之内。
- 本端目的 IP 端口转换最大支持100个 IP 端口映射（如需提升配额，请提交 [工单申请](https://console.cloud.tencent.com/workorder/category)）。
- 本端目的 IP 端口转换不支持 ACL 规则适配，因此，IP 端口转换规则将对专线网关所连接的所有专用通道生效。
本端目的 IP 端口转换仅对专用通道对端主动访问私有网络生效，如果私有网络需要主动访问专线对端，可以配置本端源 IP 端口转换。本端目的 IP 端口转换的网络请求为有状态连接，无需考虑网络回包的问题。

#### 操作步骤
1. 登录 [私有网络控制台](https://console.cloud.tencent.com/vpc/vpc?rid=1)，在左侧导航栏单击【专线网关】。
2. 在专线网关列表中单击“网关类型”为“ NAT 型”专线网关 ID，进入详情页。
![](https://main.qcloudimg.com/raw/61ed3ea77cf82597f5bd525fee500dad.png)
3. 在“专线网关”详情页，单击【本端目的 IP 端口转换】页签。
4. 在 ”IP 端口映射“页签单击【新增】，新增本端目的 IP 端口映射。
![](https://main.qcloudimg.com/raw/080dd2d1feb276f1dfe871aa34194cd8.png)
5. 在”新增本端目的 IP 端口映射“对话框中，选择协议，输入原 IP 端口、映射后 IP 端口及备注，并单击【确定】。
![](https://main.qcloudimg.com/raw/13d2a59a47f960d4fa0afeed4bcab9a4.png)
6. （可选）修改本端目的 IP 端口映射。
  - 若需修改本端目的 IP 端口映射，则在 IP 端口映射页中，单击 IP 端口映射所在行右侧的【修改 IP 端口映射】，即可修改该 IP 端口映射的映射关系及备注。
    ![](https://main.qcloudimg.com/raw/05fee1b43be789d66960df88d5109481.png)
  - 若需删除本端目的 IP 端口映射，则在 IP 端口映射页中，单击 IP 端口映射所在行右侧的【删除】并确认操作，即可删除该映射。
