
## 前提条件
已搭建微信小程序，具体操作步骤请参见 [详细步骤](https://console.cloud.tencent.com/la/guide)。


## 创建启动配置[](id:step1)

<dx-alert infotype="explain" title="">
扩容时以**启动配置**为模板创建机器，首先需通过启动配置指定地域、机型、镜像。
</dx-alert>


1. 登录 [弹性伸缩控制台](https://console.cloud.tencent.com/autoscaling/config)，单击左侧导航栏中的**启动配置**。
2. 选择小程序所在的项目和地域。如下图所示：
![](https://main.qcloudimg.com/raw/1f1c31865b09d4480e1359ccde262cf1.png)
3. 单击**新建**，在弹出页面选择配置，并完成启动配置创建。
<dx-alert infotype="notice" title="">
为了使扩容所添加的实例，无需手动配置实例环境就能够直接工作。在创建启动配置前您需要制作好镜像，确保镜像里的应用能随操作系统启动。
</dx-alert>



## 创建伸缩组
1. 登录 [弹性伸缩控制台](https://console.cloud.tencent.com/autoscaling)，单击**新建**。
2. 在新建伸缩组页面，填写集群的伸缩组管理信息，并单击**下一步**。如下图所示：
![](https://qcloudimg.tencent-cloud.cn/raw/3d70e70cf8baa89d4fe3e4080c43d229.png)
	- **名称**：按需起一个名字，这里填“会话服务器集群”。
	- **最小伸缩数**：集群实例数量的下限，这里填0即可。
	- **起始实例数**：伸缩组刚创建时，自动创建的实例数量。这里填0即可。
	- **最大伸缩数**：集群实例数量的上限，这里按需填写。
	- **启动配置**：选择您已创建的启动配置。
	- **支持网络**：会话服务器的网络环境，一般选“基础网络”即可。
3. 根据实际需求，在负载均衡下拉列表中选择已创建的负载均衡或新建，单击**完成**。完成创建。如下图所示：
若无需配置负载均衡，可不选择负载均衡，单击**下一步：竞价实例分配**。
![](https://qcloudimg.tencent-cloud.cn/raw/4b3621f10b1578d5fbcd51237800b659.png)
4. 在“竞价实例分配”步骤中，配置竞价实例分配策略，您也可单击**下一步：其他配置**跳过此步骤。
如需配置竞价实例，请参考以下参数说明：
 - **按量基础实例数**：伸缩组内按量计费实例必须满足的最小数量。当伸缩组扩容时，首先扩容此部分的实例。
 - **按量实例百分比**：除按量计费基础实例数外，按量实例所占的比例。可以指定0到100间的任意比例。
 - **竞价实例创建策略**：启动配置配置多机型时，竞价实例创建的策略。
     - **容量优化策略**：优先选择最可用的竞价实例机型，以这种方式扩容可帮助您最好的利用竞价实例资源。
    - **成本优化策略**：优先选择单核价格最低的竞价实例机型，将从您指定的可用区中分配您的实例，以这种方式扩容可帮助您最大限度节约成本。
 - **竞价实例回收监测**：开启后，弹性伸缩会尝试使用新的实例主动替换伸缩组中即将被回收的竞价实例，从而帮助您保持伸缩组内的实例数量及按量实例的比例。
 - **按量实例补充竞价容量**：开启后，当您配置的机型竞价实例库存不足时为您尝试创建按量计费实例。
5. 在“其他配置”步骤中，参考以下信息设置移出策略及实例创建策略。
 - **移出策略**：当伸缩组要减少实例且有多重选择时，将根据移出策略来选择移出的实例。支持“移出最旧的实例”及“移出最新的实例”。
 - **实例创建策略**：
	 - **首选可用区（子网）优先**：根据已配置的可用区（子网）顺序，优先选择靠前的配置项，失败后自动按顺序重试，适合以某个可用区为主，其他可用区为辅的架构。
	- **多可用区（子网）打散**：系统将根据扩容时伸缩组内实例在不同可用区（子网）的分布情况，选择相对较少的可用区（子网）创建新的实例，适合需要均匀分布实例的架构。 
6. 单击**完成**，创建伸缩组。



## 添加现有机器进伸缩组
1. 在 [伸缩组列表页](https://console.cloud.tencent.com/autoscaling)  单击伸缩组 ID，进入伸缩组详情页。
2. 选择**关联实例**，单击**添加实例**。如下图所示：
![](https://main.qcloudimg.com/raw/acb6ab01234b075b23167b3dc2c1b215.png)
3. 在添加实例页面中选择已有的会话服务器，并单击**确定**加入伸缩组。如下图所示：
![](https://main.qcloudimg.com/raw/384ba41ad2abc5287bad88f16bf47fbd.png)
添加实例成功后，进入伸缩组列表页。
4. 单击伸缩组右侧**设置移出保护**，并在弹出对话框中选择**确认**。如下图所示：
![](https://main.qcloudimg.com/raw/7550e724fd439e3d078c00dedc172e36.png)
设置成功后服务器即可“免于缩容”。在缩容活动中，伸缩组不会选择这台服务器缩容。


## 设置扩缩容策略[](id:step3)

<dx-alert infotype="explain" title="">
通常扩容任务和缩容任务成对出现。
</dx-alert>

### 定时扩缩容
扩缩容策略可根据小程序特点设置。例如，在点餐小程序中，每天午饭时间实例的负载将会比其余时间的负载高。
您可以针对此点进行如下设置：
1. 在伸缩组详情页单击**定时任务**，并选择**新建**。如下图所示：
![](https://main.qcloudimg.com/raw/acca10e746487c035e5aefd82d2b58c2.png)
2. 设置定时扩容任务为**按天**11：00 - 13：00扩容2台额外实例支撑负载，并单击**确定**。如下图所示：
![](https://main.qcloudimg.com/raw/241844ab8d2208345696330015323f96.png)
3. 设置定时缩容任务为**按天**15：00 - 17：00缩容2台实例减少支撑负载，并单击**确定**如下图所示：
![](https://main.qcloudimg.com/raw/a0ffaca1fe4712e350e255e88bcc12a0.png)

### 基于告警扩缩容
您可以进行如下设置：
设置预期不明确的扩容，应对出现意料之外的流量/攻击。
1. 在弹性伸缩组详情页单击**告警触发策略**，并选择**新建**。如下图所示：
![](https://main.qcloudimg.com/raw/997fc8d168bc09a27b2b91854fc4ba00.png)
2. 设置告警扩容策略，用于应对异常流量。如下图所示：
![](https://main.qcloudimg.com/raw/27850ffe5eebb5b34fa6823e5ece4312.png)
   - **if**：此项为策略设置条件，图中设置为伸缩组内所有实例 CPU 利用率1分钟内最大值80%，连续1次。
   - **伸缩组活动**：增加2台实例，冷却0秒。
3. 设置告警缩容策略，用于清退未充分利用的服务器。如下图所示：
![](https://main.qcloudimg.com/raw/a21dd4234644e4ff4e98bcd6252658ff.png)
   - **if**：此项为策略设置条件，图中设置为伸缩组内所有实例 CPU 利用率1分钟内最大值20%，连续1次。
   - **伸缩组活动**：减少2台实例，冷却0秒。

## 为业务服务器配置弹性伸缩策略
此过程与为会话服务器配置弹性伸缩策略类似。请按照 [创建启动配置](#step1) - [设置扩缩容策略](#step3) 的操作步骤，为业务服务器配置弹性伸缩策略。

