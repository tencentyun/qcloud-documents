本文档介绍如集群需主动外访，如何设置固定外访 IP。


## 需求场景

如果您伸缩组中的集群，同时存在这三个需求：
- 从负载均衡 CLB 接受请求。
- 集群机器需要主动外访。
- 外访时希望用**固定**的外网 IP。

那么您可以按如下方案进行设置。

## 方案简述
![](https://mc.qcloudimg.com/static/img/9cccdddfe99dbc065c97cad27448ed9f/image.png)
1. 通过负载均衡 CLB 接收和响应外部请求。
2. 将机器放入私有网络 VPC 的子网中，将路由表指向 NAT 网关，主动外访请求统一经 NAT 网关的外网 IP 发出。
3. 伸缩组的网络属性设为该子网，这样扩容出来的机器都会统一用 NAT 网关主动外访。



## 设置方法

### 步骤1：创建 VPC 和子网

#### 1. 创建 VPC<span id="createVPC"></span>
1. 登录私有网络控制台，选择左侧导航栏中的【[私有网络](https://console.cloud.tencent.com/vpc/)】。
2. 在“私有网络”页面上方，选择地域，例如，选择地域“华北地区（北京）”。
3. 单击【+新建】，在弹出的“新建VPC” 窗口中，填写私有网络和子网的名称和 CIDR，并选择子网的可用区。
4. 单击【确定】即可创建 VPC。


#### 2. 创建子网
1. 在私有网络控制台中，选择左侧导航栏中的【[子网](https://console.cloud.tencent.com/vpc/subnet)】。
2. 在“子网”页面上方，选择地域及 VPC。如下图所示：
![](https://main.qcloudimg.com/raw/3aa9e0efc7a8002ce48ef51d2b913965.png)
2. 单击【+新建】，在弹出的“创建子网”窗口中，填写子网络名称、CIDR、可用区和关联路由表。
3. 单击【创建】即可，完成创建后，您就可以购买机器到这个子网中了。


### 步骤2：创建 NAT 网关
#### 1. 新建 NAT 网关<span id="createNAT"></span>
1. 在私有网络控制台中，选择左侧导航栏中的【[NAT网关](https://console.cloud.tencent.com/vpc/nat)】。
2. 在 “NAT网关”页面中，单击【+新建】。
3. 在弹出的“新建NAT网关”窗口中，依次输入或确定以下参数：
	- 网关名称
	- 网关类型（网关类型创建后可更改）
	- NAT 网关服务的私有网络（即为 [步骤1](#createVPC) 所创建的私有网络）
	- 为 NAT 网关分配弹性 IP（该 IP 即为您的机器外访的固定 IP）
3. 配置结束后单击【创建】，即可完成 NAT 网关的创建。
创建完 NAT 网关后，您需要在私有网络控制台路由表页配置路由规则，以将子网流量指向 NAT 网关。

#### **2. 设置路由表（重点）**
1. 在私有网络控制台中，选择左侧导航栏中的【[路由表](https://console.cloud.tencent.com/vpc/route)】。
2. 在“路由表”页面中，选择需访问 Internet 的子网所关联的路由表 ID，进入该路由表详情页。
3. 单击【+新增路由策略】，在弹出的“新增路由”窗口中，参考以下信息进行配置。如下图所示：
![](https://main.qcloudimg.com/raw/fa466cc6e828fba2d0cb16f5f1321e07.png)
 - **目的端**：此场景下可填写 `0.0.0.0/0`。
 - **下一跳类型**：选择 “NAT 网关”，并选择 [步骤1](#createNAT) 中已创建的 NAT 网关 ID。
4. 单击【创建】即可。至此，您在这个子网中的机器即使没有公网 IP，也可以经过 NAT 网关主动外访了，对外而言还是固定的 IP。
即使购买无公网 IP 且带宽为0的主机，也可以主动外访。如下图所示：
![](https://mc.qcloudimg.com/static/img/17ed153e06272885b56764781d9ab581/49.jpg)
>?伸缩组需要识别这个子网，并确保机器都在这个子网上创建。
>

### 步骤3：设置伸缩组
此步骤的目的是将子网信息指向伸缩组，伸缩组就会把新扩容的机器放置在该子网中。**扩容的机器会自动地用 NAT 网关的 IP 地址进行外访，达到固定出口 IP 的效果。**
1. 登录弹性伸缩控制台，选择左侧导航栏中的【[伸缩组](https://console.cloud.tencent.com/autoscaling/group)】。
2. 在“伸缩组”页面，单击【新建】。
3. 在弹出的“新建伸缩组”页面中，填写伸缩组名称、已创建的启动配置、最大伸缩数、最小伸缩数、起始实例数等信息。
其中“支持网络”及“支持子网”，**请选择已配置好的 VPC 及子网**。如下图所示：
![](https://main.qcloudimg.com/raw/c8431f9dd94eee73080b7850c615d896.png)
单击【下一步】即可完成设置。
