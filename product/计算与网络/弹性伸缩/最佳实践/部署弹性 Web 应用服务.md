## 操作场景
本文档将指导您利用腾讯云 [弹性伸缩](https://cloud.tencent.com/product/as) 完成部署弹性 Web 应用服务。弹性伸缩帮助您以最合适的实例数量应对业务情况。当业务需求增加时，为您无缝地自动增加适量 CVM 实例。当业务需求下降时，为您自动减少不需要的 CVM 实例，提高设备利用率，为您节省部署和实例成本。
文档中提供的方案适合集群式部署的网站或 App。且示例的网站结构比较简单，只有应用服务器一个集群。复杂的网站，会有应用服务器集群、前端服务器集群、缓存服务器集群等，每个集群都可进行类似操作，每个集群对应一个伸缩组。

#### 适用条件
- 网站使用集群的方式，且集群拥有超过1台以上的服务器。
- 网站有较长时间的空闲。大部分网站的高峰时间不超8个小时，剩下的16个小时的时间，完全可以把闲置的服务器作缩容处理，这种方式能帮助您节约大量成本。

本文档以某休闲类网站为例，假设该网站20:00 - 24:00是访问高峰时段。
- 非高峰时段的负载部署固定资源，可采用包年包月 CVM。
- 高峰时段采用按量计费的 CVM，通过定时任务在20:00扩容1台 CVM 实例，并在24:00进行缩容。
![](https://main.qcloudimg.com/raw/b9ecbc69bdb83958d446731a28c45c79.png)

## 步骤1：创建集群自定义镜像
基于一台集群中现有的机器制作镜像。关于创建自定义镜像的更多信息，请参考 [制作自定义镜像](/doc/product/213/4942)。
1. 登录 [云服务器控制台](https://console.cloud.tencent.com/cvm/index) 。
2. 在制作镜像前，需要关机实例。勾选需要关机的实例，单击上方【关机】。
3. 在需要制作镜像的实例右侧单击【更多】，单击【制作镜像】。
4. 在弹出框中，输入**镜像名称**和**镜像描述**，单击【确定】提交创建。创建自定义镜像需要一定的时间，请耐心等待。
5. 创建成功后，单击左侧导航栏中的【[镜像](https://console.cloud.tencent.com/cvm/image)】，即可跳转至镜像列表查看详细信息。

>!您需要提前部署好镜像中的环境，保证镜像里的应用能随操作系统启动，这样扩容出来的机器就能直接工作，无需人工介入。
## 步骤2：创建启动配置

扩容时弹性伸缩以 **启动配置** 为模板创建机器，因此需要事先通过 **启动配置** 指定地域、机型、镜像。
1. 登录弹性伸缩控制台，选择左侧导航栏中的【[启动配置](https://console.cloud.tencent.com/autoscaling/config)】。
2. 在“启动配置”列表页面上方，选择 Web 应用所在的项目和地域。本文以“默认项目”和“广州”为例。如下图所示：
![](https://main.qcloudimg.com/raw/976a3efb87d505f7c2b911ed4d42d4a4.png)
3. 单击【新建】，在弹出的“创建启动配置”页面选择机型及相关配置。
1. 选择机型。本文选择系列1标准型1颗CPU1GB内存。
关于机型选择的更多信息，请参考 [推荐选型](https://cloud.tencent.com/act/recommended)。
2. 选择镜像。在“镜像”中选择【自定义镜像】，指定您刚创建的镜像。本文以“test”为例。
3. 按需选择存储和网络，并单击【下一步：设置主机】。
4. 设置信息。设置密码及安全组，并单击【下一步：确认配置信息】。
5. 单击【创建启动配置】即可成功创建。


## 步骤3：创建伸缩组
1. 登录弹性伸缩控制台，选择左侧导航栏中的【[伸缩组](https://console.cloud.tencent.com/autoscaling/group)】。
2. 在“伸缩组”列表页面，单击【新建】进入“新建伸缩组”页面。
3. 在“新建伸缩组”页面，根据以下信息创建伸缩组，并单击【下一步】。如下图所示：
![](https://main.qcloudimg.com/raw/94f52a9c9fd5648600662a8a10c90c60.png)
 - **名称**：伸缩组的名称，本文以“应用服务器集群”为例。
 - **最小伸缩数**：集群服务器数量的下限，示例网站填0即可。
 - **起始实例数**：伸缩组刚创建时，自动创建的机器数量。一般不会刚创建伸缩组就自动创建机器，建议填0。
 - **最大伸缩数**：集群服务器数量的上限，请按需填写。本文做大伸缩数以5为例，即伸缩组最多有5台机器。
 - **启动配置**：选择刚才您创建的启动配置。
 - **支持网络**：会话服务器的网络环境，本文以“基础网络”为例。
 - **支持可用区**：即选择扩容机器创建在哪个可用区中，此处按会话服务器所在的可用区勾选即可。
 - **移出策略**：选择默认。
4. 选择负载均衡。扩容出来的机器会自动挂载到您关联的负载均衡下，您可以选择已有负载均衡或者新建负载均衡。确认无误后，单击【完成】，完成创建。入下图所示：
 **负载均衡**：选择集群的负载均衡，本文不选择负载均衡。
 ![](https://main.qcloudimg.com/raw/cddf56c3560a1e53d08b52c46d2ed14d.png)

## 步骤4：添加现有 CVM 实例进伸缩组
1. 在“[伸缩组](https://console.cloud.tencent.com/autoscaling/group)”列表页面，选择伸缩组 ID 进入该伸缩组管理页面。
2. 选择【关联实例】页签，并单击【添加实例】。如下图所示：
![](https://main.qcloudimg.com/raw/ae9e7178c3f039c8017c7dc643ac833f.png)
3. 在弹出的“添加实例”窗口中，选择集群已有的云服务器加入伸缩组。如下图所示：
如果现在是非高峰时期，集群中未充分利用的云服务器可以退还，节约成本。本文中两台名为 use 的云服务器，一台加入伸缩组，另一台可退还。
![](https://main.qcloudimg.com/raw/7587bddebcf0d26d3ce6b91f73808e14.png)
4. 成功添加后，对该云服务器设置“免于缩容”。
选择云服务器所在行右侧的【设置移出保护】，并在弹出框中单击【确定】。如下图所示：
![](https://main.qcloudimg.com/raw/f4ef1dd0720980ec934faadcbd7bbf17.png)
已设置移出保护的云服务器在缩容活动中，伸缩组不会选择该云服务器缩容。此机器将永久保留在集群中进行服务，AS 不会更改它。

## 步骤5：设置扩缩容策略
AS 支持定时扩容及基于告警动态扩容、接收扩缩容通知、查看历史扩缩容详情等功能。您可结合实际情况进行使用，如下图所示：
![](https://main.qcloudimg.com/raw/df993a33ecf84a8240ec695b050c735a.png)
本文以设置定时扩缩容任务为例。


1. 在“伸缩组管理”页面，选择【定时任务】页签，并单击【新建】。
2. 在“新建定时任务”窗口中，根据以下信息**设置一个20:00的定时扩容任务**，20:00云服务器数量增加至2台。如下图所示：
![](https://main.qcloudimg.com/raw/5f7af88ea2eb8dfb378cfc4ee054551b.png)
	- **名称**：输入任务名称，本文以“20:00扩容”为例。
	- **伸缩组活动**：
	- **更改最小实例数**：伸缩组最小实例数，保持为0不更改。
	- **更改期望实例数**：根据**执行开始时间**每天执行一次，本文中即为每日20:00都调整到2台云服务器。
	- **更改最大实例数**：伸缩组最大实例数，保持为5不变，您可按需设置。
	- **重复周期**：伸缩组活动的周期，本文设置每天执行一次。
	- **执行开始时间**：伸缩组活动重复开始时间，即 `2019-12-14 20:00` 开始活动，并按照重复周期执行。
	- **重复结束时间**：伸缩组活动重复结束时间，即 `2020-12-14 20:00` 后不再重复。
>! 腾讯云的 CVM 需要1分钟左右创建，如果自定义镜像较大，可能需要更多时间。您可以将执行开始时间提早5分钟。
>
3. 参考以上步骤，再**设置一个24:00的缩容任务**，24:00云服务器数量减少至1台。如下图所示：
![](https://main.qcloudimg.com/raw/9a2ad6bfd4acd218ffeb5f251df2fdd7.png)
至此，网站的后台集群变为“1台固定应用服务器+1台高峰时定时创建的应用服务器”。


