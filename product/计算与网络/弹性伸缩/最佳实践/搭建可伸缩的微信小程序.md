## 操作场景
### 部署架构
我们可以按以下架构创建微信小程序，其中业务服务器集群和会话管理服务器集群需要具备弹性伸缩能力。如下图所示：
![](https://imgcache.qq.com/open_proj/proj_qcloud_v2/gateway/solution/css/img/wx/fw-pic.png)

### 为什么配置弹性伸缩？
以下两个场景下弹性伸缩能降低成本和提高业务连续性：
- 小程序访问有明显的高峰低谷：根据测算，如果业务服务器集群和会话服务器集群需要不止一台机器，且高峰短于8个小时，采用**按闲时保留固定服务器 + 高峰时期增加临时服务器**的方式，能节约30%左右成本。您可以通过 AS 设置定时扩缩容任务，让腾讯云在忙时扩容临时服务器，闲时回收终止未充分利用的服务器。
- 小程序访问量稳定的预期下：配置基于监控告警的伸缩策略可应对意外高负载，保障服务的持续可用，给问题解决争取时间。异常高负载包括 [CC攻击](http://baike.baidu.com/link?url=aSNcL5Q_xzDxPvFYRU3qbS11NIQXD5vwvI5yxtJTVlL0xhjAaLntwmDHVW8buUlH4bbNJqMzCPp8b1N2LX-OnwAUR3MnE9GhH-F7fomUac3) 以及意外流量（例如“脸萌”刚上线的远超预期的传播速度，或特定事件带来的突发访问）。详情请参见公益网站 [宝贝回家](https://cloud.tencent.com/community/article/651089001483090830) 的案例。

### 弹性伸缩会做哪些事情？
弹性伸缩可以帮助您：
1. 定时给集群增加机器或减少机器。
2. 根据集群服务器的负载情况自适应地增加机器或减少机器。
3. 加的机器会自动注册到负载均衡中，实现全自动扩容。

>!弹性伸缩能力免费，扩容的 CVM 按秒正常计费。

## 前提条件
将微信小程序的能力搭建起来，详情请参见 [详细步骤](https://console.cloud.tencent.com/la/guide)。

## 操作步骤
### 为会话服务器配置弹性伸缩策略
#### 创建启动配置
>?扩容时以**启动配置**为模板创建机器，因此我们事先通过启动配置指定地域、机型、镜像。
>
1. 登录 [弹性伸缩控制台](https://console.cloud.tencent.com/autoscaling/config)，单击左侧导航栏中的【启动配置】。
2. 选择项目和地域，这里要注意必须选择小程序所在的项目和地域。
![](https://main.qcloudimg.com/raw/ebc98eb8ffbba2ce10c3cba969b350f0.png)
3. 按需选择配置，完成启动配置创建。如下图所示：
![](https://main.qcloudimg.com/raw/cf677c9ac78494eade08a1663bce2700.png)
>!此前您需要制作好镜像，需确保镜像里的应用能随操作系统启动。这样扩容出来的机器就能直接工作，无需人工介入。


#### 创建伸缩组
登录 [弹性伸缩控制台](https://console.cloud.tencent.com/autoscaling)，单击【新建】，按如下填写集群的管理信息后选择【完成】，完成创建。如下图所示：
- **名称**：按需起一个名字，这里填“会话服务器集群”。
- **最小伸缩数**：集群服务器数量的下限，这里填0即可。
- **起始实例数**：伸缩组刚创建时，自动创建的机器数量。这里填0即可。
- **最大伸缩数**：集群服务器数量的上限，这里按需填写。
- **启动配置**：选择刚才您创建的启动配置。
- **支持网络**：会话服务器的网络环境，一般选“基础网络”即可。
- **支持可用区**：即选择机扩容器落在哪个可用区里，此处按会话服务器所在的可用区勾选即可。
- **移出策略**：选择默认即可。
- **负载均衡**：选择会话服务器的负载均衡。
![](https://main.qcloudimg.com/raw/1ddc3f8012660306073721fb562bba8f.png)



####  添加现有机器进伸缩组
1. 在 [伸缩组列表页](https://console.cloud.tencent.com/autoscaling)  单击伸缩组 ID，进入伸缩组详情页。
2. 单击【关联实例】，选择实例列表页中的【添加实例】。如下图所示：
![](https://main.qcloudimg.com/raw/acb6ab01234b075b23167b3dc2c1b215.png)
3. 在弹出的“添加实例”页面中选择已有的会话服务器，并单击【确定】加入伸缩组。如下图所示：
![](https://main.qcloudimg.com/raw/384ba41ad2abc5287bad88f16bf47fbd.png)
4. 添加实例成功后，进入伸缩组列表页。单击该实例右侧【设置移出保护】，并在弹出对话框中选择【确认】。如下图所示：
![](https://main.qcloudimg.com/raw/7550e724fd439e3d078c00dedc172e36.png)
设置成功后服务器即可“免于缩容”，这样在缩容活动中，伸缩组不会选择这台服务器缩容。

#### 设置扩容策略
>?通常扩容任务和缩容任务成对出现。
>
##### 定时扩缩容
例如一个点餐小程序，可预期午饭时间的负载比其他时间高，您可以进行如下设置：
1. 在伸缩组详情页单击【定时任务】，并选择【新建】。如下图所示：
![](https://main.qcloudimg.com/raw/acca10e746487c035e5aefd82d2b58c2.png)
2. 设置定时扩容任务：**每天**11：00 - 13：00扩容2台额外服务器支撑负载。如下图所示：
![](https://main.qcloudimg.com/raw/241844ab8d2208345696330015323f96.png)
3. 设置定时缩容任务：**每天**15:00 - 17:00缩容2台服务器减少支撑负载。如下图所示：
![](https://main.qcloudimg.com/raw/a0ffaca1fe4712e350e255e88bcc12a0.png)

##### 基于告警扩容
设置预期不明确的扩容，但需要防范出现意料之外的流量/攻击。您可以进行如下设置：
1. 在弹性伸缩组详情页单击【告警触发策略】，并选择【新建】。如下图所示：
![](https://main.qcloudimg.com/raw/997fc8d168bc09a27b2b91854fc4ba00.png)
2. 设置告警扩容策略，用于应对异常流量。如下图所示：
![](https://main.qcloudimg.com/raw/27850ffe5eebb5b34fa6823e5ece4312.png)
   - **if**：此项为策略设置条件，图中设置为伸缩组内所有实例 CPU 利用率1分钟内最大值80%，连续1次。
   - 伸缩组活动：增加2台实例，冷却0秒。
3. 设置告警缩容策略，用于清退未充分利用的服务器。如下图所示：
![](https://main.qcloudimg.com/raw/364cddd11c382e031c35ce34cdbdb203.png)
   - **if**：此项为策略设置条件，图中设置为伸缩组内所有实例 CPU 利用率1分钟内最大值20%，连续1次。
   - 伸缩组活动：减少2台实例，冷却0秒。


### 为业务服务器配置弹性伸缩策略
这个过程与会话服务器类似：
- 为业务服务器创建一个启动配置。
- 为业务服务器创建一个伸缩组“业务服务器集群”，指向业务服务器的负载均衡。
- 为业务服务器设置伸缩策略。

### 验证伸缩性
1. 进入伸缩组详情页，单击基本信息右上角【编辑】。如下图所示：
![](https://main.qcloudimg.com/raw/494726f251d350901191e90a3953ae13.png)
2 在基本信息编辑页将伸缩组的期望实例数+1，并单击【保存】。如下图所示：
![](https://main.qcloudimg.com/raw/b502a34e2d4c8c0eb01eae68c3a377d0.png)
设置成功后伸缩组会自动扩容一台服务器到集群中，如果新扩的机器能正常处理请求，说明伸缩组已正常工作。

### 查看伸缩活动
伸缩组还支持 [查询历史伸缩活动](https://cloud.tencent.com/document/product/377/3804)，确保您完全掌控伸缩活动情况。

至此，您的小程序已经具备了智能扩容的能力。您无需再为扩容缩容的问题操心，只需留意伸缩组通知或者不定期查看历史伸缩活动即可。
