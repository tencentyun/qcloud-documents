## 操作场景

消息队列 CKafka 支持用户转储消息的能力，您可以将 CKafka 消息转储至 COS 以便于对数据进行分析与下载等操作。
处理流程及架构如下：
![](https://main.qcloudimg.com/raw/8fdf8c6f74a3d4597688fddd4a3bffd4.svg)

## 前提条件

该功能目前依赖云函数（SCF）、对象存储（COS）等产品，使用时需开通相关产品功能。

## 操作步骤

1. 登录 [CKafka 控制台](https://console.cloud.tencent.com/ckafka) 。
2. 在左侧导航栏单击【实例列表】，单击目标实例的“ID/名称”，进入实例详情页。
3. 在实例详情页，单击【topic管理】标签页，单击操作列的【消息转储】。
4. 单击【添加消息转储】，转储类型选择【对象存储 COS】。
   ![](https://main.qcloudimg.com/raw/5dc536171f2f46dd513c464cf76e20b6.png)
    - 转储类型：选择对象存储（COS）。
    - 时间粒度：根据消息量的大小，选取汇聚消息的时间间隔，时间间隔为5 - 60分钟不等。为保证转储性能，聚合文件数量与 Partition 数量，partition_max 设置数值有关，具体详见文档底部产品限制说明。
    - 存放 Bucket：对不同的 topic，选取相应的 COS 中 Bucket，则请求消息会自动在 Bucket 下创建 instance-id/topic-id/date/timestamp为名称的文件路径进行存储。相关路径如无法满足业务需要，请创建完成后在云函数 CkafkaToCosConsumer 下自行修改。
    - 起始位置：转储时历史消息的处理方式，topic offset 设置。
    - 角色授权：使用云函数 SCF 产品功能，您需要授予一个第三方角色代替您执行访问相关产品权限。
    - 云函数授权：知晓并同意开通创建云函数，该函数创建后需用户前往云函数设置更多高级配置及查看监控信息。

如果您还未创建对象存储的 Bucket，请在 [新建 Bucket](https://console.cloud.tencent.com/cos/bucket) 后选取相应的存储位置。

## 方案对比

| 对比项       | 自建服务                                                     | Serverless方案                                      |
| ------------ | ------------------------------------------------------------ | --------------------------------------------------- |
| <nobr>基础设施</nobr>     | 需要用户采购和管理                                           | 只需要专注业务逻辑的开发,在控制台自行部署服务即可   |
| 项目上线周期 | 在具体业务逻辑外耗费大量的时间和人力成本，保守估计大约30人天，包括硬件采购、软件和环境配置、系统开发、测试、监控报警、灰度发布系统等 | 预计3人天， 开发调试（2人天）+ 压测观察（1人天） |
| 学习上手成本 | 除了编程语言开发能力和熟悉 Connector 以外，可能使用 K8S 或弹性伸缩，需要了解更多的产品、名词和参数的意义 | 预计 3 人天， 开发调试（2人天）+ 压测观察（1人天） |
| 压测性能     | 传统 Logstash 消费能力：200+MB/分钟                          | Serverless 方案消费能力：6000+MB/分钟               |

## 产品限制和费用计算

- 转储速度与 CKafka 实例峰值带宽上限有关，如出现消费速度过慢，请检查 CKafka 实例的峰值带宽或增加 CKafka partition 数。
- 转储速度与 CKafka 单个文件大小相关，如超过该500M，会自动分包上传。
- 当前仅支持和 CKafka 实例同个地域的 COS 进行消息存储，为保证延时，不支持跨地域存储。
- 使用COS消息转储，文件内容是 CKafka 消息里的 value 用 utf-8 String 序列化拼接而成，暂不支持二进制的数据格式。
- 开启转 COS 的操作账号必须对目标 COS Bucket 具备写权限。
- 使用 COS 消息转储必须至少拥有一个 VPC 网络环境，如在创建时选择基础网络请参考 [路由接入方式](https://cloud.tencent.com/document/product/597/36348)  绑定 VPC 网络。
- 该功能基于云函数 SCF 服务提供。SCF为用户提供了一定 [免费额度](https://cloud.tencent.com/document/product/583/12282) ，超额部分产生的收费，请以 SCF 服务的 [计费规则](https://cloud.tencent.com/document/product/583/17299) 为准。
- 转储方案价格与 CKafka Partition 数有关，当前 Partition 个数与函数并发个数保持一致。若需修改函数并发个数请检查 schedule 函数逻辑。
