## 概述

动态指标预置属于 [预置并发](https://cloud.tencent.com/document/product/583/46743) 的弹性策略，云函数系统将周期性采集函数实际并发执行情况，结合已配置的最大、最小并发数以及目标并发利用率指标来控制预置并发功能的动态伸缩，使函数预置并发数更加接近资源的真实使用量，提高预置并发的利用率，降低了过多的闲置费用。当函数实际所需并发大于动态指标预置的并发数时，则通过按量模式进行弹性扩容操作。

## 适用场景

- 对预置闲置费用非常敏感的业务，可使用动态指标预置功能降低预置闲置费用。
- 对冷启动比较敏感且无法预知业务流量高峰的函数。

## 实现原理

动态指标预置时会根据业务配置的动态策略进行伸缩。若业务设置了最小、最大并发数以及并发利用率指标，系统将会保证最小并发数的预置资源，同时预置并发数将会在最小值和最大值之间动态伸缩。

**扩缩容策略**

- **扩容**：当业务实际请求量不断增加，触发扩容阈值时系统开始扩容，达到最大并发数上限时则停止扩容操作。超出部分的请求将会通过按量模式进行扩容。
  扩容频率：每10秒进行一次扩容操作，扩容没有窗口时间。

- **缩容**：当业务实际请求量不断减小，触发缩容阈值时系统开始缩容，达到最小并发数下限时则停止缩容操作。
  缩容频率：缩容时通过10分钟的窗口时间来实现相对保守的缩容过程，即在执行动态伸缩操作后，在窗口时间内不会再进行缩容操作，可以理解为类似等一下放技能的冷却时间。若此前没有执行过扩缩容操作，则10秒就可以进行缩容操作。
  ![img](https://qcloudimg.tencent-cloud.cn/raw/935358b4a58446fe75fde98edbeb8939.png)



**预置目标值**
 预置目标值由当前并发数、目标并发利用率指标共同决定。
- **预置目标值** = 当前函数总实例数 × 当前并发利用率 ÷ 目标并发利用率 = 当前函数总实例数 × (当前并发数 ÷ 当前函数总实例数) ÷ 目标并发利用率 = **当前并发数/目标并发利用率指标**
- 预置目标值计算示例：当前并发数为100，目标并发利用率为80%，经过计算100 / 80% = 125，即预置目标值的会扩容到125个。

**并发利用率**
函数的并发利用率是指当前函数实例正在响应的请求并发值与当前函数总实例数占比，指标取值范围为[0,1)。


**最小并发数**
最小并发数代表该函数最少需要预置的并发个数，即缩容的下限值。


**最大并发数**
最大并发数代表该函数最多可预置的并发个数，即扩容的上限值。

## 操作步骤

### 新增动态指标预置
1. 登录云函数控制台，选择左侧导航栏中的 [函数服务](https://console.cloud.tencent.com/scf/list)。
2. 在“函数服务”列表页面，选择需进行配置的函数名，进入“函数管理”页面。
3. 选择左侧**并发配额** > **预置并发**，进入“预置并发”页面。
4. 在“预置并发”页面中，单击**新增预置并发**。如下图所示：
   ![](https://main.qcloudimg.com/raw/075e1b3898af140dc1e4cb9df6c7056e.png)
5. 在弹出的“新增函数预置并发”窗口中，选择预置类型为动态指标预置，函数版本。按照业务场景设置最小并发数、最大并发数以及目标并发利用率指标，单击**提交**即可。如下图所示：
   ![](https://qcloudimg.tencent-cloud.cn/raw/1a35512dccc6c98a21e3117910428a9a.png)
   设置完成后，您可在“预置并发”中查看配置的状态。云函数后台将花费一定的时间完成预置并发的扩容，并将已启动准备的并发数、完成情况展示在列表中。




### 更新动态指标预置

更新动态指标预置时，您可以修改预置类型，最小并发数、最大并发数以及目标并发利用率指标等参数。

1. 登录云函数控制台，选择左侧导航栏中的 [函数服务](https://console.cloud.tencent.com/scf/list)。
2. 在“函数服务”列表页面，选择需更新预置并发函数，进入“函数管理”页面。
3. 选择左侧**并发配额** > **预置并发**，进入“预置并发”页面。
4. 在“预置并发”页面中，选择需更新版本所在行右侧的**设置**。
5. 在弹出的“设置函数预置并发”窗口中，更新设置值并单击**提交**即可。如下图所示：
   ![](https://qcloudimg.tencent-cloud.cn/raw/5ede39e60c30fc631797c455f6bfc9c2.png)
>! 预置类型支持基础预置，动态指标预置。二者任选其一，业务更新预置类型后，此前设置的预置类型将会失效。

### 删除动态指标预置
1. 登录云函数控制台，选择左侧导航栏中的 [函数服务](https://console.cloud.tencent.com/scf/list)。
2. 在“函数服务”列表页面，选择需删除预置并发函数，进入“函数管理”页面。
3. 选择左侧**并发配额** > **预置并发**，进入“预置并发”页面。
4. 在“预置并发”页面中，选择需调整版本所在行右侧的**删除**。如下图所示：
   ![](https://qcloudimg.tencent-cloud.cn/raw/908ca60c312c1c87cb4bb62b5d65f637.png)
5. 在弹出的“删除函数预置并发配额”窗口中单击**确认**即可。

