## 使用场景

在音视频转码、ETL 大体量数据处理、AI 推理等单任务重计算的场景下，函数的单实例运行时需要更多算力及更长时间的稳定运行。若函数的调用端长时间阻塞等待执行结果，不仅会持续占用调用方资源，还会对调用链路的稳定性产生较高要求。
云函数 SCF 提供了一种全新的函数运行机制，您可通过 SCF 提供的函数异步执行模式，提升执行超时时间上限和解决现有运行机制的问题。

## 操作步骤
1. 登录 [云函数控制台](https://console.cloud.tencent.com/scf/list?rid=16&ns=default)，单击左侧导航栏的【函数服务】。
2. 在主界面上方选择期望创建函数的地域，并单击【新建】，进入函数创建流程。
3. 选择使用【空白函数】或选择使用【函数模板】来新建函数。
4. 在“函数配置”页面，展开【高级设置】，并勾选【异步执行】。
5. 单击【完成】即可创建函数。




## 运行机制

### 基础原理

函数启用异步执行后，通过同步（例如 API 网关）或异步（例如 COS、CKafka、Timer 等）调用端进行事件调用，函数将以异步执行模式响应事件。
即完成事件调度后立即返回事件的调用标识 RequestId，并结束调用操作，调用端无需阻塞等待。返回 RequestId 的同时，调用引擎将并行下发事件到函数运行时，开启函数逻辑执行。进入异步执行状态后，执行日志将实时上报至日志服务，提供对异步执行事件运行情况的实时反馈。其原理如下图所示：
![](https://main.qcloudimg.com/raw/36557e028090175f79b879ac0ad6f66b.png)

### 注意事项

- 由于运行机制差异，暂不支持切换同步/异步执行模式。仅支持创建函数时选择是否开启“异步执行”功能，函数创建后该配置将锁定，不提供修改更新操作。
- 事件调用成功，返回信息只包含 RequestId。事件执行结果需要在函数代码逻辑中自行实现回调特定的 API 或者发送通知消息。
- 实时日志强依赖于日志服务，系统将默认开启日志服务 CLS，您需要在函数高级配置中选定已有日志集及主题。
  - 如果没有日志集或日志主题，则需要新建。
  - 如果不开启日志服务 CLS，将无法获取实时日志。
- 异步执行目前支持最长执行时长为24小时。如需更长运行时长，可 [提交工单](https://console.cloud.tencent.com/workorder/category) 申请。
- 如果通过函数运行角色获取对其他云服务组件的访问权限，角色密钥有效期最长为12小时，需要考虑延长有效期策略或使用长期有效密钥。

## 状态追踪

### 基础原理

函数高级配置启用状态追踪后，针对异步执行的事件，将开始记录并上报事件响应的实时状态，并提供事件状态的统计、查询及终止等事件管理相关服务。其原理如下图所示：
![](https://main.qcloudimg.com/raw/d06476734d27d3308783e78af85897a2.png)

### 相关接口

事件管理相关服务 API 通过云 API 的方式提供：

<table>
<thead>
<tr>
<th>API 接口</th>
<th>说明</th>
<th>相关文档</th>
</tr>
</thead>
<tbody><tr>
<td>GetAsyncEventOverview</td>
<td>异步执行函数事件运行状态数据汇总概况，包含以下事件状态：
<li>运行中：事件异步执行中。</li>
<li>调用成功：事件异步执行成功，正常返回。</li>
<li>调用失败：事异步执行件失败，异常返回。</li>
<li>调用终止：用户主动对运行中的事件发起终止，异步执行停止并返回。</li>
</td>
<td>-</td>
</tr>
<tr>
<td>ListAsyncEvents</td>
<td>异步执行函数事件信息数据列表，提供根据事件 RequestId、函数名、函数版本、事件状态、事件调用/结束时间等条件对异步执行事件信息的查询功能。
<dx-alert infotype="notice" title="">
仅可查询数据范围为开启事件追踪后3天内数据。
</dx-alert>
</td>
<td><a href="https://cloud.tencent.com/document/api/583/52501">拉取函数异步事件列表</a></td>
</tr>
<tr>
<td>TerminateAsyncEvent</td>
<td>异步执行函数通过调用返回的事件 RequestId，对运行中异步执行事件下发终止指令，终止完成后返回。</td>
<td><a href="https://cloud.tencent.com/document/api/583/52500">终止正在运行中的函数异步事件</a></td>
</tr>
</tbody>
</table>









### 注意事项

- 产生的事件状态数据仅保留3天，将以3天为时间窗口滑动清理。如需保留全部记录，则需要定期拉取并保存至自有存储。
- 关闭状态追踪后，将停止提供异步执行事件相关记录、统计、查询、终止等事件管理相关服务，已产生的事件状态数据将在3天内清空。
- 异步运行函数的事件调用 QPS 限制为并发数量的十分之一，超出部分将被限制，造成响应失败。
- 由于请求 QPS 超限、账户欠费等原因，事件调用将由调度引擎直接返回对应异常，不会生成事件状态记录。


