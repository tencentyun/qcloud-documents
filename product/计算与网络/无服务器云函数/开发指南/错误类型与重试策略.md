在函数调用的过程中，可能有多种原因导致函数调用失败。不同的**错误类型**以及**调用方式（同步调用、异步调用）**都会影响重试策略。您可以配置死信队列收集错误事件信息、分析失败原因。

## 错误类型
在函数调用的过程中，可能有多种原因导致函数调用失败。错误类型分为以下几类：

### 调用错误
调用错误发生在函数实际执行前。以下情形均会产生调用错误：
  * **调用请求错误**。例如传入的 Event 数据结构过大、入参不符合要求、函数不存在等。
  * **调用方错误**。主要出现在调用方权限不足的情形。
  * **超限错误**。调用的并发数超出 [最大并发数](https://cloud.tencent.com/document/product/583/11637) 限制。

### 运行错误
运行错误发生在函数实际运行中。运行错误有以下情形：
  * **用户代码运行错误**。这类错误出现在用户代码执行过程中，例如函数代码抛出异常，或者返回结果格式问题等。
  * **Runtime 错误**。函数运行过程中，Runtime 负责拉起用户代码并执行。Runtime 错误指的是 Runtime 发现并上报的错误，例如函数运行超时（超时的时间限制请参见 [限制说明](https://cloud.tencent.com/document/product/583/11637)）、代码语法报错等。

### 系统错误
函数平台的错误，例如 internal error。

## 重试策略
不同**错误类型**以及**调用方式（同步调用、异步调用）**都会影响重试策略。

### 同步调用
同步调用有三种： [云 API 触发器](https://cloud.tencent.com/document/product/583/18198) 的同步调用、[API 网关触发器](https://cloud.tencent.com/document/product/583/12513) 及 [CKafka 触发器](https://cloud.tencent.com/document/product/583/17530)。
由于同步调用的过程中，错误信息会直接返回给用户，所以在同步调用中发生错误时，平台不会自动重试，重试策略（是否重试、重试几次）均由调用方决定。

>! Ckafka 触发器会创建后台模块作为消费者，连接 CKafka 实例并消费消息。后台模块在获取到消息后，同步调用触发函数。由于 CKafka 触发器的后台模块是由云函数侧维护，即使是同步调用，其重试策略仍由云函数侧控制。
>- 对于运行错误（含用户代码错误和 Runtime 错误），CKafka 触发器会按照您配置的重试次数进行重试。默认重试10000次。
>- 对于超限错误和系统错误，CKafka 触发器会采用指数退避的方式持续重试，直至成功为止。

### 异步调用
异步调用有四种：[云 API 触发器](https://cloud.tencent.com/document/product/583/18198) 的异步调用、[COS 触发器](https://cloud.tencent.com/document/product/583/9707)、[定时触发器](https://cloud.tencent.com/document/product/583/9708) 及 [CMQ Topic 触发器](https://cloud.tencent.com/document/product/583/11517)。
当异步调用发生以下类型错误时，重设策略如下：
  - **运行错误**（含**用户代码运行错误**和 **Runtime 错误**）：当发生该类错误时，函数平台将自动重试两次。第一次与原事件间隔1分钟，第二次与第一次间隔2分钟。在自动重试的同时，新的触发事件仍可正常处理。如果您配置了死信队列，三次失败后的事件将传入死信队列，否则事件将被函数平台丢弃。
  - **超限错误**和**系统错误**：当发生该类错误时，函数平台会持续进行重试24小时，重试间隔按照指数退避增加到1小时。如果您配置了死信队列，重试超过24小时仍失败的事件会被发送到死信队列，由用户进行进一步处理，否则事件将被函数平台丢弃。
  - **调用请求错误**和**调用方错误**：当发生该类错误时，平台不会进行重试，因为此类错误即便重试也不会成功。

## 死信队列
死信队列 DLQ 是一个用户账号下的 CMQ 队列，可用于收集错误事件信息、分析失败原因。如果您给函数配置了死信队列，以下情形的事件会被发送到死信队列：
* 用户代码运行错误重试2次依然失败。
* 超限错误和系统错误重试超过24小时。
* [异步队列](https://cloud.tencent.com/document/product/583/9694#asynchronous) 消息堆积达到上限。

>?死信队列功能目前处于内测阶段，如需使用请申请开通消息队列 CMQ。



### 死信队列消息属性
- **RequestID**：（字符串）事件调用请求的唯一标识
- **ErrorCode**：（数字）错误码状态
- **ErrorMessage**：（字符串）错误信息

死信队列投递至 CMQ 时会把属性信息与事件信息封装在一个 Json 请求体中，格式如下：
```
{
  "RequestId": "b615b896-d197-47d7-8919-xxx",
  "ErrorCode": -1,
  "ErrorMessage": "Traceback (most recent call last):\n File \"/var/user/index.py\", line 5, in main_handler\n if 'key1' in event.keys():\nNameError: global name 'event' is not defined",
  "Body": {
    "AppId": xxx,
    "Uin": "xxx",
    "SubAccountUin": "xxx",
    "RequestSource": "TRIGGER_TIMER",
    "FunctionName": "tabortest",
    "Namespace": "default",
    "Qualifier": "$DEFAULT",
    "InvocationType": "RequestResponse",
    "ClientContext": "{\"Type\":\"Timer\",\"TriggerName\":\"tabortimer\",\"Time\":\"2020-10-10T01:22:00Z\",\"Message\":\"\"}",
    "LogType": "",
    "TimeStampForInvoker": "160229310xxx",
    "RequestId": "b615b896-d197-47d7-8919-xxx",
    "PushTime": "2020-10-10T09:22:00.061824591+08:00",
    "RetryNum": 2,
    "Ttl": 0
  }
}
```





### 死信队列创建流程
>?云函数目前支持 CMQ 的主题模式和队列模式作为死信队列，您可自行选择配置。
>
1. 登录 [CMQ 消息队列控制台](https://console.cloud.tencent.com/cmq/index?rid=1)，创建您的死信队列。
CMQ 的主题模式支持标签过滤与路由匹配两种筛选方案，为了确保您的订阅者可以收到所有错误信息，请在添加订阅者时标签栏筛选设为**空**，BindingKey 筛选填**“#”**。
2. 登录 [云函数控制台](https://console.cloud.tencent.com/scf/list?rid=1&ns=default)，创建您的函数。
3. 配置死信队列。
 您可以在“新建函数”页面或“函数配置”页面进行死信队列的配置。

>?函数别名的死信队列会跟随主版本的死信队列，主版本死信队列即在控制台创建别名时第一个选择并配置的死信队列。
 
### 死信队列监控
 
使用死信队列时，权限错误、资源误配或消息的总大小超过目标队列或主题的限制大小均会导致死信投递失败。您可在云函数监控信息中查询到该监控项参数，死信队列投递失败次数/次（DeadLetterErrors）。
1. 登录 [云函数控制台](https://console.cloud.tencent.com/scf/index?rid=1)，选择左侧导航栏中的【函数服务】。
2. 在主界面上方选择期望查看死信队列监控的函数所在地域，并单击列表页中期望查看监控的函数，进入函数详情页面。
3. 在函数详情页中，单击【监控信息】即可查看死信队列投递失败次数。如下图所示：
![](https://main.qcloudimg.com/raw/d86064c68fbc069603cb388545ca71ed.png)

