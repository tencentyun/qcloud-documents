## 1. 虚拟客户机关机过程分析
以下是腾讯云Windows虚拟机的关机过程。

1) 母机上的libvirt将shutdown命令通过qmp协议传给qemu组件；
2) qemu组件将shutdown命令通过注入acpi中断方式传入子机(相关细节可阅读vmcs有关的技术文档)；
3) Windows收到关闭信号后，通知应用程序和服务进程退出；
4) 关闭核心服务进程；
5) 关闭电源。

Windows上的关机过程大致如上面过程所示，其中3~4步骤根据系统的设置不同，各个应用程序和服务的关闭顺序可能会不同。

Windows是一个闭源系统，提供了一些API可以让内核态和用户态的程序对关机过程进行干预，同时Windows本身的一些服务在运行过程中也会影响关机过程，导致无法关闭计算机。在某些情况下，Windows的关机过程会比较漫长，导致无法关闭计算机。

在虚拟化场景下中，除了通过消息通知Windows本身的关机之外，也提供另一种停止虚拟机的手段，类似物理机上关闭电源的方式，我们把这种关机叫做**硬关机**，而由系统信号发起的关机操作，相对的称之为**软关机**。

硬关机对Windows本身和用户体验是有影响的，主要有以下两方面：

1) 硬关机中断了某些服务和应用程序，导致这些程序工作可能不正常，例如未保存的文档，没有完成的WindowsUpdate过程等；

2) 由于Windows的NTFS系统(或早期的FAT32等系统）在关机的过程中，会写入一些关键数据，硬关机可能会造成这些关键数据未写入磁盘，从而导致Windows认为NTFS文件系统损坏。

基于上述原因，我们建议腾讯云的用户，<font color="red">优先使用软关机</font>的方式关闭Windows。

## 2. 关机失败的几种场景
但是由于前述所讲的，Windows系统里面可能存在某些问题，使得关机过程被影响而无法关闭。包括但不限于的以下几种场景：

1) WindowsUpdate过程可能会延长关机时间。Windows在做某些补丁操作的时候，会在关闭系统的时候做一些处理，这个时候，屏幕上一般会显示“请不要关闭计算机电源或拔出电源线”等信息。

![](//mccdn.qcloud.com/img56b1d328d17b1.jpg)

2) 如果Windows系统开启了“关机事件跟踪”机制，当系统的服务和驱动程序出现错误，系统在关机的时候，会根据配置，给用户提示框，或者填写错误描述，等待用户完成这些操作。在用户未完成这些操作之前，Windows不会关闭电源。

3) Windows可以设置用户在未登录系统的时候，不允许关机。在这种情况下，虚拟化主机发送的软关机指令被Windows丢弃，无法达到关机的目的。

4) Windows在关机的时候，广播消息到每一个服务和应用程序，如果这些程序响应这个消息没有返回可以关机的应答，则Windows不会进行关机处理。这种场景下，Windows可以做一些相关的设置，忽略这个过程。


5) Windows设置电源管理相关的操作中“当按下电源时Windows的处理方式”，如果设置成忽略或不做操作，Windows将忽略虚拟化母机的关机事件。

6) Windows由于电源管理的设置，进入休眠，不会处理关机事件。

7) Windows初次购买，由于使用的sysprep的方式分发镜像，初始化过程稍长，初始化未完成的时候，Windows忽略关机事件。

8) Windows系统里面如果安装某些恶意的软件，或者中了木马、病毒等，Windows系统环境本身遭受了破坏，可能会阻止Windows关机。

腾讯云在发布Windows公共镜像时，对上述大部分场景做了优化，使得软关机可以顺利完成。这些的优化方式措施，集成在[Windows电源管理](http://www.qcloud.com/doc/product/213/Windows%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE#4.-配置高性能电源管理)的脚本里，主要是对电源管理、关闭“关机事件跟踪”、未登录状态关机等Windows的特性进行调整。

但是这些优化措施是不能解决Windows中了病毒和木马，以及系统被损坏等场景的；另外，用户Windows虚拟机里的这些相关的设置如果被再次调整，也不能保证软关机顺利进行。而在某些时候，强制关机也会造成风险，比如WindowsUpdate过程中，需要等待更新为完成。用户在进行软关机的过程，需要通过打开VNC，查看这些关机失败的场景，根据需要做出正确的处理。在十分必要的时候再进行硬关机操作。