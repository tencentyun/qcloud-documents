创建流量镜像后，即可实现将指定采集范围的流量按不同过滤条件过滤，并复制转发至私有网络 VPC 下的 CVM 集群或与私有网络互通的 IDC 服务器上，可用于安全审计、故障排查、业务分析等场景。本文将介绍如何创建流量镜像。
>? 目前流量镜像处于灰度中，如有需要，请提交 [工单申请](https://console.cloud.tencent.com/workorder/category)，为避免多次申请，建议保存好申请时获取的链接，方便您登录流量镜像控制台。

## 前提条件
+ 当采集 VPC 中的弹性网卡流量时，请确保被采集流量的 IP 与流量接收 IP 在同一个 VPC 内，且流量采集 IP 有针对流量接收 IP 的路由表。
+ 当采集公网 IP 流量时，如接收端为 IDC 服务器，请确保流量镜像所属私有网络与 IDC 互通，私有网络有指向IDC的路由表。

## 操作步骤
### 步骤一：设置采集流量
1. 请使用通过 [工单申请](https://console.cloud.tencent.com/workorder/category) 获取的链接，登录流量镜像控制台，在顶部导航栏，选择待创建流量镜像的地域。
2. 在流量镜像页面单击【+新建】，进入【新建流量镜像】界面。
>?每个 VPC 最多创建5个流量镜像。
>
![](https://main.qcloudimg.com/raw/498a30d5fb22598a5dabe0ea94f2f121.png)
3. 在【新建流量镜像】中的【设置采集流量】界面进行如下基本信息配置：
 - **名称**：请填写流量镜像的名称，不超过60字符。
 - **所属网络**：选择流量镜像所属私有网络。
 - **采集范围**：根据实际情况，选择待采集流量的采集范围：
    - **私有网络**：采集 VPC 内除接收 IP 的镜像端口流量，一般用于全镜像场景。
![](https://main.qcloudimg.com/raw/43a15668898d95a707c26b4977a7049b.png)
     - **子网**：采集 VPC 子网内除接收 IP 的镜像端口流量。选择子网后，需勾选具体子网网段。
    ![](https://main.qcloudimg.com/raw/17192ec04b25c606e1e5f5c3811aa55b.png)
     - **弹性网卡**：采集 VPC 内除绑定接收 IP 的弹性网卡的流量。选择弹性网卡后，需勾选具体弹性网卡。
      ![](https://main.qcloudimg.com/raw/63eb07959e5ecf1907e8ed5a82af4827.png)
     - **公网IP**：采集绑定该公网 IP 的流量。支持配置多个公网 IP，多个使用换行符或逗号分隔。
    
      > 说明：
      > 此处公网 IP 可以为弹性公网 IP 或外网 CLB VIP。
      > 
    ![](https://main.qcloudimg.com/raw/4aec30002bdec242ae9be29c018359f3.png)
    
 - **采集类型**：根据业务类型选择采集流量方向，支持**全部流量**、 **出流量**和**入流量**。

    > 说明：
    > 当采集范围为【公网IP】时，采集类型仅支持【全部流量】。
    > 
 - **流量过滤**：根据业务类型选择流量过滤方式，过滤掉不需要的流量可以减轻镜像的规模和压力。
    > 说明：
    > 当采集范围为【公网IP】时，流量过滤仅支持【不过滤】。
    > 
    - **不过滤**：采集配置的全部流量。
    - **五元组**过滤：采集满足五元组条件的流量。选择**五元组**后，需设置**协议**、 **源网段** 、**目的网段**、 **源端口**和**目的端口**。若需增加筛选条件，请单击【添加】，多个筛选条件为“与”关系。
    ![](https://main.qcloudimg.com/raw/570590952efb6f89e581f94564ecdcd3.png)
    - **下一跳为 NAT 网关**：采集下一跳为 NAT 网关的流量。选择**下一跳为 NAT 网关**后，需在**筛选条件**右侧选择具体 NAT 网关。
4. 完成配置后，单击【下一步】。

### 步骤二：设置接收流量
1. 根据不同采集范围，设置接收流量页面信息。
 + 当采集范围为【私有网络】、【子网】、【弹性网卡】时，请参考如下配置指导：
    + **接收 IP**：填写接收转发流量的 IP 地址。
       > ?
       > + 接收 IP 为空时，表示不转发任何流量，因此至少需添加一个接收 IP。
       > + 若有多个接收 IP，则需使用换行符或英文逗号隔开。
       > + 在 VPC 内，接收 IP 的流量不会被采集。
			 >
     + **均衡方式**：选择如下一种方式。
        + **流量均分**：所有流量随机均匀分到接收 IP 中。
        + **按弹性网卡 HASH**：将来自同一个网卡的流量转发到同一个接收 IP 中。
 ![](https://main.qcloudimg.com/raw/6eb83745203068c240945a3df7416a37.png)
 + 当采集范围为【公网IP】时，请参考如下配置指导：
    + **发送端**：选择子网。
    + **接收端**：填写接收端 IP 和端口，格式为 ip:port，如有多个请用换行符分隔。请参考如下填写：
	    + 如果接收端为私有网络内的云服务器，则该云服务器必须与【发送端】属于同一子网。
	    + 如果接收端为与私有网络互通的 IDC 服务器，则此处填写发送端所属子网可路由到的 IDC 侧服务器 IP。
     ![](https://main.qcloudimg.com/raw/4c51d3cf4d3fc73140213c86b557d4f8.png)
2. 完成配置后，单击【确定】。

## 结果验证
>!本文以采集源弹性网卡“出流量”为例。
>
1. 返回流量镜像页面，创建的流量镜像显示在列表中，且**启用采集**为开启，则表示流量镜像任务创建成功。
    ![](https://main.qcloudimg.com/raw/5e1fb7f6a37f2ee128ee8a5eb81d2e20.png)
2. 执⾏如下操作，验证采集端的流量是否正常镜像到接收端。
	1. 构造弹性网卡流量，例如您可以登录采集源端 CVM，执行 ping **公网 IP**来构造流量。
    **source 源数据：**
	 ![](https://main.qcloudimg.com/raw/74ad4cbd7a6f2179b441cafee5976bba.png)
	2. 登录接收端云服务器，执行如下命令抓取保存为“.cap”或“.pcap”⽂件，⽅便解析。本例以“.pcap”为例。
	```plaintext
	   tcpdump -i eth0 -w capture-2020-10-27.pcap    #⽂件名可⾃定义，请根据实际填写
	   ```
	**Destination 数据包:** 
	  ![](https://main.qcloudimg.com/raw/404f6d2c612ae76b78aa63a624e98910.png)
	3. 使⽤终端模拟⼯具（例如 SecureCRT 等）登录接收端服务器，将步骤2中保存的⽂件导出到本地。
	  ```plaintext
	  sz -bye capture-2020-10-27.pcap
	  ```
	4. 使⽤报⽂解析⼯具（例如 Wireshark ⼯具）打开下载到本地的⽂件“capture-2020-10-27.pcap”获取数据详情，例如，本例中已从镜像接收端云服务端获取到采集源端的出流量12个数据包。
	 **包校验：**
	 ![](https://main.qcloudimg.com/raw/8011aef82006411e35edd41bf5eae5c4.png)
3. 如获取到数据包异常或⽆法正常获取到数据包，请及时联系技术⽀持⼈员。

## 后续步骤
- [启停流量镜像](https://cloud.tencent.com/document/product/215/44341#open)
- [修改流量镜像](https://cloud.tencent.com/document/product/215/44341#modify)
- [添加标签](https://cloud.tencent.com/document/product/215/44341#add)
- [删除流量镜像](https://cloud.tencent.com/document/product/215/44341#del)
