创建云联网后，系统会自动为您创建默认路由表，您也可以手动创建自定义路由表。通过管理自定义路由表的路由接收策略、路由传播策略、绑定的网络实例，灵活管理云联网中网络实例的互通关系。搭配路由表选择策略，可以实现比网络实例更细粒度的路由管理。
>? 目前自定义路由表和路由表选择策略功能处于内测中，如有需求请 [在线咨询](https://cloud.tencent.com/online-service?from=sales&source=PRESALE)。

## 路由表
腾讯云云联网提供两种路由表，即默认路由表和自定义路由表。网络实例之间的网络请求所匹配的路由策略，依赖网络实例所绑定的路由表以及路由表选择策略。云联网中的每一张路由表都是独立管理。


###  默认路由表与自定义路由表对比
| 对比项 | 默认路由表 | 自定义路由表|
| :--- | :--- | :--- |
| 创建方式 | 创建云联网实例后，系统自动创建。| 手动创建，创建自定义路由表请参见 [自定义路由表](https://cloud.tencent.com/document/product/877/58539)。|
| 路由表数量| 只有1个。 | 数量上限为10个，创建更多自定义路由表请[ 在线咨询](https://cloud.tencent.com/online-service?from=sales&source=PRESALE)。 |
| 路由接收策略| 初始策略为接收所有路由，且无法修改。 | 初始策略为不接收任何路由，使用前需要配置路由接收策略，否则无法学习到路由信息。配置自定义路由表路由接收策略的详细信息请参见 [配置路由接收策略](https://cloud.tencent.com/document/product/877/58540)。 |
| 路由传播策略| 初始策略为传播所有路由至绑定的网络实例，可修改。  | 初始策略为传播所有路由至绑定的网络实例，可修改。 |
| 是否支持删除| 不支持删除。 | 支持删除，在被网络实例绑定或被路由表选择策略引用时无法删除。 |


###  路由表与网络实例的关系
路由表与网络实例为配对绑定关系，例如 A 路由表绑定 B 网络实例，和 B 网络实例绑定 A 路由表产生的结果是一样的，即一张路由表和一个网络实例绑定在一起，仅表述方式不同。
路由表与网络实例之间具有以下特点：
- 加入云联网的网络实例只能绑定一张路由表，如果未指定绑定哪一张路由表，则自动绑定默认路由表。
- 网络实例从云联网中移除后则自动与绑定的路由表解绑定。
- 云联网下网络实例绑定路由表后，支持更换为同一云联网实例下的任意一张其他路由表，新路由表绑定成功后则自动与原路由表解绑定。

###  路由表选择策略
路由表选择策略是基于网络实例中某一网段粒度指定路由表，可以实现比网络实例粒度更精细的路由管理。云联网实例的路由表选择策略初始为空，用户可以根据业务的需要添加、编辑、排序或删除路由表选择策略。

如下图所示，加入到云联网中的 VPC 绑定了路由表1，同时路由表选择策略中添加了关于子网2的策略。
当 VPC 上有网络请求时：
- 子网1没有匹配到路由表选择策略，则按照绑定关系经过路由表1进行选路。
- 子网2匹配到路由表选择策略，则按照路由表选择策略经过路由表2进行选路。
![](https://main.qcloudimg.com/raw/b2128a4c4379f6db8b0717c99f96751c.png)
路由表选择策略的优先级高于网络实例与路由表的绑定关系，网络实例发送到云联网的网络请求会优先匹配路由表选择策略，未匹配到路由表选择策略时，则按照网络实例与路由表的绑定关系进行下一跳的选择。
当有多条路由表选择策略时，则按照顺序进行匹配。一旦有策略匹配上，则停止匹配。


## 路由
云联网多级路由可自动学习、下发，当您的网络拓扑发生变化时，路由能够自动学习更新，无需手工维护配置。
![](https://qcloudimg.tencent-cloud.cn/raw/51c8e926f25014a55a0a745cf4f9d70b.png)

### 网络实例发送路由至云联网
与云联网关联的网络实例，会发送目的端为自身的路由至云联网，云联网路由表自动添加路由的逻辑如下，涉及三个阶段：
1. 自动添加路由前：即路由接收逻辑，决定哪些路由可被添加至云联网路由表。
2. 自动添加路由时：即路由默认生效逻辑，决定哪些添加至云联网路由表的路由可生效。
3. 自动添加路由后：即路由优先级逻辑，决定流量根据哪条生效路由转发。

| 阶段 | 说明 | 涉及动作 |
|---------|---------|---------|
| 自动添加路由前 | 路由接收逻辑，决定哪些路由可被添加至云联网路由表 | <li>网络实例发送路由至云联网或从云联网撤回路由</li><li>路由表根据路接收策略从来自网络实例的路由中选择路由表的需要写入或删除的路由条目</li>|
| 自动添加路由时 | 路由默认生效逻辑，决定哪些添加至云联网路由表的路由可生效 | <li>依照路由检查策略状态写入路由至路由表</li> |
| 自动添加路由后 | 路由优先级逻辑，决定流量根据哪条生效路由转发 | <li>通过云联网转发的流量匹配路由规则进行转发</li> |



#### 1. 自动添加路由前

##### 网络实例发送路由至云联网
![](https://qcloudimg.tencent-cloud.cn/raw/75221c6abcbfb103de3443df9e4224bc.png)
- 关联实例类型为公有云 VPC：
	1. 子网新建时，传递目的端为子网网段，下一跳为 VPC 的路由至云联网。
	2. 发布自定义路由至云联网。参见 [私有网络：发布/撤销路由策略到云联网](https://cloud.tencent.com/document/product/215/53587#.E5.8F.91.E5.B8.83.2F.E6.92.A4.E9.94.80.E8.B7.AF.E7.94.B1.E7.AD.96.E7.95.A5.E5.88.B0.E4.BA.91.E8.81.94.E7.BD.91)
- 关联实例类型为专线网关，传递目的端为 IDC 网段，下一跳为专线网关的路由至云联网，参见 [专线网关：发布网段至云联网](https://cloud.tencent.com/document/product/216/50956)。传递路由方式分为两种：
  1. 自定义方式（原静态/手动模式）：手动填写需要传递至云联网中的 IDC 网段，下一跳为对应的专线网关，便于您做网段收敛和过滤。
  2. 自动传递（原 BGP 模式）：通过 BGP 协议动态学习路由，下一跳为对应的专线网关，便于实时感知 IDC 侧路由变化。目前支持根据 AS-PATH 控制发布至云联网的路由：
   - AS-PATH 长度一致时，云联网接收所有路由。
   - AS-PATH 长度不一致时，云联网接收 AS-PATH 更短的路由。
>?
>- 自动传递（原 BGP 模式）处于灰度阶段，如有需求请 [在线咨询](https://cloud.tencent.com/online-service?from=sales&source=PRESALE)。
>- AS-PATH 相关说明如下：
>  1. AS-PATH 信息可在专线网关侧查看。
>  2. 支持32位字符，字符异常时，将删除该路由，并上报字符异常事件，您可配置事件告警。
>  3. AS-PATH 长度30，长度超限将截断并上报截断事件，您可配置事件告警。
>  4. 经过专线网关-云联网-专线网关的 AS-PATH 将增加3个 AS 号（45090，139341，45090）。
- 关联实例类型为 VPN 网关，可以发布 VPN 通道创建配置 SPD 策略时对端网关的网段，下一跳为 VPN 网关的路由至云联网，参见 [VPN 网关：发布 IDC 网段至云联网](https://cloud.tencent.com/document/product/554/71641)。
- 关联实例类型为 SD-WAN Edge，可以在路由表中将系统路由或静态路由发布至云联网，参见 [SD-WAN 接入服务：发布路由至云联网](https://cloud.tencent.com/document/product/1277/60799)。

##### 网络实例从云联网撤回路由

|网络实例类型 |路由撤回触发条件 |
|:--|:--|
|公有云 VPC |1. VPC 实例与云联网解绑<br>2. VPC 实例子网删除<br>3. 从 VPC 路由表中撤回发布到云联网的自定义路由 |
|专线网关 |1. 专线网关与云联网解绑<br>2. 专线网关侧路由变更：<ul><li>手动填写（静态）：删除</li><li>动态学习（BGP）：对端路由更新</li></ul>  |
|VPN 网关| 1. VPN 网关与云联网解绑<br>2. VPN 网关中取消发布 IDC 网段至云联网 |
|SD-WAN Edge| 1. Edge 实例与云联网解绑<br> 2. Edge 实例路由表中取消系统路由或静态路由发布至云联网|



**路由表根据路接收策略从来自网络实例的路由中选择要写入路由表的路由条目**
- 默认路由表会接收所有网络实例发往云联网的路由
- 自定义路由表初始策略为不接收任何路由，使用前需要配置路由接收策略，否则无法学习到路由信息。配置自定义路由表路由接收策略的详细信息请参见 配置路由接收策略。

![](https://qcloudimg.tencent-cloud.cn/raw/8242475f43c3dc99225e4a359b24eee1.png)

#### 2. 自动添加路由至路由表时
- 检查策略：如果与已有路由重叠，默认后加入的路由失效（尽量不影响存量路由），您确认影响后可调整为有效。
- 不检查策略：不做特殊处理，所有路由全部生效，等价多路径(ECMP) 路由除外，ECMP 路由参见如下第3条中 [网段相同](#same) 的路由逻辑。
>?不检查策略处于灰度阶段，如有需求请 [在线咨询](https://cloud.tencent.com/online-service?from=sales&source=PRESALE)。
>

#### 3. 自动添加路由后
- 网段重叠，但不相同：根据最长掩码匹配原则，网段更精细，优先级更高，例如，路由 A 的目的端网段为 <code>10.0.1.0/20</code>，路由 B 的目的端网段为 <code>10.0.1.0/24</code>，当路由 A 和路由 B 均启用时，根据最长掩码匹配规则，会优先匹配路由 B。
  <span id="same"></span>
- 网段相同：下一跳均为专线网关的路由支持 ECMP，例如，允许同时开启多条目的端网段均为<code>10.0.1.0/20</code>的路由；其它情况的路由不支持 ECMP（即无法同时开启），例如，下一跳均为 VPC，或为 VPC 和专线网关的路由中，存在两条或两条以上目的端网段为<code>10.0.1.0/20</code>的路由，则仅能开启其中的一条路由。
>?在云联网 - 专线网络架构中，入方向路由说明如下，具体详情请参见[ 专线网关概述](https://cloud.tencent.com/document/product/216/49570)。
>- 2020 年 9 月 15 日零点前创建的云联网专线网关，向专用通道发布的路由为子网 CIDR，若专用通道为 BGP 模式，IDC 侧通过 BGP 协议学习到 VPC 子网 CIDR。
>- 2020 年 9 月 15 日零点后创建的云联网专线网关，向专用通道发布的路由为 VPC CIDR，若专用通道为 BGP 模式，IDC 侧通过 BGP 协议学习到 VPC CIDR。

### 云联网发送路由至网络实例
云联网会将网络实例绑定的路由表中的已启用的且非指向该网络实例的路由条目，作为下一跳为云联网的路由传递给该网络实例，各网络实例接收到云联网的路由后会根据自身的路由规则将接收到的路由进行处理。
![](https://qcloudimg.tencent-cloud.cn/raw/a8f186690c619e95ad3f794e0741f8ac.png)
如果需要路由从云联网传播至网络实例的过程进行更精细的控制，可以通过以下方式进行管理。

#### 通过云联网路由表绑定网络实例进行路由发送管理
- 当云联网未开启多路由表功能时，仅有一张路由表，因此会将路由表中所有的路由（指向该网络实例的路由条目除外）传递给该网络实例。
- 当云联网开启多路由表功能时，当云联网与网络实例相绑定（此时用户可指定网络实例绑定的路由表，未指定时会与云联网中的默认路由表进行绑定）时，仅会将与与网络实例绑定的路由表中的路由条目（指向该网络实例的路由条目除外）传递给该网络实例。
- 当网络实例与更换绑定的路由表时，会根据更换前后路由中路由条目的不同重新传递路由，实现云联网仅将该网络实例绑定的路由表中的已启用的且非指向该网络实例的路由条目传递给该网络实例。
![](https://qcloudimg.tencent-cloud.cn/raw/c82a3fa095e2ee9d91157b55eba57722.png)

#### 通过云联网路由表路由传播策略进行路由发送管理
云联网路由表的路由传播策略，可以实现灵活控制路由表的路由向网络实例传播。
![](https://qcloudimg.tencent-cloud.cn/raw/9726233c3bd9d723b28c46fadddca7ca.png)
每条路由传播策略，由以下主要部分组成：路由条件、传播条件、传播行为，路由传播策略通过这三部分组成了“哪些路由向哪些网络实例如何传播”的策略表达。
- **哪些路由**：路由条件是对路由进行匹配的条件，支持按照实例 ID、实例地域、实例类型、路由前缀对路由进行匹配。如果一条路由的特征同时满足某条策略中的所有路由条件，即为该条路由域本条路由传播策略匹配成功。当某条路由在从云联网传播至网络实例的过程中，会从第一条开始顺序逐条匹配其所在路由表的路由传播策略，当匹配成功时，不再进行匹配，并该条路由传播策略的传播条件和传播行为执行路由传播。
- **哪些网络实例**：默认情况下，路由表中的路由会向所有与之绑定的网络实例进行传播，传播条件可以在绑定的网络实例中进一步设置传播控制的范围。传播条件支持按照实例 ID、实例地域、实例类型对网络实例进行匹配。
- **如何传播**：传播行为包括两种：**接受**和**拒绝**。接受，表示本条策略对满足路由条件的路由向与路由表绑定且满足传播条件的网络实例传播；拒绝，则表示本条策略对满足路由条件的路由不向与路由表绑定且满足传播条件的网络实例传播。

具体支持的条件如下：

| 条件分类 | 条件类型 | 示例 | 说明 |
| :--- | :--- | :--- | :--- |
|路由条件|实例 ID|vpc-xxxxxxxxx|对路由来源网络实例（即路由条目的下一跳实例 ID）进行匹配，支持设置一个或多个网络实例 ID 作为条件值。|
|路由条件|实例地域|北京|对路由来源的地域（即路由条目的下一跳所属地域）进行匹配，支持设置一个或多个当前账号可以使用云联网服务的地域作为条件值。|
|路由条件|实例类型|专线网关|对路由来源网络实例的类型（即路由条目的下一跳实例所属的类型）进行匹配，支持设置 VPC、专线网关、VPN 网关中的一个或多个作为条件值。|
|路由条件|路由前缀-精确匹配|192.168.0.1/32|对路由条目的目的端地址段进行匹配，支持设置一个或多个合法的 CIDR 地址段作为条件值，当路由条目的目的端与设置的路由前缀中一个值完全一致时，满足该条件。|
|路由条件|路由前缀-模糊匹配|10.0.0.0/8|对路由条目的目的端地址段进行匹配，支持设置一个或多个合法的 CIDR 地址段作为条件值，当路由条目的目的端与设置的路由前缀中一个值完全一致或为其子网段时，满足该条件。|
|传播条件|实例 ID|vpc-xxxxxxxxx|对路由表绑定的网络实例 ID 进行匹配，支持设置一个或多个网络实例 ID 作为条件值。|
|传播条件|实例地域|北京|对路由表绑定的网络实例所属地域进行匹配，支持设置一个或多个当前账号可以使用云联网服务的地域作为条件值。|
|传播条件|实例类型|专线网关|对路由表绑定的网络实例的类型进行匹配，支持设置 VPC、专线网关、VPN 网关中的一个或多个作为条件值。|

