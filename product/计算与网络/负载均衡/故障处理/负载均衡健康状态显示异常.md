## 现象描述
负载均衡（Cloud Load Balancer，简称 CLB）的后端服务器（Real Server，简称 RS）的端口健康状态显示异常，后端服务器端口的真实状态与健康检查状态不一致。当健康检查探测到异常时，CLB 将不再向异常后端服务转发流量。健康检查原理可参考 [健康检查](https://cloud.tencent.com/document/product/214/6097)。


## 可能原因
健康检查异常的可能原因如下：
- 传统账号 CLB 的后端服务器（RS）的公网带宽为0（控制台健康检测工具已覆盖）。
- RS 的安全组或 ACL 没有放通相应的来源 IP 和端口（控制台健康检测工具部分覆盖）。
- RS 中服务端口没有在监听状态。
- 后端服务返回的状态码和健康检查设置的不一致。
- 监听器的后端协议配置了 HTTPS 但是 RS 不支持 HTTPS 访问。
- 健康检查的源 IP 使用非 VIP 时，RS 未放通非 VIP。
- RS 内部开启了防火墙或者安装了安全软件。


## 处理步骤

#### 步骤一：公网 CLB 检查后端服务器的公网带宽
如果您为传统账户类型，公网 CLB 绑定的后端 CVM 需要配置公网带宽，否则会导致健康检查异常。
- 若 RS 带宽为0，请为 RS 配置带宽，可参见 [调整网络配置](https://cloud.tencent.com/document/product/213/15517)。
- 否则请跳到 [步骤二](#step2)。

>?
>- 若您无法确定账户类型，可参见 [判断账户类型](https://cloud.tencent.com/document/product/1199/49090#judge)。
>- 传统账户在购买负载均衡时，不需要购买带宽，带宽在 RS 上配置并在 RS 上收取公网网络费用。您可在不分配公网 IP 的情况下，为 CVM 购买公网带宽。
>

#### 步骤二：检查安全组和 ACL[](id:step2)
如果 CLB 未开启安全组默认放通功能，则需在 RS 的安全组上放通来源 IP（包括访问的客户端 IP 和 CLB VIP）。如果您搭建的服务需要支持任意 IP 的访问，则需要在 RS 的安全组入站规则中放通所有来源的 IP（0.0.0.0/0）。
检测您的后端 RS 上是否已配置 ACL，如果配置了 ACL，请检查 ACL 没有拦截来源 IP。
 - 若配置安全组后健康检查还是异常，请检查 [步骤三](#step3)。
 - 若配置安全组后检测正常，则结束。
>?
>- 如果您不允许外部的公网 IP 地址访问您的后端 CVM，建议您直接开启 CLB 的安全组默认放通。详情请参考 [配置负载均衡安全组](https://cloud.tencent.com/document/product/214/14733)。
>- 使用跨地域绑定后，**安全组默认放通功能会对跨地域的 RS 不生效**，请单独在跨地域的 RS 中放通客户端的来源 IP。
>

#### 步骤三：检查 RS 中服务是否正常监听[](id:step3)
CLB 和后端服务 RS 之间使用内网通信，请确保服务已经启动并且监听在内网地址上。
例如，您的 RS 的内网 IP 地址为`172.16.32.15`，后端端口是80端口。
  - Windows 系统服务器使用命令 `netstat -ano | findstr :80`。
  - Linux 系统使用命令 `netstat -anp ｜ grep :80`。

如果可以看到`172.16.32.15:80`的监听或`0.0.0.0:80`的监听则说明此配置正常；否则请将应用的服务端口监听到内网上。
  - 若配置安全组后健康检查还是异常，请检查 [步骤四](#step4)。
  - 若配置安全组后检测正常，则结束。


#### 步骤四：后端返回的状态码和健康检测配置的不符合[](id:step4)
造成 RS 返回的状态码和健康检查设置的不一致原因较多。
>?
>- 后端应用程序返回的偶发错误码，未在健康检查中设置，导致异常。
>- RS 高负载返回较多错误码，导致健康检查异常。
>- RS 不支持健康检查中设置的 HTTP 请求方法，导致异常。
>- 健康检查指定的检测文件，建议是以 HTML 形式的简单页面，提升健康检查效率。
>- 开启了 TCP 的快速回收和时间戳，导致连接失败。详情请参考[ 原因分析](https://cloud.tencent.com/document/product/214/10328#.E5.8E.9F.E5.9B.A0.E5.88.86.E6.9E.90)。
>
1. 单击监听器中具体的 URL 进入到健康检查配置页，查看健康请求的方法和状态码，到 RS 的服务日志中查看 RS 给健康检查请求返回的错误码信息。如果错误码在健康检查中未配置或者 RS 不支持健康检查设置的方法，请您修改健康检查的请求方法或者错误码。如果 RS 的负载较高，建议您进行机器的扩容或者加入更多的 RS。
<img src="https://elaine-test-1254105469.cos.ap-guangzhou.myqcloud.com/%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5%E8%AE%BE%E7%BD%AE" width="50%" /> 
2. 登录 RS 服务器，检测是否已经开启了 TCP 快速回收和时间戳。如果开启了，建议关闭。
登录 RS 执行以下命令，查看值是否为 1。
```
cat /proc/sys/net/ipv4/tcp_tw_recycle
cat /proc/sys/net/ipv4/tcp_timestamps
```
 - 如果以上命令的输出值为1，请执行以下命令进行关闭，观察是否因为快速回收和时间戳导致。
```
sysctl -w net.ipv4.tcp_tw_recycle=0
sysctl -w net.ipv4.tcp_timestamps=0
```
 - 如果输出值非1，请排查 [步骤五](step5)。

#### 步骤五：监听器的后端协议设置了 HTTPS 但 RS 不支持 HTTPS 访问（仅限 HTTPS 监听器）[](id:step5)
后端协议填写 HTTPS 时，需要 RS 上的服务部署证书，支持全链路协议加密，否则会导致健康检查异常。您可以在同子网的别的机器上尝试使用 https 访问 RS 的后端端口。如果配置了 HTTPS 为后端协议，但是 RS 上未配置证书，建议在 RS 上配置证书或者参考下图将后端协议修改为 HTTP。
<img src="https://elaine-test-1254105469.cos.ap-guangzhou.myqcloud.com/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5%E5%9B%BE" width="80%"  />

#### 步骤六：健康检查源 IP 使用了非 VIP[](id:step6)
此功能使用`100.64.0.0/10`网段中的地址探测后端 RS，如果使用了此功能，需要在后端 RS 的安全组入站规则中放通`100.64.0.0/10`网段。详情请参见 [健康检查源 IP 支持非 VIP](https://cloud.tencent.com/document/product/214/65860)。


#### 步骤七：RS 内部开启了防火墙或者安装了安全软件导致健康检查异常
RS 上开启防火墙或安装其他安全类防护软件，会将负载均衡系统的本地 IP 地址屏蔽，从而导致负载均衡系统无法跟后端服务器进行通信。
检查服务器内网防火墙是否放行来源 IP 和80端口，可以暂时关闭防火墙进行测试。如果是使用了 [步骤六](#step6) 的功能，需要放通`100.64.0.0/10`和80端口。
   - Windows 系统可以在运行输入 `firewall.cpl` 命令关闭。
   - Linux 系统可以输入 `/etc/init.d/iptables stop` 命令关闭（CenOS 7.x 系统请运行 **systemctl stop firewalld** 命令）。


