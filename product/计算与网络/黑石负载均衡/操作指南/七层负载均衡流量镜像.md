## 操作场景
目前客户 HTTP/HTTPS 外网流量分发是通过黑石七层外网 LB 实现的；当客户需要对外网 HTTP/HTTPS 流量进行安全漏洞检测、反爬虫、反作弊分析，这时就需要用到黑石七层 LB 流量镜像功能。

## 功能特性
- 对七层外网 LB 中 HTTP/HTTPS 入流量进行镜像，出流量不做镜像。
- 如果为 HTTP 流量，直接转发；如果为 HTTPS 流量，先将 HTTPS 解密为 HTTP 后，再进行转发。
- 客户侧接收方式为：选择黑石物理服务器做接收机，在其上搭建 Nginx 来接收镜像流量。
 
## 使用约束
- 公网流量镜像以 VPC 为单位，同时公网 LB 七层监听器 HTTP/HTTPS、接收服务器都必须在同一 VPC 内。
-  一个七层监听器可以加入同一 VPC 的多个公网流量镜像；一台接收机可以加入同一 VPC 下不同的公网流量镜像，但后端端口不能相同。
- 接收机不能为绑定 LB 的后端服务器，将 LB 的后端服务器和流量镜像后端机器进行分离。


| 条目               | 限制                          |
| ---------------- | --------------------------- |
| 每个 VPC 支持公网流量镜像数   | 5个                          |
| 每个公网流量镜像包含七层监听器数 | 500个                        |
| 每个公网流量镜像包含接收机数   | 500个，包括同一台接收机的多次绑定（后端端口不同） |
 
## 操作步骤
### 创建公网流量镜像
如果要对七层外网 LB 中 HTTP/HTTPS 做流量镜像，需要创建公网流量镜像。
1. 登录腾讯云控制台，进入黑石负载均衡 [【公网流量镜像】](https://console.cloud.tencent.com/lbbm/trafficMirror)。
2. 单击页面左上角【新建】。
3. 根据实际需求，在弹出框中设置以下参数：
 - 名称，对公网流量镜像进行命名，方便后续区分
 - 私有网络，选择需要做流量镜像的私有网络
4. 单击【确认】，即可完成公网流量镜像创建。

 


### 七层监听器设置
1. 登录腾讯云控制台，进入黑石负载均衡 [【公网流量镜像】](https://console.cloud.tencent.com/lbbm/trafficMirror)。
2. 公网流量镜像创建完成后，单击【七层监听器】， 进入七层监听器设置界面。
3. 单击【关联】，在弹出页面中，选择需要被监听的七层监听器。
4. 单击【确定】，即可完成七层监听器设置。




 
### 接收服务器设置
1. 登录腾讯云控制台，进入黑石负载均衡[【公网流量镜像】](https://console.cloud.tencent.com/lbbm/trafficMirror)。
2. 在公网流量镜像列表页中，单击需要修改的【公网流量镜像 ID】。
3. 进入修改详情页，单击【接收服务器】，进入接收服务器设置界面。
4. 单击【关联】，在弹出框中，选择需要接收镜像流的服务器，接收服务器可以有多台，也可以是同一台的多个不同端口，按需设置不同权重。
5. 单击【确认】，即可完成接收服务器设置。

>!
- 接收服务器也可以进行健康检查，在接收服务器设置配置界面进行设置。
- 为防止业务流与镜像流相互影响，已经绑定 LB 的后端 RS 机器不能设置为镜像流量接收服务器。


