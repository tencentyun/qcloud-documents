黑石负载均衡是对多台物理服务器进行流量分发的服务。通过流量分发扩展应用系统对外的服务能力，消除单点故障以提升应用系统的可用性。

黑石负载均衡通过虚拟服务地址（VIP），将位于同一可用区的多台物理服务器资源虚拟成一个高性能、高可用的应用服务池；根据应用指定的方式，将来自客户端的网络请求分发到物理服务器池中；同时会检查应用服务池中物理服务器健康状态，自动隔离异常状态物理服务器，从而解决单台物理服务器的单点问题，同时提高了应用的整体服务能力。

## 关键特性
* 采用 Vxlan 实现多租户隔离
* 通过 FULLNAT 模式实现 IP 收敛
* 通过集群容灾和 session 同步实现高可靠
* 通过宙斯盾 +synproxy 实现抗 DDOS 攻击

## 产品优势
- 黑石负载均衡单集群提供超过 1.2 亿 的最大连接数，轻松应对亿级 Web 业务访问量。
- 黑石负载均衡单集群可处理峰值 40Gb/s 的流量，每秒处理包量（PPS）可达 600 万。
- 对每个租户的流量进行严格隔离，提供主动 DDoS 防护能力。当遭遇 DDoS 攻击时，黑石负载均衡能为您免费提供 2~10 Gb DDoS 攻击峰值流量的防御能力。

## 使用场景
* 横向扩展应用系统服务能力，适用于各种 web server 和 app server 。
* 消除应用系统单点故障，当其中一部分物理服务器宕机后，应用系统仍能正常工作。

## 协议支持
黑石负载均衡由其监听器提供，监听器负责监听负实例请求，执行策略分发流量至后端服务器；监听器分为四层监听器和七层监听器，其中四层为传输层协议，通过 VIP+ 端口接受请求并分配流量到后端服务器；七层为应用层协议，通过 URL、HTTP 头部等应用层信息进行流量分发。

**1. 四层监听器**
支持 TCP 和 UDP 协议，如果使用 TCP/UDP 协议转发，负载均衡实例会直接将请求转发到后端实例，而不修改任何数据包。

**2. 七层监听器**
支持 HTTP 和 HTTPS 协议，七层监听器先代理后端服务器和客户端建立连接（三次握手），再接收客户端发送的真正应用层内容报文，然后根据该报文中特定字段，加上设置的服务器选择方式，决定后端转发服务器。

## 均衡方式
均衡方式是指黑石负载均衡向后端服务器分配流量的算法。

**1. 四层协议**
支持按权重轮询，以轮询方式依次将请求调度到不同服务器，用权值表示服务器的处理性能，按权值的高低和轮询方式分配请求，权值高的服务器先收到连接，权值高的服务器比权值低的服务器处理更多的连接，相同权值的服务器处理相同数目的连接数。

**2. 七层协议**
支持按权重轮询和 IP HASH，IP HASH 方式根据请求的源 IP 地址，作为散列键（Hash Key）从静态分配的散列表找出对应的服务器，若该服务器是可用的且未超载，将请求发送到该服务器，否则返回空。


## 健康检查
黑石负载均衡实例定期向后端服务器发送 ping、尝试连接或发送请求来测试后端服务器运行的状况。

当后端服务器实例被判定为不健康时，负载均衡实例将不会把请求转发到该实例上，但健康检查会对所有后端服务器（不管是判定为健康的还是不健康的）进行，当不健康实例恢复正常状态时，负载均衡实例将恢复把新的请求转发给它。

**1. 四层协议**
由负载均衡向配置中指定的服务器端口发起访问请求，如果端口访问正常则视为后端服务器运行正常，否则视为后端服务器运行异常；对于 TCP 业务，使用 SYN 包进行探测；对于 UDP 业务，使用 ping 进行检查。
* 响应超时时间： 2-60 秒
* 检查间隔：5-300 秒
* 不健康阈值：2-10 次（健康后端服务器出现此指定次数响应超时后，视为不健康）
* 健康阈值：2-10 次（不健康后端服务器出现此指定次数响应不超时后，视为健康）

**2. 七层协议**
由负载均衡向后端服务器发送 HTTP 请求来检测后端服务，负载均衡器会通过 HTTP 返回值是否为用户设定的 http_xxx 来判断服务是否正常；用户可以根据业务需要设定 http_1xx 及 http_2xx 为服务正常状态，而 http_3xx 至 http_5xx 返回值为异常状态。
* 响应超时时间暂不能设置，默认响应超时时间为 3 秒
* 检查间隔 5-300 秒，默认为 6 秒
* 不健康阈值：2-10 次，默认为 3 次 （健康后端服务器出现此指定次数响应超时后，视为不健康）
* 健康阈值：2-10 次，默认为 3 次（不健康后端服务器出现此指定次数响应不超时后，视为健康）

>**注：**健康检查底层实现方式为使用100.64.0.0/10这个内网网段中 IP 对后端服务器进行健康探测，因此后端服务器需要放通100.64.0.0/10网段；

## 会话保持
可使得来自同一 IP 的请求被转发到同一台后端服务器上。

**1. 四层协议**
四层转发支持基于源地址的会话保持，会话保持时间可设为 30-3600s 中的任意整数值，超过该时间阈值，会话保持失效。

**2. 七层协议**
七层转发支持基于 cookie 插入会话保持能力（由负载均衡向客户端植入 cookie），会话保持可选时间为30-3600s。

## Client IP 获取
**1. 四层协议**
- 公网普通型/内网 LB：客户端 IP 地址获取，对于 TCP 协议并且后端服务器为 Linux 时，通过在后端服务器安装 TOA 模块获取，黑石 LB 侧默认关闭。
- 公网增强型 LB：对于 TCP/UDP 协议并且后端服务器为 Linux/Windows 时，客户端 IP 地址都可以获取。

**2. 七层协议**
客户端 IP 地址获取，通过 X-Forwarded-For 方式获取，黑石 LB 侧默认开启。

## 使用约束
关于黑石 LB 使用，有如下约束：
<table class="table-striped">
	<tobdy>
		 <tr>
      <th width="90">LB 类型</th>
      <th>四层监听器</th>
      <th>七层监听器</th>
      <th>通用限制</th>
   </tr>
		 <tr>
		 <td align="center" >内网 LB</td>
		  <td rowspan="3" frame=vsides>
			一个 LB 下最多 50 个监听器；<br/>
			一个监听器下最多 200 个主机；<br/>
			一个监听器下最多绑定同一主机的 200 个端口。</td>
			<td rowspan="2" >
			一个 LB 下最多 50 个监听器；<br/>
			一个监听器下最多 100 个转发域名；<br/>
			一个转发域名下最多 100 个转发 URL 路径；<br/>
			一个转发 URL 路径下最多 255 个主机；<br/>
			一个 URL 下最多绑定同一主机的 255 个端口。</td>
			<td rowspan="3">每种类型在每个 zone 累计可购买 100 个。</td>
		 <tr><td >公网普通型 LB</td></tr>
		<tr><td >公网增强型 LB</td><td>不支持</td></tr>
		</tr>
	 </tbody>
</table>
