黑石 NAT 网关是一种将 VPC 中内网 IP 和公网 IP 进行转换的高性能网关，是 VPC 内的一个公网流量的出入口，其典型应用场景如下：
- 安全公网访问：NAT 网关提供 IP 安全转换，将用户 VPC 内黑石主机内网 IP 转化为公网 IP，通过公网 IP 与外网进行通信；
- 大带宽、高可用公网访问，针对用户需要超大带宽、高可用性、部署服务较多的公网访问应用场景；

## 网络拓扑关系
黑石 NAT 网关在 VPC 中网络拓扑关系，如下图所示：
![](https://mc.qcloudimg.com/static/img/9081d69c42e37dc141ac816b79b23ea5/image.png)

## 配置类型
黑石 NAT 网关支持绑定4个 EIP，单个 EIP 最大提供2Gbps，同时提供了三种配置类型，最大满足8Gbps突增流量和 1000w 并发连接数：
- 小型（最大100w连接数）
- 中型（最大300w连接数）
- 大型（最大1000w连接数）

## 转发方式
黑石 NAT 网关默认转发方式为 IP 方式，为支持 Docker/KVM 中大量虚拟化实例通过 NAT 网关访问外网，同时提供网段方式转发，以下为两种转发方式区别：

| IP 方式 | <a align="center">网段方式</a> |
|---------|---------|
| 可支持已使用的 1024 个物理服务器或者云服务器 IP 绑定到 NAT 网关 | 可支持 1024 条掩码为 24 的网段绑定到 NAT 网关，如子网 CIDR中 掩码小于 24（注 1），将按 24 进行拆分（注 2）；最大可支持 260000 个 IP |
| 对加入 NAT 网关子网 CIDR 中掩码无限制 | 对加入 NAT 网关子网 CIDR 中掩码 不能大于 24，其子网 CIDR 中掩码范围须为 16-24 |
| 子网中可全部/部分 IP 加入 NAT 网关 | 子网中必须全部 IP 加入 NAT 网关 |

>!CIDR(Classless Inter-Domain Routing)：是用户指定的独立网络空间地址块，通过 IP 和掩码结合，实现对网络的整体划分。以 10.1.0.0/16 为例，斜杠左边为网络块的 IP，斜杠右边为网络块的掩码，通过设定掩码的大小就可以调整网络块的大小。网络块包括 IP 数 = 2^(32- 掩码)，因而 10.1.0.0/16 网络块最多包含65536个 IP 地址；


>!网段拆分方式：加入网段方式 NAT 网关，子网 CIDR 中掩码范围须为16-24，如果子网 CIDR 中掩码为23，将拆分成2条掩码为24的网段；如果子网 CIDR 中掩码为22，将拆分为4条24的网段；网段拆分条数 = 2^(24- 掩码)；同时单个网段方式 NAT 网关，最多支持1024条24的网段；


## 关键特性
黑石 NAT 网关主要有以下关键特性：
- SNAT：源网络地址转换，支持单个 VPC 下不同物理主机通过同一公网 IP 主动访问 Internet；
- 高性能：可以支撑单实例8Gbps级别的转发能力；
- 高可用：使用集群模式，单机出故障自动切换，业务无感知；
- 监控展示：展示 NAT 网关关键指标，该监控明细数据可保存7天；

## 使用约束
关于黑石 NAT 网关使用，有如下约束：
- 当 VPC 下物理主机所在子网已经加入 NAT 网关，这时物理主机绑定 EIP，绑定 EIP 成功，此物理主机通过 EIP 和外网进行通信；如果后续此物理主机解绑 EIP，此主机自动加入 NAT 网关； 
- 当物理主机已绑定 EIP，再使用子网中部分 IP 方式，将此物理主机加入 NAT 网关，加入失败；
- 同一个子网只能加入一个 NAT 网关；
- 删除 NAT 网关会解绑其 EIP，但不会从用户帐号释放该 EIP；
- 可以选择当前所有子网通过 NAT 网关访问外网，但后续新建子网需要通过 NAT网关访问外网时，需要再进行关联；
- 无法通过 VPC 对等连接将流量路由到 NAT 网关，例如，VPC 1 的发往 Internet 的流量都可以通过 NAT 网关实现，现在 VPC 1 和 VPC 2 建立了对等连接，VPC 2 里所有资源可以访问 VPC 1 中的所有资源，但 VPC 2 中的所有资源不可以经过 NAT 网关访问 Internet。
- NAT 网关资源限制如下：

| 资源 | 限制 |
|---------|---------|
| 每个 VPC 支持 NAT 网关数 | 10个 |
| 每个 NAT 网关支持 EIP 数	| 4个 |
| 每个 NAT 网关最多支持转发能力 | 8Gbps |
|每个 NAT 网关（IP 方式）最多支持 IP 数	| 1024个 |
| 每个 NAT 网关（网段方式）最多支持 IP 数	| 260000个(1024*256) |

## 黑石 NAT 网关与黑石 EIP 使用区别
NAT 网关和 EIP 是物理主机访问 Internet 两种方式，可以选择其中一种或两种：

- 方案 1：只使用 NAT 网关
物理主机不绑定 EIP，所有访问 Internet 流量通过 NAT 网关转发。此方案中，物理主机访问 Internet 流量会通过内网转发至 NAT 网关；

- 方案 2：只使用 EIP 
物理主机只绑定 EIP，不使用 NAT 网关。此方案中，物理主机所有访问 Internet 流量通过EIP 出；

- 方案 3：同时使用 NAT 网关和 EIP 
物理主机绑定了 EIP，同时所在子网访问 Internet 流量指向了 NAT 网关，此方案中，物理主机通过 EIP 与外网进行通信；
