## 操作场景
本文介绍如何通过 TKE Stack 控制台，在已有集群下创建业务或服务。

## 前提条件
已参考 [创建及导入集群](https://cloud.tencent.com/document/product/1205/43565) 成功创建集群。


## 操作步骤
### 创建业务
1. 登录 TKE Stack 控制台，选择左侧导航栏中的【业务管理】。
2. 在“业务管理”列表页面，单击【新建业务】。
3. 在“新建业务”页面，参考以下提示设置业务信息。如下图所示：
![](https://main.qcloudimg.com/raw/acdeddc50f4840da9fdccaea25f86569.png)
 - **业务名称**：自定义业务名称，不能超过63个字符。
 - **业务成员**：“用户管理”列表中已存在的用户。
 - **集群**：“集群管理”列表中已创建的集群。
 - **上级业务**：支持多级业务管理，可不选。
4. 单击【完成】即可创建业务。

### 创建服务
>!由于Master 节点的预设置，请参考 [添加节点](#addNode) 步骤，向集群中增加节点后再创建服务。
>
1. 选择左侧导航栏中的【集群管理】，进入“集群管理”列表页面。
2. 选择需创建服务的集群 ID，进入该集群 “Deployment” 页面并单击【新建】。
3. 在 “新建Workload” 页面，参考以下信息设置 Deployment 参数。如下图所示：
![](https://main.qcloudimg.com/raw/126e1db83a90ce4a7f560c6abb8991ca.png)
主要参数信息如下：
	- **工作负载名**：输入自定义名称，最长63个字符，只能包含小写字母、数字及分隔符 `-`，且必须以小写字母开头，数字或小写字母结尾。
	- **命名空间**：根据实际需求进行选择。
	- **类型**：选择【Deployment（可扩展的部署 Pod）】。
6. 如需指定容器挂载至指定路径时，单击【添加数据卷】，并根据以下信息设置。如下图所示：
![](https://main.qcloudimg.com/raw/2d971c8e615df80264849340ece5f64a.png)
	- **使用临时目录**：主机的临时目录，生命周期和 Pod 一致。
	- **使用主机路径**：主机的真实路径，可以重复使用，不会随 Pod 一起销毁。
	- **使用NFS盘**：挂载外部 NFS 到 Pod，用户需要指定相应 NFS 地址。例如，`127.0.0.1:/data`。
	- **使用已有PVC**：可选择在业务 Namespace 下的 PVC。
	- **使用ConfigMap**：可选择在业务 Namespace 下的 ConfigMap。
	- **使用Secret**：可选择在业务 Namespace 下的 Secret。
7. 根据实际需求，为 Deployment 的一个 Pod 设置一个或多个不同的容器。如下图所示：
![](https://main.qcloudimg.com/raw/a2b6b32ec9723bca7a53699719d63256.png)
主要参数信息如下：
 - **名称**：自定义名称，最长63个字符，只能包含小写字母、数字及分隔符 `-`，且不能以分隔符开头或结尾。
 - **镜像**：根据实际需求进行填写。
 - **镜像版本（Tag）**：根据实际需求进行填写。
 - **CPU/内存限制**：可根据 [Kubernetes 资源限制](https://kubernetes.io/docs/concepts/configuration/manage-compute-resources-container/) 进行设置 CPU 和内存的限制范围，提高业务的健壮性。
 - **显示高级设置**：可设置“工作目录”、“运行命令”、“运行参数”、“容器健康检查”和“特权级”等参数。
8. 参考以下信息设置实例数量。如下图所示：
![](https://main.qcloudimg.com/raw/43db545ddcdbd13752b18221550c269a.png)
 - **实例数量**：根据实际需求选择调节方式，设置实例数量。
	 - **手动调节**：直接设定实例个数。
	 - **自动调节**：根据设定的触发条件自动调节实例个数。目前支持根据 CPU、内存利用率和利用量出入带宽等调节实例个数。
 - **定时调节**：根据 Crontab 语法周期性设置实例个数。
9. 单击【显示高级设置】，并参考以下信息进行设置。如下图所示：
![](https://main.qcloudimg.com/raw/24e2289886c3187857a321b1e33a482d.png)
	- **imagePullSecrets**：镜像拉取密钥，用于拉取用户的私有镜像。
	- **节点调度策略**：根据配置的调度规则，将 Pod 调度到预期的节点。
	- **注释（Annotations）**：给 Pod 添加相应 Annotation，例如用户信息等。
	- **网络模式**：Pod 网络模式，根据以下信息进行设置：
	 - **OverLay（虚拟网络）**：基于 IPIP 和 Host Gateway 的 Overlay 网络方案。
	 - **FloatingIP（浮动 IP）**：支持容器、物理机和虚拟机在同一个扁平面中直接通过 IP 进行通信的 Underlay 网络方案。提供了 IP 漂移能力，支持 Pod 重启或迁移时 IP 不变。
	 - **NAT（端口映射）**：Kubernetes 原生 NAT 网络方案。
	 - **Host（主机网络）**：Kubernetes 原生 Host 网络方案。
10. 参考以下信息进行访问设置。如下图所示：
![](https://main.qcloudimg.com/raw/c56bb37f4510c9703ff87e8930647d05.png)
	- **Service**：勾选【启用】按钮，配置负载端口访问。
	- **服务访问方式**：
	 - **仅在集群内访问**：将提供一个可以被集群内其他服务或容器访问的入口，支持 TCP/UDP 协议。数据库类服务如 MySQL 可选择此方式，来保证服务网络隔离性。
	 - **主机端口访问**：提供一个主机端口映射到容器的访问方式，支持 TCP/UDP 协议，可用于业务定制上层负载均衡转发到 Node。
	 - **Headless Service**：解析域名时返回相应 Pod IP 而不是 Cluster IP。**创建完成后不支持变更访问方式**。
	- **端口映射**：输入负载要暴露的端口并指定通信协议类型。
11. 单击【创建Workload】即可完成创建。
当运行数量=期望数量时，即表示 Deployment 下的所有 Pod 已创建完成。如下图所示：
![](https://main.qcloudimg.com/raw/7677b741d306407c74c082fa43c6c697.png)

## 相关操作
### 添加节点<span id="addNode"></span>
1. 登录 TKE Stack 控制台，选择左侧导航栏中的【集群管理】。
2. 选择需创建服务的集群 ID，进入该集群 “Deployment” 页面。
3. 选择左侧菜单栏中的【节点管理】>【节点】，进入“节点列表”页面。
4. 在“节点列表”页面，选择【添加节点】。如下图所示：
![](https://main.qcloudimg.com/raw/922b1f24f8dba95c03105f0af32a0f58.png)
5. 在“添加节点页面”，参考以下信息进行设置。
	- **目标机器**：Master&Etcd 节点的内网 IP，建议节点配置4核及以上机型。
	- **SSH端口**：请确保目标机器安全组放通22端口和 ICMP 协议，否则无法远程登录和 Ping 通。
	- **主机label**：设置主机 Label，可用于指定容器调度。
	- **认证方式**：
		- **密码认证**：目标机器密码。
		- **密钥认证**：
			- **私钥**：目标机器私钥。
			- **私钥密码**：目标机器私钥密码，可选填。
	- **GPU**：目标机器是否为 GPU 机型，使用 GPU 机器需提前安装驱动和 runtime。
6. 单击【提交】即可在“节点列表”页面查看进度。
如下图所示，则为添加成功：
![](https://main.qcloudimg.com/raw/ad3bcb295cc717980b9aecfa86914985.png)


