本文为您详细介绍在 CODING 持续部署中部署流程的阶段类型。

## 前提条件

使用 CODING 项目管理的前提是，您的腾讯云账号需要开通 CODING DevOps 服务，详情请参见 [开通服务](https://cloud.tencent.com/document/product/1159/44859)。 

## 进入项目

1. 登录 [CODING 控制台](https://console.cloud.tencent.com/coding)，单击【立即使用】进入 CODING 使用页面。
2. 单击工作台首页左侧的 <img src ="https://main.qcloudimg.com/raw/12230547b45d5eae85ad1c4fa86fba68.png" style ="margin:0" data-nonescope="true">，进入持续部署控制台。

## 通用类型

### 预置条件检查

在执行下一步之前检查前置条件，例如检查集群规模或某个阶段的状态，前置条件支持 [部署流程表达式](https://cloud.tencent.com/document/product/1159/45167)。

### Entity Tags

在 CODING 持续部署的资源实体（应用、集群、服务组、负载均衡器、安全组）中使用 tag。

### 自定义变量（Evaluate Variables）

添加自定义变量（`key/value` 键值对），在此阶段的定义的变量可以被下游阶段引用。

![](https://main.qcloudimg.com/raw/0f55f6d34a5dcfc88a8d685b51234fd3.png)

### 人工确认

在执行下一步之前等待人工确认。可以在人工确认阶段增加指引说明帮助确认人进行人工确认，或者添加输入选项让用户选择。这些输入选项可以决定下游阶段的执行行为。例如，可以使用 `预置条件检查` 来确保只有满足特定的条件时才执行相应的阶段。

### 部署流程

将其他部署流程作为子部署流程执行。您可以执行当前应用的部署流程，也可以执行具有访问权限的其他应用的部署流程。在阶段执行结束前可以选择是否等待子部署流程的执行结果。如果选择等待执行结果，此阶段的状态即为子部署流程的最终执行状态；否则，只要子部署流程开始执行此阶段的状态就会被标记为“成功”。
![](https://main.qcloudimg.com/raw/38db2b5fc98f774d5730c7a3836f0069.png)

配置选项说明：

| 字段             | 是否必填 | 说明                                                         |
| ---------------- | -------- | ------------------------------------------------------------ |
| 应用             | 是       | 列出所有具体访问权限的应用                                   |
| 部署流程         | 是       | 列出应用下所有的部署流程                                     |
| 是否等待执行结果 | 否       | 如果选择等待执行结果，此阶段的状态即为子部署流程的最终执行状态；否则，只要子部署流程开始执行此阶段的状态就会被标记为“成功”。 |

![](https://main.qcloudimg.com/raw/dce600da596e23bdf75c7157118b2e8a.png)

### 等待

等待一定的时间段后继续执行。在部署流程执行过程中可以手动减少等待时间或直接跳过等待。等待时间支持表达式。

![](https://main.qcloudimg.com/raw/50bdbbde6635407d2a008959929e2ebe.png)

### Webhook

支持调用外部系统 API 作为部署流程的阶段。

利用指定 Webhook 的目标 URL 和 HTTP 方法，支持自定义 `header` 和 JSON 格式的 payload。默认情况下，如果 Webhook 调用返回 `2XX` 或 `3XX` 表示阶段执行成功，返回 `4XX` 或 `5XX` 表示执行失败。Webhook 的 URL、payload 调用的最终状态都会展示在部署流程执行详情中。

用户可以在 URL 字段和 payload 中使用部署流程表达式。当阶段执行完成后，阶段上下文的 `Webhook` 对象包含了 payload  内容，可以在后续的部署流程表达式中引用 payload。例如以下表达式可以获取 Webhook 执行的最终状态：

```
${#stage("My Webhook Stage")["context"]["webhook"]["statusCode"]}
```

![](https://main.qcloudimg.com/raw/5fdcfdb9e222839c28bae3988283561b.png)

## 腾讯云类型

### Bake

Bake 是指创建云服务器镜像的过程。CODING 部署控制台基于 Hashicorp 的 Packer 抽象出 Bake 阶段，提供了默认的 Packer 模板和基本的虚拟机镜像，以帮助用户快速入门。

需要注意的时，如果 CODING 部署控制台检测到不需要进行新的 Bake，则跳过 Bake 过程。 CODING 部署控制台会根据 Bake 阶段参数（基础操作系统，预装软件等）为每次 Bake 生成唯一的键（key）。如果软件包或 Bake 阶段参数发生了更改，则会触发新的 Bake 操作。 要更改默认行为并在部署流程每次运行时重新 Bake 镜像，请在阶段阶段配置中勾选 `Rebake`。[阅读更多](https://www.packer.io/intro)。

### 部署

通过指定部署策略部署提前准备好的镜像。CODING 持续部署提供了部分内置的部署策略，如：红黑（蓝绿）部署、Highlander 部署。您还可以选择对已有服务组无侵入式的部署方式，或者创建自定义的部署策略。

![](https://main.qcloudimg.com/raw/559672da6e15ce7f5a7778d28f821d9e.png)

### 回滚集群

回滚集群中一个或多个区域的实例。

配置选项说明：

| 字段     | 是否必填 | 说明                                     |
| -------- | -------- | ---------------------------------------- |
| 云账号   | 是       | 腾讯云账号                               |
| 地域     | 是       | 集群所属的地域                           |
| 集群     | 是       | 指定需要回滚的集群                       |
| 健康检查 | 是       | 执行此任务时，仅参考腾讯云提供的健康检查 |

![](https://main.qcloudimg.com/raw/79f3ff125d2430550a3cb3420506c063.png)

### 禁用集群

禁用集群意味着让集群保持运行状态但不处理流量，用户可以指定运行一定数量的服务组而禁用剩下的。

![](https://main.qcloudimg.com/raw/e12dcaea34fd8ab75cd921a6648a617f.png)

配置选项说明：

| 字段       | 必填（是/否） | 说明                 |
| ---------- | ------------- | -------------------- |
| 云账号     | 是            | 管理资源对象的云账号 |
| Namespaces | 是            | 集群所属的地域       |
| 集群       | 是            | 指定禁用的集群       |
| 禁用选项   | 是            | 指定具体的禁用策略   |
| 健康检查   | 否            | 配置健康检查策略     |

### 集群缩容

可以选择是否对活跃的（正常运行）的服务组缩容；另外支持使指定数量的服务组保持当前规模，将其他服务组缩容。

![](https://main.qcloudimg.com/raw/04daaf9f2b42d1fa0cbedcffee4cfb9f.png)

| 字段     | 必填（是/否） | 说明                                     |
| -------- | ------------- | ---------------------------------------- |
| 云账号   | 是            | 管理资源对象的云账号                     |
| 地域     | 是            | 服务组所属的地域                         |
| 集群     | 是            | 指定需要缩容的集群                       |
| 缩容选项 | 是            | 指定缩容策略                             |
| 缩容选项 | 是            | 执行此任务时，仅参考腾讯云提供的健康检查 |

### 克隆服务组

将已有服务组的所有属性克隆到新服务组（依赖镜像、容器等）。在创建新服务组时可以选择覆盖克隆服务组的任意属性。

### 启动服务组

启动服务组即让被禁用的服务组重新处理请求流量。负载均衡器的配置决定了新旧服务组之间的路由规则。启用服务组的同时也启用伸缩容策略。

![](https://main.qcloudimg.com/raw/6e3014c1e9711f754080536b23a218f8.png)

配置选项说明：

| 字段       | 必填（是/否） | 说明                       |
| ---------- | ------------- | -------------------------- |
| 云账号     | 是            | 管理资源对象的云账号       |
| Namespaces | 是            | 服务组所属的命名空间       |
| 集群       | 是            | 服务组所属的集群           |
| 服务组     | 是            | 指定服务组需满足的匹配规则 |
| 健康检查   | 否            | 配置健康检查策略           |

### 禁用服务组

禁用服务组意味着让服务组保持运行状态但不处理流量。另外针对禁用服务组的伸缩容操作也会被禁用。禁用服务组使得在新旧服务组之间做流量切换变得很简单。在阶段启动之前用户必须指定禁用最新、最旧或次新的服务组。

### 销毁服务组

销毁指定集群的服务组和相应资源。在阶段启动之前用户必须指定销毁最新、最旧或次新的服务组。

### 调整服务组规模

以当前服务组规模的百分比或指定数量来调整服务组大小。支持如下调整策略：

- 扩容：增大目标服务组的规模
- 缩容：减小目标服务组的规模
- 扩容至相对最大规模：将目标服务组规模扩容至与当前集群中最大服务组一致
- 调整为特定规模：将目标服务组调整至特定规模

### Shrink Cluster

指定保留一定数量的最新或规模最大的服务组，将其他的服务组全部删除。用户可以选择是否删除不满足指定条件的活跃（正常运行）服务组

### Modify Scaling Process

暂停/恢复 扩缩容操作

### 从集群中查找镜像

从已部署集群中查找镜像。请确保指定的集群和服务组存在符合查找条件的镜像，否则可能会导致异常。

![](https://main.qcloudimg.com/raw/36eaf64994a79413e7f21e9ae107c123.png)

配置选项说明：

| 字段                     | 必填（是/否） | 说明                               |
| ------------------------ | ------------- | ---------------------------------- |
| 云账号                   | 是            | 镜像所属的云账号                   |
| 地域                     | 是            | 镜像所属的地域                     |
| 集群                     | 是            | 镜像所属的集群                     |
| 服务组                   | 是            | 指定服务组需满足的匹配规则         |
| 是否只选择已启用的服务组 | 否            | 如果勾选，表示不匹配被禁用的服务组 |

## Kubernetes 类型

### Bake（Manifest）

使用诸如 Helm 这样的模板渲染器 Bake 资源清单。


### 启用（Manifset）

启用 Kubernetes 对象。

配置选项说明：

- `Selector` 选择 `静态指定目标`

| 字段      | 必填（是/否） | 说明                                                         |
| --------- | ------------- | ------------------------------------------------------------ |
| 云账号    | 是            | 管理资源对象的云账号                                         |
| Namespace | 是            | 资源对象所在的命名空间                                       |
| Selector  | 是            | 通过名称静态指定删除的目标资源                               |
| Kind      | 是            | 资源对象类型                                                 |
| Name      | 是            | 资源对象名称（如 replicaSet 类型的资源 `nginx-deployment-5dfd77bbf9`） |

![](https://main.qcloudimg.com/raw/12ad63a8b438fb1073f9290d5db52d82.png)

- `Selector` 选择 `静态选择目标`

| 字段      | 必填（是/否） | 说明                                                         |
| --------- | ------------- | ------------------------------------------------------------ |
| 云账号    | 是            | 管理资源对象的云账号                                         |
| Namespace | 是            | 资源对象所在的命名空间                                       |
| Selector  | 是            | 通过名称静态指定删除的目标资源                               |
| Kind      | 是            | 资源对象类型                                                 |
| 集群      | 是            | 资源对象名称（如 replicaSet 类型的资源 `nginx-deployment-5dfd77bbf9`） |
| Target    | 是            | 选择规则匹配资源对象                                         |

### 禁用（Manifest）

禁用 Kubernetes 对象。

### 删除（Manifest）

删除通过资源清单创建的 Kubernetes 对象。

配置选项说明：

- `Selector` 选择 `静态指定目标`

| 字段      | 必填（是/否） | 说明                                                         |
| --------- | ------------- | ------------------------------------------------------------ |
| 云账号    | 是            | 管理资源对象的云账号                                         |
| Namespace | 是            | 资源对象所在的命名空间                                       |
| Selector  | 是            | 通过名称静态指定删除的目标资源                               |
| Kind      | 是            | 资源对象类型                                                 |
| Name      | 是            | 资源对象名称（如 replicaSet 类型的资源 `nginx-deployment-5dfd77bbf9`） |

![](https://main.qcloudimg.com/raw/3a656186c3fadcf213455d7eddd5d0a8.png)

- `Slector` 选择 `动态选择目标`

| 字段      | 必填（是/否） | 说明                                     |
| --------- | ------------- | ---------------------------------------- |
| 云账号    | 是            | 管理资源对象的云账号                     |
| Namespace | 是            | 资源对象所在的命名空间                   |
| Selector  | 是            | 通过集群和 `Target` 字段动态选择资源对象 |
| Kind      | 是            | 资源对象类型                             |
| Cluster   | 是            | 资源对象所在的集群                       |
| Target    | 是            | 选择规则匹配资源对象                     |

![](https://main.qcloudimg.com/raw/b15211917f729214dda2535d99c045f0.png)

- `Selector` 选择 `使用标签匹配目标`

| 字段      | 必填（是/否） | 说明                                         |
| --------- | ------------- | -------------------------------------------- |
| 云账号    | 是            | 管理资源对象的云账号                         |
| Namespace | 是            | 资源对象所在的命名空间                       |
| Selector  | 是            | 通过指定标签规则匹配资源对象                 |
| Kind      | 是            | 资源对象类型                                 |
| Labels    | 否            | 不填写规则表示匹配所有满足指定类型的资源对象 |

![](https://main.qcloudimg.com/raw/5e4fb4ba141dc5788185fa15cde41e5c.png)

设置选项说明：

| 字段         | 必填（是/否） | 说明                                                         |
| ------------ | ------------- | ------------------------------------------------------------ |
| 级联删除     | 否            | 勾选后，表示删除此资源对象管理的所有资源对象（如：Replica Set 管理的所有 Pods），不勾选可能会产生孤儿资源 |
| Grace Period | 否            | （可选）指定资源对象正式终止的时间，将会覆盖 manifest 设置的时间（如果已设置） |

### 部署（Manifest）
 
部署 YAML/JSON 格式的资源清单。

### 从资源中查找制品（Manifest）

从 Kubernetes 资源中查找制品。

### Patch（Manifest）

对 Kubernetes 对象执行 Patch 操作。

### Run Job（Manifest）

运行一个 Kubernetes Job。

### 扩缩容（Manifest）

对 Kubernetes 对象执行扩缩容操作。

### Undo Rollout（Manifest）

回滚到之前的版本。

