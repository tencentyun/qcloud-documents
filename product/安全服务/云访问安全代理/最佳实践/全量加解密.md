针对于数据库存量数据的加解密问题，本文将为您详细介绍云访问安全代理的全量加解密方案整体流程，包括通过控制台界面设置加解密策略、创建元数据相关操作。
>?
>- 配置加密策略后，直接连接 DB 并写加密字段时，会造成 DB 中加密字段存在明文，会造成该条明文记录无法通过代理读取，需执行全量加密后将明文加密成密文。
>- 配置加密策略后，在全量加密完成前，DB 中可能同时存在明文和密文，此时通过代理无法查询到明文的记录，全量加密完成后可正常查询。


## 前提条件
已完成腾讯云 [账号注册](https://cloud.tencent.com/document/product/378/17985)，并完成 [实名认证](https://cloud.tencent.com/document/product/378/10496)。 

## 步骤1：创建 CASB 实例
通过 [云访问安全代理（CASB）控制台](https://console.cloud.tencent.com/casb)，您可以灵活选择创建不同版本的服务实例，详情请参见 [购买方式](https://cloud.tencent.com/document/product/1303/53298)。

## 步骤2：服务及账号授权
- 开通密钥管理系统（KMS）服务并完成 KMS 对云访问安全代理服务的角色授权。详情请参见 [使用 KMS 加密并授权](https://cloud.tencent.com/document/product/1303/48491)。
- 账号授权及策略配置。详情请参见 [账号授权管理](https://cloud.tencent.com/document/product/1303/48429)。

## 步骤3：创建元数据
1. 基于腾讯云数据库服务中的数据库或腾讯云外的自建数据库实例，添加为元数据。详情请参见：[添加云元数据](https://cloud.tencent.com/document/product/1303/55925) 或 [添加自建元数据](https://cloud.tencent.com/document/product/1303/55926) 。
>?
>- **现象：**在添加元数据后，测试连通时，提示“连接失败”。
>- **检查步骤：**
>   - 在数据源的安全组中，应该放通 11.163.0.0/16 TCP:ALL，以及云资源所在 VPC 的 cidr，否则无法进行通信。
>   - 在数据源的 VPC 环境中，ACL 规则应该放通9网段和11网段，否则无法进行通信。
>   - 检查数据源的端口、账号密码与实际是否一致。
>   - 检查数据源的账号，是否有9网段和11网段访问的权限。

2. 提取数据表结构信息：
 1. **命令授权**：
因为 CASB 提取表结构时，需要 show 和 describe 的命令权限，所以需要对代理账号绑定的数据库账号进行命令的授权；命令包括 show databases/tables/views, show create tables/view, describe table/view 等。
 - **提取的操作步骤：**
    1. 当元数据创建完成及正常连通后，对数据库表结构进行数据的提取，具体请参见 [更新表结构](https://cloud.tencent.com/document/product/1303/55927#GXBJG) 。
    2. 提取完成后，在其右侧的操作栏中，单击**使用**操作。
   ![](https://main.qcloudimg.com/raw/df7db56e5a13aa7387bdcb8be1e60ee7.png)


## 步骤4：proxy 资源绑定
将已创建完成的元数据与 CASB 实例进行绑定。绑定的详细操作步骤，请参见 [Proxy 资源绑定](https://cloud.tencent.com/document/product/1303/64636) 。

## 步骤5：创建代理账号
创建 Proxy 代理账号，用于连接数据库。详情请参见 [创建代理账号](https://cloud.tencent.com/document/product/1303/64635) 。

## 步骤6：创建工作密钥
在控制台上创建工作密钥，用于后续加解密。创建详情请参见 [创建密钥](https://cloud.tencent.com/document/product/1303/64625) 。

## 步骤7：创建加解密策略
在控制台上创建加解密策略，用于后续数据库进行策略的配置。详情请参见 [创建策略](https://cloud.tencent.com/document/product/1303/64619)。

## 步骤8：创建全量加解密任务
在控制台上创建全量任务，即能对历史数据进行加解密操作。详情请参见 [创建任务](https://cloud.tencent.com/document/product/1303/64622)。

>? 全量加解密任务： 额外需要建表的权限（需要创建临时表），建表的时候会访问 `INFORMATION_SCHEMA`。

