本文档将指导您通过访问控制功能配置互联网边界规则、NAT 边界规则及 VPC 间规则。
## 互联网边界规则
访问控制规则支持域名过滤，以及地理位置要求的流量过滤。**互联网边界规则**提供两张访问控制规则列表，分别是入站规则与出站规则，**入站规则**：管控外到内的南北向流量。 **出站规则**：管控内到外的南北向流量。本文档将以“入站规则”为例，进行相关操作说明，“出站规则”操作同理。
1. 登录 [云防火墙控制台](https://console.cloud.tencent.com/cfw/ac/internet)，在左侧导航栏中，选择【访问控制】>【互联网边界规则】，进入互联网边界规则页面。
2. 在互联网边界规则页面，单击【入站规则】，进入入站规则页面。
3. 在入站规则页面，可查看最近操作记录。最近操作记录展示了用户最近对规则列表进行的操作：
	- 单击【详情】，可查看该条操作记录详情。
	&nbsp;
![](https://main.qcloudimg.com/raw/a960d5852448d434c767fb5f39af8da2.png)
&nbsp;
	- 单击【查看操作日志】，可查看详细操作记录。
	>?因投递日志需1分钟左右的时间，所以最近操作记录更新会有稍许延迟。
4. 添加规则，在入站规则页面，可进行规则的配置。
	1. 在入站规则页面，单击【添加规则】，将弹出“添加入站规则”的弹窗。
	2. 在“添加入站规则”的弹窗中，可进行规则的配置，访问目的类型分为 **IP 地址**和**地理位置**，然后填写访问源 IP，填写访问目的、目的端口、选择协议、策略等信息。
>!
	>- 入站规则：访问源填写0.0.0.0/0时，后台会自动关联全部公网 IP，填写 CIDR 地址同理，仅对该网段内的公网 IP 生效。
>- 出站规则：与入站规则相同。
>
![](https://main.qcloudimg.com/raw/77f3994058c5e1ff50561a16d407f18d.png)
&nbsp;
		- **字段说明**：
			- **执行顺序**：访问控制规则的执行顺序，出站规则和入站规则的执行顺序互不影响，执行顺序较高的规则被优先匹配，命中某条规则后，不再匹配后序规则。当您修改某条规则的执行顺序时，原本该位置的规则的执行顺序+1，以此类推。当您删除某条规则时，后序所有规则的执行顺序-1。
			- **访问源**：入站规则访问源支持任意 IP 地址、 CIDR 格式地址和地理位置，例如10.10.10.10、10.10.10.10/24或广东省。
			- **访问目的**：入站规则的访问目的仅对您的公网 IP 生效，若填写 CIDR 地址，则后台会自动关联为该地址段内包含的全部公网 IP。
			- **目的端口**：支持单端口号、基于'/'的端口段以及英文逗号分隔的离散端口值。例如“80”、“80/80”、“-1/-1”、“0/65535”或“80,443,3380/3389”
			- **协议**：当前版本的入站规则仅支持 TCP 协议。
			- **策略说明**：
				- 放行：放通命中规则的流量，记录命中次数但不记录访问控制日志，且记录流量日志。
				- 观察：放通命中规则的流量，记录命中次数并记录访问控制日志与流量日志。
				- 阻断：拦截命中规则的流量，记录命中次数并记录访问控制日志，但不记录流量日志。 
			- **描述**：用于描述规则，最多支持50个字符。
		<span id="hlw"></span>
		- **互联网边界通配规则：**
防火墙提供了不同的通配 IP、通配端口和通配域名的规则：
<table>
    <thead>
        <tr>
            <th >输入字段</th>
            <th >输入示例</th>
            <th >说明</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>访问源/访问目的</td>
            <td>0.0.0.0/0</td>
            <td>表示全部 IP。</td>
        </tr>
        <tr>
            <td>域名</td>
            <td>*</td>
            <td>表示全部域名。</td>
        </tr>
        <tr>
            <td><font >域名</font></td>
            <td><font >*.aa.com</font></td>
            <td><font >表示以*开头的二级域名：aa.com。</font></td>
        </tr>
        <tr>
            <td><font >目的端口</font></td>
            <td><font>-1/-1</font></td>
            <td><font >表示全部端口。</font></td>
        </tr>
        <tr>
            <td><font >目的端口</font></td>
            <td><font >0/65535</font></td>
            <td><font>表示全部端口。</font></td>
        </tr>
        <tr>
            <td><font>目的端口</font></td>
            <td><font>80,443,3389</font></td>
            <td><font>表示对80、443、3389三个端口生效。</font></td>
        </tr>
        <tr>
            <td><font>目的端口</font></td>
            <td><font>80/443</font></td>
            <td><font>表示对80到443之间的全部端口生效。</font></td>
        </tr>
        <tr>
            <td><font>目的端口</font></td>
            <td><font>80/443,3389</font></td>
            <td><font>表示对80到443之间全部端口与3389端口生效。</font></td>
        </tr>
    </tbody>
</table>
5. 在右侧操作栏单击【复制】， 添加多条规则。
>?在“添加入站规则”的弹窗中，一行代表一条规则，每次添加规则默认插入到列表的最后位置，即执行顺序最大，优先级最低的位置。
>
	- **场景1**：已在本地完成规则列表的编辑，需要批量添加规则提升效率。
		1. 在右侧操作栏单击【复制】，可在当前位置的下方新增一行规则，单次最多支持添加10条规则。
		&nbsp;
	![](https://main.qcloudimg.com/raw/ba290527c1f408925550f2772c3028e8.png)
		&nbsp;
		2. 完善表单中所有字段。
		3. 提交前，检查批量添加规则的执行顺序是否符合预期。
		4. 单击【确定】，提交所配置的规则。
	- **场景2**：需要同时对某个 IP 配置多条规则。
		1. 首先编辑一行规则，只编辑需要重复填写的部分。
		2. 在右侧操作栏单击【复制】，可在当前位置的下方新增一行规则，并自动复制上一行已经填写的内容，单次最多支持添加10条规则。
		&nbsp;
		![](https://main.qcloudimg.com/raw/8b6f27063c456d62cc8cec04f276a31d.png)
		&nbsp;
		3. 完善表单中其他字段，补充不需要重复填写的部分。
		4. 提交前，检查批量添加规则的执行顺序是否符合预期。
		5. 单击【确定】，提交所配置的规则。
6. 规则添加完成后，即可在规则列表中查看相关规则。
7. 导入规则，单击【导入规则】，可以从本地选择文件导入，您可以指定导入位置、下载导入模板和导出现有规则。
&nbsp;
![](https://main.qcloudimg.com/raw/52b8f7ae20809267466beea90dc595b1.png)

## NAT 边界规则

访问控制规则支持域名过滤，以及地理位置要求的流量过滤。**NAT 边界规则**提供两张访问控制规则列表，分别是入向规则与出向规则，**入向规则**：在互联网边界内，管控由外到内的南北向流量。**出向规则**：在互联网边界内，管控由内到外的南北向流量。本文档将以“入向规则”为例，进行相关操作说明，“出向规则”操作同理。

1. 登录 [云防火墙控制台](https://console.cloud.tencent.com/cfw/ac/internet)，在左侧导航栏中，选择【访问控制】>【NAT边界规则】，进入 NAT 边界规则界面。
2. 在 NAT 边界规则界面，选择一个地域，单击【入向规则】，进入入向规则界面。
3. 在入向规则界面，可查看对应的防火墙实例的详细信息（实例 ID、绑定弹性 IP、端口转发规则个数、访问控制规则个数和列表详情）和最近操作记录。最近操作记录展示了用户最近对规则列表进行的操作：
   * 单击【详情】可查看该条操作记录详情
   * 单击【查看操作日志】，可查看详细操作记录。
&nbsp;
   ![](https://main.qcloudimg.com/raw/a290bb33f01faab45b0c78590a856858.png)
4. 添加规则，在入向规则页面，可进行规则的配置。
   i. 在入向规则页面，单击【添加规则】，将弹出“添加入向规则”的弹窗。
   ii. 在“添加入向规则”的弹窗中，可根据访问目的的类型进行规则的配置，访问目的类型分为 **IP 地址**和**地理位置**，然后填写访问源 IP、访问目的、目的端口等信息。
	 &nbsp;
   ![](https://main.qcloudimg.com/raw/aaeeed523e0d5688fda990754b8676eb.png)
	 &nbsp;
   **字段说明**：
     - **执行顺序**：访问控制规则的执行顺序，出站规则和入站规则的执行顺序互不影响，执行顺序较高的规则被优先匹配，命中某条规则后，不再匹配后序规则。当您修改某条规则的执行顺序时，原本该位置的规则的执行顺序+1，以此类推。当您删除某条规则时，后序所有规则的执行顺序-1。
     - **访问源**：入向规则访问源对所有公网 IP 生效，支持 IP、CIDR 和地理位置。
     * **访问目的**：入向规则访问目的仅对当前地域内的所有内网资产生效，支持 IP 和 CIDR。
     * **目的端口**：TCP/UDP 规则支持单端口号、基于'/'的端口段以及英文逗号分隔的离散端口值，例如“80”、“80/80”、“-1/-1”、“0/65535”或“80,443,3380/3389”，ICMP 规则不需要配置端口。
     * **协议**：当前版本的入向规则支持 TCP、UDP 和 ICMP 协议。
     * **策略说明**：
       * 放行：放通命中规则的流量，记录命中次数但不记录访问控制日志，且记录流量日志。
       * 观察：放通命中规则的流量，记录命中次数并记录访问控制日志与流量日志。
       * 阻断：拦截命中规则的流量，记录命中次数并记录访问控制日志，但不记录流量日志。
     * **描述**：用于描述规则，最多支持50个字符。
   * **NAT 边界通配规则**：
     防火墙提供了不同的通配 IP、通配端口和通配域名的规则：
      <table>
         <thead>
             <tr>
                 <th >输入字段</th>
                 <th >输入示例</th>
                 <th >说明</th>
             </tr>
         </thead>
         <tbody>
             <tr>
                 <td>访问源/访问目的</td>
                 <td>0.0.0.0/0</td>
                 <td>表示全部 IP。</td>
             </tr>
             <tr>
                 <td>域名</td>
                 <td>*</td>
                 <td>表示全部域名。</td>
             </tr>
             <tr>
                 <td><font >域名</font></td>
                 <td><font >*.aa.com</font></td>
                 <td><font >表示以*开头的二级域名：aa.com。</font></td>
             </tr>
             <tr>
                 <td><font >目的端口</font></td>
                 <td><font>-1/-1</font></td>
                 <td><font >表示全部端口。</font></td>
             </tr>
             <tr>
                 <td><font >目的端口</font></td>
                 <td><font >0/65535</font></td>
                 <td><font>表示全部端口。</font></td>
             </tr>
             <tr>
                 <td><font>目的端口</font></td>
                 <td><font>80,443,3389</font></td>
                 <td><font>表示对80、443、3389三个端口生效。</font></td>
             </tr>
             <tr>
                 <td><font>目的端口</font></td>
                 <td><font>80/443</font></td>
                 <td><font>表示对80到443之间的全部端口生效。</font></td>
             </tr>
             <tr>
                 <td><font>目的端口</font></td>
                 <td><font>80/443,3389</font></td>
                 <td><font>表示对80到443之间全部端口与3389端口生效。</font></td>
             </tr>
         </tbody>
     </table>

5. 在右侧操作栏单击【复制】，添加多条规则。
 >? 在“添加入站规则”的弹窗中，一行代表一条规则，每次添加规则默认插入到列表的最后位置，即执行顺序最大，优先级最低的位置。
 >
 * **场景1**：已在本地完成规则列表的编辑，需要批量添加规则提升效率。
     1. 在右侧操作栏单击【复制】，可在当前位置的下方新增一行规则，单次最多支持添加10条规则。
     &nbsp;
        ![](https://main.qcloudimg.com/raw/a666ad2efdde8216647453a8d12393a4.png)
	&nbsp;
     2. 完善表单中所有字段。
     3. 提交前，检查批量添加规则的执行顺序是否符合预期。
     4. 单击【确定】，提交所配置的规则。
   * **场景2**：需要同时对某个 IP 配置多条规则。
     1. 首先编辑一行规则，只编辑需要重复填写的部分。
     2. 在右侧操作栏单击【复制】，可在当前位置的下方新增一行规则，并自动复制上一行已经填写的内容，单次最多支持添加10条规则。
     &nbsp;
      ![](https://main.qcloudimg.com/raw/82ec9780a6009dc71723a750b35753a2.png)
	&nbsp;
     3. 完善表单中其他字段，补充不需要重复填写的部分。
     4. 提交前，检查批量添加规则的执行顺序是否符合预期。
     5. 单击【确定】，提交所配置的规则。
6. 导入规则，单击【导入规则】，可以从本地选择文件导入，您可以指定导入位置、下载导入模板和导出现有规则。
&nbsp;
   ![](https://main.qcloudimg.com/raw/5245c289432715cc14408e86a65ecab6.png)

 
 ## VPC 间规则
VPC 间规则提供有多张访问控制列表，每张访问控制列表对应一对互通 VPC，同时也对应一个 VPC 间防火墙开关。

1. 登录 [云防火墙控制台](https://console.cloud.tencent.com/cfw/ac/internet)，在左侧导航栏中，选择【访问控制】>【VPC 间规则】，进入 VPC 间规则页面。
2. 在 VPC 间规则页面左上角，可通过“防火墙开关名称”的下拉框切换不同的 VPC 间访问控制列表。
&nbsp;
![](https://main.qcloudimg.com/raw/0a572af87b014c85ece293475990e3df.png)
>?
>- 区别于互联网边界和 NAT 边界访问控制列表，VPC 间访问控制列表不区分方向区。
>- 本端 VPC 与对端 VPC 是等价的，在配置规则时，可以根据访问源与访问目的所在的 CIDR 网段判断所属 VPC，进而区分方向。
3. 在 VPC 间规则页面，单击【添加规则】，进入添加规则页面。
4. 在添加规则页面，已提供了 VPC 间访问控制列表的本端及对端 VPC 信息与防火墙开关信息，仅需填写访问源 IP、访问目的 IP 及目的端口等信息，即可完成规则配置。
&nbsp;
![](https://main.qcloudimg.com/raw/fd0be8b9f056dee09fbdf07466383e7f.png)
&nbsp;
**字段说明**：
	- **执行顺序**：访问控制规则的执行顺序，与防火墙开关中对应规则列表的执行顺序互不影响，执行顺序较高的规则会被优先匹配，命中某条规则后，则不再继续匹配后序规则。当您修改某条规则的执行顺序时，原本该位置规则的执行顺序+1，以此类推。当您删除某条规则时，后序所有规则的执行顺序-1。
	- **访问源**：支持0.0.0.0/0作为通配规则的访问源（仅生效与于前 VPC 之间），除此之外访问源只能填写本端或对端 VPC 的 CIDR 中的 IP 或子网段，且不与访问目的在同一个 VPC 网段内。
	- **访问目的**：支持0.0.0.0/0作为通配规则的访问目的（仅生效于当前VPC之间），除此之外访问目的只能填写本端或对端 VPC 的 CIDR 中的 IP 或子网段，且不与访问源在同一个 VPC 网段内。
	- **目的端口**：支持单端口号、基于'/'的端口段以及英文逗号分隔的离散端口值。例如“80”、“80/80”、“-1/-1”、“0/65535”或“80,443,3380/3389”。
	- **协议**：当前版本支持 UDP、TCP与 ICMP 协议。
	- **策略说明**：
		- 放行：放通命中规则的流量，记录命中次数但不记录访问控制日志，且记录流量日志。
		- 观察：放通命中规则的流量，记录命中次数并记录访问控制日志与流量日志。
		- 阻断：拦截命中规则的流量，记录命中次数并记录访问控制日志，但不记录流量日志。 
	- **描述**：用于描述规则，最多支持50个字符。
	- **VPC 间通配规则**：支持通配的 IP 地址段，详情可参见 [互联网边界通配规则](#hlw)。	
 >!
>- 本端 VPC 与对端 VPC 的 CIDR 网段不能相同，也不能重叠，否则将无法开启防火墙开关。
>- VPC 间访问控制规则中，访问源与访问目的仅支持填写：本端/对端 VPC 的 CIDR 地址中的 IP 地址或 CIDR 子网段，由于本端 VPC 和对端 VPC 的 CIDR 不能相同，通过“访问源”、“访问目的”便可以区分规则所控制的流量方向。
>- 若填写本端 VPC 或对端 VPC 的 CIDR 以外的地址，则规则无法生效。
>- 当“访问源”和“访问目的”填写0.0.0.0/0时，可以用来表示 VPC 的全部地址。
>
5. 在右侧操作栏单击【复制】， 添加多条规则。
>?在“添加入站规则”的弹窗中，一行代表一条规则，每次添加规则默认插入到列表的最后位置，即执行顺序最大，优先级最低的位置。
>
	- **场景1**：已在本地完成规则列表的编辑，需要批量添加规则提升效率。
		1. 在右侧操作栏单击【复制】，可在当前位置的下方新增一行规则，单次最多支持添加10条规则。
		&nbsp;
		![](https://main.qcloudimg.com/raw/6fb9fb39c493201bd29314e4b68ede3e.png)
		&nbsp;
		2. 完善表单中所有字段。
		3. 提交前，检查批量添加规则的执行顺序是否符合预期。
		4. 单击【确定】，提交所配置的规则。
	- **场景2**：需要同时对某个 IP 配置多条规则。
		1. 首先编辑一行规则，只编辑需要重复填写的部分。
		2. 在右侧操作栏单击【复制】，可在当前位置的下方新增一行规则，并自动复制上一行已经填写的内容，单次最多支持添加10条规则。
		&nbsp;
		![](https://main.qcloudimg.com/raw/847c2fdc1b4071f140f0293253416895.png)
		&nbsp;
		3. 完善表单中其他字段，补充不需要重复填写的部分。
		4. 提交前，检查批量添加规则的执行顺序是否符合预期。
		5. 单击【确定】，提交所配置的规则。
6. 规则添加完成后，即可在规则列表中查看相关规则。
7. 导入规则，单击【导入规则】，可以从本地选择文件导入，您可以指定导入位置、下载导入模板和导出现有规则。
&nbsp;
![](https://main.qcloudimg.com/raw/3cc529af73cf333623960fd3d1b2bfab.png)
	
## 特殊应用场景

### 管理规则列表的执行顺序
互联网边界规则、NAT 边界规则和 VPC 间规则都支持管理规则列表的执行顺序，接下来将以“互联网边界规则”为例进行说明 。
#### 场景1：对列表内规则进行快速排序

1. 登录 [云防火墙控制台](https://console.cloud.tencent.com/cfw/ac/internet)，在左侧导航栏中，选择【访问控制】>【互联网边界规则】，进入互联网边界规则页面。
2. 在互联网边界规则页面的规则列表上方，单击【快速排序】，列表进入编辑模式。
3. 用户能够在当前页面范围内，批量移动规则的位置和顺序，通过拖动规则前方图标，对规则进行排序。
4. 移动完成后需单击【保存】即可生效。
&nbsp;
![](https://main.qcloudimg.com/raw/53acd9daa6a3f754e2403b52450b6ce2.png)
&nbsp;
**排序操作说明**：
	- 每次松开鼠标后，导致<strong>位置</strong>发生变化的规则落地，视为一次排序操作。
	- 松开鼠标后，<strong>位置</strong>没有发生变化，则不是一次排序操作。
	- 发生过一次排序操作后，【撤销】按钮亮起。
	- 单击一次【恢复】，列表回到上一次排序操作后的状态。
	- 单击【保存】，完成后，页面上方会出现<strong>排序完成</strong>提示。
	- 单击【取消】，列表会回到初始状态，所有排序操作不生效。

#### 场景2：通过编辑将规则移动至指定位置
当需要大范围的移动某条规则时，快速排序功能不能高效的执行这一类操作，因此，通过编辑可以快速的将当前规则移动到指定的位置，与快速排序不同，编辑功能一次只能实现对一个规则执行顺序的修改。
1. 登录 [云防火墙控制台](https://console.cloud.tencent.com/cfw/ac/internet)，在左侧导航栏中，选择【访问控制】>【互联网边界规则】，进入互联网边界规则页面。
2. 在互联网边界规则页面的规则列表中，找到需要移动的规则，确定移动的期望位置。
2. 在规则右侧，单击【编辑】，进入规则编辑模式。
3. 修改执行顺序字段的值，修改为期望位置的执行顺序值。
>!由于执行顺序的不可重复原则与连续原则，通过编辑进行规则的移动时，执行顺序的合理输入最小值为1，最大值为当前列表中的规则数量。
>
![](https://main.qcloudimg.com/raw/0ac11a630840c3b6f162e3fd9aa71556.png)
&nbsp;
4. 单击【完成】，检查列表中的规则顺序是否符合预期。
>?通过编辑规则可以实现移动规则在列表中的位置，从而直接将该规则的执行顺序调整到期望的位置，其他所有规则也会自动移动调整。 

#### 场景3：在现有列表中的指定位置插入一条规则
云防火墙支持在任意两条规则之间，插入一条规则，插入规则的执行顺序即为当前插入的位置。

规则采用**前插**的方式，若需要在执行顺序为“2”和“3”的规则之间，插入一条新的规则：
1. 登录 [云防火墙控制台](https://console.cloud.tencent.com/cfw/ac/internet)，在左侧导航栏中，选择【访问控制】>【互联网边界规则】，进入互联网边界规则页面。
2. 在互联网边界规则页面的规则列表中，找到执行顺序为“3”的规则，在规则右侧单击【插入】。
2. 将在执行顺序为“3”的规则上方，弹出规则编辑框。
3. 在规则编辑框中，填写规则字段，单击【完成】即可完成规则插入。
>?完成插入操作后，被插入的所有规则执行顺序自动“+1”。
>
![](https://main.qcloudimg.com/raw/2ab4d37807c6e66167a9f78bc1fbc0bf.png)

### 查看规则是否生效

- **方式1**：查看访问控制列表中的命中次数，若有命中次数，则表示规则生效。
>?若规则命中次数为零，只能说明暂时没有被命中，可以理解为暂时没有生效，但是不代表规则配置有误。
>
![](https://main.qcloudimg.com/raw/bbabe496cba03c9e49890e9ad48fabb0.png)
&nbsp;
- **方式2**：左侧导航栏中，选择【日志审计】>【[访问控制日志](https://console.cloud.tencent.com/cfw/log)】，查看访问控制日志（规则命中记录日志），若在访问控制日志中，查看到相关规则，则表示该规则生效。
&nbsp;
![](https://main.qcloudimg.com/raw/1d38de9920818addc5017dd90d5deb72.png)


### 操作锁

同一个 AppID 的同一张访问控制列表（VPC 使用防火墙 ID 来区分），在同一时间只允许一个用户执行【添加规则】、【导入规则】、【快速排序】、【编辑】、【插入】中的任意一个操作。

当用户对列表进行操作时，如在页面上方出现：“列表可能正在被其他人操作，已被锁定，请稍后重试”的提示时，则代表此时有其他的用户正在对该列表进行操作。
>?操作锁的有效期为5分钟，到时后自动释放。
>
![](https://main.qcloudimg.com/raw/41ba052cef64634011f069c5bc36f0f0.png)
