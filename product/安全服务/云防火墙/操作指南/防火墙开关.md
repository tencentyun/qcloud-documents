云防火墙开关分为三种，分别是“互联网边界防火墙开关”、“NAT 边界防火墙开关”以及“VPC 间防火墙开关”。云防火墙开关支持一键开启防护，您无需进行任何的网络接入部署与路由策略配置，且无需安装任何镜像文件，云防火墙可以为您提供即开即用的产品体验。

## 打开互联网边界防火墙开关
在互联网边界开关页面，系统会自动探测到您所持有的公网 IP 以及关联的云上资产，并为您配置对应的防火墙开关。
1. 登录 [云防火墙控制台](https://console.cloud.tencent.com/cfw/switch/internet)，在左侧导航栏中，选择【防火墙开关】>【互联网边界开关】，进入互联网边界开关页面。
2. 在开关列表中，找到需要防护的资产，在“防火墙开关”列，单击开关按钮，便可以对该资产进行边界防护。
&nbsp;
![](https://main.qcloudimg.com/raw/340421ef1b57e84e480d51d44367761e.png)

>?
>- 当前版本支持的资产类型为：云服务 CVM、负载均衡 CLB、NAT 网关、VPN 网关，<strong>仅支持中国大陆资产。</strong>
>- 开启开关：当开启开关时，该公网 IP 的所有流量将经过云防火墙，且访问控制、入侵防御、日志审计功能将对该公网 IP 生效。
>- 关闭开关：当关闭开关时，该公网 IP 的所有流量将不会经过云防火墙。
>

3. 其他辅助操作。
	- **防火墙状态监控**：为了避免因互联网边界防火墙带宽达到规格限制而带来网络丢包和波动时，用户可以实时查看并监控基于公网 IP 的带宽情况，从而及时作出扩容或关闭部分开关等调整。
		1. 在状态监控面板右上角，单击统计按钮。
		&nbsp;
![](https://main.qcloudimg.com/raw/f85f411cc9d6472ff0aa9d5126eb3458.png)
&nbsp;
		2. 在“防火墙状态监控”页面，可实时查看并监控基于公网 IP 的带宽情况，并进行扩容或关闭部分开关等操作。
		&nbsp;
		![](https://main.qcloudimg.com/raw/69daccb354cef4cd7f02676f850f5447.png)
		&nbsp;
	-	**同步资产**：后台定时轮询用户资产信息的间隔为5分钟，因此当用户资产规模在此间隔内发生变化，但尚未被后台同步时，可在列表上方，单击【同步资产】，及时调用后台接口重新读取并同步用户的资产信息与数据。
	&nbsp;
![](https://main.qcloudimg.com/raw/05d0786e51d03426681ca751cfd3337b.png)
&nbsp;
	- **资产扫描**：面向公网开放的端口时刻都有可能受到来自外界的安全威胁，可以对向公网开放的云服务器资产进行风险扫描，从而有效的探测资产的端口风险以及测绘资产的端口开放情况，做到减少开放不必要面向公网的端口。
		- **方式1**：对所有资产进行扫描。
			1. 在列表上方，单击【资产扫描】。
			&nbsp;
		![](https://main.qcloudimg.com/raw/3e3441a117f68fcf26475e5f8f4210bd.png)
		&nbsp;
			2. 在“资产扫描”弹窗中，选择扫描方式，单击【确定】。
			&nbsp;
		![](https://main.qcloudimg.com/raw/093aecc1589815df5d86da9e0656a44b.png)
		&nbsp;
		- **方式2**：对单个资产进行扫描。
			1. 在列表中，选择需要扫描的目标资产，在右侧操作栏，选择【更多】>【资产扫描】。
			>?如选中的单个资产类型为非云服务器，则无法对该资产进行扫描。
			>
			![](https://main.qcloudimg.com/raw/c3452180fa33bfecfd6bb975f5e2fa35.png)
			&nbsp;
			2. 在“资产扫描”弹窗中，选择扫描方式，单击【确定】。

## 打开 NAT 边界防火墙开关
NAT 边界防火墙支持基于内网资产进行流量管控与安全防护，同时支持基于 SNAT、DNAT 所进行的网络流量转发。
1. 登录 [云防火墙控制台](https://console.cloud.tencent.com/cfw)，在左侧导航栏中，选择【防火墙开关】>【NAT边界开关】，进入 NAT 边界开关页面。
>?当某个 NAT 边界防火墙开关开启后，对应子网的互联网流量将经过防火墙，届时访问控制规则、入侵防御功能将对其生效，流量日志也会生成。
2. 在 “NAT 边界开关”页面，可进行创建实例、同步资产、查看并监控基于 NAT 边界的带宽情况等操作。
	- **查看并监控基于 NAT 边界的带宽情况**
		1. 在状态监控面板右上角，单击统计按钮，进入防火墙状态监控页面。
			&nbsp;
			![](https://main.qcloudimg.com/raw/6ea02b0cf2adc53dcaf91f1f9dbfb268.png)
			&nbsp;
		2. 在防火墙状态监控页面，可实时查看并监控基于 NAT 边界的带宽情况，可避免因 NAT 边界防火墙带宽超出规格而带来网络丢包和波动，从而及时作出扩容或关闭部分开关等调整。
		 &nbsp;
		![](https://main.qcloudimg.com/raw/a2c73c199d26ea5d3caa4a96d7bf7cac.png)
		&nbsp;
	- **创建实例**	
		1. 在 “NAT 边界开关”页面下，单击【创建实例】。
		2. 在“新建 NAT 边界防火墙”弹窗中，可为当前账号创建一个新的 NAT 边界防火墙实例。
&nbsp;
![](https://main.qcloudimg.com/raw/55bcbc838eddb40cd76a13033af5b866.png)
&nbsp;
>?
>- 地域：用户可在拥有 VPC 的所有国内地域中进行地域选择，但已经创建了 NAT 边界防火墙的地域将无法选择。
>- 弹性 IP：若选择新建弹性 IP，系统会自动为用户申请一个弹性 IP，用户也可从所有闲置的弹性 IP 中选择一个进行绑定。
	- **同步资产**
在 “NAT 边界开关”页面下，单击【同步资产】，可以主动调用后台接口重新读取并同步用户子网的资产信息，可避免发生因用户资产规模在后台轮询间隔内发生变化，但尚未被同步的情况。
&nbsp;
![](https://main.qcloudimg.com/raw/873683d079d9231ae7083bb48f31bcb0.png)
&nbsp;
	- **防火墙开关**：在防火墙开关页面，支持开启或关闭基于子网粒度的 NAT 边界防护。
		- **开启防护**
		>!开启开关后，请勿在 [私有网络控制台](https://console.cloud.tencent.com/vpc/vpc?rid=1) 中手动变更开关对应的路由，否则将导致防火墙丢失路由而引发网络中断。
		>
			- **方式1**：在实例列表上方，单击【开启防护】，所有未开启的 NAT 边界防火墙开关将被打开，所有路由表将会自动添加下一跳类型为 NAT 边界防火墙的路由策略，所有子网的互联网流量将会经过 NAT 边界防火墙。
			>?若用户选择开启同一路由表关联的所有子网，系统会自动在该路由表中增加一条下一跳指向 NAT 边界防火墙的路由策略，并关闭原访问公网的路由策略，因此该路由表关联的所有子网的互联网流量，将会经过NAT边界防火墙。
			>
			![](https://main.qcloudimg.com/raw/30ff60ac2cd2f3a28b9388cf9581d6a0.png)
			&nbsp;
			- **方式2**：如想开启对某个子网实例的 NAT 边界防护，可以在右侧操作栏，单击“防火墙开关”按钮，开启对该子网资产的防护。
	>?若用户仅选择开启某个子网，系统会自动为当前子网创建新的路由表，复制现有的全部路由策略，在新路由表中增加一条下一跳指向 NAT 边界防火墙的路由策略，并关闭原访问公网的路由策略，因此该子网的互联网流量，将会经过 NAT 边界防火墙。
	>
	![](https://main.qcloudimg.com/raw/71c8a31db4f3ad15aae9e863540ed895.png)
	&nbsp;
		- **关闭防护**
 			- **方式1**：在实例列表上方，单击【关闭防护】，所有已开启的 NAT 边界防火墙开关将被关闭，NAT 边界防火墙会自动关闭下一跳类型为 NAT 边界防火墙的所有路由表的路由策略，所有子网将断开与互联网的连接，用户需要在 [私有网络控制台](https://console.cloud.tencent.com/vpc/vpc?rid=1) 手动启动新的路由策略。
 			>?若用户选择关闭同一路由表关联的所有子网，系统会自动关闭该路由表中下一跳指向 NAT 边界防火墙的路由策略，该路由表关联的所有子网将会断开与互联网的连接。
 			>
 			![](https://main.qcloudimg.com/raw/ad1bdfd566e683c156f4795a6b807f03.png)
			&nbsp;
 			- **方式2**：如想关闭对某个子网实例的NAT边界防护，可以在右侧操作栏，单击“防火墙开关”按钮，关闭对该子网资产的防护，关闭开关后，用户需要前往 [私有网络控制台](https://console.cloud.tencent.com/vpc/vpc?rid=1) 手动启用新的路由策略。
	 >?若用户仅选择关闭某个子网，系统会自动为当前子网创建新的路由表，复制现有的全部路由策略，并关闭下一跳指向 NAT 边界防火墙的路由策略，该子网将会断开于互联网的连接。
	 >
![](https://main.qcloudimg.com/raw/d0a253d93d4cf0002aedb96230032987.png)
&nbsp;
		- **防火墙开关异常场景说明**
			- **场景1**：当已有子网x.x.x.x/24加入了 NAT 边界防火墙且开启开关，当前地域内存在另一个子网且也是x.x.x.x/24时，已开启相同网段的子网会导致防火墙开关开启失败。
			- **场景2**：在后台定时轮询资产的时间间隔内，若用户删除了某个子网或变更了子网绑定的路由表，虽然该子网仍会出现在开关列表内，但防火墙开关将无法开启。
		- **查看某个子网绑定的路由表以及路由策略**
在目标实例右侧操作栏，选择【更多】>【查看路由策略】，进入路由表页面进行查看。
&nbsp;
![](https://main.qcloudimg.com/raw/fb93a415e7929d26ae18b70e05a35d83.png)
&nbsp;
	- **实例配置**：在实例配置页面下，可以看到用户基于 NAT 边界防火墙实例所添加的 DNAT 端口转发规则，以及与实例关联的弹性 IP。
		1. 在实例配置页面，单击【新建规则】，弹出“新建端口转发规则”窗口。
		&nbsp;
![](https://main.qcloudimg.com/raw/44f442859246931c1f1419eca8803941.png)
&nbsp;
		2. 在“新建端口转发规则”窗口，用户可为当前 NAT 边界防火墙实例添加一条外部 IP 为用户所绑定的弹性 IP 的 DNAT 规则。
		>?
		>- 在外部 IP 端口下拉框内，提供的选项为当前 NAT 边界防火墙实例所绑定的弹性 IP。
		>- 输入内部 IP 地址时，用户需填写本地域 VPC 网段内可用的 IP。
		>
![](https://main.qcloudimg.com/raw/b91bf104d7c290a7c015d6b9562f869a.png)
&nbsp;
		3. 在实例配置页面右侧的“关联弹性 IP”模块，单击【+绑定弹性IP】。
		4. 在单选下拉框内，用户可为当前 NAT 边界防火墙实例绑定一个系统新建的弹性 IP，或在当前地域拥有的所有闲置弹性 IP 里选择一个进行绑定。
		>?
		>- 关联弹性 IP 功能目前只支持新增模式，暂未支持迁移模式。
		>- 解除绑定某个弹性 IP 时，页面上与其相应的 DNAT 规则也会消失。
		>
![](https://main.qcloudimg.com/raw/48461beaa0162204aa2db464d949458a.png)

## 打开 VPC 间防火墙开关

1. 登录 [云防火墙控制台](https://console.cloud.tencent.com/cfw/switch/vpc)，在左侧导航栏中，选择【防火墙开关】>【VPC 间开关】，进入 VPC 间开关页面。
2. 在  VPC 间开关页面，单击【防火墙开关】，进入防火墙开关页面，系统会自动探测您的 VPC 信息与互通关系，并在每一对互通的 VPC 间，建立云防火墙开关。
3. 在防火墙开关页面，找到需要防护的 VPC 间对应的开关，在“防火墙开关”列，单击开关按钮，便可以防护这一对 VPC 间的流量。
&nbsp;
![](https://main.qcloudimg.com/raw/ec39c3b72deb251a41286a3837972090.png)

>?
>- 当前版本支持的 VPC 互通服务的类型为：对等连接 PC、云联网 CCN，<strong>仅支持中国大陆地区的VPC</strong>。
>- 在开关列表中显示的本端 VPC 与对端 VPC 是等价的，不区分方向。</li>
>- 开启开关：开关所对应的一对 VPC 之间的流量将会经过云防火墙，该开关对应的访问控制列表将会生效于这一对 VPC 之间的流量，并记录日志。</li>
>- 关闭开关：对应的一对 VPC 间的流量将不会经过云防火墙（VPC 间将恢复之前的路由策略，通过对等连接或云联网进行通信）。

4. 其他辅助操作。
	- **同步资产**：在 VPC 间开关页面下的“网络拓扑”标签内，单击【同步资产】，可以及时调用后台接口重新读取并同步用户的资产信息，从而避免发生因用户资产规模在后台轮询间隔内发生变化，但尚未被同步的情况。
	&nbsp;
![](https://main.qcloudimg.com/raw/3b43ee6f50db56c5d959b94631a1c903.png)
&nbsp;
	- **选择 VPC**：在“网络拓扑”或“防火墙开关”标签下，可以根据规格选择需要防护的 VPC.
		1. 在“网络拓扑”或“防火墙开关”标签下，单击【选择 VPC】。
		2. 在左侧选择 VPC 的穿梭框内，用户可以根据上方蓝色提示栏所提供的规格信息，选出需要被防护的地域，单击【下一步】。
		&nbsp;
![](https://main.qcloudimg.com/raw/274209317aa3f41516ead93bab4e668d.png)
&nbsp;
		3. 根据地域选择需要被防护的 VPC，单击【确定】。
		&nbsp;
![](https://main.qcloudimg.com/raw/1f16f489cf9af8fe82456b0e40e6e82e.png)
&nbsp;
		4. 防火墙会根据用户选择的 VPC 构建网络拓扑图与 VPC 间的防火墙开关。
		&nbsp;
![](https://main.qcloudimg.com/raw/781624c9906a5724763f946c4eff0a03.png)
&nbsp;
		5. （可选）若想重新进行 VPC 的选择，可以重复上述操作。
>!
>- 当用户再次选择时，请务必检查 VPC 间防火墙的开关状态，并确保所有开关都已手动关闭。
>- 在进行新的选择时，之前被放弃的防火墙开关数据仍会被保留（防火墙开关 ID 、名称、对应规则以及开启时间内的所有日志）。

## 使用 VPC 视图梳理 VPC 间的访问关系
云防火墙提供了一个可视化视图，帮助您快速梳理 VPC 之间的访问关系。在 VPC 可视化视图中，每个节点是一个 VPC 实例，VPC 间防火墙是一个中心化的设备，为每一对互通的 VPC 配置了开关。已开启开关的 VPC 间流量将会被牵引至防火墙进行过滤与防护。
1. 登录 [云防火墙控制台](https://console.cloud.tencent.com/cfw/switch/vpc)，在左侧导航栏中，选择【防火墙开关】>【VPC 间开关】，进入 VPC 间开关页面。
2. 在  VPC 间开关页面，单击【网络拓扑】，进入网络拓扑页面。
3. 将鼠标在某个 VPC 节点上悬停，可查看 VPC 的简要信息，同时与之互联的所有 VPC 也会亮起。单击**私有网络 ID** 的蓝色字体，可进入 VPC 详情页查看该 VPC 的详细信息。
&nbsp;
![](https://main.qcloudimg.com/raw/4695ad39e9521abf15790f5853aa302e.png)
&nbsp;
4. 您可以单击某个 VPC 节点，页面进入聚焦视图，显示以聚焦 VPC 为中心的拓扑结构。
5. 彼此互通的 VPC 间通过连线相连接，连线中可以查看防火墙开关，您可以操作开关，也可以通过单击开关的图标，直接进入访问控制规则配置页面。
&nbsp;
![](https://main.qcloudimg.com/raw/068efc0cca7825bff46fface21af1313.png)

## VPC 间防火墙的异常场景说明
- VPC 间防火墙在开启和关闭开关时，涉及后台自动修改您的路由策略，导致**在一个极短的时间内会出现网络闪断**，为不影响您的业务，请您合理安排操作 VPC 间防火墙开关的时间。如果需要进行批量或频繁的开关操作，建议在业务流量较小的深夜进行。
>?互联网边界防火墙的开关不存在类似问题。
- VPC 间防火墙开关建立在 VPC 间的对等连接（或云联网）之上，若您变更（或删除）了对等连接（或云联网）的配置，则防火墙开关也会自动对应变更（或删除）。为了不影响您的业务，云防火墙只会对状态为关闭的开关立即执行变更（或删除）。
>?若您的云上资产有所变更（或删除），互联网边界防火墙开关会在短时间内（5分钟左右）自动同步。
>
- 若 VPC 间没有正在启用的路由，则防火墙开关无法开启。
>?如需配置对等连接路由，请参见 [配置指向对等连接的路由](https://cloud.tencent.com/document/product/553/19696)。如需配置云联网路由，请参见 [路由概述](https://cloud.tencent.com/document/product/877/38801)。

- 云防火墙开关开启状态下，**在 [私有网络控制台](https://console.cloud.tencent.com/vpc/vpc?rid=1) 手动变更对应 VPC 路由表属于高危操作**，由于云防火墙无法同步路由的变更，可能导致防火墙失效，网络连接中断。

- 云防火墙开关关闭状态下，您可以根据需要切换 VPC 间的其他对等连接（或云联网）路由，但**请勿启用备注信息为“防火墙”的路由**，否则将导致网络连接中断，防火墙开关故障。
