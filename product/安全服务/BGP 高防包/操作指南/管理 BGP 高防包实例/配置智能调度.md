## 应用场景
一般每个账号下可能拥有多个高防实例，且每个高防实例至少拥有一条高防线路，因此每个账号下可能会存在多条高防线路。当将业务添加至高防实例进行防护后，表示您已经为该业务配置一条高防线路作为防护线路。若您的业务配置存在多条高防线路作为防护线路，您需要考虑该业务流量的最佳调度方式，即如何将业务流量调度到最优的高防线路进行防护，保证业务访问速度和高可用性。
目前 DDoS 防护（大禹）服务提供优先级方式的 CNAME 智能调度功能，您可以根据实际需要，勾选高防实例并设置高防线路的优先级。
>?支持设置解析的高防实例有 DDoS 高防包、DDoS 高防 IP 和 DDoS 高防 IP 专业版，其中 DDoS 高防包包括独享包和共享包。

## 优先级调度方式
指针对所有的 DNS 请求均以优先级最高的高防线路进行响应，即所有访问流量被调度至当前优先级最高的高防线路。您可以编辑高防线路的优先级，默认优先级为100，优先级的值越小，则表示该高防线路优先级越高。具体调度规则如下：
- 如果业务配置的高防实例包含多条不同高防线路，且优先级相同时，则按照 DNS 请求的运营商来源进行响应。当其中某条高防线路遭遇封堵后，将按照 BGP > 电信 > 联通 > 移动 > 境外（包括中国香港、中国台湾）的线路顺序进行调度。
- 如果同一优先级的高防线路均遭遇封堵后，访问流量将自动调度到当前可用的优先级次高的高防线路。
>!若当前无次高优先级的高防线路可用，则无法进行自动调度，业务访问将会中断。
- 如果业务配置的高防实例，包含多条相同高防线路，且优先级相同时，则按负载均衡方式进行调度，将访问流量平均分发至这些相同运营商的高防线路上进行处理。

#### 示例
假设您拥有高防实例：BGP 高防 IP 1.1.1.1和1.1.1.2、电信高防 IP 2.2.2.2、联通高防 IP 3.3.3.3，其中1.1.1.1、2.2.2.2和3.3.3.3的优先级都为1，1.1.1.2的优先级为2。正常情况下，所有流量被调度至当前优先级为1的一组高防线路进行分发处理，因此来自联通的流量调度到3.3.3.3进行处理，来自电信的流量调度到 2.2.2.2进行处理，来自其他运营商的流量调度到1.1.1.1进行处理。当1.1.1.1进入封堵时，该 IP 下的访问流量将自动调度到2.2.2.2进行处理，当1.1.1.1和3.3.3.3都被封堵时，则原本调度至1.1.1.1和3.3.3.3的访问流量，都将分发至2.2.2.2进行处理，当该组高防线路全部进入封堵时，流量将被调度至1.1.1.2进行处理。
## 前提条件
- 在开启智能调度前，请将需要防护的业务接入高防实例进行防护。
>?
	- 若您需要将防护的云上产品 IP 添加至已购买的高防包实例，请参见 DDoS 高防包 [快速入门](https://cloud.tencent.com/document/product/1021/31463) 。
	- 若您需要将四层或七层业务添加至已购买的 DDoS 高防 IP 实例，请参见  DDoS 高防 IP  [接入非网站业务](https://cloud.tencent.com/document/product/1014/31105) 或 [接入网站业务](https://cloud.tencent.com/document/product/1014/31106) 。
	- 若您需要将防护业务添加至已购买的 DDoS 高防 IP 专业版实例，请参见 DDoS 高防 IP 专业版 [业务接入](https://cloud.tencent.com/document/product/1005/38240) 。

- 在修改 DNS 解析前，您需要成功购买域名解析产品，例如腾讯云的 [DNS 解析 DNSPod](https://cloud.tencent.com/document/product/302/2589)。

## 设置线路优先级
请参考以下步骤，按照设想的调度方案为您的高防线路设置优先级：
1. 登录 [DDoS 防护管理控制台](https://console.cloud.tencent.com/dayu/overview)，在左侧导航栏选择【智能调度】>【域名列表】，进入域名列表页面，单击【创建智能调度】，系统自动生成一个 CNAME 记录。
![](https://main.qcloudimg.com/raw/5f40b1c5f47a2262de89200d8e2de274.png)
2. 找到该 CNAME 记录所在行，单击【添加高防实例】，进入智能调度编辑页面。
![](https://main.qcloudimg.com/raw/8a66828d0ae9e41e0ffaa19f88d93eca.png)
3. 在智能调度编辑页面中，TTL 值默认60秒，取值范围为1 - 3600（秒），调度方式为默认优先级。
![](https://main.qcloudimg.com/raw/fba008f9a82438fc0a3526233770d754.png)
4. 进入添加高防实例页面，勾选需要设置高防线路优先级的实例，可选高防实例包括独享包、共享包、DDoS 高防 IP 和 DDoS 高防 IP 专业版，单击【确定】。
![](https://main.qcloudimg.com/raw/7741df650ea5b5366e0c0eef960c3097.png)
5. 选择高防实例后，实例的高防线路默认开启域名解析，再为其设置优先级。
![](https://main.qcloudimg.com/raw/a866b4734b0fbbfe86101f970229979a.png)

#### 示例
例如，您想要将业务流量先调度到 BGP 高防线路，当 BGP 高防线路被攻击遭到封堵后，将流量自动调度到电信高防线路。如果电信高防线路也被封堵，则将流量调度到联通高防线路。当 BGP 高防线路的封堵解除后，流量将自动恢复调度至 BGP 高防线路。
优先级设置方式：您可以将防护业务的高防实例中属于 BGP 高防线路的优先级设置成1、电信高防线路的优先级设置成2、联通高防 IP 线路的优先级不变，即可满足上述调度方案。
![](https://main.qcloudimg.com/raw/d5a2e5c8c7ffc55d58280446a4ffe44b.png)
如果您暂时不希望联通高防 IP 线路加入流量调度机制，单击<img src="https://main.qcloudimg.com/raw/5a5d700ec3e79ad7e0e6f50d4f440b02.png" style = "margin:0;">关闭域名解析即可，后面再根据需要重新开启域名解析并设置优先级。若想从当前调度机制中剔除该线路，可直接找到该线路对应实例所在行，单击【解除绑定】即可。
## 修改 DNS 解析
使用 CNAME 智能调度前，建议您将业务域名 DNS 的 CNAME 记录，修改为 DDoS 防护智能调度系统自动生成的 CNAME，使所有用户访问业务网站的流量都牵引至高防系统。
1. 登录腾讯云 [DNS 解析 DNSPod 控制台](https://console.cloud.tencent.com/cns)，在左侧导航栏中，单击【域名解析列表】，在域名解析列表页面，找到目标域名所在行，单击【解析】。
![](https://main.qcloudimg.com/raw/31e86278ecfc0dde46f345edebd531b6.png)
2. 选择【记录管理】>【添加记录】，记录类型选择 CNAME，记录值内输入智能调度系统自动生成的 CNAME 地址，单击【保存】。
![](https://main.qcloudimg.com/raw/b81a09f5f526341cc74513d41ae45ef4.png)
