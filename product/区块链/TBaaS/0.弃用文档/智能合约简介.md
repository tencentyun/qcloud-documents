## 智能合约介绍

智能合约是一种计算机程序或交易协议，记录了交易条款信息、事件、行为，旨在减少对可信中间人的需求、仲裁和执行成本。在 ChainMaker 上，用户可以通过高级语言（C++、Go、Rust）来编写智能合约，经过编译后，以 WASM 字节码的形式存储在区块链中。用户可以通过发送交易来触发执行智能合约中的代码。

虚拟机为智能合约提供计算资源和运行容器。每个虚拟机都运行在隔离的环境中，确保资源访问安全性，只能修改属于该合约自身的状态记录。智能合约需要有执行终止条件，以限制对资源的消耗；终止条件可以是按照时间、指令数量、指令执行代价（类似 ETH gas）等方式。

长安链支持多种智能合约编程语言和虚拟机，为虚拟机提供统一的数据访问和密码算法访问接口。当一批交易通过调度器被发送至虚拟机时，虚拟机将解析交易中的智能合约调用参数，并且在运行时，通过数据访问接口获取运行时必要的数据，最后执行生成交易的读写集、交易执行结果和交易执行的日志信息。

<img src="https://main.qcloudimg.com/raw/40e3a6c19c190241783213111be5aa98.png" style="zoom: 60%;" />

## 字节码

长安链目前在软件上支持的虚拟机字节码：WASM（WebAssembly）。

+ WebAssembly 有一套完整的语义，实际上 WASM 是体积小且加载快的二进制格式， 其目标就是充分发挥硬件能力以达到原生执行效率。WebAssembly 设计了一个非常规整的文本格式用来开发、调试、测试、优化。


## 智能合约SDK

用户通过高级语言编写的智能合约一般情况而言，都需要存取区块链上的数据、API 支持，ChainMaker 为不同的高级语言提供了不同的 SDK。当然，这些 SDK 提供的基本能力是相同的，包括读取数据、写入数据、查询区块链的一些状态等。

不同语言的 SDK 受限于语言本身特性和编译器的支撑能力，例如 Go 语言支持函数同时返回多个数据，而 tinygo 编译器对垃圾回收支持存在缺陷，加上区块链系统本身为智能合约提供的运行内存大小受限、调用栈深度受限，用户编写合约时，需要注意这些特性。

目前 ChainMaker 已经支持的智能合约开发 SDK 包括 Rust、Go、C++。


## 智能合约生命周期管理

### 合约部署

用户编写完成智能合约后，经过编译器编译为字节码，需要通过发送交易的形式部署到区块链上。发送的交易将被共识节点和同步节点接收和处理，在校验完成各项参数后，字节码将被存储在区块链数据库中。

在校验参数的过程中，如果下列校验出错，将把执行的错误信息记录在交易的执行结果中：

- 同一条链上不允许存在重名的合约
- 字节码不能为空
- 指定的智能合约执行引擎必须有效
- 版本信息不能为空

<img src="https://main.qcloudimg.com/raw/13e542928cc6d2c8c8f96ff139eb9fd9.png" style="zoom: 60%;" />

随后将调用执行合约的初始化方法：

- 对于 WASM 而言，将调用 **init_contract()** 方法，用户必须提供导出的 **init_contract()** 方法
  <img src="https://main.qcloudimg.com/raw/acf74f497099f991656a2809faffd2a0.png
  " style="zoom: 60%;" />


### 合约升级

ChainMaker 支持对基于 WASM 和 EVM 的字节码进行升级

- 对于 WASM 而言，将调用 **upgrade()** 方法，用户必须提供导出的 **upgrade()** 方法

合约升级也同样需要校验参数，如果下列校验出错，将把执行的错误信息记录在交易的执行结果中：

- 合约必须已经被部署成功
- 字节码不能为空
- 版本信息不能为空

### 合约注销（废止）

用户也可以注销已经被安装的合约，合约一旦被注销，将永远无法再次对合约发起任何操作。

##  智能合约事件

智能合约事件（contract event）是合约虚拟机中提供的一种智能合约向客户端发送通知消息的功能。当一笔交易触发了合约事件时，事件相数据会进行广播并记录在区块当中。

+ 事件的发送：用户可以在合约函数中指定合约事件 topic 和对应的合约事件数据，当一笔交易调用了包含合约事件的函数即可触发合约事件，ChainMaker 会向指定的 topic 发送事件数据，从而进行合约事件发送。

+ 事件的订阅：用户可以使用 ChainMaker SDK 进行合约事件的订阅，如果用户对指定 topic 进行了订阅，当合约事件触发后，用户会收到对应 topic 的合约事件数据。

+ 事件的存储：合约事件功能支持用户可配置存储，目前支持 mysql 的可配置存储。
