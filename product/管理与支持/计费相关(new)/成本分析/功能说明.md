>!成本分析目前正在灰度体验中，如需体验，可以联系您的客户经理。

## 成本分析说明
- 成本分析用来展示您的资源按月的使用成本，包括按量计费资源的月度消费和包年包月资源的按月分摊费用，由于涉及费用分摊，该数据仅供成本预估参考，不可用于对账，对账请使用费用账单或收支明细。
- 按量计费资源按实际使用时间进行月度成本统计且不分摊，包年包月资源按天进行费用分摊后进行月度成本统计。
- 成本分析的功能基于消耗明细数据，提供基于资源 ID、产品、项目、地域、消耗类型等各种维度的成本数据汇总及展示分析。


成本分析相比旧版的消耗明细1.0能提供更详细的信息，主要更新内容如下：

- 支持全产品；
- 支持预付费包年包月产品和按量计费产品；
- 支持代金券、赠送金和现金三种支付类型的成本统计；
- 对于退款、升降配等特殊场景，设计分摊算法。


## 成本分摊规则
基于费用账单进行成本分摊计算，扣费对应的成本为正，退款对应的成本为负。购买或者扣费使用的代金券、赠送金和现金金额分别记录，按类型做区分。具体成本分摊规则如下：


#### 按量计费资源
- “消耗月份”记录为用量实际发生月份即资源实际使用月份；
- 按量计费金额的费用，不做分摊处理。


#### 预付费一次性购买
- “消耗月份”记录为资源的购买月份，“开始时间”和“结束时间”分别记录为购买当天的00:00:00到23:59:59；
- 一次性购买的费用：如套餐包，不做分摊处理。

#### 预付费包年包月新购
- 从新购当天开始分摊成本，按天产生消耗明细数据，直到资源有效期到期前一天为止。“消耗月份”记录为消耗所在月份，“开始时间”和“结束时间”分别记录为分摊当天的00:00:00到23:59:59。
- 根据订单时长和购买的费用，分别计算代金券、赠送金、现金每天的分摊成本，数据四舍五入保存小数点后两位。如果费用分摊到每天后不足0.01元，则按照每天0.01元从第二天开始分摊，直到购买费用全部分摊完毕。


#### 预付费包年包月续费
- 从资源续费后新周期第一天开始分摊成本，按天产生消耗明细数据，直到资源有效期到期前一天为止。“消耗月份”记录为消耗所在月份，“开始时间”和“结束时间”分别记录为分摊当天的00:00:00到23:59:59。
- 根据订单时长和购买费用，分别计算代金券、赠送金、现金在每天的分摊成本，数据四舍五入保存小数点后两位。如果费用分摊到每天后不足0.01元，则按照每天0.01元从第二天开始分摊，直到购买费用分摊完毕。


#### 预付费包年包月升配
- 从资源升配当天开始分摊，按天产生消耗明细数据，直到资源有效期到期前一天为止。“消耗月份”记录为变更当天所在月份，“开始时间”和“结束时间”分别记录为分摊当天的00:00:00到23:59:59。
- 根据订单时长和购买费用，分别计算代金券、赠送金、现金在每天的分摊成本，数据四舍五入保存小数点后两位。如果费用分摊到每天后不足0.01元，则按照每天0.01元从第二天开始分摊，直到购买费用分摊完毕。


#### 预付费包年包月降配
- 降配折算时长：延长的时长不做分摊处理。
- 降配退费：
  - 从降配当天起，根据退费金额及资源有效期，按天产生变更分摊费用，直到该资源有效期到期前一天为止。“消耗月份”记录为变更当天所在月份，“开始时间”和“结束时间”分别记录为分摊当天的00:00:00到23:59:59。
  - 降配前的分摊消耗明细数据不变，根据订单结束时间和购买的消耗金额，分别计算代金券、赠送金、现金在每天的分摊成本，数据四舍五入保存小数点后两位。如果费用分摊到每天后不足0.01元，则按照每天0.01从第二天开始分摊，直到购买费用分摊完毕。

#### 预付费包年包月退款
退款前的消耗明细数据不变，退款当天进行补分摊和退费销毁操作，退款的费用一次性分摊到退费当天（并且为负数）。同时该资源未分摊完的费用也在退费当天一次性分摊完，称为补分摊。 **补分摊 = 订单费用 - 订单已分摊数据，退费销毁 = 订单退款费用，订单当月实际消耗数据 = 正常分摊 + 补分摊 + 退费销毁**。




## 消耗类型说明
**续费分摊**
指在该月续费的包年包月资源，在该月所分摊的成本。
例如：2019年8月20日用户对某个包年包月的资源续费了2个月（该续费订单的时长为61天），续费订单费用共122元，从8月20日至8月31日分摊的成本类型为续费分摊，8月续费分摊成本为：122元 / 61天 * 12天 = 24元。

**历史分摊**
指历史月份续费的包年包月资源，在该月所分摊的费用。
例如：在2019年7月10日用户对某个包年包月的资源续费2个月（该续费订单的额时长为62天），续费订单费用共124元，则在8月1日至8月31日分摊的成本和9月1日-9月9日分摊的成本类型为历史分摊，8月历史分摊成本为：124元 / 62天 * 31天 = 62元，9月历史分摊成本为：124元 / 62天 * 9天 = 18元。

**新购分摊**
指在该月新购的包年包月资源，在该月所分摊的费用。
例如：2019年7月20日用户新购买了1个月的资源，新购费用共31元，则从7月20日至7月31日分摊的成本类型为新购分摊，7月新分摊成本为：31元 / 31天 * 12天 = 12元。

**历史新购**
指历史月份新购了包年包月的资源，在该月分摊的费用。
例如：用户在2019年7月10日用户新购买了2个月的资源（该新购订单时长为62天），新购费用共124元，则在8月1日至8月31日分摊的成本和9月1日-9月10日分摊的成本类型为历史新购，8月历史新购成本为：124元 / 62天 * 31天 = 62元，9月历史新购成本为：124元 / 62天 * 9天 = 18元。

**按量计费**
按量计费资源，在该月使用所产生的费用。
例如：1、用户在2019年8月21日-8月31日使用按量计费日结的资源，共产生费用50元，该资源产生的成本类型为按量计费，则8月按量计费成本为50元；
2、用户在2019年7月1日-7月31日使用按量计费月结的资源，共产生费用80元，该资源产生的成本类型为按量计费，则7月按量计费成本为80元；

**补分摊**
如果用户发起了退费，但该资源的费用还未分摊完，则在用户退费后，该资源未分摊完的费用不再继续进行分摊而应在退费当天一次性分摊完，未分摊完的这部分成本类型为补分摊。
例如：用户在2019年1月1日新购买了6个月的资源（该新购订单时长为181天），新购费用共181元，用户在2019年5月10日进行了退款，退费金额为-30元，之前已经支付的181元还未分摊完，剩余未分摊的金额会一次性分摊到退费的当天（5月10日），该分摊成本类型为补分摊，5月补分摊成本为：181元 - 已分摊金额130元 = 51元，同时5月退费销毁成本为：-30元。

**退费销毁**
退费销毁为负值，指用户在该月发起退款，退还的费用在该月所分摊的费用。
例如：用户在2019年1月1日新购买了6个月的资源（该新购订单时长为181天），新购费用共181元，用户在2019年5月10日进行了退款，退费金额为-30元，则退费金额将一次性分摊到退费当天（5月10日），则5月的退费销毁成本为：-30元。

**变配分摊**
指用户升降配后产生的费用，在该月所分摊的费用。
例如：用户在2019年5月10日购买了1个月的资源，在5月20日又对该资源进行了升配（该升配订单时长为21天），升配费用共42元，则5月20日到5月31日的分摊成本和6月1日到6月9日的分摊成本类型为变配分摊，5月变配分摊成本为：42元 / 21天 * 12天 = 24元，6月的变配分摊成本为：42元 / 21天 * 9天 = 18元。
