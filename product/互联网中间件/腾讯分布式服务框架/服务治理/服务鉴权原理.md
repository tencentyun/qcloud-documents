服务鉴权是为了解决微服务之间相互访问的权限解决方案。配置中心下发鉴权规则到服务，当请求到来时，服务根据鉴权规则判断鉴权结果，如果鉴权通过，则继续处理请求，否则返回鉴权失败的HTTP 状态码 403（Forbidden）。

## 鉴权原理

下图为鉴权流程图

![](https://main.qcloudimg.com/raw/92c1a7c764bd68250d88968e17de8524.png)



服务鉴权功能支持白名单和黑名单的鉴权方式。

- **白名单**：当请求匹配 **任意一条** 鉴权规则时，允许调用；否则拒绝调用。
- **黑名单**：当请求匹配 **任意一条** 鉴权规则时，拒绝调用；否则允许调用。

## 鉴权规则

#### 鉴权规则的关系

一个服务可能有多个鉴权规则，多个鉴权规则之间是逻辑或（OR）的关系，只要请求满足任意一条鉴权规则，就相当于匹配成功。

#### 逻辑关系与值个数的关系

一条标签中，值的个数与逻辑关系的关系如下：

| 逻辑关系            | 值个数 |
| ------------------- | ------ |
| 包含（IN）          | 多个   |
| 不包含（ NOT IN）   | 多个   |
| 等于（==）          | 一个   |
| 不等于（!=）        | 一个   |
| 正则表达式（regex） | 一个   |



## 示例说明

### 示例1 

**需求**：服务 provider-demo 只允许来自 consumer-demo 服务 **且** 带有 user=foo 的自定义标签的请求调用。

要满足上面的鉴权需求，用户可以在 provider-demo 的鉴权页面，设置鉴权方式为白名单，鉴权规则如下图（注意最后要将生效状态改为生效）：

![](https://main.qcloudimg.com/raw/5e25379f873b7bdc25560c5770e39f4b.png)



示例 1 展示了要满足 `逻辑与 AND`  （既满足条件 A ，又满足条件B）时，需要使用标签表达式。



### 示例2

**需求**：服务 provider-demo 只允许来自 consumer-demo 服务 **或** 带有 user=foo 的自定义标签的请求调用。

要满足上面的鉴权需求，用户可以在provider-demo 的鉴权页面，设置鉴权方式白名单，创建2条鉴权规则，如下图：

![](https://main.qcloudimg.com/raw/0c93bd1a5299997bf2ad736d4531703c.png)



示例 2 展示了要满足 `逻辑与 OR`  （满足条件 A 或 条件B）时，需要使用多条鉴权规则。

### 示例说明

**白名单鉴权方式示例**：鉴权规则内容是 `username 等于 foo`，当请求中带有 username=foo 的 tag 时，因为匹配规则，服务允许调用；当请求中带有 username=bar 的 tag 时，因为不匹配规则，服务拒绝调用。

**黑名单鉴权方式示例**：鉴权规则内容是 `username 等于 foo`，当请求中带有 username=foo 的 tag 时，因为匹配规则，服务**拒绝**调用；当请求中带有 username=bar 的 tag 时，因为不匹配规则，服务允许调用。






