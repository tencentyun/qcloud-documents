限流主要是保护服务节点或者数据节点，防止瞬时流量过大使服务和数据崩溃，造成服务不可用。当资源成为瓶颈时，服务框架需要对请求做限流，启动流控保护机制。



## 限流原理

在服务提供者端配置限流依赖项，在 TSF 控制台配置限流规则。此时服务消费者去调用服务提供者时，所有的访问请求都会通过限流模块进行计算，若服务消费者调用量在一定时间内超过了预设阈值，则会触发限流策略，进行限流处理。 

TSF 限流方案采用了动态配额分配制，限流中控根据实例的历史流量记录，动态计算预测下一时刻该实例的流量，若所有实例的流量预测值都小于额定平均值（总配额/在线实例数），则以该平均值作为所有实例分配的配额；否则按预测流量的比例分配，且保证一个最小值。

![](https://main.qcloudimg.com/raw/655cbea0f553aac79d7db55d1fed22c5.png)

> **注意：**目前 TSF 仅支持关联了普通应用的服务的服务限流配置。





## 限流使用场景

- 全局限流：服务设置一个最大的 QPS（每秒请求数） 阈值 T，当服务实际接收到的每秒请求数超过 T 时，触发限流。
- 基于标签限流：服务设置【基于标签】的限流规则，
  - 示例1：设置自定义标签 `username=foo` 的 QPS 阈值 1000 次/秒，当服务实际接收到的请求中包含了标签`username=foo`  的 QPS 超过 1000 次/秒 时，触发限流。
  - 示例2：设置自定义标签 " username 包含 foo, bar " 的 QPS 阈值 1000 次/秒，当服务实际接收到的请求中包含了标签 `username=foo` 或 `username=bar` 的 QPS 超过 1000 次/秒 时，触发限流。



## 限流功能使用说明

要使用限流功能，用户需要在客户端配置依赖项，然后在 TSF 控制台设置限流规则。

### 1. 客户端配置依赖项

对于 Spring Cloud 应用，参考开发手册中的[《服务限流》](https://cloud.tencent.com/document/product/649/19019)。对于 Mesh 应用，无须额外配置。



###2. 控制台上设置限流规则

前提条件：服务列表上有 "在线" 状态的微服务。

#### 2.1 新建限流规则

1. 登录 TSF 控制台。

2. 单击左侧导航栏 **服务治理**。

3. 单击服务列表的服务名，进入服务详情页。

4. 选择 **服务限流** 标签页，单击【新建限流规则】按钮。

5. 填写限流规则信息。

   - **规则名**：填写规则名
   - **限流粒度**：
     - 全局限流：不区分限流来源，统计所有请求；
     - 基于标签限流：根据标签规则设置限流，

   - **单位时间**：正整数，单位秒
   - **请求数**：正整数，单位次

   - **生效状态**：是否立即启用限流规则

   - **描述**：填写描述信息

     ![](https://main.qcloudimg.com/raw/ddad7485e7b6b89bd4cedb13992074bb.png)

     ![](https://main.qcloudimg.com/raw/c10e70576908bbb974256c2c26f282b2.png)

6. 单击【提交】按钮。 

#### 2.2 启动限流规则

1. 在限流规则列表中，可以修改规则的【生效状态】
2. 多条限流规则都是生效状态时，只要服务接收到的请求满足 **任意一条** 限流规则，就会触发限流逻辑。

 ![](https://main.qcloudimg.com/raw/413683d02c902da837b7dc698400f721.png)



#### 2.3 触发限流

假设服务提供了 `/echo` API，可以通过不断执行 `curl /echo` 来模拟限流场景。

示例：

在 Demo 中 consumer-demo 服务提供了 `/echo-feign/{str}` API ，那么针对 consumer-demo 服务新建限流规则，限流粒度为全局限流，单位时间 2秒，请求数 5次。启用限流规则。

下载脚本 [tsf_ratelimit.sh](https://main.qcloudimg.com/raw/d7c79e0db1db03dc78f1721f2999a664/tsf-ratelimit.sh) ，登录可以访问到 consumer-demo 的机器（consumer-demo 所在机器也可以），执行 `./tsf_ratelimit.sh <IP>:<Port>` ，其中 IP 是 consumer-demo 所在机器 IP， Port 为服务监听端口 18083。脚本的作用是**每 2 秒触发 10 次**调用。由于调用的频率大于限流规则，正常情况下，会收到 HTTP 429 (Too Many Requests) 的状态码。



### 3. 查看限流效果

如果请求数达到了限流阈值，任何到达的请求都会限流模块处理。如果该服务上的配额已经消耗完，会对请求返回 HTTP 429 （Too Many Requests）；否则会正常放行。用户可以在限流规则列表下方的 **请求数-时间** 图中查看到被限制的请求数或者  **被限制请求率-时间** 图中查看到被限制请求率（计算公式 `被限制请求率 = 被限制的请求数 / 请求数`）随时间的变化。

![](https://main.qcloudimg.com/raw/f7eac411dcce6f333ae72cd3315465a5/%E9%99%90%E6%B5%81%E6%95%88%E6%9E%9C3.png)