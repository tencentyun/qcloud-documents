限流主要是保护服务节点或者数据节点，防止瞬时流量过大使服务和数据崩溃，造成服务不可用。当资源成为瓶颈时，服务框架需要对请求做限流，启动流控保护机制。

## 限流原理

在服务提供者端配置限流依赖项，在 TSF 控制台配置限流规则。此时服务消费者去调用服务提供者时，所有的访问请求都会通过限流模块进行计算，若服务消费者调用量在一定时间内超过了预设阈值，则会触发限流策略，进行限流处理。 

TSF 限流方案采用了动态配额分配制，限流中控根据实例的历史流量记录，动态计算预测下一时刻该实例的流量，若所有实例的流量预测值都小于额定平均值（总配额/在线实例数），则以该平均值作为所有实例分配的配额；否则按预测流量的比例分配，且保证一个最小值。

![](https://main.qcloudimg.com/raw/655cbea0f553aac79d7db55d1fed22c5.png)

> **注意：**目前 TSF 仅支持关联了普通应用的服务的服务限流配置。

## 新建限流规则

1. 登录 TSF 控制台。

2. 单击左侧导航栏 **服务治理**。

3. 单击服务列表的服务名，进入服务详情页。

4. 选择 **服务限流** 标签页，单击【新建限流规则】按钮。

   ![](https://main.qcloudimg.com/raw/07a1364155d058194a8a3601854fa9b3.png)

5. 填写限流规则信息。

   - 规则名：填写规则名
   - 限流阈值：
     - 主调服务：可以选择某一个服务或者所有服务。如果选择单个服务，则只针对单个主调服务的请求进行限流；如果选择所有服务，则针对所有请求进行限流。
     - 单位时间：单位是秒，正整数
     - 请求数：正整数
   - 生效状态：是否立即启用限流规则
   - 描述：填写描述信息

6. 单击【提交】按钮。

 ![](https://main.qcloudimg.com/raw/e33463d5177b840fe96be6c18d3846be.png)

## 启动限流规则

1. 在限流规则列表中，可以修改规则的【生效状态】
2. 多条限流规则都是生效状态时，只要服务接收到的请求满足 **任意一条** 限流规则，就会触发限流逻辑。

 ![](https://main.qcloudimg.com/raw/413683d02c902da837b7dc698400f721.png)

## 查看限流效果

如果请求数达到了限流阈值，任何到达的请求都会限流模块处理。如果该服务上的配额已经消耗完，会对请求返回 HTTP 429 Too Many Requests；否则会正常放行。用户可以在限流规则列表下方的 **请求数-时间** 图中查看到被限制的请求数或者  **被限制请求率-时间** 图中查看到被限制请求率（计算公式 `被限制请求率 = 被限制的请求数 / 请求数`）随时间的变化。
