## 功能简介

文件配置功能支持用户通过 TSF 控制台将配置下发到服务器的指定目录，应用程序通过读取该目录下的配置文件实现特殊的业务逻辑。

文件配置支持如下功能：

- 创建文件配置项：一个文件配置项管理多个版本的配置。
- 生成新版本：基于历史版本生成新版本。
- 发布配置：支持发布配置到部署组。
- 发布情况：查看配置项的发布到哪些部署组。
- 回滚：回滚到上一个版本的配置。

## 应用场景

### 场景1：定时检查配置是否更新

- 应用程序中包含了读取指定目录配置文件的逻辑，例如定时去检查配置文件是否更新（通过文件 md5 是否变化等方式检查），如果更新了会执行特定逻辑。
- 在控制台上创建文件配置，下发到部署组。

### 场景2：动态替换 PHP 文件

通过控制台发布一个 PHP 文件到指定目录，来达到动态替换服务器上 PHP 文件的目的。

## 前提条件

能否使用文件配置功能，依赖于应用部署的环境是否满足以下条件：

- **对于使用虚拟机部署的应用**：只有2018年11月20号之后导入到集群的云主机上会具有满足应用配置功能的环境。
- **对于使用容器部署的应用**：该功能需要用户修改 Dockerfile。以下示例在 [制作镜像](https://cloud.tencent.com/document/product/649/50610) 文档的基础上做修改：
	- 需要将`tsf-consul-template-docker.tar.gz`（[下载地址](https://tsf-doc-attachment-1300555551.cos.ap-guangzhou.myqcloud.com/%E5%85%AC%E6%9C%89%E4%BA%91/%E6%96%87%E4%BB%B6%E9%85%8D%E7%BD%AE/tsf-consul-template-docker.zip)） 添加到`/root/`目录下：
	```Dockerfile
	ADD tsf-consul-template-docker.tar.gz /root/
	```
	- 启动脚本中，需要执行`/root/tsf-consul-template-docker/script` 目录下的 `start.sh` 脚本：
	```shell
	CMD ["sh", "-ec", "sh /root/tsf-consul-template-docker/script/start.sh; exec java ${JAVA_OPTS} -jar ${jar} 2>&1"]    
	```



## 创建文件配置

1. 登录 [TSF 控制台](https://console.cloud.tencent.com/tsf)。
2. 在左侧导航栏单击**配置管理** > **文件配置**，进入文件配置页面。
3. 在页面顶部选择好地域和关联的应用后，单击**新建配置**。
   - 配置名称：填写配置名称，最长60个字符，只能包含字母、数字及分隔符（“-”、“_”)，且不能以分隔符开头或结尾。
   - 文件保存编码：支持 **utf-8** 和 **gbk**。
   - 配置内容：支持上传本地配置文件或者在控制台上直接编辑。
   - 配置文件名称：填写下发到服务器的配置文件的文件名称。
   - 版本号：填写文件配置初始版本的描述。
   - 版本描述：填写文件配置初始版本号。
   - 配置下发路径：配置下发到服务器的路径。
   - 后置脚本命令：配置下发到服务器后执行的命令（**不需要** 包含 #! /bin/bash）
   	![](https://main.qcloudimg.com/raw/abad2fd25b6931305bbde8082e1c20b1.png)
   - 数据集：用于细粒度管理子账号权限，可不选。数据集使用，请参阅 [数据集管理](https://cloud.tencent.com/document/product/649/38326)。
   - 标签：用于分类管理资源，可不选。详情参见 [标签](https://cloud.tencent.com/document/product/649/53869)。
4.  单击**完成**。

## 发布配置

文件配置项创建完成后，用户需要将配置项发布到应用下的部署组上才能生效。

1. 在 [文件配置](https://console.cloud.tencent.com/tsf/config-file) 列表页，单击目标配置名称，进入详情页。
2. 在配置版本标签页，单击某个配置版本操作栏的**发布**，勾选配置发布的目标部署组，填写发布描述。
3. 单击**提交**，完成发布。



## 生成新版本配置

1. 在 [文件配置](https://console.cloud.tencent.com/tsf/config-file) 列表页，单击目标配置名称，进入详情页。
2. 在配置版本标签页，单击某个配置版本操作栏的**生成新版本**，填写变更的新版本的配置内容和版本号。
> !新版本配置的版本号不能与原版本相同。
3. 单击**完成**。
>?新版本配置生成后，您需要将新版本配置发布到绑定应用下的部署组上，即可生效。



## 删除配置版本

> !删除后所有数据将被清除且不可恢复，请提前备份数据。

1. 在 [文件配置](https://console.cloud.tencent.com/tsf/config-file) 列表页，单击目标配置名称，进入详情页。
2. 在配置版本标签页，单击某个配置版本操作栏的**删除**，确认后即可删除该配置版本。



## 查看部署组的配置发布历史

用户可以通过**查看发布信息**查看该配置相关部署组的配置发布记录。

1. 在 [文件配置](https://console.cloud.tencent.com/tsf/config-file) 列表页，单击操作列的**查看发布信息**，进入发布情况页面。
2. 展开部署组，查看该部署组的配置发布记录。
3. 单击每条发布记录， 可查看配置发布前后区别。
   
   

## 回滚配置

回滚配置会将部署组的配置回滚到**上一次**发布的版本。

1. 在 [文件配置](https://console.cloud.tencent.com/tsf/config-file) 列表页，单击操作列的**查看发布信息**，进入发布情况页面。
2. 找到目标部署组，单击操作栏的**回滚**，可查看回滚前后配置变化。
3. 单击**提交**，完成回滚。
   
   











