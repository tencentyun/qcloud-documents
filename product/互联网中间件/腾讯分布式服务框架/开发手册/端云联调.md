# 端云联调

## 1.背景       

​        在进行应用开发时，您可以使用TSF提供的插件满足本地应用和部署在云端的TSF应用测试联调的需求，无需搭建VPN，帮助您快速提升开发效率。

## 2.前提条件

创建流量代理

1.您需在腾讯云购买一台与云端联调服务同地域的CVM资源，将其加入到云端联调服务的VPC中，并其绑定一个公网IP

2.如果您需要云端调用本地测试服务，需要在上述已购买的CVM机器SSH服务进行如下配置：

- 编辑sshd_config配置

```shell
Sudo vim /etc/ssh/sshd_config
```

- 添加如下配置信息允许远程主机连接本地的转发端口，并保存

```shell
GatewayPorts clientspecified
```

- 重启SSH服务

Debian/Ubuntu linux

```shell
sudo systemctl restart ssh
```

CentOS / RHEL / Fedora / Redhat Linux 

``` Shell
 sudo systemctl restart sshd
```

## 3.使用限制

1.作为跳板机的CVM必须和联调服务集群处于同一个VPC私有网络
2.暂时只支持TSF Spring Cloud应用、TSF Service Mesh应用
3.不支持分布式任务调度、分布式事物、日志、监控、分布式链路追踪的云端联调能力
4.TSF Servie Mesh应用的云端服务在调用本地服务的时候不能显示指定被调服务的端口号(或者将端口号设置为80)

## 4.操作配置

1.创建应用

​        如果本地测试服务未在云端部署则需为其创建应用并创建部署组获取联调配置，如果本地测试服务已在云端部署仅为本地开发测试实例则仅需在已有的云端应用下创建部署组获取联调配置。（注意：目前本地联调服务仅支持虚机部署的普通应用）

![](https://main.qcloudimg.com/raw/8e5d8c70b332db1a4ee7ff35579dddd2.png)

3.创建部署组获取联调配置

- 创建部署组

​      创建部署组关联云端测试服务的集群及命名空间无需，确保其能相互访问，无需关联实例及部署应用点击保存

![](https://main.qcloudimg.com/raw/d01e18ce172d6c9f25de1aca4b4e9c1c.png)

- 获取联调配置

  点击部署组ID，查看基本信息获取联调配置，具体参数如下所示：

  |       参数        |           描述            |
  | :---------------: | :-----------------------: |
  |     tsf_token     | TSF 服务注册token认证信息 |
  | tsf_namespace_id  |       TSF命名空间ID       |
  | tsf_applicaton_id |         TSF应用ID         |
  |   tsf_appid_id    |     腾讯云 账户ID信息     |
  |   tsf_group_id    |        TSF部署组ID        |

  ![](https://main.qcloudimg.com/raw/5f055cfb0000c549d89038b33a23c453.png)

4.本地环境配置

- 下载本地联调agent程序包，[点击下载](https://tsf-sdk-offline-install-1300555551.cos.ap-guangzhou.myqcloud.com/agent-2.0.jar "download")

- 打开本地IDE环境，配置JVM启动参数

![](https://main.qcloudimg.com/raw/b23ffb58e4487e21d5bbb30c848fdf67.png)

JVM启动参数配置如下：

```java
-javaagent:"agent绝对路径=ssh_host=cvm公网ip&&user=用户名&&pass=密码&&local_port=本地服务启动端口&&remote_ip=cvm内网ip"
-Dtsf_token=TSF服务注册token认证信息
-Dtsf_namespace_id=TSF命名空间ID
-Dtsf_application_id=TSF应用ID
-Dtsf_app_id=腾讯云 账户ID信息
-Dtsf_group_id=TSF部署组ID
```

example:
```
-javaagent:"/Users/root/agent.jar=ssh_host=139.136.79.195&&user=root&&pass=123456tt&&local_port=8080&&remote_ip=172.30.0.93"
-Dtsf_token=rakxSMEnGjXtAvSe9I2BlvqOootl_WAw9YzIiaJ-RD4= 
-Dtsf_namespace_id=namespace-py5lr6v4 
-Dtsf_application_id=application-nygxjma2
-Dtsf_app_id=1300555551 
-Dtsf_group_id=group-jy9zr8ag
```

配置详情描述如下：

| 参数              | 描述                       |                             必填                             |
| ----------------- | -------------------------- | :----------------------------------------------------------: |
| javaagent         | javaagent动态代理jar包路径 |                             必填                             |
| ssh_host          | ssh服务器地址              |                             必填                             |
| ssh_port          | ssh服务监听端口            |                             必填                             |
| user              | ssh服务登陆用户名          |                             必填                             |
| pass              | ssh服务登陆密码            |              选填，pass和key必须要有一个不为空               |
| key               | ssh服务登陆私钥路径        |              选填，pass和key必须要有一个不为空               |
| local_port        | 本地启动服务端口           | 选填，如果本地调试服务只是正向调用云端服务则可以不填写，如果需要被云端服务访问则需要填写 |
| remote_ip         | cvm内网ip                  | 选填，如果本地调试服务只是正向调用云端服务则可以不填写，如果需要被云端服务访问则需要填写 |
| tsf_token         | TSF 服务注册token认证信息  |                             必填                             |
| tsf_namespace_id  | TSF命名空间ID              |                             必填                             |
| tsf_applicaton_id | TSF应用ID                  |                             必填                             |
| tsf_appid_id      | 腾讯云 账户ID信息          |                             必填                             |
| tsf_group_id      | TSF部署组ID                |                             必填                             |

- 启动本地服务

## 5.联调测试验证

   本地服务启动后会在TSF服务治理对应的服务详情中显示服务实例列表信息，包含实例信息、服务端口、部署组信息。

![](https://main.qcloudimg.com/raw/98c94da1184b2c09c462239b989af15b.png)

在本地通过联调测试远程服务，显示response信息则验证成功

![](https://main.qcloudimg.com/raw/a5597f52bcca95e4c4984e3d007cf1bb.png)







​        

​      