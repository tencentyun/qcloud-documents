## 操作场景

在应用的生命周期中，可以简单抽象为这样的执行环节：运行前 → 运行中 → 停止前 → 停止。

在 **运行前** 环节，有些应用会有如下需求：

- 检查外部依赖是否准备好
- 执行环境的初始化操作
- 记录运行开始的事件
- ……

在 **停止前** 环节，部分应用会有如下需求：

- 保存当前环境状态
- 应用优雅退出
- ……

针对应用生命周期中 **运行前** 和 **停止前** 两个环节的配置需求，TEM 提供了应用启停管理能力，在运行环境启动后和应用结束前设置处理任务，支持 shell 命令的执行方式。



## 整体流程

1. 应用根据需求，判断需要在 *运行环境启动后* 和 *应用结束前* 需要执行哪些逻辑。
2. 在 TEM 部署或升级应用时配置应用生命周期管理。

## 操作步骤

### 1. 确定应用生命周期的操作逻辑

用户可根据自身业务逻辑判断是否需要配置以及具体的操作，下述以 nginx 应用为例作为说明：

- 运行环境启动后，检查目标数据库是否联通：

  - ```
    echo 'exit' | telnet <MySQL Host> 3306
    ```

- 应用结束前，确保 nginx 优雅退出：

  - ```
    nginx -s quit
    ```

### 2. 在 TEM 上配置应用启停管理

若还没有创建环境，可参考该文档创建环境：[创建环境](https://cloud.tencent.com/document/product/1371/53293)

1. 登录 [弹性微服务控制台](https://console.cloud.tencent.com/tem)。

2. 在左侧导航栏，单击**应用管理**进入应用列表页面，选择您的应用部署地域。

3. 单击**新建**，进入新建应用页面，填写应用信息。

这里以 Nginx 镜像类应用为例：

![](https://qcloudimg.tencent-cloud.cn/raw/d7709ab8a4e54d43e49faf54c7a08ca6.png)

4. 单击**提交**，进入服务部署页面。

配置应用启停管理，其中 PostStart 和 PreStop 根据上述应用需求进行选择性配置，同时可以选择在 sh 或 bash 环境下执行

![](https://qcloudimg.tencent-cloud.cn/raw/d4c8362317255a728b1c8225e8311294.png)



## 其他

配置 PostStart 和 PreStop 时，可以设置多条命令，如：

```
echo Hello
nginx -s quit
```

对于多条命令，平台会转换为如下方式执行：

```
echo Hello; nginx -s quit
```
