## 概念定义

- 旧实例：2022年6月1日之前创建的实例
- 新实例：2022年6月1日之后创建的实例

## 操作背景

  为了提升kong的性能、提供更多的功能、优化操作便利等，kong从旧实例迁移至新实例，旧实例的用户需要按照本文档进行实例的迁移，迁移的好处有下面几点：

- 新实例支持更多的自定义参数 ，旧实例不支持
- 新实例新增自定义插件上传不需要审批即可安装，旧实例不支持
- 新实例新增了部分基础监控指标，旧实例无新增
- 后续功能迭代只在新实例上，旧实例不再维护

## 前置条件

>!
>注意事项：迁移后的ip会发生变化
>
>如果您的kong实例给管理接口 admin-api  配置了除了Basic Auth 之外的复杂鉴权，则不支持迁移。建议先删除管理接口 admin-api 的复杂鉴权配置，待新实例配置迁移后，手动添加，[具体参考](https://cloud.tencent.com/document/product/1364/73677)。其他 api 接口不受影响，跳过这里。


- 已购买新架构kong网关的实例
- 已购买旧架构kong网关的实例，并配置了admin-api、service、routes、plugins、cert、tag等需要迁移
- 终端机安装了decK工具，请前往Kong官方下载[点击前往](https://docs.konghq.com/deck/latest/installation/)，并安装到您的终端

## 操作步骤

### 步骤一：利用decK工具导出旧架构的腾讯云云原生网关Kong的配置

1. **利用decK工具导出旧架构云原生网关Kong的配置**

> ! 注意将 kong公网代理ip 替换为旧实例Kong网关的公网代理ip
>
> 这里的 admin-api 是配置了安全认证的

```
deck --kong-addr https://admin:admin***123@kong公网代理ip/admin-api dump --tls-skip-verify
```


2. **检查生成的kong.yaml文件**

```
_format_version: "1.1"
certificates:

- cert: |-
  -----BEGIN CERTIFICATE-----
  MIIIOjCCByKgAwIBAgIQBLzZCHEC5BgRtBzEZrnncDANBgkqhkiG9w0BAQsFADBf
  MQswCQYDVQQGEwJVUzEVMBMGA1UEChMMRGlnaUNlcnQgSW5jMRkwFwYDVQQLExB3
  d3cuZGlnaWNlcnQuY29tMR4wHAYDVQQDExVTZWN1cmUgU2l0ZSBQcm8gQ0EgRzIw
  HhcNMTkwNzEwMDAwMDAwWhcNMjAwNzE0MTIwMDAwWjCBpDELMAkGA1UEBhMCQ04x
  EjAQBgNVBAgTCUd1YW5nZG9uZzERMA8GA1UEBxMIU2hlbnpoZW4xNjA0BgNVBAoT
  LVRlbmNlbnQgVGVjaG5vbG9neSAoU2hlbnpoZW4pIENvbXBhbnkgTGltaXRlZDEV
  MBMGA1UECwwM5LqR5Lqn5ZOB6YOoMR8wHQYDVQQDExZzZy5hcGlndy50ZW5jZW50
  Y3MuY29tMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAiKMchffY20SE
  6QrMS5xFrAhGYGMnOAZ/fMzZ3wsiSPsO3cPFY1tLjZEVG+SHyxC3a3OtpqRxPn1m
  go/ElIjM9UD8jcS3gzgaxKJf7fHAN4gz586jQgQ7wyklWlGLuBlMpogqVfujX0lX
  Cj7y5+tV1fv1n+GKnh3D3X4S3hh5FuSup60Fs+CuUtboaXBhceAcMxq7qkhAhqe0
  cvjQLTRI5dTOxt3OIrKwP9T0nHQj0EY5DBZ7Gm4r5LuOBKLAeYtptbgOggf587v9
  FE+wuHVFczJj4CmEcTqRFIYuWbLHBd9E7CYmaffY1BVOw5rr2QKTdrJe41H+XnMX
  fluu9mFyLwIDAQABo4IEqjCCBKYwHwYDVR0jBBgwFoAURUHjk1RwuOmlt5a8JrFY
  dUKXPvMwHQYDVR0OBBYEFDqeAoLD7KhmuSQslsLvXo1oNw3JMIIB5wYDVR0RBIIB
  3jCCAdqCFnNnLmFwaWd3LnRlbmNlbnRjcy5jb22CGCouc2cuYXBpZ3cudGVuY2Vu
  dGNzLmNvbYIYKi5ydS5hcGlndy50ZW5jZW50Y3MuY29tghkqLnVzdy5hcGlndy50
  ZW5jZW50Y3MuY29tghgqLmNkLmFwaWd3LnRlbmNlbnRjcy5jb22CGCouY2EuYXBp
  Z3cudGVuY2VudGNzLmNvbYIYKi5kZS5hcGlndy50ZW5jZW50Y3MuY29tghgqLmty
  LmFwaWd3LnRlbmNlbnRjcy5jb22CGCouY3EuYXBpZ3cudGVuY2VudGNzLmNvbYIY
  Ki5pbi5hcGlndy50ZW5jZW50Y3MuY29tghkqLnVzZS5hcGlndy50ZW5jZW50Y3Mu
  Y29tghgqLnRoLmFwaWd3LnRlbmNlbnRjcy5jb22CGCouanAuYXBpZ3cudGVuY2Vu
  dGNzLmNvbYIaKi5qbmVjLmFwaWd3LnRlbmNlbnRjcy5jb22CGiouaHplYy5hcGln
  dy50ZW5jZW50Y3MuY29tghkqLnRzbi5hcGlndy50ZW5jZW50Y3MuY29tghkqLnRw
  ZS5hcGlndy50ZW5jZW50Y3MuY29tghgqLm5qLmFwaWd3LnRlbmNlbnRjcy5jb20w
  DgYDVR0PAQH/BAQDAgWgMB0GA1UdJQQWMBQGCCsGAQUFBwMBBggrBgEFBQcDAjB1
  BgNVHR8EbjBsMDSgMqAwhi5odHRwOi8vY3JsMy5kaWdpY2VydC5jb20vU2VjdXJl
  U2l0ZVByb0NBRzIuY3JsMDSgMqAwhi5odHRwOi8vY3JsNC5kaWdpY2VydC5jb20v
  U2VjdXJlU2l0ZVByb0NBRzIuY3JsMEwGA1UdIARFMEMwNwYJYIZIAYb9bAEBMCow
  KAYIKwYBBQUHAgEWHGh0dHBzOi8vd3d3LmRpZ2ljZXJ0LmNvbS9DUFMwCAYGZ4EM
  AQICMG8GCCsGAQUFBwEBBGMwYTAhBggrBgEFBQcwAYYVaHR0cDovL29jc3AuZGNv
  Y3NwLmNuMDwGCCsGAQUFBzAChjBodHRwOi8vY3JsLmRpZ2ljZXJ0LWNuLmNvbS9T
  ZWN1cmVTaXRlUHJvQ0FHMi5jcnQwDAYDVR0TAQH/BAIwADCCAQQGCisGAQQB1nkC
  BAIEgfUEgfIA8AB2AKS5CZC0GFgUh7sTosxncAo8NZgE+RvfuON3zQ7IDdwQAAAB
  a9qQPGcAAAQDAEcwRQIgUKBDGudSU8O9LGZNIMDgW08o2wnO8XzxBOG+Ya1H0D0C
  IQCpK46GS/IDH2xJBY2DCcRw6TDdkuv4sxmcIfk6ySfBywB2AId1v+dZfPiMQ5lf
  vfNu/1aNR1Y2/0q1YMG06v9eoIMPAAABa9qQPLcAAAQDAEcwRQIhAOB/jWiVVVZ6
  UahoVmIBsGPpd7rM1N0RjsFYHeXxY9KIAiAkVXGqgKXmSCNHKV/r0gJxpLW0OkAl
  v8IrGFfIPMuGcjANBgkqhkiG9w0BAQsFAAOCAQEAQTfHhGsdu4jwGWAv40Tf0C5q
  jUbfNsRZAAqjGKK/XVtgfkPZzRH1ctFVhoHzxOg6cOS4DN89CEjmw5BNedi8fNMv
  DVIVYV6KvcZbMN+tNplg/VqYaN1mvZgxivw66NF8MBWlR/9UtyMSRmoLTVTPTxCX
  krbIkxcxmzhNlDcHphR8jgA810bzEJBfFWAQyyiwVQCnEDh6vhruyojb9M9xamMy
  yYIfTQdqgQOYqGNLD61Idv/o6uNH/K4GZ6wPBmT4dfvEfpolFaJ2B4BQTMXRQfSe
  OcItl6Bz+ADoS/lWZebzT0dkpsgAaQcEhnDnVTx5fCfoyE9oOdamxDAlgizv5Q==
  -----END CERTIFICATE-----
  id: 63dc031b-ef02-4ba0-aea6-dd2b5c90cd17
  key: |-
    -----BEGIN RSA PRIVATE KEY-----
    MIIEowIBAAKCAQEAiKMchffY20SE6QrMS5xFrAhGYGMnOAZ/fMzZ3wsiSPsO3cPF
    Y1tLjZEVG+SHyxC3a3OtpqRxPn1mgo/ElIjM9UD8jcS3gzgaxKJf7fHAN4gz586j
    QgQ7wyklWlGLuBlMpogqVfujX0lXCj7y5+tV1fv1n+GKnh3D3X4S3hh5FuSup60F
    s+CuUtboaXBhceAcMxq7qkhAhqe0cvjQLTRI5dTOxt3OIrKwP9T0nHQj0EY5DBZ7
    Gm4r5LuOBKLAeYtptbgOggf587v9FE+wuHVFczJj4CmEcTqRFIYuWbLHBd9E7CYm
    affY1BVOw5rr2QKTdrJe41H+XnMXfluu9mFyLwIDAQABAoIBAAZBnJA7yXw8uwDv
    Pv7Aua8Zoi68Xc5HRVGLERzH3PGFPMPzb1eG8PmbFmG0gAQZx1jOQYMI6T465PoR
    A5VVy6VBv0oSNXN2v2XhXuAY6HK5WHaChk2VUQpZhuI+mXo7/uRql9UWwjYL7yGw
    wS9旧x2176uR7ftjItrQAl7wYcPistNWxrl34sSTOHQjakuKO7xwnJRB9cYC1oI
    3woBA6fMZBJ3asCgHVh0HkR1f130xGUp5P3CjDSYU/yDXjHb/E2UruVpNQ4sHG4A
    aKOj+iqaunaoxJZyXYfXgrS93JxUGa7eKFCZ7Vwir8/ANxgHyuyPDOxNgv+GWPp0
    /xH7CFkCgYEAw+Hx/9eJ20s5YCfWCCYB1+JjT/AWDF7ve00ljXAwNh5GW6eGnBCh
    hxqvUvS2btf4YVSONCrO+oflRNoHP0kURtxmkyfcMR1Bra/lI+SX1D5X2nQLzSyQ
    5b58xW8ZWIZIEh/UxBQHcR04Rl3ydWIZUDPg2zXF7o5FYnRZCeRVzikCgYEAspJi
    ifetVa6hjUq/t5TlxUdBQAFK5muNPLrsedqSVYh3CvnY7Di8h1KXIx06bZrrdIfQ
    DAcdmKAh44adltbDhjyULDGiJnoVfoqVEMyrsSC9zjqomwGAreVhTOmyoqZb0J0t
    zMmveX8NyVVOeRBVmwD8IPYURxqSGYP7mrUJGJcCgYAGJrA8wn33vvL8TAPymY7x
    QpCvz/BBTzHiA1gsittYt7ap5ibZ+8O2xGXBCyI3dNy94bPde4KoZ2ARu28C076p
    Qv6NnHDTsgF//MgLSoBiD9seZwp/1Ohv7n1ojcaT+xOETi+WQLLDIJHF0+lrOjtl
    Q1vKRnQCu8D+CH1LTDpNkQKBgQCBczb111OTen3opFho6ArNQYNet9EpSqxfaw5E
    o5tTYBMUJN0JGXQqEUg5D1Ys4JJxroa2QW5GF0eZ3htdnqCtLjsn8m8ev3/XdPTs
    8cJBLIAMAV/6xlMXPOKVVBDIchq7F0Z9X3PSerVuz2WMw7ebH1KnPlyi0vM4hgIe
    O8C1TwKBgCRMImFaaD4vRIbgLvEwV6RMuodxKU+xD2fETdpcfIdNdqtGJIzvBcmR
    TYe52hn3AY/hUrkPRetLiVFN/JzpH/fQtteWtMj1Ey6OL0i3dfgpNfB1qolbWvO7
    5L4P8UL+INBN6Uq7kU9utrUzkoJ7grpvt0QIybIlVPwOl7z67PS7
    -----END RSA PRIVATE KEY-----
  snis:
  - name: other-ssl-example.com
  - name: ssl-example.com
    consumers:
- basicauth_credentials:
  - password: 8b2458a246afa4550cf3982d052e1d9312622e65
    username: admin
    username: admin
    plugins:
- config:
  batch_size: 100
  cls_host: ap-guangzhou.cls.tencentyun.com
  cls_topic: afd0b9fb-52d4-43e6-b4b1-a645c2e67e8f
  fallback_to_access_log: false
  log_req_body: true
  log_resp_body: true
  max_req_body_size: 10240
  max_resp_body_size: 10240
  mode: memory
  retry_count: 3
  secret_id: AKIDTCgvuSpa9Tj9LJ51B45wsqgP89uUQFOF
  secret_key: kjAKHxnodAxWv3uqumMFLYtxvd5GHYlj
  enabled: false
  name: cls-log
  protocols:
  - grpc
  - grpcs
  - http
  - https
    services:
- connect_timeout: 60000
  host: 127.0.0.1
  name: admin-api
  path: /
  plugins:
  - config:
    anonymous: null
    hide_credentials: false
    enabled: true
    name: basic-auth
    protocols:
    - grpc
    - grpcs
    - http
    - https
      port: 8001
      protocol: http
      read_timeout: 60000
      retries: 5
      routes:
  - https_redirect_status_code: 426
    id: 5ad394cc-d55f-4e1e-b76a-61c84387c4a1
    path_handling: v1
    paths:
    - /admin-api
      preserve_host: false
      protocols:
    - http
    - https
      regex_priority: 0
      request_buffering: true
      response_buffering: true
      strip_path: true
      write_timeout: 60000
- client_certificate: 63dc031b-ef02-4ba0-aea6-dd2b5c90cd17
  connect_timeout: 60000
  host: www.fangcao.net.cn
  name: myservice
  path: /fasfas
  plugins:
  - config:
    anonymous: null
    hide_credentials: false
    enabled: true
    name: basic-auth
    protocols:
    - grpc
    - grpcs
    - http
    - https
      port: 80
      protocol: https
      read_timeout: 60000
      retries: 5
      routes:
  - headers:
    myheader:
    - test
      hosts:
    - www.mytest.com
      https_redirect_status_code: 426
      methods:
    - GET
    - POST
      name: myroute
      path_handling: v1
      paths:
    - /
      preserve_host: false
      protocols:
    - http
    - https
      regex_priority: 0
      request_buffering: true
      response_buffering: true
      strip_path: true
      tags:
  - CarwynmatestTAGS
    write_timeout: 60000
    upstreams:
- algorithm: round-robin
  hash_fallback: none
  hash_fallback_header: fdsfs
  hash_on: none
  hash_on_cookie: fadsfas
  hash_on_cookie_path: /fasfas
  hash_on_header: fdsfa
  healthchecks:
    active:
      concurrency: 10
      healthy:
        http_statuses:
        - 200
        - 302
        interval: 0
        successes: 0
      http_path: /
      https_verify_certificate: true
      timeout: 1
      type: http
      unhealthy:
        http_failures: 0
        http_statuses:
        - 429
        - 404
        - 500
        - 501
        - 502
        - 503
        - 504
        - 505
        interval: 0
        tcp_failures: 0
        timeouts: 0
    passive:
      healthy:
        http_statuses:
        - 200
        - 201
        - 202
        - 203
        - 204
        - 205
        - 206
        - 207
        - 208
        - 226
        - 300
        - 301
        - 302
        - 303
        - 304
        - 305
        - 306
        - 307
        - 308
        successes: 0
      type: http
      unhealthy:
        http_failures: 0
        http_statuses:
        - 429
        - 500
        - 503
        tcp_failures: 0
        timeouts: 0
    threshold: 0
  name: shangyouName
  slots: 1000
```

### 步骤二：新建云原生网关实例

1. [新建云原生网关实例](https://cloud.tencent.com/document/product/1364/72495)。
2. 没有使用自定义插件，则跳过该步骤；如果旧实例 kong 网关有使用自定义的插件，需要在新的实例上安装好自定义的插件[查看详情](https://cloud.tencent.com/document/product/1364/72498)。

### 步骤三：利用decK工具导入配置到新架构的腾讯云云原生网关Kong

1. **运行如下命令将Kong.yaml中的配置导入新实例Kong网关中**

> ! 注意将 tencent 替换为新实例 Kong 网关的代理 ip

```
deck --kong-addr  https://tencent/admin-api sync --tls-skip-verify
creating upstream shangyouName
creating certificate 63dc031b-ef02-4ba0-aea6-dd2b5c90cd17
updating consumer admin  {
   "id": "190e1682-ea1a-43e5-8eaa-e08b2677fe2b",
   "username": "admin"
 }

creating sni other-ssl-example.com
creating sni ssl-example.com
creating service myservice
updating service admin-api  {
   "host": "127.0.0.1",
   "id": "6fe5bcbe-eee6-4d13-94c6-05356a61bb7f",
   "name": "admin-api",
   "path": "/",
   "port": 8001,
   "protocol": "http"

+  "connect_timeout": 60000
+  "read_timeout": 60000
+  "retries": 5
+  "write_timeout": 60000
   }

Warning: import/export of basic-authcredentials using decK doesn't work due to hashing of passwords in Kong.
creating route 5ad394cc-d55f-4e1e-b76a-61c84387c4a1
creating route myroute
creating plugin basic-auth for service admin-api
creating plugin basic-auth for service myservice
deleting route 15de658f-65aa-4c60-9e2d-33489d28dc92
Summary:
  Created: 9
  Updated: 2
  Deleted: 1
```

2. 打开新架构的腾讯云云原生 Kong 网关控制台，查看配置是否导入成功。

![](https://qcloudimg.tencent-cloud.cn/raw/cd6bc4ad85755fbd0630f1edf98500cc.png)

![](https://qcloudimg.tencent-cloud.cn/raw/8110cd3def1866409535149942f2b5b1.png)

3. 如果admin-api接口迁移前有删除的认证插件，参考[认证插件配置](https://cloud.tencent.com/document/product/1364/73677)，在新实例配置。

### 步骤四：客户端验证

1. 如果使用的是域名访问，验证前，切换域名的DNS记录到新实例kong的公网或者内网代理ip；如果使用的是ip,只需要切换ip到kong实例的公网或内网ip
2. 验证配置的api，在kong新实例上是否可以正常访问

> ! 注意：旧实例的网关迁移结束后不要立即销毁，可以保持一段时间，等待流量正常验证后删除
