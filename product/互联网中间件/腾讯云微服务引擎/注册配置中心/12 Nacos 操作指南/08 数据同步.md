## 适用场景

Nacos 数据同步是通过数据库层面的数据导入，实现将自建的 Nacos 集群数据库中存储的配置数据、用户信息、命名空间数据、访问控制等信息全量迁移至 TSE Nacos 集群并进行实时增量同步。

Nacos 数据同步功能适用于以下场景：
- 自建 Nacos 迁移至 TSE Nacos，请参见 [Nacos 迁移指南](https://cloud.tencent.com/document/product/1364/80035)。
- Nacos 多活容灾与就近访问，请参见 [Nacos 多活容灾指南](https://cloud.tencent.com/document/product/1364/85951)。

## 架构图
![](https://qcloudimg.tencent-cloud.cn/raw/ea5addf8cbd1165f8624a82bb7356f09.png)

[](id:step1)
## 步骤1：TSE 创建 Nacos 实例

通过 [TSE 控制台](https://console.cloud.tencent.com/tse/nacos?rid=33) 创建 Nacos 实例，创建的环境信息需跟自建的 Nacos 一致。在数据同步的过程中，将会覆盖 TSE Nacos 实例原本的数据，所以建议 TSE Nacos 实例为空库，或在迁移前确保 TSE Nacos 的数据可以被覆盖。


[](id:step2)
## 步骤2：源 Nacos 数据库开启公网访问并检查配置
TSE Nacos 数据同步任务支持通过公网的方式，接入源数据库类型为自建数据库、腾讯云数据库、第三方云厂商数据库等，并实施数据同步。
在开始数据同步任务前，您需要先为您的源数据开启公网访问，并将数据同步任务的 IP 地址添加到源数据库的白名单中，以便数据同步任务可以与需要访问的数据库连通。
同时，请根据以下提供的校验项检查您的源 Nacos 数据库配置，校验失败将会导致数据同步失败。


### 操作指引
#### 1. 根据源数据库所在地域，在下方获取对应地域 数据同步任务 的 IP 地址，将其加入到源数据库的白名单中。
- 自建数据库，请在防火墙设置中允许 数据同步任务 IP 地址访问。
- Windows 系统：打开控制面板找到 Windows 防火墙，查看防火墙策略。
- Linux 系统：请执行 `iptables -L` 命令，查看服务器防火墙策略。
- 腾讯云数据库或者 CVM 上的自建数据库，请参考如下指导将 数据同步任务的 IP 地址添加到安全组中。
	- 登录源数据库，在实例列表，单击实例 ID，进入实例管理页面。
	- 在实例管理页面，选择安全组页或者数据安全页， 添加 DTS 服务的 IP 地址到安全组中。 
![](https://qcloudimg.tencent-cloud.cn/image/document/b2d8cb88bef99de2285c35dd44a11499.png)
- 第三方云厂商数据库，请添加 数据同步任务 IP 地址到相关的安全组配置中。
- **数据同步任务的 IP 地址：**
<table>
<thead>
<tr>
<th>地域</th>
<th>数据同步任务 IP 地址</th>
</tr>
</thead>
<tbody><tr>
<td>广州</td>
<td>111.230.198.143,118.89.34.161,123.207.84.254,139.199.74.159</td>
</tr>
<tr>
<td>上海</td>
<td>111.231.139.59,111.231.142.94,115.159.71.186,182.254.153.245</td>
</tr>
<tr>
<td>北京</td>
<td>123.207.145.84,211.159.157.165,211.159.160.104,58.87.92.66</td>
</tr>
<tr>
<td>成都</td>
<td>111.231.225.99,118.24.42.158</td>
</tr>
<tr>
<td>重庆</td>
<td>139.186.122.1/24,129.28.12.1/24,129.28.14.1/24,139.186.77.242,139.186.109.1/24, 139.186.131.1/23,94.191.102.144,94.191.98.210</td>
</tr>
<tr>
<td>杭州ec</td>
<td>111.231.139.59,111.231.142.94,115.159.71.186,182.254.153.245</td>
</tr>
<tr>
<td>南京</td>
<td>129.211.166.117,129.211.167.130</td>
</tr>
<tr>
<td>天津</td>
<td>154.8.246.150,154.8.246.48</td>
</tr>
<tr>
<td>深圳</td>
<td>118.126.124.6,118.126.124.83</td>
</tr>
<tr>
<td>中国香港</td>
<td>119.29.180.130,119.29.208.220,124.156.168.151,150.109.72.54</td>
</tr>
<tr>
<td>北京金融</td>
<td>62.234.240.36,62.234.241.241</td>
</tr>
<tr>
<td>深圳金融</td>
<td>118.89.251.206,139.199.90.75</td>
</tr>
<tr>
<td>上海金融</td>
<td>115.159.237.246,211.159.242.74</td>
</tr>
<tr>
<td>新加坡</td>
<td>119.28.103.40,119.28.104.184,119.28.116.123,150.109.11.113</td>
</tr>
<tr>
<td>雅加达</td>
<td>43.129.33.41,43.129.35.144</td>
</tr>
<tr>
<td>曼谷</td>
<td>150.109.164.203,150.109.164.82</td>
</tr>
<tr>
<td>孟买</td>
<td>119.28.246.130,119.28.246.18</td>
</tr>
<tr>
<td>首尔</td>
<td>119.28.150.71,119.28.157.173</td>
</tr>
<tr>
<td>东京</td>
<td>150.109.195.201,150.109.196.137</td>
</tr>
<tr>
<td>硅谷</td>
<td>49.51.38.216,49.51.39.189</td>
</tr>
<tr>
<td>弗吉尼亚</td>
<td>170.106.2.63,49.51.85.120</td>
</tr>
<tr>
<td>多伦多</td>
<td>45.113.70.156,45.113.70.6,49.51.10.104,49.51.9.221</td>
</tr>
<tr>
<td>法兰克福</td>
<td>49.51.132.38,49.51.133.85</td>
</tr>
<tr>
<td>莫斯科</td>
<td>162.62.16.46,162.62.21.243</td>
</tr>
</tbody></table>

#### 2. 根据以下的配置校验项，检查您的源 Nacos 数据库配置正确：
<table>
<thead>
<tr>
<th>校验项</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>innodb_stats_on_metadata</td>
<td>源数据库环境变量参数 innodb_stats_on_metadata 需要设置为 OFF。  innodb_stats_on_metadata 参数开启时，每当查询 information_schema 元数据库里的表，Innodb 就会更新 information_schema.statistics 表，导致访问时间变长。关闭后可加快对于 schema 库表的访问。 <br>MySQL 5.6.6 之前版本 innodb_stats_on_metadata 参数预设值为 ON，需要修改为 OFF。MySQL 5.6.6 及其以后的版本预设值为 OFF，不存在问题。</td>
</tr>
<tr>
<td>数据库版本</td>
<td>源数据库版本 ≤ 8.0</td>
</tr>
<tr>
<td>数据库权限</td>
<td>源数据库账号需要至少具备以下权限： RELOAD,LOCK TABLES,REPLICATION CLIENT,REPLICATION SLAVE,SHOW DATABASES,SHOW VIEW,PROCESS</td>
</tr>
<tr>
<td>实例参数检查</td>
<td>1. 源库变量 connect_timeout 必须大于10。 <br>2. 源库表的 row_format 不能为 FIXED。 <br>3. 源库表lower_case_table_names 变量必须为0。</td>
</tr>
<tr>
<td>BINLOG相关参数检查</td>
<td>1. log_bin 变量必须设置为 ON。 <br>2. binlog_format 变量必须设置为 ROW。 <br>3. binlog_row_image 必须设置为 FULL。 <br>4. server_id 参数需要手动设置，且值不能设置为0。 <br>5. 不允许设置 do_db，ignore_db。</td>
</tr>
<tr>
<td>外键依赖检查</td>
<td>外键依赖只能设置为 NO ACTION、RESTRICT。 部分库表迁移时，有外键依赖的表必须齐全。</td>
</tr>
</tbody></table>


## 步骤3：TSE Nacos 中创建迁移任务
在完成源 Nacos 集群数据库的公网访问配置后，请在 TSE Nacos 实例详情页面 - 迁移任务页面下配置并开启迁移任务。
![](https://qcloudimg.tencent-cloud.cn/raw/ffb6027434d7ba030ba7f4885f55ecfe.png)
- 接入类型：当前仅支持公网接入。
- 数据库类型：当前仅支持 MySQL 数据库。
- 数据库名：请输入源 Nacos 数据库名。
- 主机地址：请填入源 Nacos 数据库实例公网地址。
- 端口：请填入源 Nacos 数据库实例公网端口。
- 账号：请填入源 Nacos 数据库账号。
- 密码：请填入源 Nacos 数据库密码。

单击**提交**后，迁移任务将开始执行。

## 步骤4：数据同步
在完成迁移任务的配置后，将开启源 Nacos 数据库的全量+增量数据迁移，在任务执行过程当中支持向源 Nacos 数据库写入新的数据，目标TSE Nacos 数据库将会实时同步新的数据。**请注意，如果您需要在迁移过程中保证新增服务的可用性，需要配合 [Nacos 双注册双发现热迁移](https://cloud.tencent.com/document/product/1364/80035)一起使用**。

### 注意事项
- 在执行数据迁移时，会占用一定源数据库实例资源，可能会导致源数据库实例负载上升，增加数据库自身压力。如果您的数据库配置过低，建议您在业务低峰期进行迁移。
- 默认采用无锁迁移来实现，迁移过程中对源数据库不加全局锁（FTWRL），仅对无主键的表加表锁，其他不加锁。
- 迁移任务执行时，会使用执行迁移任务的账号在源数据库中写入系统库`__tencentdb__`，用于记录迁移任务过程中的数据对比信息。
    - 为保证后续数据对比问题可定位，迁移任务结束后不会删除源数据库中的`__tencentdb__`。
    - `__tencentdb__`系统库占用空间非常小，约为源数据库存储空间的千分之一到万分之一（例如源数据库为50GB，则`__tencentdb__`系统库约为5MB-50MB） ，并且采用单线程，等待连接机制，所以对源数据库的性能几乎无影响，也不会抢占资源。

### 操作指引
![](https://qcloudimg.tencent-cloud.cn/raw/6f7b7e640f0958fe2a29c1104bc0d669.png)
- 您可以在 TSE Nacos 实例详情页 - 迁移任务页面下查看迁移任务当前运行的进度与状态：
- 当迁移任务执行至同步增量阶段后，任务将持续同步源 Nacos 数据库中的增量数据。
- 如果在迁移任务执行过程中出现错误，且检查您的源 Nacos 数据库配置无误，可通过 [快速提工单](https://console.cloud.tencent.com/workorder/category?level1_id=517&level2_id=727&source=14&data_title=%E5%85%B6%E4%BB%96%E8%85%BE%E8%AE%AF%E4%BA%91%E4%BA%A7%E5%93%81&step=1)，联系腾讯云助手协助。

