## 操作场景

>! 此文档仅针对专业版北极星网格引擎。

服务限流主要是保护服务节点或者数据节点，防止瞬时流量过大造成服务和数据崩溃，导致服务不可用。当资源成为瓶颈时，服务框架需要对请求做限流，启动流控保护机制。

该任务指导您通过 TSE 控制台，如何在 Spring Cloud Tencent 中使用专业版北极星网格引擎的分布式限流功能。

## 前提条件

- 已 [创建专业版北极星网格引擎](https://cloud.tencent.com/document/product/1364/61430)。
- 下载 Github 的 [demo 源码](https://github.com/Tencent/spring-cloud-tencent/blob/hoxton/spring-cloud-tencent-examples/polaris-ratelimit-example/README-zh.md) 到本地并解压。

## 操作步骤

### 创建 polaris.limiter 服务

1. 在实例的基本信息页面中，记住访问地址中的每个VPC内网IP地址以及访问端口。
![](https://qcloudimg.tencent-cloud.cn/raw/0106756c5e872a548358878a31dc1b0b.png)
2. 针对每一个内网VPC的IP地址，在命名空间 **Polaris** 下创建服务 **polaris.limiter-{vpc 名称}**。
![](https://qcloudimg.tencent-cloud.cn/raw/2c1ce87a97bbb51173767e9f06247043.png)
3. 点击服务 **polaris.limiter-{vpc 名称}**，进入到服务的实例页面，根据对应上述第一步所记录的VPC内网IP地址以及端口协议**grpc**、**http**分别创建实例。
![](https://qcloudimg.tencent-cloud.cn/raw/8f6c8b0d7a43cc0dff5a79680bdb6656.png)
4. 按照上述步骤的操作，最终服务**polaris.limiter-{vpc 名称}**的实例列表如下：
![](https://qcloudimg.tencent-cloud.cn/raw/78e61b5dcb2e6a310741389037b653ea.png)

### 

1. 登录 [TSE 控制台](https://console.cloud.tencent.com/tse)。
2. 在**北极星网格**下的 **polarismesh** 页面，单击页面左上方下拉列表，选择目标地域。
3. 单击目标引擎的“ID”，进入基本信息页面。
4. 查看访问地址，Spring Cloud 应用访问使用 gRPC 端口（8091）：
![](https://qcloudimg.tencent-cloud.cn/raw/e7dc5ac5f7c76a316ae68b667d8a365f.png)
5. 修改 demo 中的注册中心地址。
  1. 在下载到本地的 [demo 源码目录](https://github.com/Tencent/spring-cloud-tencent/blob/hoxton/spring-cloud-tencent-examples/polaris-ratelimit-example) 下，找到
    `spring-cloud-tencent-examples/polaris-ratelimit-example/ratelimit-callee-service/src/main/resources/bootstrap.yml` 这个文件。
  - 添加微服务引擎北极星网格地址到项目配置文件中（以`\polaris-quickstart-example\quickstart-provider\src\main\resources\bootstrap.yml`为例）。
<dx-codeblock>
:::  yaml
server:
  port: 0
spring:
  application:
    name: EchoServer
  cloud:
    polaris:
      address: grpc://10.0.4.6:8091
:::
</dx-codeblock>
  2. 在下载到本地的 [demo 源码目录](https://github.com/Tencent/spring-cloud-tencent/blob/hoxton/spring-cloud-tencent-examples/polaris-ratelimit-example) 下，找到
    `spring-cloud-tencent-examples/polaris-ratelimit-example/ratelimit-callee-service/src/main/resources/` 这个文件夹。
  - 在该文件夹下新增 `polaris.yml` 文件。
<dx-codeblock>
:::  yaml
provider:
  # 分布式限流配置
  rateLimit:
    limiterNamespace: Polaris
    limiterService: polaris.limiter-{vpc 名称}
:::
</dx-codeblock>
6. 部署 Spring Cloud Tencent 微服务应用。详情请参见 [Spring Cloud Demo 部署](https://cloud.tencent.com/document/product/1364/66655)。
7. 确认部署结果。
 - 进入前面提到的微服务引擎北极星网格实例页面。
 - 选择**注册中心** > **服务列表**，查看微服务 RateLimitCalleeService 的实例数量：
 - 若实例数量值不为0，则表示已经成功接入微服务引擎。=
 - 针对 RateLimitCalleeService 配置分布式限流策略。
 ![](https://qcloudimg.tencent-cloud.cn/raw/9dd79fa734a32e0bd1ca5b9776a7ba33.png)
 - 调用 RateLimitCalleeService 服务的 HTTP 接口，执行 http 调用。
  ```shell
  curl -L -X GET 'http://127.0.0.1:48081/business/invoke'

  # 预期10次调用后，就开始被限流：
  hello world for ratelimit service 1
  hello world for ratelimit service 2
  ...
  hello world for ratelimit service 10
  request has been limited, service is RateLimitCalleeService, path is /business/invoke, 11
  ```

