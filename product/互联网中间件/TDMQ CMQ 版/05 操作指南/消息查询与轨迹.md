当一条消息从生产者发送到 TDMQ CMQ 版服务端，再由消费者进行消费，TDMQ CMQ 版会完整记录这条消息中间的流转过程，并以消息轨迹的形式呈现在控制台。
消息轨迹记录了消息从生产端到 TDMQ CMQ 版服务端，最后到消费端的整个过程，包括各阶段的时间（精确到微秒）、执行结果、生产者 IP、消费者 IP 等。
![](https://qcloudimg.tencent-cloud.cn/raw/b672877413753d67b1b82519bcc18350.jpg)

## 操作场景

当您需要排查以下问题时，就可以使用 TDMQ CMQ 版控制台的消息查询功能，按照时间维度或者根据日志中查到的消息 ID，来查看具体某条消息的消息内容、消息参数和消息轨迹。

- 查看某条消息的具体内容，具体参数。
- 查看消息由哪个生产 IP 发送，是否发送成功，消息到服务端的具体时间。
- 查看消费由哪些消费者消费了，是否消费成功，消息确认消费的具体时间。
- 需要做分布式系统的性能分析，查看 MQ 对相关消息处理的时延。

## 查询限制

- 消息查询最多可以查询近3天的消息。
- 一次性最多可以查询65536条消息。

## 前提条件

已经参考 [SDK 文档](https://cloud.tencent.com/document/product/1496/61039) 部署好生产端和消费端服务，并在3天内有消息生产和消费。

## 操作步骤

1. 登录 [TDMQ CMQ 版控制台](https://console.cloud.tencent.com/tdmq/cmq-queue)，在左侧导航栏单击**消息查询**。
2. 在消息查询页面，首先选择地域，再选择需要查询的时间范围和资源，如果您知道对应的消息 ID，也可以输入消息 ID 进行精准查询。
3. 单击**查询**，下方列表会展示所有查询到的结果并分页展示。
![](https://qcloudimg.tencent-cloud.cn/raw/ad5208f7b1546059589f6260fabdb683.png)
<table>
    <thead>
    <tr>
        <th>参数</th>
        <th>说明</th>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td>消息 ID</td>
        <td>每条消息都会收到一个由腾讯云系统分配的消息 ID，该 ID 可由 SendMessage 接口请求中返回给用户。此标识符用于识别消息。</td>
    </tr>
    <tr>
        <td>发送方式</td>
        <td>消息发送方式，支持<strong>单条发送</strong>或<strong>批量发送</strong>两种。当发送方式为批量发送时，将鼠标放置在<code>批量发送</code>字段上，您可以看到同一批次发送的消息
            ID。
        </td>
    </tr>
    <tr>
        <td>消息创建时间</td>
        <td>消息创建的时间。</td>
    </tr>
    </tbody>
</table>
4. 找到您希望查看内容或参数的消息，单击操作列的**查看详情**，即可查看消息的基本信息、内容（消息体）以及参数。
![](https://qcloudimg.tencent-cloud.cn/raw/0fb0db5c5a3358918e673c25f7007425.png)
5. 单击操作列的**查看消息轨迹**，或者在详情页单击 Tab 栏的**消息轨迹**，即可查看该消息的消息轨迹（详细说明请参见 [消息轨迹查询结果说明](#1)）。
![](https://qcloudimg.tencent-cloud.cn/raw/166659d434a39a18ed237b07d0a76f3b.png)

<span id="1"></span>
## 消息轨迹查询结果说明

消息轨迹查询出来的结果分为两段：消息生产和消息消费。

#### 消息生产
<table>
    <thead>
    <tr>
        <th>参数</th>
        <th>说明</th>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td>
            <nobr>生产地址</nobr>
        </td>
        <td>对应生产者的地址以及端口。</td>
    </tr>
    <tr>
        <td>生产时间</td>
        <td>TDMQ CMQ 版服务端确认接收到消息的时间，精确到毫秒。</td>
    </tr>
    <tr>
        <td>生产状态</td>
        <td>表示消息生产成功或失败，如果状态为失败一般是消息在发送过程中遇到了头部数据部分丢失，以上几个字段可能会为空值。</td>
    </tr>
    </tbody>
</table>

#### 消息消费

消息消费是以列表形式呈现的。列表中展示的信息说明：
<table>
    <thead>
    <tr>
        <th>参数</th>
        <th>说明</th>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td>
            <nobr>消息句柄</nobr>
        </td>
        <td>每当收到来自队列的消息时，用户都会收到该消息的接收句柄。消息句柄始终与接收消息的操作相关联，与消息本身无关。要删除消息或更改消息属性，用户则必须提供接收句柄，而不是消息 ID。</td>
    </tr>
    <tr>
        <td>消费地址</td>
        <td>收到消息的消费者地址及端口。</td>
    </tr>
    <tr>
        <td>消费时间</td>
        <td>消费者回复确认信息（ACK）到 TDMQ CMQ 版服务端，服务端接收到确认信息的时间。</td>
    </tr>
    <tr>
        <td>删除时间</td>
        <td>消息在 <strong>Inactive </strong>状态中被删除的时间。</td>
    </tr>
    <tr>
        <td>消费状态</td>
        <td>消费者消费成功或者失败，消费者如果返回了取消确认的信息（NACK），这个字段会显示失败。</td>
    </tr>
    </tbody>
</table>
