
与微信支付紧密合作的第三方移动金融支付解决方案提供商，如深圳威富通等，促进了全国各行各业的线下商铺，通过微信支付，提高效率，免除现金结算的低效率。支付系统主要架构如下：

1. 老百姓在便利店购物（如7-11）提交的支付请求，发送给微信支付，微信支付确认后会返回 ACK。

2. 返回的 ACK 确认后，微信支付系统会下发一条『订单支付成功的消息』，详细说明了消费的账户信息、时间、金额，终端信息等。该消息会发给威富通。

3. 威富通将该明细，写入 TDMQ CMQ 版，用作暂存。『订单支付成功的消息』作为威富通与商家（便利店）之间结算的重要凭证，必须可靠传递，保证不丢。

4. 异步的，将 TDMQ CMQ 版内的『订单支付消息』，返回给多商家的服务器（便利店），这个返回的过程不需要及时，可以异步处理。具体怎么做呢？是将该消息写到 Queue 里，然后一个 HTTP 代理，来拉消息。取出后，HTTP 发给商家。

5. 在未接入 TDMQ CMQ 版之前，假如威富通通知商户失败，威富通会重新向微信支付发起请求，微信随后会再次将同样的『订单支付消息』投递给威富通。接入 TDMQ CMQ 版之后，从微信的角度来看，威富通系统的成功率提升不少，微信对其评级会提升（可靠性、信誉）。

6. 最后，每笔『订单支付消息』，由另一个 Topic 不断向风控管理、活动管理、促销活动等系统投递。例如风控管理会持续分析 Topic投递的每一笔订单支付情况，当商家 A 在短时间内交易额大幅上涨时（刷单嫌疑），会用回调接口，禁止商家 A 的后续交易。

参考图示如下：
![](//mc.qcloudimg.com/static/img/7f42706e0f87a942e0c0122167797fa5/image.png)
