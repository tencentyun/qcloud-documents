## 操作场景

为了满足开发者根据设备上报的数据及状态，通过在云端定义规则，即可实现将告警、通知消息实时推送至腾讯连连公众号或 App 推送，降低开发者处理设备上报数据的成本。


## 前提条件
已 [创建项目及产品](https://cloud.tencent.com/document/product/1081/34739)，并定义该产品的 [物模型](https://cloud.tencent.com/document/product/1081/56625)。

## 新建告警任务

1. 登录 [物联网开发平台控制台](https://console.cloud.tencent.com/iotexplorer) ，选择**公共实例**或者您购买的**标准企业实例**进入项目列表页。
2. 单击**项目 ID**进入项目详情页面，单击左侧菜单**数据开发**。
3. 进入数据开发列表页面，单击**新建数据流**。
   ![](https://main.qcloudimg.com/raw/70a877bf9956f7a84a8f104bae31aff5.png)
 - **数据流名称**：输入数据流处理的名称标识。
  - **描述**：输入该数据流处理的备注信息。  
4. 单击**保存**，保存成功后则显示数据流列表页。


## 告警任务配置

### 设备属性编排

1. 单击数据流列表页中的**数据流名称**，进入编排页面。
2. 鼠标长按左键拖动左侧输入区域中的**设备数据**节点，放置到画布区域。设备数据节点对应的是物模型中设备上报的属性
3. 单击已拖放的**设备数据**节点，界面右侧显示该节点的配置内容。
![](https://main.qcloudimg.com/raw/94a9ecb53e4442627e46dce0a7eb3fc8.png)
 - 节点名称：该**设备数据**的节点名称，默认为“设备数据”可修改。
 - 选择产品：下拉选择该项目下的某个产品后，平台则对该产品下所有设备上报的数据进行实时处理。
 - 属性：用户可根据需要选择该产品下哪些属性作为输入
4. 选择完产品、属性后，必须要单击**确定**，系统才会保存该节点的配置数据。
5. 当**设备数据**节点保存成功后，画布中的**设备数据**节点右侧图标将会变成绿色。


### 数据过滤编排

1. 鼠标长按左键拖动左侧处理区域中的**数据过滤**节点，放置到画布区域。
2. 单击已拖放的**数据过滤**节点，界面右侧显示该节点的配置内容。
3. 在配置“数据过滤”前，必须要指定数据源，即需要将“设备数据”与“数据过滤”两个节点进行连接。
![](https://main.qcloudimg.com/raw/b030bb5e6730c49d2803e972012b647f.png)
4. 数据过滤条件目前支持全部与、全部或逻辑组合，可根据上一个节点的输出任意组合过滤条件，本文选择条件组合方式为“全部与”。
5. 添加“过滤条件”，选择“亮度”属性，选择条件为“大于”，输入值80；表示只有当设备上报的亮度值为大于80的数据才会输出到下一个处理节点。


### 腾讯连连 App 推送

若开发者的告警场景是将告警信息推送到腾讯连连 App，则可以将“App 推送”节点拖放到画布。

1. 鼠标长按左键拖动左侧输出区域中的**App 推送**节点，放置到画布区域。
2. 单击已拖放的**App 推送**节点，界面右侧显示该节点的配置内容。
3. 在配置“App 推送”前，必须要指定数据源，即需要将“App 推送”与“数据过滤”两个节点进行连接。
   ![](https://main.qcloudimg.com/raw/17191f5ec351e95e74987d67196c611f.png)
4. 输入推送标题。
5. 推送内容可以由开发者定义，并且可以通过输入$ 获取上一个节点输出的数据。
6. 单击**确定**保存该节点的配置。


### 腾讯连连公众号推送

若开发者的告警场景是将告警信息推送到腾讯连连公众号，则可以将“公众号推送”节点拖到画布。

1. 鼠标长按左键拖动左侧输出区域中的**公众号推送**节点，放置到画布区域。
2. 单击已拖放的**公众号推送**节点，界面右侧显示该节点的配置内容。
3. 在配置“公众号推送”前，必须要指定数据源，即需要将“公众号推送”与“数据过滤”两个节点进行连接。
   ![](https://main.qcloudimg.com/raw/018c0edfdb7c406e32bb0ec7004ab140.png)
4. 选择通知类型：设备告警或通知消息，通知类型的区别在于公众号消息模板标题不同。
5. 输入推送标题。
6. 推送内容可以由开发者定义，并且可以通过输入$ 获取上一个节点输出的数据。包括设备上报的属性数据以及系统级的数据，例如产品 ID、设备 ID、设备别名等。
7. 单击**确定**保存该节点的配置。

### 自定义推送

若开发者需要将过滤、聚合后的数据转发到开发者自己的服务器上，可以使用自定义推送。

1. 鼠标长按左键拖动左侧输出区域中的**自定义推送**节点，放置到画布区域。
2. 单击已拖放的**自定义推送**节点，界面右侧显示该节点的配置内容。
3. 在配置“自定义推送”前，必须要指定数据源，即需要将“自定义推送”与“数据过滤”两个节点连接起来。
   ![image](https://main.qcloudimg.com/raw/656aea281b527fd177ec654714c5a74b.png)
4. 输入推送标题以及推送内容。
5. 输入接受告警推送消息的服务器地址和鉴权 Token 并单击**确定**

<dx-alert infotype="explain" title="">
为了您后台稳定使用，请填写鉴权 Token。您可以任意填写 Token，用作生成签名（该 Token 会和接口 URL 中包含的 Token 进行比对，从而验证安全性）。
</dx-alert>

### 推送消息内容格式

1. 平台侧推送到服务端的告警内容消息模板如下。
<dx-codeblock>
:::  Java
{
	"RequestId": "推送请求Id",
	"ProductId": "产品ID",
	"DeviceName": "设备名称",
	"MsgTitle": "推送标题",
	"MsgContent": "推送内容"
}
:::
</dx-codeblock>
2. 若需要推送到自主品牌公众号，请参见微信公众号官方文档-[通过模板消息推送](https://developers.weixin.qq.com/doc/offiaccount/Message_Management/Template_Message_Interface.html#2)。
3. 若需要推送到自主品牌小程序或 App 的告警消息，开发者可自行根据业务逻辑实现。



### 保存与启用数据流

1. 用户设置完输入、处理与输出节点的规则后，单击页面上方**保存** > **启用**。
2. 当启用数据流后，只要该设备上报的数据符合定义的规则，则会触发公众号推送。
![](https://main.qcloudimg.com/raw/3e283e54080b18d9fc734d7527d13b29.png)

### 体验公众号推送[](id:test)

告警规则如上述步骤配置完成并启用后，可遵循以下两步体验虚拟设备告警推送公众号消息。

#### “腾讯连连”小程序绑定虚拟设备

1. 进入上述告警规则所对应的产品，单击**设备调试** > **虚拟设备调试**。
   ![image](https://main.qcloudimg.com/raw/fdf6720f0462c1b26b9d4d0c8bbbe8f6.png)
2. 打开微信 App，直接使用微信“扫一扫”扫码虚拟设备二维码。
![](https://main.qcloudimg.com/raw/cfdd23cb0cf4e2e5bbd0c5134158e857.png)
3. 绑定成功后会在设备列表显示如下。
![image](https://main.qcloudimg.com/raw/cdd6b195864986a679025b6c5992436a.png)
4. 首次绑定需要关注“腾讯连连”公众号，点击下图红色线框关注腾讯连连公众号后，才可以接收云端推送的公众号消息。
![image](https://main.qcloudimg.com/raw/44dfccfec37df30ba10eb431be2d88f7.png)


#### 虚拟设备模拟上报数据

1. 在虚拟设备操控面板，将亮度值填写为91，其他值也填写对应值，单击“上报”。
   ![image](https://main.qcloudimg.com/raw/8ab8b40bbbb9b7ec6e7f8add83b420c3.png)
2. 进入腾讯连连公众号，将会显示一条推送“消息”
   ![image](https://main.qcloudimg.com/raw/06769a7c4ae6a2d433ca9e6e53383dc2.png)


### 体验 App 推送

1. 参考 [通用 App](https://cloud.tencent.com/document/product/1081/48968) 下载说明，下载对应 App。
2. [体验公众号推送](#test) 虚拟设备模拟上报数据后，可查看如下 App 推送消息。
![](https://main.qcloudimg.com/raw/b033dce90a0dfe087d82ab614b1d9192.png)



### 禁用数据流

1. 当用户需要停止某个数据流服务时，进入数据开发页面查看对应的数据流列表。
2. 单击生效状态列下的**关闭**，系统弹出确认提示，单击**禁用**表示停止该数据流服务，即使设备上报数据后，系统将不会进行处理。
   ![image](https://main.qcloudimg.com/raw/51e8366f0a90e4abf8dfd449d3245d2d.png)

