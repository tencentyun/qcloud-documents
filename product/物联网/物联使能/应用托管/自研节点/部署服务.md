
本文为您介绍如何在物联网 SaaS 托管平台部署服务。

## 前提条件

已完成 [服务创建](https://cloud.tencent.com/document/product/1465/59050)。

<span id="test" > </span > 

## 步骤一：版本配置

1. 登录 [物联网开发平台](https://console.cloud.tencent.com/iotexplorer) ，选择**公共实例**或您购买的**标准企业实例**。
2. 单击**项目 ID**进入项目详情页面，单击**物联使能** > **SaaS 服务**进入 SaaS 列表页面，选择对应的 SaaS 进入 SaaS 详情页，单击**自研节点**进入自研节点页。
3. 在已新建的服务中选择您需要部署版本的服务，单击**服务名称**进入服务详情页面。
<img src="https://main.qcloudimg.com/raw/d1a12eb907be5031e0ab8b76a122baf6.png"  / >
4. 单击**新建版本**，在弹出的新建版本配置框中，进行相应的配置。
<img src="https://main.qcloudimg.com/raw/409813fedddab52524862714d6a16004.jpg" style="width: 450px;" ></br>
	- **镜像来源**：支持**我的镜像**与 **Demo** 两种方式。选择 **Demo** 可使用 Demo 镜像快速体验部署过程。
	- **镜像名称**：当镜像来源选择**我的镜像**，需要由您自行采用任意方式进行镜像构建后，手动将镜像上传至服务所绑定的镜像仓库中，然后系统将基于您选定的镜像进行部署。若无所需镜像版本，可单击**查看上传指引**上传镜像。
	- **服务端口**：SaaS 监听端口，默认为80。
	- **流量策略**：选择是否开启100%流量。若不开启，此版本发布后将没有流量访问。
> ? 部署完成后如何开启流量，目前有如下两种选择。部署后如想再次调整流量，可以进行手动配置，详情请参见 [流量配置](https://cloud.tencent.com/document/product/1081/50047)。</font > 
> 1. 部署完成后保持流量为0，稍后再手动调整流量</font > ：希望部署完成后先手动验证再开流量，或只希望引入部分流量进行灰度升级。部署完成后，会先按副本个数的最小值创建出对应数量的实例并保持，等您手动配置流量后实例个数将根据扩缩容条件变化。若您将副本个数最小值设为0，此时将不会创建实例。
> 2. 部署完成后自动开启100%流量：首次部署完成后立刻开流量。部署完成后立刻开始创建实例并开始自动扩缩容。
- **版本描述**：不超过50个字符，您可以根据需要选填。



## 步骤二：托管配置 

1. 完成 [步骤一](#test) 配置后，单击**下一步**可进入托管配置。
<img src="https://main.qcloudimg.com/raw/3a69df0cb02652ead8cdc17cd09db981.jpg" style="width: 450px;" ></img> </br> 
	- **指定机型**：支持通用机型/M5机型两种类型。如您当前自研节点的使用场景需要大量的内存操作、查找和计算，可指定选取内存型M5机型进行托管。
	- **资源规格**：指集群中每个容器实例的配置。自动扩容时，新创建的实例将使用这个规格。
	- **副本模式**：支持低成本/高可用两种模式。
		- 模式 1：低成本
			适合对成本敏感，对冷启动相对不敏感的业务。
			- 副本个数最小值为 0，当连续半个小时没有流量打到版本上时，版本将缩容到 0，不保留任何实例，不产生任何费用。
			- 连续半个小时无流量才将实际缩容到 0（避免流量偶然波动带来的误判）。再次冷启动时，可能有 30 秒服务延迟，请谨慎选择。
			- 虽然没有业务流量，部署过程中仍然会先产生一个实例，部署完成后再缩容到 0，因此**部署过程本身会产生一定的资源消耗**。
>?将版本流量百分比设置为 0 并不是触发缩容到 0 的充要条件。低成本模式下，版本流量百分比设置为 0，一定会触发缩容到 0。但如果版本流量百分比不为 0，需要连续半小时的观测期，期间版本没有产生真实业务流量，才会触发缩容到 0。
>			
		- 模式 2：高可用
			适合对成本相对不敏感，对服务常驻有诉求，或无法接受冷启动的业务。
			- 副本个数最小值不能为 0，可以设置为 1 ～ 50 间的任意整数。即便业务无任何流量，即没有流量打到版本上，仍会保持最小个数的实例数在运行并会**持续产生费用**，但是好处是可保持服务常驻无冷启动影响。
			- 部署过程中即开始按最小副本个数和规格产生实例，**部署过程本身会产生一定的资源消耗。**
	- **副本个数**：指当前版本在自动扩缩容时可达到的最大实例数及最小实例数。最小值下限为 0，最大值上限为 50。
  如需将最小值修改为 0，请先切换副本模式至“低成本”。
  如需将最小值修改为大于 0 的整数，请先切换副本模式至“高可用”。
> ?自动扩容到最大实例数后若仍不足以承载业务流量，即便再次达到扩缩容条件，也不会继续创建新的实例，可能导致您的业务受影响，请您评估好业务指标后合理设定最大实例数。
>
	- **扩缩容条件**：当达到某个条件时，SaaS 托管的自研节点将自动创建/删除一个实例，冷却 15 秒后，检测是否再次达到条件，如果满足条件则继续扩缩容，如此反复直至实例数量达到副本个数的最小值/最大值，或不再满足扩缩容条件时停止自动扩缩容。目前仅支持 CPU 使用率作为扩缩容条件，即当前实例 CPU 使用率超过设定值后，若实例数小于最大副本个数，则创建出一个新的实例。默认值为 60%。
	- **日志采集路径**：可设置目录或文件，支持设置多个路径。默认路径为 stdout。版本部署完成后即可通过日志页面查看日志。
	- **InitialDelaySeconds**：实例创建完成后，等待一定的时间后开始进行健康检查。若健康检查失败，将重试 3 次，依然失败则判定服务版本异常。请将此值设定为大于自研节点启动的时间，否则版本可能持续处于异常状态。默认值为 2 秒。
	- **环境变量**：用户所需的环境变量，直接传入容器中。以 key value 的形式可配置多个环境变量，支持导入。
2. 单击**开始部署**，若部署成功则状态变为“正常”，若有报错，会变为具体的错误状态。版本部署状态说明如下：
	- 正常：版本部署成功后的状态。
	- 部署失败：版本部署失败后的状态，单击“部署失败”可查看详细的错误日志。
	- 创建中：版本部署中的状态。
	- 版本调整中：账户欠费停机状态下，充值后版本调整恢复中的状态。
>?版本部署过程中，在版本状态处单击**点击查看**可以进入操作详情页面，查看部署进程日志。
<img src="https://main.qcloudimg.com/raw/b60d83dd6df1532eb00cb0fb77f24807.jpg"  / > 
版本部署完成后，可以在日志页面查看容器日志与服务调用日志。
![](https://main.qcloudimg.com/raw/e2bb1fdd867a42f7bf5c7396433149ed.jpg)

</dx-alert > 

## 使用限制

- 版本名由系统自动生成，格式为“服务名”+“序号”，序号按照创建顺序依次递增，不支持修改（例如 testservice-001、testservice-002 等）。
- 不再使用的版本可以手动删除，已删除的版本不计入版本总数，但不会影响新建版本的序号。（例如删除掉版本 "testservice-002"，再次新建的版本仍然会是 "testservice-003"。）
