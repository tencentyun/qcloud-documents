## 功能说明
- 支持全员推送；
- 支持按用户属性推送；
- 支持按用户标签推送；
- 管理员向指定帐号推送消息，接收方看到消息发送者是管理员；
- 管理员指定某一帐号向其他帐号推送消息，接收方看到发送者不是管理员，而是管理员指定的帐号；
- 支持消息离线存储。
- 目前推送接口可能存在延迟，因此暂不适用于对消息实时性要求较高的场景。

>!当前推送功能比较适合低频次推送场景（例如每天或每周一次的营销推送）。如果推送频次过高，则推送可能会有延迟。

## 接口调用说明
本功能需要申请开通才能使用。
如有需要，请到云通信控制台相应 SdkAppid 详情页的【应用配置】>【功能配置】>【消息推送】设置开启；功能开启后，将在 50 分钟内生效。

### 请求 URL 示例
```
https://console.tim.qq.com/v4/openim/im_push?usersig=xxx&identifier=admin&sdkappid=88888888&random=99999999&contenttype=json
```
### 请求参数说明

| 参数               | 说明                                 |
| ------------------ | ------------------------------------ |
| https              | 请求协议为 HTTPS，请求方式为 POST       |
| console.tim.qq.com | 固定域名                             |
| v4/openim/im_push  | 请求接口                  |
| usersig            | App 管理员帐号生成的签名，参见 [UserSig 后台 API](https://cloud.tencent.com/document/product/269/32688)                            |
| identifier         | 必须为 App 管理员帐号                |
| sdkappid           | 创建应用时云通信控制台分配的 SdkAppid |
| random             | 32位无符号整数随机数                 |
| contenttype        | 固定值为：json                       |

### 调用频率
本接口包含全员/属性/标签推送，总共最高每天 100 次，每两次推送间隔必须大于 1s。有特别频率需求的，请咨询客户经理。

### 请求包示例
- **全员推送示例**
管理员进行全员推送（发送方帐号为请求 URL 中的 identifier 参数，即管理员本身）：
```
{
    "MsgRandom": 20160201,
    "MsgBody": [
        {
            "MsgType": "TIMTextElem",
            "MsgContent": {
                "Text": "hi, beauty"
            }
        }
    ]
}
```
管理员指定某一帐号进行全员推送（例子中发送方帐号为 xiaoming） ：
```
{
    "MsgRandom": 20160204,
    "From_Account": "xiaoming",
    "MsgBody": [
        {
            "MsgType": "TIMTextElem",
            "MsgContent": {
                "Text": "hi, beauty"
            }
        }
    ]
}
```
管理员给全员推送消息，并且消息离线保存 120 秒(即 2 分钟)：
```
{
    "MsgRandom": 20160204,
    "MsgLifeTime": 120,
    "MsgBody": [
        {
            "MsgType": "TIMTextElem",
            "MsgContent": {
                "Text": "hi, beauty"
            }
        }
    ]
}
```

- **按用户标签推送示例**
管理员给带有关注“股票A”和“股票B”标签的用户推送消息：
```
{
	"MsgRandom": 20126201,
	"Condition": {
		"TagsAnd": ["股票A","股票B"]
	},
	"MsgBody": [
		{
			"MsgType": "TIMTextElem",
			"MsgContent": {
				"Text": "hi, beauty"
			}
		}
	]
}
```
管理员给带有关注”股票A“或“股票B”标签的用户推送消息：
```
{
	"MsgRandom": 20126201,
	"Condition": {
		"TagsOr": ["股票A","股票B"]
	},
	"MsgBody": [
		{
			"MsgType": "TIMTextElem",
			"MsgContent": {
				"Text": "hi, beauty"
			}
		}
	]
}
```
管理员给关注”股票A“或“股票B”的用户推送消息，并且消息离线保存 120 秒(即 2 分钟)：
```
{
	"MsgRandom": 20526201,
	"MsgLifeTime": 120,
	"Condition": {
		"TagsOr": ["股票A","股票B"]
	},
	"MsgBody": [
		{
			"MsgType": "TIMTextElem",
			"MsgContent": {
				"Text": "hi, beauty"
			}
		}
	]
}
```
- **按用户属性推送**
管理员给在深圳的超白金会员用户推送消息：
```
{
    "MsgRandom": 20160204,
    "Condition": {
        "AttrsAnd": {
            "会员等级": "超白金会员",
            "city": "深圳"
        }
    },
    "MsgBody": [
        {
            "MsgType": "TIMTextElem",
            "MsgContent": {
                "Text": "hi, beauty"
            }
        }
    ]
}
```
管理员给在深圳或者性别为男的用户推送消息：
```
{
    "MsgRandom": 20160204,
    "Condition": {
        "AttrsOr": {
            "sex": "男",
            "city": "深圳"
        }
    },
    "MsgBody": [
        {
            "MsgType": "TIMTextElem",
            "MsgContent": {
                "Text": "hi, beauty"
            }
        }
    ]
}
```
管理员给在深圳的超白金用户用户推送消息，并且消息离线保存 120 秒(即 2 分钟)：
```
{
    "MsgRandom": 2016204,
		"MsgLifeTime": 120,
    "Condition": {
        "AttrsAnd": {
            "会员等级": "超白金用户",
            "city": "深圳"
        }
    },
    "MsgBody": [
        {
            "MsgType": "TIMTextElem",
            "MsgContent": {
                "Text": "hi, beauty"
            }
        }
    ]
}
```


### 请求包字段说明

| 字段 | 类型|属性| 说明 |
|---------|---------|---------|---|
| Condition | Object |选填|Condition 包含 TagsOr 和 TagsAnd 两种属性条件类型，这两种可以类型可以并存。这时候表示同时满足 TagsOr 和 TagsAnd 的用户；如果没有 Condition，则推送给全部用户  |
| MsgRandom | Integer |必填| 消息随机数，由随机函数产生。用于推送任务去重。对于不同的推送请求，MsgRandom7 天之内不能重复，否则视为相同的推送任务（调用推送 API 返回失败的时候可以用相同的 MsgRandom 进行重试）|
| MsgBody | Object |必填 | 消息内容，具体格式请参考 [MsgBody消息内容说明](https://cloud.tencent.com/document/product/269/消息格式描述#.E6.B6.88.E6.81.AF.E5.86.85.E5.AE.B9msgbody.E8.AF.B4.E6.98.8E)（一条消息可包括多种消息元素，所以 MsgBody 为 Array 类型）  |
| MsgType | String |必填| TIM 消息对象类型，目前支持的消息对象包括： TIMTextElem(文本消息)，TIMFaceElem(表情消息)， TIMLocationElem(位置消息)，TIMCustomElem(自定义消息)  |
| MsgContent | Object |必填 | 对于每种 MsgType 用不同的 MsgContent 格式，具体可参考 [TIMMsgElement 对象](https://cloud.tencent.com/document/product/269/2720#.E6.B6.88.E6.81.AF.E5.85.83.E7.B4.A0timmsgelement) 的定义   |
| MsgLifeTime | Integer |选填 | 消息离线存储时间，单位秒，最多保存1天（86400秒）。默认为 0，表示不离线存储  |
| From_Account | String |选填 | 消息推送方帐号  |
| AttrsOr | Object  |选填| 属性条件的并集。<br>注意属性推送和标签推送不可同时作为推送条件  |
| AttrsAnd | Object |选填 | 属性条件的交集。<br>注意属性推送和标签推送不可同时作为推送条件 |
| TagsOr | Object  |选填| 标签条件的并集。标签是一个不超过 50 字节的字符串。<br>注意属性推送和标签推送不可同时作为推送条件。TagsOr 条件中的标签个数不能超过 10 个|
| TagsAnd | Object |选填 | 标签条件的交集。标签是一个不超过 50 字节的字符串。<br>注意属性推送和标签推送不可同时作为推送条件。TagsAnd 条件中的标签个数不能超过 10 个|

### 应答包体示例

```
{
    "ActionStatus": "OK",
    "ErrorInfo": "",
    "ErrorCode": 0,
    "TaskId": "123456789_201621292_2016020204"
}
```

### 应答包字段说明

| 字段|类型 |说明 |
|---------|---------|---------|
| ActionStatus| String | 请求处理的结果，OK 表示处理成功，FAIL 表示失败  |
| ErrorCode| Integer | 错误码  |
| ErrorInfo| String | 错误信息  |
| TaskId| String | 推送任务 ID。可用于推送任务状态查询  |

## 错误码说明
除非发生网络错误（例如 502 错误），否则该接口的 HTTP 返回码均为 200。真正的错误码，错误信息是通过应答包体中的 ErrorCode、ErrorInfo 来表示的。
公共错误码（60000 到 79999）参见 [错误码](https://cloud.tencent.com/document/product/269/1671) 文档。
本 API 私有错误码如下：

| 错误码 |含义说明 |
|---------|---------|
| 90001 |JSON 格式解析失败，请检查请求包是否符合 JSON 规范|
| 90002 |JSON 格式请求包中 MsgBody 不符合消息格式描述，或者 MsgBody 不是 Array 类型，请参考 [TIMMsgElement 对象](https://cloud.tencent.com/document/product/269/2720#.E6.B6.88.E6.81.AF.E5.85.83.E7.B4.A0timmsgelement) 的定义|
| 90004 |Json 格式请求包体中 MsgSeq 不是 Number 类型或者其值范围不在 0~4294967296|
| 90005 |Json 格式请求包体中 MsgRandom 不是 Number 类型或者其值范围不在 0~4294967296|
| 90007 |JSON 格式请求包体中 MsgBody 类型不是 Array 类型，请将其修改为 Array 类型|
| 90009 |请求需要 App 管理员权限|
| 90010 |JSON 格式请求包不符合消息格式描述，请参考 [TIMMsgElement 对象](https://cloud.tencent.com/document/product/269/2720#.E6.B6.88.E6.81.AF.E5.85.83.E7.B4.A0timmsgelement) 的定义|
| 90020 |标签长度超过限制（不能超过50字节）|
| 90026|息离线存储时间错误（最多不能超过7天）|
| 91000 |服务内部错误，请重试|
| 90032|TagsOr 或者 TagsAnd 中的标签个数不能超过10个|
| 90039|按属性推送和按标签推送不可同时存在|
| 20002 |内部鉴权失败|

## 接口调试工具
通过 [REST API 在线调试](https://avc.qcloud.com/im/APITester/APITester.html#v4/openim/im_push) 工具调试本接口。

## 参考
获取推送报告([v4/openim/im_get_push_report](https://cloud.tencent.com/document/product/269/获取推送报告))。
