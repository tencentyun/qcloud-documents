## 应用场景
### App 内双人聊天
单聊消息适用于 App 内双人聊天，类似 QQ 好友、微信好友的聊天方式。

### App 管理员发送消息
单聊消息可以由 App 管理员在后台发送消息，也可以模拟其他用户身份发送消息。

### App 管理员模拟系统消息
通过 App 管理员在后台发送消息，可以模拟系统消息，以系统消息的形式给用户下达通知，App 端收到 App 管理员的自定义消息可做特殊处理。

## 发送单聊消息

| 接口分类             | 接口说明                                                     | 备注                                                         |
| -------------------- | ------------------------------------------------------------ | :----------------------------------------------------------- |
| IM SDK发送接口       | [Android 收发消息](/doc/product/269/9232#.E6.B6.88.E6.81.AF.E5.8F.91.E9.80.81)<br>[iOS 收发消息](/doc/product/269/9150#.E6.B6.88.E6.81.AF.E5.8F.91.E9.80.81)<br>[Windows 收发消息](/doc/product/269/消息收发（Windows%20SDK）)<br>[Web 收发消息](/doc/product/269/消息收发（Web%20SDK）) | 通过 IM SDK接口发送消息，首先根据目标用户的 `Identifier`，获取对应会话，再调用客户端接口 `sendMessage` 发送消息 |
| REST API发送接口     | [Rest API 发送单聊消息](/doc/product/269/单发单聊消息)       | App 管理员可调用，且支持指定消息发送账号                     |
| REST API批量发送接口 | [Rest API 批量发送单聊消息](/doc/product/269/批量发单聊消息) | App 管理员可调用，且支持指定消息发送账号                     |

>!
>- 目前发送单聊消息，云通信默认不会判断是否是好友关系。如果需要判断好友关系，可以通过以下两种方案实现：
>1. APP 拉取好友列表或者通过检查是否好友关系的接口进行判断；
>1. 在云通信控制台，开启“单聊消息校验好友关系”的配置。（登录云通信控制台，选择相应SdkAppid【应用配置】>【功能配置】>【单聊消息检验关系链】)



## 接收单聊消息
| 接口分类            | 接口说明                                                     | 备注                                                         |
| ------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| IM SDK接收在线消息  | [Android 消息接收](/doc/product/269/9232#.E6.8E.A5.E6.94.B6.E6.B6.88.E6.81.AF)<br>[iOS 消息接收](/doc/product/269/9150#.E6.8E.A5.E6.94.B6.E6.B6.88.E6.81.AF)<br>[Windows 消息接收](/doc/product/269/消息收发（Windows%20SDK）#2.-.E6.8E.A5.E6.94.B6.E6.B6.88.E6.81.AF)<br>[Web 初始化新消息回调](/doc/product/269/初始化（Web%20SDK）) | IM SDK 接收消息都是通过统一回调接口 `onNewMessage` 返回，通过 `onNewMessage` 回调获得消息后，能根据消息获取相应的会话 |
| IM SDK接收离线消息  | 同在线消息                                                   | 发送者发消息时，如果接收方不在线，后台服务器会对消息进行缓存，存储时长默认为 7 天，当接收方 7 天内登录时，可以通过 `onNewMessage` 回调获取到离线消息 |
| IM SDK 查询历史消息 | [Android 获取消息](/doc/product/269/9232#.E8.8E.B7.E5.8F.96.E4.BC.9A.E8.AF.9D.E6.BC.AB.E6.B8.B8.E6.B6.88.E6.81.AF)<br>[iOS 获取消息](/doc/product/269/1569#.E8.8E.B7.E5.8F.96.E4.BC.9A.E8.AF.9D.E6.BC.AB.E6.B8.B8.E6.B6.88.E6.81.AF)<br>[Windows 获取消息](/doc/product/269/消息收发（Windows%20SDK）#.E8.8E.B7.E5.8F.96.E4.BC.9A.E8.AF.9D.E6.9C.AC.E5.9C.B0.E6.B6.88.E6.81.AF) | 在 IM SDK 接收到消息后，默认情况下会对消息进行缓存和存储（如果不需要，可以调用 `disableStorage` 接口进行存储禁用，提升性能），各个终端通过调用 `getMessage` 接口可以获取本地的记录（开启漫游的情况下，还可以获取后台服务器漫游的消息） |

>!
>- IM SDK的在线消息和离线消息都会通过TIMMessageListener的onNewMessage接口通知到上层应用。在登录成功以后，SDK会同步离线期间的消息，同步回来的离线消息会通过onNewMessage通知到上层应用，同时在所有数据同步完成后，会通过TIMRefreshListener的onRefresh接口通知到上层应用，上层应用在收到onRefresh通知的时候可以进行一些必要的操作，比如刷新UI界面等。
>
>- 云通信后台默认会对单聊消息保存 7 天，如果 APP 需要延长保存时间，可以按需提 [工单](/doc/product/269/云通信配置变更需求工单#.E4.BF.AE.E6.94.B9.E6.AF.8F.E6.97.A5.E5.88.9B.E5.BB.BA.E7.BE.A4.E7.BB.84.E9.85.8D.E9.A2.9D) 配置，详情请参考[价格说明](https://cloud.tencent.com/document/product/269/11673)。

## 单聊权限控制
### App 内任意两个用户之间发送单聊消息
App 内不进行好友关系的判断，任意两个用户默认是可以随意发消息的。若接入方关系链已经导入至云通信 IM 侧，也可以通过云通信控制台相应 SdkAppid【应用配置】>【功能配置】>【单聊消息检验关系链】设置开启仅好友关系才能收发消息。

### App 管理员发送单聊消息
App 内管理员可以给任意用户发送单聊消息。

### 只允许给好友发送消息
目前 IM SDK 以及后台默认情况下在发消息时不会对关系链进行判断，需要 App 在本地获取关系链或者通过接口判断是否好友决定是否发送。

若接入方关系链已经导入至云通信 IM 侧，也可以通过到云通信控制台相应 SdkAppid【应用配置】>【功能配置】>【单聊消息检验关系链】设置开启，将发送消息权限设置为仅好友关系才能收发消息。

### 拒绝来自某人的消息

如果想要拒绝来自某人的消息，可以通过黑名单进行控制。把用户加入黑名单之后，对方发消息会显示成功，但消息会被丢弃，接收方无法接收消息。另外，在把用户加入黑名单时，如果之前是好友关系，会自动解除好友。

设置黑名单的接口如下：

| 接口分类     | 接口说明                                                     | 备注          |
| ------------ | ------------------------------------------------------------ | ------------- |
| IM SDK接口   | [Android设置黑名单](/doc/product/269/9231#.E6.B7.BB.E5.8A.A0.E7.94.A8.E6.88.B7.E5.88.B0.E9.BB.91.E5.90.8D.E5.8D.95)<br>[iOS设置黑名单](/doc/product/269/9153#.E6.B7.BB.E5.8A.A0.E7.94.A8.E6.88.B7.E5.88.B0.E9.BB.91.E5.90.8D.E5.8D.95)<br>[Windows设置黑名单](/doc/product/269/1593#5.5-.E6.B7.BB.E5.8A.A0.E7.94.A8.E6.88.B7.E5.88.B0.E9.BB.91.E5.90.8D.E5.8D.95)<br>[Web设置黑名单](/doc/product/269/1600#7-.E5.A2.9E.E5.8A.A0.E9.BB.91.E5.90.8D.E5.8D.95) |               |
| REST API接口 | [通过 REST API 设置黑名单文档](/doc/product/269/3718)        | APP管理员调用 |

## 获取聊天记录
| 方法                                                  | 描述                                                         | 使用场景                         |
| ----------------------------------------------------- | ------------------------------------------------------------ | -------------------------------- |
| [单发消息后回调](/doc/product/269/发单聊消息之后回调) | 单聊消息发送成功后，会把消息回调给APP后台， APP后台可以保存消息。该回调需要在控制台开通配置。 | 适用于需要获取实时聊天记录的场景 |
| [REST API消息记录下载](/doc/product/269/消息记录下载) | 云通信会将 APP 在一段时间内产生的所有消息打包成文件，APP后台可以通过REST API来获取该文件 | 适用于需要定期下载消息记录的场景 |

## 多终端同步

默认情况下，无法同时登录多个终端，通过提工单配置后，可以允许多平台同时登录，且会在多个终端之间尽量保持消息的完整性。另外，在默认情况下，用户在多个终端之间切换登录，也无法保证所有终端消息的一致性，需要提需求工单进行配置。
配置后，可实现在多个终端切换，或者同时登录多个终端的情况下，保持消息内容的一致性（由于后台服务器存储消息的时长以及空间限制，只能保证大多数情况下一致性）。

## 单聊消息的离线推送
### APNs 离线推送
IM SDK 默认支持 APNs 离线推送，在控制台上传对应推送证书，客户端上报 Token 后，可以收到 APNs。通过自定义 TIMCustomElem 的 `Ext` 字段可以指定推送内容的 `Ext` 字段，方便用户点击后跳转；通过 `sound` 字段，可以自定义某条消息的声音。可参见 appledoc 说明。

如果需要自定义接收声音，可以调用接口设置单聊推送声音。APNs 离线推送形式为：`昵称：内容`。详细请参阅[iOS 离线推送](/doc/product/269/9154)。

### Android 离线推送

在 Android 1.8.0 以后版本，IM SDK 支持离线推送。详情请参阅：[Android离线推送](/doc/product/269/9234)。

## 单聊消息中携带发送者资料
目前单聊消息中并未携带发送者昵称，如果需要可通过方法 `GetUserProfile` 获取昵称和头像等资料，如果是好友关系，可以通过 `GetFriendProfile` 获取好友相关的资料，比如备注、分组等信息。详细请参阅以下接口描述：

- [Android 用户资料](/doc/product/269/9231)
- [iOS 用户资料](/doc/product/269/9153)
- [Windows 用户资料](/doc/product/269/用户资料与关系链（Windows%20SDK）)
- [Web 用户资料](/doc/product/269/用户资料（Web%20SDK）)

## 单聊离线消息处理流程

![](//mc.qcloudimg.com/static/img/e6aa14e6fb7844dc99635dc45687da1e/image.png)

**单聊消息离线及漫游处理流程：**

1. 用户 A 调用 `sendMessage` 给用户 B 发送消息，用户 B 处于下线状态；
	1.1 把用户 A 添加进用户 B 的最近联系人，缓存大小为 100 条；
	1.2 把消息存入离线缓存中，缓存大小 30K，时间限制 7 天；
	1.3 把消息存入漫游服务器中，时间限制 7 天。
1. 用户 B 调用 `login` 接口登录云通信；
1. SDK 自动拉取离线缓存中的消息，通过 `OnNewMessage` 抛出；
1. SDK 自动拉取最近联系人，通过 `OnNewMessage` 接口抛出；
1. 同步消息过程完成，通过 `OnRefresh` 接口通知用户已完成消息同步；
1. 用户调用 `getMessage`，如果本地消息不完整，SDK 自动拉漫游服务器。
