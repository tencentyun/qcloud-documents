腾讯云微搭低代码的数据源提供了数据集合本身的存储以及操纵数据的各种方法，本质上是一系列操作数据的方法集合。低码平台提供了数据源管理功能，可以创建、管理多个数据源。



#### 数据源
数据源是腾讯云微搭低代码的重要能力，通过对数据源模型的设计、对页面组件的数据绑定，可快速实现各类应用中数据的存储、使用。低码提供了数据源模型创建和数据可视化管理的能力。


#### 数据源模型

数据源模型定义了一种数据源类型，在应用编辑器内，可根据数据源模型创建多个数据源变量并与组件进行绑定。数据源模型可被所有应用共用，数据源模型上限为80个。

>?对数据源的改动（创建、更新、删除）只有在使用该数据源的应用发布时才会真正生效。数据源若被多个应用使用，则需要每一个使用该数据源的应用重新发布，才可以使用最新的数据源。特别地，应用区分预览和发布两种场景，两种场景使用的数据源亦互不影响。


## 数据源分类

根据数据源目的及存储方式的不同，数据源可分为以下两类：

| 数据源模型 | 说明 |
|---------|---------|
| 自建数据源 | 使用腾讯云微搭低代码提供的数据库存储数据（[参考文档](https://docs.cloudbase.net/lowcode/datasource/intro.html)） |
| 外部数据源 | 使用第三方已有的数据源集成到腾讯云微搭低代码平台（[参考文档](https://docs.cloudbase.net/lowcode/datasource/intro.html)） |


>?数据源需要有一个标识，以便数据源在低码编辑器及低码中使用，因此该标识应当遵循一般代码变量命名规则， 命名时应当具有一定可读性。





## 数据源方法目的分类

根据数据源方法目的及实际使用场景，可将数据源方法分为以下五类：


| 数据源方法目的 | 对应方法 | 说明                                                         |
| -------------- | -------- | ------------------------------------------------------------ |
| 查询列表       | getList  | 返回多条数据记录，适用于前端需要展示列表、表格等场景       |
| 查询单条       | getItem  | 返回单条数据记录，适用于前端需要展示详情、信息卡片等场景；前端编辑数据的场景也会需要使用该类型方法获取需要编辑的数据 |
| 修改数据       | update   | 更新已存在的数据记录，例如更新个人信息，修改已发布的文章等 |
| 删除数据       | delete   | 删除（也包括多选删除）已有数据记录，例如多选删除             |
| 新增数据       | create   | 添加新的数据记录，例如注册用户，发布文章等                 |



数据库类型的数据源已预置实现了 “getList” 、“getItem” 、“update” 、“delete” 、“create” 方法，与上述五种目的一一对应。用户在新建、编辑数据库类型的数据源时，可选择是否启用上述方法。

>?同数据源一样，数据源方法也需要一个标识，以便数据源方法在低码编辑器及低码中使用。

## 数据源方法实现

### 实现分类

根据数据源方法实现方式的不同，可分为云函数和本地函数。

<dx-tabs>
::: 云函数
基于云开发的云函数能力封装，需使用 JS 语法编写，最终将运行在服务器端的 Nodejs 环境中，拥有服务器端权限。相比本地函数，云函数权限更大。云函数必须使用 `module.exports` 导出。
云函数编写形式如下：
<dx-codeblock>
:::  js
module.exports = async function (params，context) {
	...
}
:::
</dx-codeblock>
- 参数 params 为函数接收的参数，context 则为平台注入的对象，包含辅助工具，方便云函数的开发。
- 函数处理中发现错误，可以直接 `throw new Error('xxxx')` 来抛出错误，也可以使用 `throw new TCBError(code，'msg')` 抛出错误并自定义错误代码。
:::
::: 本地函数
本地函数需使用 JS 语法编写，根据使用该数据源的应用发布形式的不同，执行环境也会不同：
- 若应用发布为 H5，则数据源的本地函数将会在浏览器端执行，函数受浏览器端的环境及安全策略限制。
- 若应用发布为小程序，则本地函数将会在小程序中执行，函数受小程序的环境及安全策略限制。

本地函数必须使用 `export default` 导出。

本地函数编写形式如下：
<dx-codeblock>
:::  js
export default async function (params，context) {
	...
}
:::
</dx-codeblock>
- 参数 params 为函数接收的参数，context 则为平台注入的对象，包含辅助工具，方便云函数的开发。
- 函数处理中发现错误，可以直接 `throw new Error('xxxx')` 来抛出错误，也可以使用 `throw new TCBError(code，'msg')` 抛出错误并自定义错误代码。
:::
</dx-tabs>



### 数据源方法的入参及出参

不论是云函数或是本地函数，均需要描述函数的入参和出参数据结构，以便低码编辑器使用该方法。

- **入参**：函数的 params。
- **出参**：函数返回结果，即 return 语句返回的内容。

**实际调用数据源方法时**，低码框架将对返回的结果进行包装，实际输出结果结构为：


<dx-codeblock>
:::  ts
interface IResponse {
	// 0 即表示成功，其他情况为失败，使用 Error 抛出的错误，code 为 -1
	// 使用 TCBError 抛出的错误，code 即为其指定的值
	code: number
	// 结果，即数据源函数的出参
	data: IResult
	// 错误信息，失败时会有该值
	message: string
}
:::
</dx-codeblock>



## 数据源更新及发布

数据源的改动（创建、更新、删除）只有在使用该数据源的应用发布时，才会真正生效。


>!
>- 数据源若被多个应用使用，则需要每一个使用该数据源的应用重新发布，才可使用最新的数据源。
>- 应用本身区分预览和发布两种场景，两种场景使用的数据源亦互不影响：
>  - 若需预览时使用最新的数据源，则需重新预览一次应用。
>  - 若希望已上线发布的应用使用最新的数据源，则重新发布应用即可。


## 数据源使用

目前提供两种使用数据源方式：低码编辑器和数据源变量。


<dx-tabs>
::: 低码编辑器
低码框架会在低码运行环境中注入全局对象，以便访问不同的数据源及数据源方法。 

使用形式如下：
```plaintext
app.dataSources.<数据源标识>.<数据源方法名称>(params)
```

>!数据源方法皆为异步。

在低码编辑器中则可以在全局或者页面的生命周期、handler 中，通过上述形式使用数据源。

例如，在自定义 handler  `createUser`  中调用“用户数据源（user）”的新建（create）方法：
<dx-codeblock>
:::  js
export default async function (params) {
	try {
		const resp = await app.dataSources.user.create(params)
		if (!resp.code) {
			console.log('成功')
		} else {
			console.log('失败 ' + resp.meesage)
		}
	} catch(e) {
		console.log('未知错误' + e.message)
	}	
}
:::
</dx-codeblock>
:::
::: 数据源变量
在低码编辑器中，还可以在变量管理中通过添加数据源变量的方式来更方便的使用数据源。

数据源变量定义之后，可通过以下两种方式使用：

- 方式1：在组件编辑时，绑定数据源变量的值。
- 方式2：在低码编辑器中通过 `app.dataset.state.<全局数据源变量标识>`  和 `$page.dataset.state.<页面数据源变量标识>` ，使用全局和页面的数据源变量。
:::
</dx-tabs>

