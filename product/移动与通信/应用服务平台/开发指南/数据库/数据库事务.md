äº‘å¼€å‘æ”¯æŒæ•°æ®åº“äº‹åŠ¡ï¼Œå¹¶ä¿è¯äº‹åŠ¡çš„ ACID ç‰¹æ€§ã€‚æœ¬æ–‡å°†ä»‹ç»æ•°æ®åº“äº‹åŠ¡çš„ä½¿ç”¨åœºæ™¯ã€æ¡ˆä¾‹ã€åŸç†ä»¥åŠæœ€ä½³å®è·µï¼Œæ¥å¸®åŠ©å¼€å‘è€…å®Œæˆæ›´å¤æ‚çš„ä¸šåŠ¡éœ€æ±‚ã€‚

## ä½¿ç”¨åœºæ™¯

äº‘å¼€å‘æä¾›çš„äº‘æ•°æ®åº“æ˜¯åŸºäºæ–‡æ¡£çš„éå…³ç³»å‹æ•°æ®åº“ã€‚ä¸åŒäºä¼ ç»Ÿçš„å…³ç³»å‹æ•°æ®åº“ï¼Œå¼€å‘è€…å¯ä»¥ç›´æ¥åœ¨å•æ–‡æ¡£ä¸­åµŒå¥—å­æ–‡æ¡£ï¼Œä»¥æè¿°æ›´å¤æ‚çš„æ•°æ®ç»“æ„ã€‚

åœ¨å¤§å¤šæ•°åœºæ™¯ä¸­ï¼Œå•æ–‡æ¡£å®Œå…¨å¯ä»¥æ»¡è¶³éœ€æ±‚ã€‚ä½†åœ¨ä¸€äº›åœºæ™¯ä¸­ï¼Œä½¿ç”¨æ•°æ®åº“äº‹åŠ¡çš„ä¼˜åŠ¿æ›´æ˜æ˜¾ ğŸ‘‡

- ä»ä¼ ç»Ÿå…³ç³»å‹æ•°æ®åº“è¿ç§»åˆ°äº‘å¼€å‘ï¼šæ•°æ®æ¨¡å‹å¹³æ»‘è¿ç§»ï¼Œä¸šåŠ¡ä»£ç æ”¹é€ æˆæœ¬ä½
- æ¶‰åŠå¤šä¸ªæ–‡æ¡£/å¤šä¸ªé›†åˆçš„ä¸šåŠ¡æµç¨‹ï¼šä¿è¯ä¸€ç³»åˆ—è¯»å†™æ“ä½œå®Œå…¨æˆåŠŸæˆ–è€…å®Œå…¨å¤±è´¥ï¼Œé˜²æ­¢å‡ºç°ä¸­é—´æ€

## æ”¯æŒçš„æ–¹æ³•

ç›®å‰æ”¯æŒ 4 ç§æ“ä½œäº‹åŠ¡æµç¨‹çš„æ–¹æ³•ï¼š

| API              | è¯´æ˜         |
| ---------------- | ------------ |
| startTransaction | å‘èµ·äº‹åŠ¡     |
| commit           | æäº¤äº‹åŠ¡     |
| rollback         | å›æ»šäº‹åŠ¡     |
| runTransaction   | è‡ªåŠ¨æäº¤äº‹åŠ¡ |

ç›®å‰æ”¯æŒäº‹åŠ¡ä¸­ 5 ç§è¯»å†™æ•°æ®çš„æ–¹æ³•ï¼š

| API    | è¯´æ˜                               |
| ------ | ---------------------------------- |
| get    | æŸ¥è¯¢æ–‡æ¡£                           |
| add    | æ’å…¥æ–‡æ¡£                           |
| delete | åˆ é™¤æ–‡æ¡£                           |
| update | æ›´æ–°æ–‡æ¡£                           |
| set    | æ›´æ–°æ–‡æ¡£ï¼Œæ–‡æ¡£ä¸å­˜åœ¨æ—¶ï¼Œä¼šè‡ªåŠ¨åˆ›å»º |

æ‚¨å¯ä»¥å‰å¾€ [æ•°æ®åº“äº‹åŠ¡](https://docs.cloudbase.net/api-reference/server/node/database/database.html#shu-ju-ku-shi-wu)ï¼ŒæŸ¥çœ‹æ›´è¯¦ç»†çš„ API è¯´æ˜ã€‚

## ä½¿ç”¨æ¡ˆä¾‹

ä¸ºäº†å¸®åŠ©æ‚¨å¿«é€Ÿä½“ä¼šåˆ°æ•°æ®åº“äº‹åŠ¡çš„é‡è¦æ€§å’Œä¾¿æ·æ€§ï¼Œè¿™é‡Œä»¥â€œæ¸…ç©ºè´­ç‰©è½¦â€çš„éœ€æ±‚ä¸ºä¾‹ï¼Œä»‹ç»æ•°æ®åº“äº‹åŠ¡åœ¨å¤æ‚ä¸šåŠ¡åœºæ™¯ä¸­çš„ä½¿ç”¨ã€‚

å‡è®¾å•†å“æ•°æ®æ”¾åœ¨äº† `goods` é›†åˆä¸­ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```json
[
  {
    "_id": "item1",
    "inventory": 20,
    "name": "å•†å“a",
    "price": 10
  },
  {
    "_id": "item2",
    "inventory": 10,
    "name": "å•†å“b",
    "price": 5
  }
]
```

ç”¨æˆ·çš„æ•°æ®æ”¾åœ¨äº† `users` é›†åˆä¸­ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```json
[
  {
    "_id": "user1",
    "balance": "1000", // è´¦æˆ·ä½™é¢
    "cart": [
      // è´­ç‰©è½¦
      {
        "id": "item1", // å•†å“id
        "num": 1 // è´­ä¹°æ•°é‡
      },
      {
        "id": "item2",
        "num": 1
      }
    ],
    "name": "ç”¨æˆ·1"
  }
]
```

å½“ç”¨æˆ· 1 æ¸…ç©ºè´­ç‰©è½¦æ—¶ï¼Œä¸šåŠ¡çš„æ•´ä½“æµç¨‹æ˜¯ï¼š

- è®¡ç®—è´­ç‰©è½¦ä¸­çš„å•†å“æ€»ä»·
- å‡å°‘å¯¹åº”å•†å“çš„åº“å­˜
- æ›´æ–°ç”¨æˆ· 1 çš„è´¦æˆ·ä½™é¢
- æ¸…ç©ºç”¨æˆ· 1 çš„è´­ç‰©è½¦æ•°æ®

æˆ‘ä»¬å°†è¿™äº›æ“ä½œæ”¾å…¥ä¸€ä¸ªäº‹åŠ¡ä¸­æ‰§è¡Œï¼Œä»£ç å®ç°å¦‚ä¸‹ï¼š

:::playground

```javascript
// Node.js ç¯å¢ƒ
const cloudbase = require('@cloudbase/node-sdk')

const app = cloudbase.init({})

const db = app.database()

exports.main = async (event, context) => {
  const userId = 'user1'
  const transaction = await db.startTransaction()
  const usersCollection = transaction.collection('users')
  const goodsCollection = transaction.collection('goods')

  // 1. è·å–ç”¨æˆ·ä¿¡æ¯
  const user = await usersCollection.doc(userId).get()

  // 2. è·å–è´­ç‰©è½¦æ•°æ®å’Œå¯¹åº”çš„å•†å“ä¿¡æ¯
  const { cart, balance } = user.data
  const goods = []
  for (const { id } of cart) {
    const good = await goodsCollection.doc(id).get()
    goods.push(good.data)
  }

  let totalPrice = 0
  for (let i = 0; i < cart.length; ++i) {
    // 3. è®¡ç®—è´­ç‰©è½¦ä¸­çš„å•†å“æ€»ä»·
    totalPrice += cart[i].num * goods[i].price
    // 4. æ›´æ–°å•†å“åº“å­˜
    await goodsCollection.doc(goods[i]._id).set({
      inventory: goods[i].inventory - cart[i].num
    })
  }

  await usersCollection.doc(userId).set({
    balance: balance - totalPrice, // 5. æ›´æ–°è´¦æˆ·ä½™é¢
    cart: [] // 6. å®Œæˆè´­ä¹°åï¼Œæ¸…ç©ºè´­ç‰©è½¦
  })

  await transaction.commit()

  // ä»æ•°æ®åº“ä¸­æŸ¥è¯¢æœ€æ–°çš„ç”¨æˆ·ï¼Œåº“å­˜ä¿¡æ¯
  const usersInfo = await db.collection('users').get()
  const goodsInfo = await db.collection('goods').get()
  return {
    usersInfo,
    goodsInfo
  }
}
```

>! ä¸ºäº†æ›´ç®€æ´åœ°ä½“ç°äº‹åŠ¡åœ¨å¤æ‚ä¸šåŠ¡åœºæ™¯ä¸­çš„ä¼˜åŠ¿ï¼Œæ¡ˆä¾‹ä¸­æ²¡æœ‰å¯¹åº“å­˜ã€ä½™é¢ç­‰ä¿¡æ¯è¿›è¡Œé¢å¤–çš„ä»£ç æ£€æŸ¥ã€‚

ä»â€œæ¸…ç©ºè´­ç‰©è½¦â€çš„æ¡ˆä¾‹ä¸­å¯ä»¥çœ‹å‡ºï¼Œæ•°æ®åº“äº‹åŠ¡æå¤§åœ°èŠ‚çœäº†å¼€å‘çš„æˆæœ¬ï¼Œé¿å…å¼•å…¥å¤æ‚çš„æ•°æ®åº“è®¾è®¡ï¼Œè®©å¼€å‘è€…çš„ç²¾åŠ›æ›´èšç„¦äºå½“å‰ä¸šåŠ¡ã€‚

## åŸç†ä»‹ç»

æœ¬å°èŠ‚ä¼šä»‹ç»æ•°æ®åº“äº‹åŠ¡çš„åº•å±‚åŸç†ï¼Œä»¥åŠ æ·±æ‚¨å¯¹æ•°æ®åº“äº‹åŠ¡çš„ç†è§£ï¼Œæ›´å¥½åœ°ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡ã€‚

### å¿«ç…§éš”ç¦»

åœ¨è°ƒç”¨ `db.startTransaction()` å¼€å§‹äº‹åŠ¡ä¹‹åï¼Œå¹¶æ²¡æœ‰ç«‹å³ç”Ÿæˆä¸€ä»½â€œå¿«ç…§â€ï¼Œâ€œå¿«ç…§â€æ˜¯åœ¨ç¬¬ä¸€æ¬¡è¯»ä¹‹åæ‰ä¼šç”Ÿæˆã€‚åœ¨æ²¡æœ‰è°ƒç”¨ `transaction.commit()` æäº¤äº‹åŠ¡å‰ï¼Œæ‰€æœ‰çš„è¯»å†™æ“ä½œéƒ½æ˜¯åœ¨â€œå¿«ç…§â€ä¸Šè¿›è¡Œï¼Œä¸ä¼šå½±å“æ–‡æ¡£åŸæœ¬çš„æ•°æ®ã€‚åœ¨æˆåŠŸæäº¤äº‹åŠ¡åï¼Œâ€œå¿«ç…§â€ä¸Šçš„æ•°æ®æ‰ä¼šè½ç›˜ï¼Œç›¸å…³æ–‡æ¡£æ•°æ®å®Œæˆæ›´æ–°ã€‚

å‡è®¾å¯¹äºå•†å“ A æ¥è¯´ï¼Œå®ƒçš„åº“å­˜è¿˜æœ‰ 13 ä¸ªï¼š

```json
{
    "id": "xxxxxx",
    "name: "å•†å“A",
    "inventory": 13
}
```

å¦‚æœæ¶ˆè´¹è€…å‘èµ·äº†è´­ä¹°å•†å“ A çš„äº‹åŠ¡ï¼Œåœ¨è´­ä¹°äº‹åŠ¡æœªæˆåŠŸæäº¤å‰ï¼Œæ‰€æœ‰çš„å˜æ›´éƒ½æ˜¯åœ¨å¿«ç…§ä¸Šè¿›è¡Œï¼Œä¸ä¼šå½±å“å•†å“ A çš„æ•°æ®ï¼Œæ‰€ä»¥å…¶ä»–æ¶ˆè´¹è€…çœ‹åˆ°çš„å•†å“ A çš„åº“å­˜ä¾ç„¶æ˜¯ 13ã€‚

### é”ä¸å†™å†²çª

å½“äº‹åŠ¡ä¿®æ”¹æ–‡æ¡£æ—¶ï¼Œä¼šé”å®šç›¸å…³æ–‡æ¡£ï¼Œä½¿å…¶ä¸å—å…¶ä»–æ›´æ”¹çš„å½±å“ï¼Œç›´åˆ°äº‹åŠ¡ç»“æŸã€‚å› æ­¤ï¼Œå¤–éƒ¨çš„æ™®é€šå†™å…¥ï¼Œä¼šè¢«é˜»å¡ã€‚

å¦‚æœä¸€ä¸ªäº‹åŠ¡æ— æ³•è·å–åˆ°è¯•å›¾ä¿®æ”¹çš„æ–‡æ¡£çš„é”ï¼Œå¯èƒ½æ˜¯å› ä¸ºå¦ä¸€ä¸ªäº‹åŠ¡å·²ç»æŒæœ‰è¯¥é”ï¼Œé‚£ä¹ˆäº‹åŠ¡ä¼šç»ˆæ­¢ï¼Œå¹¶å‡ºç°å†™å†²çªã€‚

>? è¯»å–æ–‡æ¡£çš„æ“ä½œä¸éœ€è¦ä¸æ–‡æ¡£ä¿®æ”¹ç›¸åŒçš„é”ã€‚è¿™æ„å‘³ç€å³ä½¿å½“å‰äº‹åŠ¡å¯¹æŸä¸ªæ–‡æ¡£è¿›è¡Œäº†æœªæäº¤çš„å†™æ“ä½œï¼Œå…¶ä»–äº‹åŠ¡ä»ç„¶å¯ä»¥è¯»å–è¿™ä¸ªæ–‡æ¡£çš„å†…å®¹ã€‚
> 
> æ ¹æ®â€œå¿«ç…§éš”ç¦»â€ï¼Œè¯»å–çš„æ–‡æ¡£å†…å®¹æ˜¯æ–‡æ¡£æœªæäº¤çš„çŠ¶æ€ã€‚

å› æ­¤ï¼Œä¸ºäº†ä½¿ä»£ç æ›´å¥å£®ï¼Œæ¨èåœ¨è¿›è¡Œäº‹åŠ¡æ“ä½œæ—¶ï¼Œä½¿ç”¨ `try-catch` æ¥æ•è·å¼‚å¸¸ã€‚ä»£ç ç¤ºä¾‹å¦‚ä¸‹ï¼š

**Web**

```javascript
const cloudbase = require("@cloudbase/js-sdk");

const app = cloudbase.init({
  env: "your env"
});
// 1. è·å–æ•°æ®åº“å¼•ç”¨
const db = app.database();

// 2. æ¨¡æ‹Ÿäº‹åŠ¡æ“ä½œ
async function main() {
  try {
    const transaction = await db.startTransaction();
    // ... ...
    // æ¶‰åŠæ–‡æ¡£æ›´æ”¹çš„äº‹åŠ¡æ“ä½œ
    // ... ...
    await transaction.commit();
  } catch (error) {
    // å‘ç”Ÿå†™å†²çªæ—¶ï¼Œè¿›è¡Œå¼‚å¸¸å¤„ç†
    console.error(error.message);
  }
}
```

**å°ç¨‹åº**

```javascript
// 1. è·å–æ•°æ®åº“å¼•ç”¨
const db = wx.cloud.database();

// 2. æ¨¡æ‹Ÿäº‹åŠ¡æ“ä½œ
async function main() {
  try {
    const transaction = await db.startTransaction();
    // ... ...
    // æ¶‰åŠæ–‡æ¡£æ›´æ”¹çš„äº‹åŠ¡æ“ä½œ
    // ... ...
    await transaction.commit();
  } catch (error) {
    // å‘ç”Ÿå†™å†²çªæ—¶ï¼Œè¿›è¡Œå¼‚å¸¸å¤„ç†
    console.error(error.message);
  }
}
```

**Node.js**

```javascript
const cloudbase = require("@cloudbase/node-sdk");

const app = cloudbase.init({
  env: "xxx"
});
// 1. è·å–æ•°æ®åº“å¼•ç”¨
const db = app.database();

// 2. æ¨¡æ‹Ÿäº‹åŠ¡æ“ä½œ
async function main() {
  try {
    const transaction = await db.startTransaction();
    // ... ...
    // æ¶‰åŠæ–‡æ¡£æ›´æ”¹çš„äº‹åŠ¡æ“ä½œ
    // ... ...
    await transaction.commit();
  } catch (error) {
    // å‘ç”Ÿå†™å†²çªæ—¶ï¼Œè¿›è¡Œå¼‚å¸¸å¤„ç†
    console.error(error.message);
  }
}
```

## æœ€ä½³å®è·µ

- ä¸ºäº†æ›´å¥½åœ°ä½¿ç”¨äº‹åŠ¡ï¼Œå¼€å‘è€…åº”è¯¥éµå¾ªå‡ ç§æœ€ä½³å®è·µã€‚
- é¿å…åˆ›å»ºé•¿æ—¶é—´è¿è¡Œçš„äº‹åŠ¡ï¼Œæˆ–è€…æ‰§è¡Œè¿‡å¤šæ“ä½œã€‚å› ä¸ºäº‹åŠ¡ä¼šåˆ›å»ºå¿«ç…§ï¼Œæ‰€æœ‰çš„åç»­å†™å…¥æ“ä½œéƒ½ä¼šåœ¨ç¼“å­˜ä¸­ç§¯ç´¯ï¼Œç›´åˆ°äº‹åŠ¡æäº¤æˆ–è€…ç»ˆæ­¢ã€‚å½“ä¸€ä¸ªäº‹åŠ¡ä¸­çš„æ“ä½œè¿‡å¤šæ—¶ï¼Œå¯èƒ½ä¼šå½±å“æ•°æ®åº“çš„æ€§èƒ½ã€‚å½“äº‹åŠ¡è¿è¡Œæ—¶é—´è¿‡é•¿ï¼ˆé€šå¸¸æŒ‡çš„æ˜¯è¶…è¿‡ 30sï¼‰ï¼Œäº‹åŠ¡å¯èƒ½ä¼šè¢«è‡ªåŠ¨ç»ˆæ­¢ã€‚æ¨èå°†äº‹åŠ¡æ‹†åˆ†æˆæ›´å°çš„äº‹åŠ¡ï¼Œä»¥é˜²æ­¢è¿™äº›æƒ…å†µçš„å‘ç”Ÿã€‚
- é¿å…åœ¨è¿›è¡Œ DDL æ“ä½œæ—¶ï¼ˆä¾‹å¦‚ï¼šåˆ›å»ºç´¢å¼•ã€åˆ é™¤æ•°æ®åº“ï¼‰ï¼Œè¿›è¡Œäº‹åŠ¡æ“ä½œã€‚åœ¨ DDL æ“ä½œæœŸé—´ï¼Œå°è¯•è®¿é—®ç›¸å…³èµ„æºçš„äº‹åŠ¡æ— æ³•è·å¾—é”ï¼Œä»è€Œå¯¼è‡´æ–°äº‹åŠ¡ç»ˆæ­¢ã€‚
- åœ¨è¿›è¡Œä½¿ç”¨äº‘å¼€å‘æä¾›çš„ sdk æ“ä½œäº‹åŠ¡æ—¶ï¼Œæ¨èé…åˆ `try-catch` æ¥æ•è·å¼‚å¸¸ï¼Œä»è€Œå°½æ—©å‘ç°å’Œå¤„ç†å†™å†²çªã€ç½‘ç»œå¼‚å¸¸ç­‰é—®é¢˜ã€‚
