基于对个人隐私信息的保护，按照最小必要返回身份信息的要求，E证通服务不再返回姓名和身份证号的明文信息。如因业务需要返回，可以在控制台上申请加密的形式返回。


### 申请CSR证书
**1. 安装国密 SSL**
[打开 GMSSL 地址](https://github.com/guanzhi/GmSSL)，根据指引下载安装 [GmSSL-master.zip](https://github.com/guanzhi/GmSSL/archive/master.zip) ，根据 quick start 安装成功。
![](https://qcloudimg.tencent-cloud.cn/raw/0bf65124d94d0f801d358a4c0ede950e.png)
**2. 生成公私钥对**
```
gmssl ecparam -genkey -name sm2p256v1 -out CAkey.pem
```
**3. 查看并保留私钥** 

``` 
gmssl pkey -in CAkey.pem -noout -text
```

>!保留如下图私钥后续代码解密使用。
![](https://qcloudimg.tencent-cloud.cn/raw/81101ad201da6536e2713db3a9886ab9.png)

**4. 创建证书请求** 
```
 gmssl req -new -sm3 -key CAkey.pem -out CAcsr.pem
```
信息填写规范和说明如下图所示：
![](https://qcloudimg.tencent-cloud.cn/raw/a8e154f274fdfe6fabf376cda7028959.png)

**5. 查看证书请求**
```
gmssl req -in CAcsr.pem -noout -text -subject
```
至此，证书请求制作完成，请将 CAcsr.pem 文件上传 [控制台](https://console.cloud.tencent.com/faceid/access?tab=eid)，CAkey.pem（私钥）请自行妥善保管。


**6. 其他说明**
制作 CA 证书请求也可以通过这个 [在线工具](https://myssl.com/csr_create.html) 在线制作，但安全性方面不能得到保障，请谨慎选择。
>?
- 使用此方法生成 CA 请求，信息填写规范请对照本文1.4部分填写内容说明填写（域名部栏填写公司名称）。
- “证书类型”请选择“国密 SSL”。
- 公私钥信息请妥善保管。



### 申请实名信息返回

 登录腾讯云 [人脸核身控制台](https://console.cloud.tencent.com/faceid)，单击**自助接入**>**E证通服务**，在E证通服务列表右侧操作栏中单击**申请返回身份信息**。
 将**CA证书申请表**和 **CSR(证书签名请求)文件**上传到控制台，确认后单击**提交**进行申请。



### 解密 Demo
在拉到核身结果后，EidInfo 中会有 DesKey 和 UserInfo，需要使用上面生成私钥解密。解密过程如下：
- 使用 SM2 和上面生成的私钥对 DesKey（Base64 decde成字节数组）解密获得“会话密钥”。
- 使用会话密钥和sm4算法 ecb 模式（无填充）解密获得明文字符串。
- 字符串格式为{"name":"姓名","idtype":"01（代表身份证）","idnum":"身份证号"}。

#### 解密代码
GO 代码示例：
```
// require github.com/tjfoc/gmsm v1.4.1    或者go get github.com/tjfoc/gmsm

	import(
		"github.com/tjfoc/gmsm/sm2"
		"github.com/tjfoc/gmsm/sm4"
		"github.com/tjfoc/gmsm/x509"
	)
	
const privateKey = "f9b587743f051b1e59efa05125f31b5bf371957bf3d3012c1739091334b73738"
const DesKey = "xxx"
const UserInfo = "xxx"

func decode() {
   pb, err := x509.ReadPrivateKeyFromHex(privateKey) //上述私钥16进制
   fmt.Println(pb, err)
   dek, err := base64.StdEncoding.DecodeString(DesKey)
   sessionKey, err := sm2.Decrypt(pb, dek, 0)
   info, _ := base64.StdEncoding.DecodeString(UserInfo)
   out, err := sm4.Sm4Ecb(sessionKey, info, false)
   fmt.Println(string(out), err)
}
```

Java 代码示例：
```
<dependency>
   <groupId>org.bouncycastle</groupId>
   <artifactId>bcprov-jdk15to18</artifactId>
   <version>1.69</version>
</dependency>
<dependency>
   <groupId>cn.hutool</groupId>
   <artifactId>hutool-all</artifactId>
   <version>5.7.15</version>
</dependency> 

// hutool-all 工具类使用最新版本即可。
// bouncycastle 请使用与当前JDK相对应的版本。

    private static final String PrivateKeyHex = "f9b587743f051b1e59efa05125f31b5bf371957bf3d3012c1739091334b73738";
    private static final String DesKey = "xxx";
    private static final String UserInfo = "xxx";

    public void DecodeUserInfo() {
        byte[] desKeyBytes = Base64.decode(DesKey);
        final SM2 sm2 = new SM2(PrivateKeyHex, null, null);
        sm2.usePlainEncoding();

        byte[] sm4KeyBytes = sm2.decrypt(desKeyBytes);

        SymmetricCrypto sm4 = SmUtil.sm4(sm4KeyBytes);

        byte[] plaintext = sm4.decrypt(Base64.decode(UserInfo));
        System.out.println(new String(plaintext));
    }
```




