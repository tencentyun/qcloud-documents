## 自动扩缩容
如果您的业务负载有显著的峰谷特征，为了提升推理算力资源的利用效率，您可以使用在线服务模块的自动扩缩容能力。该功能支持在线服务的实例数量根据您配置的扩缩容策略自动调整，从而实现在业务负载高峰时实例数量自动扩容，在业务负载低谷时实例数量自动缩容。
自动扩缩容支持两种类型的调节策略：基于时间调节、基于HPA调节，下文将详细介绍两种调节策略的使用方法。

### 基于时间调节
如果您的业务负载有显著的时间特征，则可以根据时间进行自动扩缩容策略的配置。
1.  如何开启定时扩缩容
	1. 登录 TI-ONE 控制台，在左侧导航栏中选择**模型服务** > **在线服务**，进入在线服务列表页面；
	2. 在服务列表中找到需要开启定时扩缩容策略的服务，单击**服务名称**，进入版本列表页面，单击**更新**进入服务详细配置更新页面，或者单击**扩缩容**进入实例调节弹窗；
![](https://qcloudimg.tencent-cloud.cn/raw/a5b456751f0afda22417e7400a913d34.png)
	3. 服务详细配置中，将“实例调节”字段的选项设置为“自动调节”，调节策略类型选择“基于时间”，即可进行时间调节策略的规则配置；
	4. 您可以根据实际业务负载的时间特征自行配置多条定时策略规则，例如若8:00至20:00为业务高峰时段，20:00至8:00为业务低谷时段，则可以配置如下图的定时策略，每日8:00将实例数扩容至2，每日20:00将实例数缩容为1（默认策略为服务启动后的初始实例数量）；
![](https://qcloudimg.tencent-cloud.cn/raw/436c53d5191bd5938687bb503b3cd8a5.png)
	5. 若您配置了多条定时策略规则，且多条规则之间存在时间冲突，则会以优先级级别较高（即优先级排序靠前）的策略为准；
	6. 完成扩缩容策略的内容配置后，点击“更新服务”即可进行配置信息保存，待服务完成更新后，您所配置的自动扩缩容策略即会生效。
2.  例外时间配置规则
	1. 若某个定时策略希望在特定的时间不执行，则可以为该定时策略规则配置例外时间，支持添加多个；
	2. 例外时间需通过 Cron 表达式进行配置，Cron 表达式共包含6位，分别代表“秒”“分”“时”“日”“月”“星期”，若特定位的取值为任意值则使用星号(\*)即可，若特定位取值需包含连续多个数值则可以使用连字符(-)，若特定位取值需包含多个离散数值则可以使用逗号(,)；
	3. 例外时间的最小配置粒度是日，因此 Cron 表达式的前三位取值需要使用“\*”（前三位配置其他值不会生效），后三位取值可按需配置，第4位“日”的可用值范围为1-31，第5位“月”的可用值范围为1-12或 JAN-DEC，第6位“星期”的可用值范围为0-6或 SUN-SAT；
	4. 例如：每年10月1日至10月7日的 Cron 表达式为“\* \* \* 1-7 10 *”。
![](https://qcloudimg.tencent-cloud.cn/raw/bcf92bf393093194ed0f8b2b182bb4a6.png)

### 基于 HPA 调节
如果定时调节不适合于您的业务模式，您也可以选择“基于 HPA” 的自动扩缩容调节策略，在该策略下，服务实例数量可根据您所配置的策略指标与指标阈值，在实例数的最小值与最大值之间自动进行调节。策略指标支持 CPU 使用率、GPU 使用率、单实例 QPS 等。
![](https://qcloudimg.tencent-cloud.cn/raw/5dddf90a89103df97be60c08e1a0b03d.png)

### 混合计费模式下的调节策略
若您的在线服务使用了“预付费+后付费”的计费模式，则该服务需要为预付费算力、后付费算力分别设置服务实例数量。该计费模式下，后付费实例数支持根据时间策略进行自动调节，从而实现稳定的业务负载通过预付费算力支撑，不稳定的业务负载通过后付费算力支撑，业务负载高峰过后，后付费算力占用可以缩容到0，从而实现更低成本的算力资源使用策略。




## 流量分配      
为了满足灰度验证或者A/B测试类的服务使用诉求，平台支持用户为单个服务添加多个版本，并进行流量分配。  
1. 登录 TI-ONE 控制台，在左侧导航栏中选择**模型服务 > 在线服务**，进入在线服务列表页面。  
2. 找到需要测试的服务，单击服务的**新增版本**操作，打开服务版本创建页，按需配置当前服务版本的容器信息及实例调节信息。   
![](https://qcloudimg.tencent-cloud.cn/raw/5d1f57802a9ee5d9642c6dc4d5bcc818.png)   
3. 单击**启动服务**，若为后付费模式则需进行费用冻结确认，即可完成新版本创建。  
4. 创建新的服务版本后，系统将为您创建网关后端并调度计算资源，需要等待一段时间，待服务版本成功完成部署时，状态将变为**运行中**。  
5. 此时可单击服务版本列表上方的**流量分配**操作，进行多版本流量比例的设置。  
![](https://qcloudimg.tencent-cloud.cn/raw/3bb13b5431980e657f3c3212cc972fac.png)  

## 服务监控  
为了满足服务运行情况追踪的诉求，平台提供服务数据监控、调用数据监控、事件与日志查看能力。  
1. 在线服务列表页面，单击**服务名称**进入版本列表页后，单击**服务调用>调用监控**，可查看服务调用情况的统计信息，包括接收请求数、成功请求数、失败请求数、被限制请求数、平均响应时间。   
![](https://qcloudimg.tencent-cloud.cn/raw/906b69bb12830c37eb6bc59f239186a8.png)  
2. 在线服务列表页面，单击**服务名称**进入版本列表页后，单击**服务版本名称**进入版本详情页面，可查看服务监控（实例数量、运行中实例数量、CPU使用率、MEM使用率、GPU使用率、显存使用率、网路流量、QPS和QPS限流）、事件监控、运行日志。  
![](https://qcloudimg.tencent-cloud.cn/raw/315ff7b0966350cf5a46461dba0963f2.png)  
![](https://qcloudimg.tencent-cloud.cn/raw/c10408930823cafb4064b21f4154018c.png)  
![](https://qcloudimg.tencent-cloud.cn/raw/a4323cd013c46afb7a8a608e5e0b6522.png)  

## 服务更新  
已部署的服务支持更新实例调节信息用于调整扩缩容策略，支持更新实例容器信息用于更新迭代模型，且在多实例的情况下更新服务时，后台会对多实例进行分批滚动更新，不影响生产业务对模型服务的调用。  
1. 在线服务列表页面，单击服务名称进入版本列表页后，单击服务版本**更新**操作进入服务更新页面。支持编辑修改实例容器、实例调节模块的相关信息。  
![](https://qcloudimg.tencent-cloud.cn/raw/a5b456751f0afda22417e7400a913d34.png)     
2. 若需进行服务扩缩容操作，可直接点击**扩缩容**进行快捷实例更新操作。  
3. 若需更新模型信息，可在实例容器模块修改模型文件或运行环境。  
4. 配置信息确认无误后，单击**启动服务**完成服务参数配置的更新操作。  
5. 在服务版本列表页单击**服务版本名称**，进入**更新记录**模块，可查看当前服务版本历史的更新记录信息。  
![](https://qcloudimg.tencent-cloud.cn/raw/36140a48b2795254282f75d9098674a5.png)

