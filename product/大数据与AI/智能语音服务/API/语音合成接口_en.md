## Overview

Speech synthesis service provides text to speech conversion capability with a variety of tone and speed choices.

This service is provided via the Restful API. After you upload the Chinese text to synthesize through the API, the system will immediately synthesize it on the cloud, and then return the synthesized speech.

Speech synthesis achieves machine-human voice interaction by making applications "speak", thus simplifying the human-machine interaction. This service applies to radio broadcasting, audio novels, intelligent vehicles, and so on.

## Restful API
The request structure of RESTful API for speech synthesis is as follows:

| Parameter Name | Required | Type | Description | 
| ------------- | ---------- | ------------- | ---------- |
| Version | Yes | String | HTTPS protocol version | 
| URL | Yes | String | HTTPS request address | 
| Https Headers | Yes | Dataset | HTTPS request header | 
| Https Method | Yes | String | HTTPS request method, which is POST
| Https Body | Yes | String | HTTPS request body | 

The URL structure is as follows:
```
https://aai.qcloud.com/tts/v1/<appid>?
projectid=xxx&
sub_service_type=xxx&
speech_format=xxx&
volume=xxx&
person=xxx&
speed=xxx&
secretid=<secretid>&
timestamp=xxx&
expired=xxx&
nonce=xxx
```

The description of the fields in the URL is as follows (the value of each field needs to be URL-encoded):

| Field | Required | Type | Description | 
| ------------- | ---------- | ------------- | ---------- |
| appid | Yes | Uint | Tencent Cloud application ID | 
| projectid | No | Uint | Tencent Cloud project ID. If the field is left empty (0), the default project is used. The ID should not exceed 1,024 bytes. | 
| sub_service_type | Yes | Uint | Subservice type. 0: Real-time synthesis of short text, which is the only supported type. | 
| speech_format | Yes | String | The format of synthesized speech, which only supports MP3 | 
| volume | Yes | Uint | Volume. Value range: 0 -10. Default is 5. |
| person | Yes | Uint | Speaker. 0: female voice |
| speed | Yes | Uint | Speed of speech. Default is 0. Value range: -40 to 40; 1 indicates 1.1 times the speed, and -1 indicates 1.1 times slower than the normal speed |
| secrettid | Yes | String | The SecretId obtained from the official cloud API key |
| timestamp | Yes | Uint | Current timestamp (in sec). It is a value that aligns with the UNIX Epoch timestamp specifications. | 
| expired | Yes | Uint | Validity period of the signature (in sec). It is a value that aligns with the UNIX Epoch timestamp specifications. "expired" must be greater than "timestamp" and the interval between "expired" and "timestamp" must be less than 90 days. |
| nonce | Yes | Uint | Random positive integer with a maximum length of 10 digits. It needs to be generated by users. |

The structure of HTTPS Headers is as follows:

| Parameter Name | Required | Type | Description | 
| -------- | ------ | ------- | ------ |
| Host | Yes | String | Speech recognition service domain name. It is always ``aai.qcloud.com ``. | 
| Authorization | Yes | String | A valid signature of the user for authentication. It corresponds to the signature string obtained in signature authentication. | 
| Content-Type | Yes | String | multipart/form-data | 
| Content-Length | Yes | Int | Request Length. Here is the total number of bytes in the https body. It is utf-8-encoded text data with a maximum length of 1,024 bytes. | 

### Request Example

In the following example, <arrow brackets> enclose the variable that must be replaced with a valid value. The request Host and path are as follows:
```
https://aai.qcloud.com/tts/v1/<appid>?
```
Request Parameters: 
```
{
"projectid":"0",
"sub_service_type":"0",
"speech_format":"mp3",
"volume":"3",
"person":"0",
"speed":"0",
"secretid":"AKIDlfdHxN0ntSVt4KPH0xXWnGl21UUFNoO5",
"timestamp":"1484109983",
"expired":"1484113583",
"nonce":"1675199141"
}
```
Taking < appid > = 20170111, < SecretKey >=oaYWFO70LGDmcpfwo8uF1IInayysGtgZ as an example, the combined original signature text is:
```
POSTaai.qcloud.com/tts/v1/20170111?expired=1484113583&nonce=1675199141&person=0&projectid=0&secretid=AKIDlfdHxN0ntSVt4KPH0xXWnGl21UUFNoO5&speech_format=mp3&speed=0&sub_service_type=0&timestamp=1484109983&volume=3
```
Encrypt the original signature:
```
Base64Encode(HmacSha1(Original signature text, SecretKey))
```
The result signature string is as follows:
```
HRCKlbwPhWtVvfGn914qE5O1rwc=
```
Request headers:
```
{
"Content-Type":"multipart/form-data",
"Authorization":"HRCKlbwPhWtVvfGn914qE5O1rwc="
}
```

## Structure of Returned Value

### Returned Result from RESTful API

The returned results from RESTful API for text to speech conversion are shown in the following table:

| Name | Type | Description | 
| ------------- | ---------- | ------------- | 
| code | Int | Server error code. 0: successful |
| message | String | Message returned by server |
| speech | String | Base64-encoded synthesized speech data |

### Example of Returned Result
 An example of the returned message is as follows:
```
 {
 "code":0, 
 "message":"success",
 "speech": "xxxxxxx"
 }
```

## Error Codes

Error codes are as follows:

| Code | Description |
|---------|---------|
| 0 | Successful |
| 100 | Failed to obtain text |
| 101 | The number of text bytes exceeds the limit |
| 102 | Invalid parameter |
| 103 | Invalid APPID |
| 104 | The template does not exist |
| 105 | Authentication failure |
| 106 | Incorrect IP of backend CVM |
| 107 | Backend CVM timeout |
| 108 | Backend CVM Failure |
| 109 | Synthesized result is empty |
| 110 | Incorrect format of synthesized result package |
| 111 | Empty text |
| 112 | Failed to transcode the text |
| 1000 | Incorrect format of backend receiving package |
| 1001 | Character set not supported |
| 1002 | Failed to synthesize the speech |
| 1003 | Failed to transcribe the speech |

## Python Sample Code
```python
#!/usr/bin/python
# coding: UTF-8

import requests
import time
import random
import hmac, hashlib, base64
import json

appid = 0
secret_id = 'your_secret_id'
secret_key = 'your_secret_key'

args = {
        'secretid': secret_id,
        'projectid': 0,
        'sub_service_type': 0,
        'speech_format': 'mp3',
        'volume': 2,
        'person': 0,
        'speed': 0,
        'timestamp': int(time.time()),
        'expired': int(time.time()) + 60 * 60,
        'nonce': random.randint(1048576, 104857600),
}

query_str = "&".join(["%s=%s"%(k,args[k]) for k in sorted(args.keys())])
calc_str = "POSTaai.qcloud.com/tts/v1/%(appid)s?%(query_str)s"%vars()
hashed = hmac.new(secret_key, calc_str, hashlib.sha1)
headers = {"Authorization": base64.b64encode(hashed.digest())}

url = "http://aai.qcloud.com/tts/v1/%(appid)s?%(query_str)s"%vars()
upload_file = "hello.txt"
files = {"file": open(upload_file, "rb")}
resp = requests.post(url=url, files=files, headers=headers)
resp = json.loads(resp.text)
data = base64.b64decode(resp["speech"])

f = open("hello.mp3", "w")
f.write(data)
f.close()
```

## PHP Sample Code
```php
<?php
ini_set("display_errors", "1");
error_reporting(E_ALL);
$serverIp = "aai.qcloud.com";
$serverPort = 80;

$appid = YOUR_APPID;
// Obtain secretId and secretKey -> https://console.cloud.tencent.com/capi
$secret_id = 'YOUR_SECRET_ID';
$secret_key = 'YOUR_SECRET_KEY';

$query_arr = array(
    'secretid' => $secret_id,
    'projectid' => 0,
    'sub_service_type' => 0,
    'speech_format' => 'mp3',
    'volume' => 2,
    'person' => 0,
    'speed' => 0,
    'timestamp' => time(),
    'expired' => time() + 60 * 60,
    'nonce' => rand(),
);

ksort($query_arr);
$query_str = "";
foreach($query_arr as $key => $val) {
    $query_str .= "$key=$val&";
}
$query_str = trim($query_str, "&");

// Calculate the signature
$sign_str = "POSTaai.qcloud.com/tts/v1/$appid?$query_str";
$signature = base64_encode(hash_hmac('SHA1', $sign_str, $secret_key, TRUE));

// Request body, in multipart/form-data format
$form_boundary = "----WebKitFormBoundarybS1Fvrpes3yfBSvu";
$body_str = "--$form_boundary\r\n";
$body_str .= "Content-Disposition: form-data; name=".'"'."test1".'"'."; filename=".'"'."test_upload.txt".'"'."\r\n";
$body_str .= "Content-Type: application/octet-stream\r\n";
$body_str .= "\r\n";
$body_str .= "Hello\r\n";
$body_str .= "--$form_boundary\r\n";
$body_str .= "Content-Disposition: form-data; name=".'"'."test2".'"'."; filename=".'"'."debug.log".'"'."\r\n";
$body_str .= "Content-Type: application/octet-stream\r\n";
$body_str .= "\r\n";
$body_str .= "It's foggy and hazy. You'd better stay inside\r\n";
$body_str .= "--$form_boundary\r\n";
$body_str .= 'Content-Disposition: form-data; name="submit"'."\r\n";
$body_str .= "\r\n";
$body_str .= "Submit\r\n";
$body_str .= "--$form_boundary--\r\n";

$req = "POST /tts/v1/$appid?$query_str HTTP/1.1 \r\n";
$req .= "Host: aai.qcloud.com\r\n";
$req .= "Authorization: $signature\r\n";
$req .= "Content-Type: multipart/form-data; boundary=$form_boundary\r\n";
$req .= "Content-Length: ";
$req .= strlen($body_str);
$req .= "\r\n\r\n";
$req .= $body_str;
echo "=================== req start ===================\n";
echo "$req\n";
echo "=================== req end ===================\n";
$socket = socket_create(AF_INET, SOCK_STREAM, SOL_TCP);
if($socket < 0){
    echo "socket_create failed : ".socket_strerror($socket)."\n";
    return ;
}
$res = socket_connect($socket, $serverIp,$serverPort);
if($res < 0){
    echo "socket_connect failed : ".socket_strerror($res)."\n";
    return ;
}
$res = socket_write($socket,$req,strlen($req));
if(!$res){
    echo "socket_write failed : ".socket_strerror($socket)."\n";
    return ;
}
$rsp = "";
while($tmprsp = socket_read($socket,8192)){
    $rsp .= $tmprsp;
}
echo "=================== resp ===================\n";
echo "rsp :\n".$rsp."\n";
socket_close($socket);
```
