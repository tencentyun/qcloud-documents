## 功能介绍
在集群业务发生增长或下降时，可以使用自动伸缩功能，自动增加或减少 Task 节点，在满足集群计算能力的同时节约成本。自动伸缩支持按负载伸缩和时间伸缩两种伸缩策略。

## 前提条件
1. 自动伸缩功能只能对 Task 节点进行扩容或缩容。
2. 自动伸缩功能只支持 Hadoop 类型的集群。
3. 负载伸缩和时间伸缩策略，只能二选一不能同时使用。

## 操作步骤
登录 [EMR 控制台](https://console.cloud.tencent.com/emr) 在集群列表中单击集群 **ID/名称**，进入集群详情页面后，选择**自动伸缩 > 基础设置 > 编辑**配置自动伸缩功能相关触发策略。
![](https://main.qcloudimg.com/raw/caea2748caa5459f5f6075f7003197cf.png)


### 基础设置
策略限制用于配置自动伸缩规则触发时集群可保留的弹性 task 节点数量。
- 最小实例数：自动缩容策略触发时，集群最少保留弹性伸缩的 task 节点数。
- 最大实例数：自动扩容策略触发时，集群最多保留弹性伸缩的 task 节点数，单条或多条规格累计扩容数不能超过最大实例数。
![](https://main.qcloudimg.com/raw/2ca7723e90cf196510fa1eaf69c14fd1.png)
- 全部释放：是指一键清除自动伸缩扩容出来的全部节点，非自动伸缩的节点不受影响。
- 释放竞价实例：是指仅一键清除自动伸缩扩容出来的竞价实例节点，非竞价实例资源节点不受影响。
- 释放按量计费实例：是指一键清除自动伸缩扩容出来的按量计费实例节点，非自动伸缩出的按量计费节点不受影响。

 
### 设置伸缩规格
伸缩规格是指通过自动伸缩可以扩容的节点规格，每个集群最多可配置3种伸缩规格，伸缩规格设置支持按量计费和竞价实例。扩容规则触发时将根据规格优先级进行扩容，当高优先级规格小于扩容节点数时，将选择扩容次优先级的规格进行扩容。为了保持集群负载的线性变化，建议尽量使伸缩规格的 CPU 和内存保持一致。
- 伸缩规格最多支持三种实例，扩容优先级顺序为1＞2＞3。
- 伸缩规格中的实例支持增、删、改、查，可按需调整伸缩规格优先级。

![](https://main.qcloudimg.com/raw/a4246856b8119b72c606ec9aa9940444.png)
![](https://main.qcloudimg.com/raw/5c298076f93776f9c994ac5c86e78013.png)
![](https://main.qcloudimg.com/raw/e76c67f93cf762028a15c886c4bd4542.png)

### 设置伸缩规则
伸缩规则是配置扩缩容动作触发条件以及变化节点数量的业务策略，支持按负载伸缩和时间伸缩两种伸缩策略（这两种策略只能二选一，不能同时使用）。策略切换时，原伸缩规则会保留，但处于失效状态，不会被触发执行。当前已扩容的节点也会保留，除非缩容规则触发，否则不会被缩容。每种策略最多可配置10条伸缩规则，当两条规则同时触发时，会先执行优先级较高的规则。
![](https://main.qcloudimg.com/raw/31e373a4ae8274bf20e97d310e1c1c37.png)

设置伸缩规则，需要在**伸缩规则管理**模块，选择**自动伸缩类型**为负载伸缩或时间伸缩，然后单击**添加规则**即可。
![](https://main.qcloudimg.com/raw/e0ef5cfef4ee497442c8257912e392df.png)
  
#### 负载伸缩
无法准确的预估集群计算的波峰和波谷时，为确保重要作业按时完成，可使用按负载伸缩进行策略配置。负载主要基于预设 YARN 的指标统计规则，触发预设条件时自动调整 task 节点。

添加负载伸缩规则，需要选择**自动伸缩类型**为负载伸缩，然后单击**添加规则**，在“新建规则”页面，配置如下内容：
- 规则名称：伸缩规则的名称，在一个集群中，伸缩规则名称不允许重复（包括扩容规则和缩容规则）。
- 有效时间：仅在有效时间内触发负载伸缩规则；默认时间范围选择**不限制**，支持自定义时间段按负载进行伸缩规则配置。    
- 负载指标：根据选定的集群负载指标设置触发阈值的条件规则，此处指 YARN 的负载指标。
<table>
<thead>
<tr>
<th><strong>EMR-自动伸缩指标</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>AvailableVCores#root</td>
<td>Root 队列可用虚拟核数的数量</td>
</tr><tr>
<td>PendingVCores#root</td>
<td>Root 队列等待可用的虚拟核数</td>
</tr><tr>
<td>AvailableMB#root</td>
<td>Root 队列可用内存数量（MB）</td>
</tr><tr>
<td>PendingMB#root</td>
<td>Root 队列等待可用的内存数量（MB）</td>
</tr><tr>
<td>AvailableMemPercentage</td>
<td>剩余内存的百分比</td>
</tr><tr>
<td>ContainerPendingRatio</td>
<td>待分配的容器数与已分配的容器数的比率</td>
</tr><tr>
<td>AppsRunning#root</td>
<td>Root 队列运行中的任务数</td>
</tr><tr>
<td>AppsPending#root</td>
<td>Root 队列挂起的任务数</td>
</tr><tr>
<td>PendingContainers#root</td>
<td>Root 队列待分配的容器数</td>
</tr><tr>
<td>AllocatedMB#root</td>
<td>Root 队列已分配的内存量</td>
</tr><tr>
<td>AllocatedVCores#root</td>
<td>Root 队列已分配的虚拟核数</td>
</tr><tr>
<td>ReservedVCores#root</td>
<td>Root 队列预留的虚拟核数</td>
</tr><tr>
<td>AllocatedContainers#root</td>
<td>Root 队列已分配的容器数</td>
</tr><tr>
<td>ReservedMB#root</td>
<td>Root 队列预留的内存量</td>
</tr><tr>
<td>AppsKilled#root</td>
<td>Root 队列终止的任务数</td>
</tr><tr>
<td>AppsFailed#root</td>
<td>Root 队列失败的任务数</td>
</tr><tr>
<td>AppsCompleted#root</td>
<td>Root 队列完成的任务数</td>
</tr><tr>
<td>AppsSubmitted#root</td>
<td>Root 队列提交的任务数</td>
</tr><tr>
<td>AvailableVCoresPercentage#root</td>
<td>Root 队列可用虚拟核数百分比</td>
</tr>
</tbody></table>
- 统计规则：用户选定的集群负载指标在一个统计周期内，按照选定的聚合维度（平均值），达到触发阈值为一次触发。
- 统计周期：指标的统计时长，目前支持三个统计周期分别为：300秒、600秒、900秒。
- 重复次数：负载指标聚合后达到阈值触发的次数，达到该次数后触发集群弹性伸缩的动作。
- 扩容数量：规则被触发时，每次执行增加的弹性 Task 节点数量。
- 缩容数量：规则被触发时，每次执行减少的弹性 Task 节点数量。
- 冷却时间：当前规则执行成功后，再次启动执行下一次自动伸缩动作的间隔时间（冷却时间的范围600 - 43200秒）。
- 规则状态：规则状态用于标记规则是否开启，默认为开启状态，当不需要规则运行但仍想保留规则配置时可将规则状态设置为关闭。     

![](https://main.qcloudimg.com/raw/968be2d78d95a58fdb6e4ef09ab80944.png)

#### 时间伸缩
集群计算量存在一定周期内的明显波峰和波谷，为确保重要作业按时完成，可以使用时间伸缩进行策略配置。时间伸缩策略可以设置在每天、每周或每月的固定时间段添加或减少 task 节点。

添加时间伸缩规则，需要选择**自动伸缩类型**为时间伸缩，然后单击**添加规则**，在“新建规则”页面，配置如下内容：
- 规则名称：伸缩规则的名称，在一个集群中，伸缩规则名称不允许重复（包括扩容规则和缩容规则）。
- 执行一次：指特定的时间进行触发伸缩动作，精确到分钟。
- 重复执行：指设定每个时间段或特定的时间触发伸缩动作，分别支持“每日”、“每周”、“每月”。
- 过期重试时间：弹性伸缩在到达指定时间时可能由于各种原因不能执行，通过设置重试过期时间，系统会在该时间范围内每隔 30 秒尝试执行一次，直到在满足条件时执行伸缩。
- 规则有效期：在时间伸缩规则中，单条规则触发最长有效期。
- 扩容数量：规则被触发时，每次执行增加的弹性 Task 节点数量。
- 缩容数量：规则被触发时，每次执行减少的弹性 Task 节点数量。
- 冷却时间：当前规则执行成功后，再次启动执行下一次自动伸缩动作的间隔时间（冷却时间的范围600 - 43200秒）。
- 规则状态：规则状态用于标记规则是否开启，默认为开启状态，当不需要规则运行但仍想保留规则配置时可将规则状态设置为关闭。
- 优雅缩容：开启优雅缩容模式后，如果缩容动作触发时节点正在执行任务，节点不会立即释放，而是在自定义时间内等待任务执行完成后进行缩容；若自定义时间结束时任务未执行完成也将进行缩容。

![](https://main.qcloudimg.com/raw/ed6253002f64f4faf8230311e159a913.png)

### 查看自动伸缩记录
伸缩记录可查看自动伸缩活动的执行记录等信息。
- 可按执行时间段筛选伸缩记录，并且支持按策略名称进行查找。
- 按时间顺序排列展示，执行时间、策略名称、伸缩类型、执行状态，在操作类型下单击**详情**可查看详细信息。
- 自动伸缩的执行状态包括以下四类：
 - 执行中：自动伸缩活动正在执行。
 - 成功：根据伸缩规则，所有自动伸缩中的所有节点被加入或移出集群。
 - 部分成功：根据伸缩规则，有部分节点成功被加入或移出集群，但是受磁盘配额管理或 cvm 库存的影响，部分节点执行失败。
 - 失败：根据伸缩规则，没有一个节点被加入或移出集群。
