## 功能简介

腾讯云文档转码服务为您提供了将文件转码为 `HTML5`页面和图片的能力，将转码后的文档展示于白板，为您提供和线下教育体验高度一致的在线教育服务。

## <span id="jump1">服务开通</span>

若您能还没开通文档转码服务，请按照 [购买指南](https://cloud.tencent.com/document/product/680/34356) 发送邮件申请开通。

## 服务接入

### 基本流程

文档转码服务接入有两种方式，一种为主动轮询（较适用于客户端发起转码请求），一种为注册 CGI 接口回调（较适用于服务端发起转码请求）。两种接入方式的基本使用流程如图所示：

#### 主动轮询

![主动轮询](https://main.qcloudimg.com/raw/b68d5f5531262a91806e3862611a2cd6/%E6%96%87%E6%A1%A3%E8%BD%AC%E7%A0%81%E4%B8%BB%E5%8A%A8.png)

#### 注册 CGI 接口回调

![注册CGI接口回调](https://main.qcloudimg.com/raw/73fc644b99182750a43b4b725aa5580f/%E6%96%87%E6%A1%A3%E8%BD%AC%E7%A0%81CGI.png)

### 鉴权签名算法

所有转码请求调用都需要带上签名以便服务器鉴权，签名算法如下：

```
sign = md5(TicKey+expire_time)
```

| 参数名      | 描述                             |
|:------------|:---------------------------------|
| TicKey      | [服务开通](#jump1) 中获取的密钥 TicKey           |
| expire_time | Unix 时间戳，单位秒，签名过期时间 |

 签名举例：
1. 当前时间戳是 `1548247717`；
2. 签名有效时间是 `120` 秒，则过期时间戳是 `expire_time = 1548247717 + 120 = 1548247837`；
3. `tic_key = 9016607A382749C69D4F4B00C61DD083`；
4. 计算签名：`sign = md5(9016607A382749C69D4F4B00C61DD0831548247837) = 5400bac77ba6467a8f8ac056f1769f45`；
5. 在请求 URL 参数中，带上`expire_time`字段，值为`1548247837`。

GoLang 代码示例：

```go

func CalculateSign(ticKey string, expireTime int) string {
    // 获取签名过期时间为当前时间加上签名有效期
    // TicKey 为邮件中的回复的32位 TicKey，expireTime 是当前签名过期时间的 Unix 时间戳（单位秒）
    
    // 拼接 TicKey 与过期时间
    hashString := fmt.Sprintf("%v%v", ticKey, expireTime)
    // 计算拼接后字符串的 MD5 获得签名
    return GetMD5Hash([]byte(hashString))
}

func GetMD5Hash(data []byte) string {
    checksum := md5.Sum(data)
    return fmt.Sprintf("%x", checksum)
}
```

## 接口说明

### <span id="jump4.1">上传文档并获取链接</span>

发起转码时需要提供待转码文档的下载链接，转码服务将在文档下载完成后开始转码。您可以选择使用腾讯云对象存储上传文档并获取下载链接，也可以使用您自己的文件服务器，以下几点需要注意：

1. 目前只支持包含`http://`或`https://`前缀的 URL。
2. 请检查 URL 的访问权限，保证文档转码服务能正常访问并下载该文档原文件。如果您使用腾讯云对象存储（Cloud Object Storage，COS），请检查存储桶的访问权限为**公有读私有写**。您可以在腾讯云控制台设置存储桶的访问权限，具体请参考 [设置访问权限](https://cloud.tencent.com/document/product/436/13315)。
3. 如果您使用其他的文件存储服务，请注意文件存储服务的上传带宽，文档转码服务提供**1分钟**的下载时间，如果下载不成功本次的转码请求将以失败终止。
4. PPT 文档（后缀名为`.ppt`或`.pptx`）会转码结果为`HTML5`页面，其他文档会转码为图片。

### 请求文档转码

#### 接口说明

发布一个文档转码任务。

| 请求基本信息 | 描述                                               |
|:-----------|:--------------------------------------------------|
| 方法        | POST                                              |
| 请求 URL     | https://iclass.api.qcloud.com/transcode/v1/create |
| 请求 Header  | Content-Type:application/json                     |

#### 请求参数

URL 参数

| 参数名   | 描述                                              |
|:---------|:--------------------------------------------------|
| sdkappid | 客户的 sdkappid                                    |
| sign     | 用于鉴权的签名                                    |
| expire_time | 用于鉴权的签名过期时间，Unix 时间戳，单位秒       |
| random   | 随机 int32 正整数，每次请求都需要带上，用于定位问题 |

Body 参数（JSON 格式）

| 参数名       | 类型    | 描述                                |
|:------------|:-------|:-----------------------------------|
| url         | string | 在 [上传文档并获取链接](#jump4.1) 中获取的下载 URL，请检查 URL 的访问权限 |

请求示例：
请将参数替换为实际值。

```
请求URL：https://iclass.api.qcloud.com/transcode/v1/create?random=526919&sdkappid=1400127115&expire_time=1557202745&sign=d33bfea49d7f2795a4829c0d80047a7d
请求Header："Content-Type:application/json"
请求包体：
{
    "url": "http://e4fb-edu-1400127115-1257240643.cos.ap-shanghai.myqcloud.com/语文课.ppt"
}
```

>? 如果转码过程中出现文档下载失败相关的错误，请检查 URL 的访问权限，或者联系客服人员并提供 task_id 方便进行排查。

#### 接口返回参数

返回参数（JSON 格式）

| 参数名     | 类型   | 描述                                       |
|:-----------|:-------|:-------------------------------------------|
| error_code | int    | 错误码                                     |
| error_msg  | string | 错误信息                                   |
| task_id    | string | 任务的唯一标识 ID，用于查询该转码任务的进度 |

返回示例：

```json
{
    "error_code": 0,
    "error_msg": "ok",
    "task_id": "g68cee8e90jcq4ogg8jb"
}
```

### 查询转码任务进度

#### 接口说明

| 请求基本信息 | 描述                                          |
|:-------------|:----------------------------------------------|
| 方法         | POST                                          |
| 请求 URL      | https://iclass.api.qcloud.com/transcode/v1/query |
| 请求 Header   | Content-Type:application/json                 |


#### 请求参数

URL 参数

| 参数名   | 描述                                                                    |
|:---------|:------------------------------------------------------------------------|
| sdkappid | 客户的 sdkappid                                                          |
| sign     | 用于鉴权的签名                                                          |
| expire_time | 用于鉴权的签名过期时间，Unix 时间戳，单位秒       |
| random   | 随机 int32 正整数，每次请求都需要带上，定位问题时需要提供该次请求的 random |

Body 参数（JSON 格式）

| 参数名      | 类型   | 描述                  |
|:------------|:-------|:----------------------|
| task_id     | string | 文档转码任务的唯一标识 |

请求示例：
请将参数替换为实际值。

```
请求URL：https://iclass.api.qcloud.com/transcode/v1/query?random=526919&sdkappid=1400127115&expire_time=1557202745&sign=d33bfea49d7f2795a4829c0d80047a7d
请求Header："Content-Type:application/json"
请求包体：
{
    "task_id": "g68cee8e90jcq4ogg8jb"
}
```

#### 接口返回参数

返回参数（JSON 格式）

| 参数名      | 类型    | 描述                     |
|:-----------|:-------|:------------------------|
| error_code | int    | 错误码                   |
| error_msg  | string | 错误信息                 |
| task_id    | string | 任务的唯一标识 ID          |
| status     | string | 任务状态                 |
| progress   | int    | 0-100的整数表示转码当前进度 |
| result_url | string | 转码完成后结果 URL         |
| resolution | string | 文档的分辨率              |
| pages      | int    | 文档的总页数                 |
| title      | string | 文档的文件名              |

返回示例：

```json
{
    "error_code": 0,
    "error_msg": "ok",
    "task_id": "g68cee8e90jcq4ogg8jb",
    "status": "processing",
    "progress": 62,
    "result_url": "https://test04-1257240443.cos.ap-shanghai.myqcloud.com/05iftk0sb6b26k5uv7jb/index.html",
    "resolution": "1024x768",
    "pages": 20,
    "title": "test20-pages.pptx"
}
```

转码任务可能的状态如下所示：

| 状态     | 描述             |
|:-----------|:-----------------|
| queued     | 正在排队等待转换 |
| processing | 转换中           |
| finished   | 转换完成         |

>!文档转码服务需要耗时较长，因此转码任务可能需要短时间排队执行。

### 设置转码服务回调地址

#### 接口说明

| 请求基本信息 | 描述                                             |
|:-------------|:-------------------------------------------------|
| 方法         | POST                                             |
| 请求 URL      | https://iclass.api.qcloud.com/transcode/v1/callback |
| 请求 Header   | Content-Type:application/json                    |


#### 请求参数

URL 参数

| 参数名   | 描述                                                                    |
|:---------|:------------------------------------------------------------------------|
| sdkappid | 客户的 sdkappid                                                          |
| sign     | 用于鉴权的签名                                                          |
| expire_time | 用于鉴权的签名过期时间，Unix 时间戳，单位秒       |
| random   | 随机 int32 正整数，每次请求都需要带上，定位问题时需要提供该次请求的 random |

Body 参数（JSON 格式）

| 参数名       | 类型    | 描述                                                                                                           |
|:------------|:-------|:--------------------------------------------------------------------------------------------------------------|
| callback    | string | 文档转码进度回调地址，如果传空字符串会删除原来的回调地址配置，回调地址仅支持 http 或 https 协议，即回调地址以`http://`或`https://`开头 |

请求示例：
请将参数替换为实际值。

```
请求URL：https://iclass.api.qcloud.com/transcode/v1/callback?random=526919&sdkappid=1400127115&expire_time=1557202745&sign=d33bfea49d7f2795a4829c0d80047a7d
请求Header："Content-Type:application/json"
请求包体：
{
    "callback": "https://iclass.api.qcloud.com/task/callback"
}
```

##### 接口返回参数

返回参数（JSON 格式）

| 参数名     | 类型   | 描述     |
|:-----------|:-------|:---------|
| error_code | int    | 错误码   |
| error_msg  | string | 错误信息 |


返回示例：

```json
{
    "error_code": 0,
    "error_msg": "ok"
}
```

### 转码进度回调格式

#### 接口说明

如果您的业务服务器设置了回调地址，当转码任务进度有更新时，转码服务会主动往回调地址发送任务的转换进度。

- 业务服务器需对签名做校验，判断是否为有效请求。
- 业务服务器必须回包`{"error_code": 0}`，否则，转码服务认为回调发送失败后进行重试，每分钟重试1次，最多重试10次。


| 请求基本信息 | 描述                          |
|:-------------|:------------------------------|
| 方法         | POST                          |
| 请求 Header   | Content-Type:application/json |


#### 回调请求参数

URL 参数

| 参数名       | 描述                                                           |
|:------------|:--------------------------------------------------------------|
| sign        | 用于鉴权的签名，需对该签名做校验，判断是否为有效请求                   |
| expire_time | 用于鉴权的签名过期时间，Unix 时间戳，单位秒                          |
| random      | 随机 int32 正整数，每次请求都需要带上，定位问题时需要提供该次请求的 random |
| sdkappid    | 客户的 sdkappid                                                 |

Body 参数（JSON 格式）

| 参数名       | 类型    | 描述                           |
|:------------|:-------|:------------------------------|
| error_code  | int    | 错误码                         |
| error_msg   | string | 错误信息                       |
| timestamp   | int    | 回调发送的时间戳                 |
| task_id     | string | 任务的唯一标识 ID                |
| task_type   | string | 文档转码任务类型固定为`transcode` |
| status      | string | 任务状态                       |
| progress    | int    | 0-100的整数表示转码当前进度       |
| result_url  | string | 转码完成后结果 URL               |
| resolution  | string | 文档的分辨率                    |
| title       | string | 文档的文件名                    |
| pages       | int    | 文档的总页数                    |

回调示例：

```
回调URL：https://业务后台URL?random=526919&expire_time=1557202745&sign=d33bfea49d7f2795a4829c0d80047a7d&sdkappid=1400127140
回调Body：
{
    "error_code":0,
    "error_msg":"",
    "timestamp": 1553245423,
    "task_id": "9m4e2mr0ui3e8a215n4g",
    "task_type": "transcode",
    "status":"processing",
    "progress": 10,
    "result_url":"http://xxxxx/index.html",
    "resolution": "1024x768",
    "title": "test.ppt",
    "pages": 100
}
```

#### 回调地址返回参数

返回示例：

```json
{"error_code": 0}
```

## 支持转码格式
目前只支持：doc(x)、ppt(x) 和 pdf 文档；暂时不支持 excel 和 txt 文档转码。

## 后台错误码

#### 文档转码过程错误码

| 错误码 | 错误描述                        | 解决方法                  |
|:------|:-------------------------------|:-------------------------|
| 0     | 任务执行成功                     |         -                 |
| -1     | ppt 下载的 url 格式错误                 | 请检查 PPT 下载 URL                                         |
| -2     | ppt 打开过程中发生未知错误            | 请检查 PPT 格式是否正确                                    |
| -3     | ppt 打开超时                           | 请检查 PPT 格式是否正确                                    |
| -4     | ppt 打开无响应                        | 请检查 PPT 格式是否正确                                    |
| -5     | ppt 文件被加密                        | 不支持转换已加密的 PPT                                    |
| -6     | 未知 ppt 格式                           | 请检查 PPT 格式是否正确                                    |
| -7     | ppt 打开时发生异常                    | 请检查 PPT 格式是否正确                                    |
| -8     | ppt 为只读格式                        | 不支持只读 ppt，请检查 PPT 格式是否正确                     |
| -9     | ppt 转码失败                          | 请检查 PPT 格式是否正确                                    |
| -10    | pptx 格式解析错误                     | 请检查 PPT 格式是否正确                                    |
| -11    | ppt 下载失败，未知错误                | 请检查 ppt 下载 URL 是否有效                                 |
| -12    | h5 上传失败                           | 请联系客服人员或重试                                     |
| -13    | ppt 转换服务未加载                    | 请联系客服人员                                           |
| -14    | ppt 转码过程中，发生错误              | 请根据错误信息中的页数，检查该页中的元素或动画组合是否正确;</br>如果错误信息中，无具体页数“unknown page”，则代表无法获取某一页转换失败，该 ppt 不支持转换|
| -15    | ppt 转码文件生成失败                  | 请联系客服人员或重试                                     |
| -16    | ppt 转换模式异常                      | PPT 格式不支持或联系客服人员                              |
| -17    | ppt 超过最大的转换页数限制（目前为500） | 不支持转换超过500页的 PPT                                 |
| -18    | ppt 转换失败，错误未知                | ppt 格式不支持或联系客服人员                              |
| -19    | ppt 被加密                            | 不支持加密的 PPT                                          |
| -20    | ppt 未知属性错误                      | 请检查 PPT 格式是否正确                                    |
| -21    | ppt 检测属性超时                      | 请检查 PPT 格式是否正确                                    |
| -22    | ppt 转换异常                          | 请检查 PPT 格式是否正确或重试                              |
| -23    | ppt 下载链接含有非法字符              | 请检查 ppt 下载链接是否正确                                |
| -24    | ppt 下载链接打开失败                  | 请检查 ppt 下载地址是否有效                                |
| -25    | ppt 下载链接打开超时                  | 请检查 ppt下载链接是否有效或下载服务器网络状况          |
| -26    | ppt 下载数据失败                      | 请检查 ppt下载服务器网络状况                              |
| -27    | ppt 下载数据超时                      | 请检查 ppt下载服务器网络状况或是否 ppt 过大，导致下载超时 |
| -101  | task info 文件读取失败           | 请联系维护人员             |
| -102  | task info 格式不正确             | 请联系维护人员             |
| -103  | task info 的 error_code 不等于0 | 请联系维护人员             |
| -104  | task 的 url 为空                | 请联系维护人员             |
| -105  | task 的 下载url错误              | 请检查转码文件下载链接       |
| -106  | 不支持的文件名后缀                | 请检查文件名后缀名          |
| -107  | 文件下载失败，未知错误             | 请检查下载链接地址是否有效   |
| -108  | 下载链接非法                     | 请检查转码文件下载链接       |
| -109  | 下载链接打开失败                  | 请检查下载链接地址是否有效   |
| -110  | 下载链接打开超时                  | 请检查下载链接地址是否有效   |
| -111  | 下载失败                        | 请检查下载链接地址是否有效   |
| -112  | 下载超时                        | 请检查下载链接带宽          |
| -113  | 本地临时文件夹创建失败             | 请联系维护人员             |
| -114  | 文件上传转码后台失败              | 请联系维护人员             |
| -115  | cos 请求转码失败                 | 文件格式不支持             |
| -116  | cos 请求转码失败                 | 文件格式不支持             |
| -117  | cos 转码失败超时                 | 文件格式不支持             |
| -118  | cos 转码过程中失败               | 文件格式不支持             |
| -119  | 上传转码后的文件，到 cdn cos 失败  | 请联系维护人员或重试      |
| -120  | cos 转码，未知错误               | 文件格式不支持             |
| -121  | 超过最大页数                     | 不支持超过500页的文件转码   |
| -3001 | 转换失败或者任务创建失败.          | 文件格式不支持             |
| -3002 | 服务器过载，转换队列过长           | 请稍后重试转码             |
| -3003 | 转换超时                        | 文件格式不支持             |
| -3004 | 文件不存在                       | 请联系维护人员             |
| -3005 | 参数错误                        | 请联系维护人员             |
| -3006 | 文档加密                        | 不支持加密的文件转换         |
| -3007 | 强制结束，超时强制结束生成了部分数据 | 文件格式不支持             |
| -3008 | 文件长度为0                      | 文件格式不支持             |
| -3009 | 加载配置文件失败                  | 请联系维护人员             |
| -3010 | 请求信息组包失败                  | 请联系维护人员             |
| -3011 | 文档类型不支持                   | 文件格式不支持             |
| -3012 | pdf 文件转换失败                  | 文件格式不支持             |
| -3013 | 处理失败或者请求页超过             | 文件格式不支持             |
| -3014 | 转换成功读取失败                  | 请联系维护人员             |
| -3015 | 转换成功，但请求页超过了总页数      | 无                       |
| -3016 | 压缩文档转换失败                  | 无                       |
| -3017 | 文档传输中                       | 请稍后重试转码             |
| -3018 | 下载文件分片失败                  | 请稍后重试转码             |
| -3019 | 文件落地失败                     | 请稍后重试转码             |
| -3020 | 没找到相应的预览任务              | 请稍后重试转码             |

#### 请求错误码

| 错误码 | 错误描述           | 解决方法                                                      |
|:------|:------------------|:------------------------------------------------------------|
| 20000 | 客户未开通服务      | 请参考`服务开通`中流程发送邮件申请开通文档转码服务               |
| 20001 | 签名已过期          | 检查请求 URL 中的 expire_time 签名时间，更新过期时间后重新生成签名字符串 |
| 20002 | 签名校验失败        | 检查 TicKey 与签名算法是否正确                                    |
| 20003 | 参数解析失败        | 根据 error_msg 查询具体的请求参数异常信息，更正参数缺失/类型错误等     |
| 20004 | 设置回调地址格式错误 | 检查回调地址是否正确                                            |
| 20005 | 数据读取失败        | 请检查请求中的 TaskId 或联系客服人员                               |
| 20099 | 转码服务内部错误     | 请联系客服人员                                                 |

## ppt 演示文稿课件格式建议

1. 建议使用 Microsoft Office 2007 或以上版本（wps 和 keynote 都有一定的兼容性问题）。
2. 请勿使用不支持的四种 ppt 动效，包括：1：“Bold Flash”、2：“Underline”、3：“Grow With Color”、4：“Bold Reveal”。
3. 请勿插入 flash 动画，不支持 flash 动画播放。
4. 如果使用 wps，请注意不支持 WPS ppt 中的音视频元素。
5. 如果使用 keynote，请注意插入的音频播放标签，无法展示。
6. 建议使用操作系统默认的中英文字体，请勿使用自己安装的字体，否则可能会出现转码失败或者转码 h5 格式异常 [查看转码服务器支持字体](https://cloud.tencent.com/document/product/680/35951)。
7. ppt 页数不要过多，页数越多，转换速度越慢（目前最大支持500页转码）。
8. ppt 中如果带有音视频，体积尽量小，否则会影响转换速度和转换后的 h5 加载速度。

## 常见问题
1. ppt 转 h5 后，出现某些字体错位，或大小不一致，如何处理？  
问题原因：该问题一般是因为 ppt 中使用了转码服务器不支持的字体库导致的。[查看转码服务器支持字体](https://cloud.tencent.com/document/product/680/35951)。
解决方法（两个方法）：  
方法一：
去掉或更改字体为服务器支持的字体库。
操作指引：
打开 ppt，选择不支持字体的文字，然后切换到服务器支持的字体。
方法二：
ppt 保存时，将字体库一起打包进 ppt。
操作指引：
打开 ppt，选择【文件】>【选项】>【保存】，然后勾选【将字体嵌入文件】>【仅嵌入演示文稿中使用的字符(适于减小文件大小)】>【确定】保存 ppt，看到 PowerPoint 的底部状态栏，显示【正在嵌入字体】即可。
![保存字体](https://main.qcloudimg.com/raw/749786466e29a0afb8db26af51aded6e/powerpoint%E4%BF%9D%E5%AD%98%E5%AD%97%E4%BD%93-%E8%8C%83%E4%BE%8B.png)

2. 为什么有些 ppt 动效，转换为 h5 后，丢失了呢？  
问题原因：ppt 中使用了不支持转换的动效；包括：1：“Bold Flash”、2：“Underline”、3：“Grow With Color”、4：“Bold Reveal”。
解决方法：去掉不支持的特效或者使用其他特效替换。
3. 为什么有些 ppt 或 pptx 文件，本地 PowerPoint 预览正常；但是转码时，服务器返回错误“ppt may contain unsupported elements”？  
问题原因：ppt 的内容中含有一些不支持转码 h5 的元素，所以导致转码失败。
解决方法：如果是 pptx 格式文件，可以用 powerpoint 另存为 ppt 格式，然后重新尝试转码。
如果是 ppt 格式文件，可以用 powerpoint 另存为 pptx 格式，然后重新尝试转码
