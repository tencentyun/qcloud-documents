## 文件说明

### TIC 源码

| 文件名称 | 说明 | 位置 |
|---------|-----| ---- |
| TICManager.h | TIC 管理类 | TIC/Windows/SDK/TIC/TICManager.h |
| TICManager.cpp | TIC 管理类 | TIC/Windows/SDK/TIC/TICManager.cpp |
| TICManagerImpl.h | TIC 管理类实现 | TIC/Windows/SDK/TIC/TICManagerImpl.h |
| TICManagerImpl.cpp | TIC 管理类实现 | TIC/Windows/SDK/TIC/TICManagerImpl.cpp |
| TICRecorder.h | 录制相关功能实现 | TIC/Windows/SDK/TIC/TICRecorder.h |
| TICRecorder.cpp | 录制相关功能实现 | TIC/Windows/SDK/TIC/TICRecorder.cpp |
| HttpClient.h | HTTP 请求工具类 | TIC/Windows/SDK/TIC/HttpClient.h |
| HttpClient.cpp | HTTP 请求工具类 | TIC/Windows/SDK/TIC/HttpClient.cpp |
| NTP.h | NTP 协议请求对时工具类 | TIC/Windows/SDK/TIC/NTP.h |
| NTP.cpp | NTP 协议请求对时工具类 | TIC/Windows/SDK/TIC/NTP.cpp |
| jsoncpp | jsoncpp开源库 | TIC/Windows/SDK/TIC/jsoncpp |


### 依赖 SDK

| SDK 名称 | 说明 | 位置 |
|---------|-----| ---- |
| TEduBoard | 腾讯云白板 SDK | TIC/Windows/SDK/TEduBoard |
| TIM | 腾讯云通信 SDK | TIC/Windows/SDK/TIM |
| TRTC | 腾讯云实时音视频 SDK | TIC/Windows/SDK/TRTC |


## 快速集成

### 项目配置

在`Visual Studio`开发环境下，按如下步骤导入`依赖SDK`以及`TIC源码`，
1. 源码导入
将`TIC/Windows/SDK/TIC`目录下的`TIC源码`导入到工程；建议在【解决方案资源管理器】中单独为源码建立筛选器，如TIC、TIC\jsoncpp，再将源码导入到对应筛选器下，可参考TIC Demo;

2. 项目配置
在使用SDK的项目上右键，选择【属性】，对项目属性进行配置；
（1）附加包含目录：
项目【属性】-->【C/C++】-->【附加包含目录】-->将所有`依赖SDK`的头文件以及`TIC源码`所在目录路径添加到这里；
例如: `./TIM/includes;./TRTC/include;./TEduBoard/include;`

（2）附加库目录：
项目【属性】-->【链接器】-->【附加库目录】-->将所有`依赖SDK`的导入库所在目录路径添加到这里;
例如：`./TIM/lib/Release;./TRTC/lib;./TEduBoard/lib;`

> 注意: 这里IMSDK分Debug和Release版本，项目的Debug和Release版本对应IMSDK的导入库路径不一样;

3. 引入头文件
在需要使用`TIC`的源码文件内添加如下代码引入`TIC`头文件。

```cpp
#include "TICManager.h" // 引入 TIC 头文件
```

> 注意: 一般大型项目中都会使用预编译头(stdaf.h)来加快编译速度,所以，TIC目录下所有cpp文件都在顶部包含了"stdafx.h"；如果您的项目中，没有使用预编译头，需要将TIC目录及其子目录下的所有cpp文件的第一行注释掉;

### 基本使用流程
![TIC使用流程](https://gitee.com/uploads/images/2019/0428/205955_90abcd21_1637273.png "TICFlow.png")

#### 初始化
1. `TIC`初始化主要是针对`TIM`的初始化，建议您在应用启动的时候调用。
2. 用户被踢或`UserSig`过期会收到相应回调，建议您在登录之前添加 IM 状态回调`AddStatusListener` 。

```cpp
// 添加 IM 状态回调
TICManager::GetInstance().AddStatusListener(statusListener /*消息回调监听器*/);
// 初始化
TICManager::GetInstance().Init(SDK_APP_ID, [](TICModule module, int code, const char *desc) {
    if (code == 0) {
        // 初始化成功
    }
    else {
        // 初始化失败
    }
});

void onTICForceOffline() {
    // 被踢下线
}  

void onTICUserSigExpired() {
    // UserSig过期
}
```

其中 `SDK_APP_ID`为需要您自己填写的参数，回调函数内的 `module` 参数为当前操作模块，具体含义如下：

| 模块名 | 值 | 说明 |
| ------  |-------|-------|
| TICMODULE_IMSDK | 0 | `TIM` 模块 |
| TICMODULE_TRTC | 1 | `TRTC` 模块 |
| TICMODULE_BOARD | 2 | `TEduBoard` 模块 |
| TICMODULE_TIC | 3 | `TIC` 模块 |


#### 登录/登出
初始化后您可以使用登录接口登录，如果调用登录接口时传的用户 ID 已经处于登录中，先登录的设备会被强制下线收到 `onTICForceOffline` 回调。

```cpp
TICManager::GetInstance().Login(USER_ID, USER_SIG, [](TICModule module, int code, const char *desc){
    if (code == 0) {
        // 登录成功
    }
    else {
        // 登录失败
    }
});
```

其中 `USER_ID`、`USER_SIG` （[如何获取 UserSig？](https://cloud.tencent.com/document/product/647/17275)）为需要您自己填写的参数，登出对应接口如下：

```cpp
TICManager::GetInstance().Logout([](TICModule module, int code, const char *desc) {
    if (code == 0) {
        // 登出成功
    }
    else {
        // 登出失败
    }
});
```


#### 创建/销毁课堂
登录成功后您可以创建课堂，如果课堂已存在，可直接加入课堂。

```cpp
TICManager::GetInstance().CreateClassroom(CLASS_ID, [](TICModule module, int code, const char *desc) {
    if(code == 0) {
        // 创建课堂成功
    }
    else if(code == 10021) {
        // 该课堂已被他人创建
    }
    else if(code == 10025) {
        // 该课堂已创建
    }
    else {
        // 创建课堂课堂错误
    }
});
```

其中 `CLASS_ID` 为需要您自己填写的参数，如果课堂不再使用，可销毁课堂，课堂销毁后，课堂内的成员将会收到 `TICEventListener` 中的`onTICClassroomDestroy` 回调。

```cpp
TICManager::GetInstance().DestroyClassroom(CLASS_ID, [](TICModule module, int code, const char *desc) {
    if(code == 0) {
        // 课堂销毁成功
    }
    else if(code == 10004) {
        // 课堂不存在
    }
    else if(code == 10007) {
        // 非创建者没有权限销毁课堂
    }
    else {
        // 销毁课堂错误
    }
});
```

#### 加入/退出课堂
如果课堂已经存在，您可以通过接口 `AddMessageListener` 设置消息监听，`AddEventListener` 设置事件监听，然后加入课堂，已在课堂的其他成员会收到 `TICEventListener` 中的 `onTICMemberJoin` 回调。

```cpp
// 进房参数
TICClassroomOption option;
option.classId = CLASS_ID;
// 消息监听
TICManager::GetInstance().AddMessageListener(messageListener /*消息回调监听器*/);
// 事件监听
TICManager::GetInstance().AddEventListener(eventListener /*消息回调监听器*/);
// 加入课堂
TICManager::GetInstance().JoinClassroom(option, [](TICModule module, int code, const char *desc) {
    if(code == 0) {
        // 加入课堂成功
    }
    else if(code == 10015) {
        // 课堂不存在
    }
    else {
        // 加入课堂失败
    }
});
```

其中 `CLASS_ID`为需要您自己填写的参数，`TICClassroomOption`参数说明如下：

| 参数名 | 参数类型 | 参数说明 |
| ------  |-------|-------|
| classId | int | 课堂 ID | 
| openCamera| bool | 是否开启前置摄像头，默认 false |
| cameraId | string | 要打开的摄像头 ID，默认 nullptr |
| openMic | bool | 是否开启麦克风，默认 false |
| micId | string | 要打开的麦克风 ID，默认 nullptr |
| rendHwnd | HWND | 用于渲染本地画面的窗口 HWND |
| ntpServer | string | NTP 对时服务器地址 |

退出课堂时您需要先移除事件监听 `RemoveEventListener` 和消息监听 `RemoveMessageListener` ，再退出课堂，课堂内的其他成员将会收到 `TICEventListener` 中的 `onTICMemberQuit` 回调。

```cpp
// 移除事件监听
TICManager::GetInstance().RemoveEventListener(eventListener /*消息回调监听器*/);
// 移除消息监听
TICManager::GetInstance().RemoveMessageListener(messageListener /*消息回调监听器*/);
// 退出课堂
TICManager::GetInstance().QuitClassroom([](TICModule module, int code, const char *desc) {
    if(code = 0) {
        // 退出课堂成功
    }
    else {
        // 退出课堂失败
    }
});
```

### 白板操作
`TIC` 中只封装了 `TEduBoard` 的初始化部分代码，您可以通过 `TICManager` 获取白板控制器做更多白板的操作。

```cpp
// 获取白板控制器
TEduBoardController *boardController = TICManager::GetInstance().GetBoardController();
// 其它白板操作
```

更多 `TEduBoard` 接口，请参考 [互动白板接入文档](https://cloud.tencent.com/document/product/680/36113)。


### IM 收发消息
`TIC` 封装了 `TIM` 发消息的常用接口，每个发消息接口在 `TICMessageListener` 监听中都能找到对应的接收消息回调，具体对应关系如下：

| 发送消息接口 | 接收消息回调 | 参数说明 |
| ------  |-------|-------|
| SendTextMessage | onTICRecvTextMessage | 发送和接收 C2C 文本消息 |
| SendCustomMessage| onTICRecvCustomMessage | 发送和接收 C2C 自定义消息 |
| SendGroupTextMessage | onTICRecvGroupTextMessage | 发送和接收群文本消息 |
| SendGroupCustomMessage | onTICRecvGroupCustomMessage | 发送和接收群自定义消息 |
| SendMessage\SendGroupMessage | onTICRecvMessage | 透传除内部协议外的其他消息 |


### TRTC 视频渲染
如果房间内有成员打开或关闭摄像头，其他成员会收到 `TICEventListener` 监听中的 `onTICUserVideoAvailable` 回调，如果房间内有成员打开或关闭屏幕分享，其他成员会收到 `TICEventListener` 监听中的 `onTICUserSubStreamAvailable` 回调，您需要在回调中调用 `TRTC` 的相关方法开启或关闭渲染。

```cpp
void onTICUserVideoAvailable(const std::string& userId, bool available)
{
    if(available) {
        // 获取用于渲染该用户画面的窗口 HWND，该接口需要您自己实现（也可参考 demo 中的实现）
        HWND rendHwnd = getRemoteViewWnd(userId);
        // 开始渲染画面
        TICManager::GetInstance().GetTRTCClound()->startRemoteView(userId.c_str(), rendHwnd);
    }
    else{
        // 停止渲染画面
        TICManager::GetInstance().GetTRTCClound()->stopRemoteView(userId.c_str());
        // 重置用于渲染该用户画面的窗口，该接口需要您自己实现（也可参考 demo 中的实现）
        resetRemoteViewWnd(userId);
    }
}

void onTICUserSubStreamAvailable(const std::string& userId, bool available)
{
    if(available) {
        // 获取用于渲染辅路画面的窗口 HWND，该接口需要您自己实现（也可参考 demo 中的实现）
        HWND rendHwnd = getSubStreamViewWnd();
        // 开始渲染画面
        TICManager::GetInstance().GetTRTCClound()->startRemoteSubStreamView(userId.c_str(), rendHwnd);
    }
    else{
        // 停止渲染画面
        TICManager::GetInstance().GetTRTCClound()->stopRemoteSubStreamView(userId.c_str());
        // 重置用于渲染辅路画面的窗口，该接口需要您自己实现（也可参考 demo 中的实现）
        resetSubStreamViewWnd();
    }
}
```

`TIC` 中只封装了 `TRTC` 的基本用法，您可以通过 `TICManager` 获取 `TRTC` 实例做更多高级操作。

```cpp
// 获取 TRTC 实例
TRTCCloud *trtc = TICManager::GetInstance().GetTRTCClound();
// 开启本地渲染及视频上行
trtc->startLocalPreview(true, rendHwnd);
// 关闭本地渲染
trtc->stopLocalPreview();
// 开启音频上行
trtc->startLocalAudio();
//关闭音频
trtc->stopLocalAudio();
```

以上只列出了 `TRTC` 常用方法，更多 `TRTC` 相关内容，请参考 [腾讯云 TRTC 文档](https://cloud.tencent.com/product/trtc/developer)。


### 离线白板录制

| 文件名称 | 说明 | 位置 |
|------|-----|-----|
| TICRecorder.h | 录制功能定义 | TIC/Windows/SDK/TIC |
| TICRecorder.cpp | 录制功能实现 | TIC/Windows/SDK/TIC |


| 工具类 | 说明 | 位置 |
|------|-----|-----|
| NTP | 获取 ntp 时间 | TIC/Windows/SDK/TIC |
| HttpClient | 封装 winhttp 组件 | TIC/Windows/SDK/TIC |

TIC 进房成功后自动发送课后离线录制需要的对时消息并上报群组 ID，对时消息发送成功您会收到`TICEventListener`的回调`onTICSendOfflineRecordInfo`，只有发送对时信息成功，才能进行课后离线录制。

> 1. demo 对时消息 ntp 时间戳是从腾讯云 ntp 服务获取，您可以选择搭建自己的 ntp 服务器。
> 2. 由于 IM 群消息有可能大于10000，当 IM 群消息大于10000时，消息会开始丢弃，导致空洞消息。上报群组后，后台判断，当群组中 IM 消息大于10000时，会自动备份群消息到 COS。
