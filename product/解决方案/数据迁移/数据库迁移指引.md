数据库迁移方案提供数据库不同迁移场景下的方法步骤，使数据库轻松上云。数据迁移比较典型的应用场景：
- 由于业务需要，从传统 IDC 迁移到云上。
- 用云端作为数据备份，将数据迁移到云端。
- 数据已经在云端，但由于业务需求，需要进行数据迁移，如跨区迁移，自建数据库迁移到 CDB 等场景。

## 数据迁移的类型
### 由本地IDC迁移至腾讯云 CDB
本地业务上云，数据库作为最后部分内容迁入云端。经过前期的测试和试运行，业务运行稳定，现需要将所有业务上云，涉及到最为关键的数据上云过程。
![](//mc.qcloudimg.com/static/img/76feef0a84ddd0976f0ff62cffeaf531/image.png)
### 由其他云迁移至腾讯云 CDB
客户已在其他云上运行业务，需将数据从其他云上迁移到腾讯云CDB中。用户比较关注迁移的可行性，迁移所需要花费的成本（人力成本和时间成本），迁移过程所带来的风险等问题。
![](//mc.qcloudimg.com/static/img/726d581686a3514111be5b8e58e30886/image.png)
### 由腾讯云 CVM 自建数据库迁移至腾讯云 CDB
客户已经在使用腾讯云产品，而且也已经将数据库部署在腾讯云，但使用的是 CVM 自己搭建数据库，随着业务增长以及数据库的增长等因素，需将 CVM 中自建数据库迁移至 CDB 中。此类用户比较关注迁移的便捷性以及可操作性，目前已有成熟产品 CDT 帮助用户进行数据迁移。
![](//mc.qcloudimg.com/static/img/aec7e6007a925755d9a7d809589da0e3/image.png)
### 腾讯云 CDB 跨区域迁移
客户在腾讯云的一个区域内购买了 CDB 服务，随着业务需求，需要在另外一个区域建立应用服务。应用通过跨区进行访问数据库会受性能等限制，所以需要将一个区域的 CDB 迁移到另外一个区域，保持数据同步。
![](//mc.qcloudimg.com/static/img/44d7f9f31260166bc6b8e692f8750b68/image.png)
### 由自建 MySQL 迁移至腾讯云 CVM 自建数据库
用户在本地有自建的 MySQL 数据库，在上云过程中，仅使用了 CVM 产品，用 CVM 自己搭建了数据库服务，满足业务需求，当一定阶段需要再使用 CDB 来满足业务发展需求。
![](//mc.qcloudimg.com/static/img/6ee993e7c50a4ef16abdd3672b90611d/image.png)
## 数据库迁移指引
### DTS工具迁移
腾讯云针对在线迁移场景提供了数据迁移工具（DTS），具体的工具使用说明可参考。
迁移流程如下：
**1. 迁移准备**
- 确认 DTS 是否支持源数据库和目标数据库的系统和版本。
- 确认源数据库的网络联通，明确可访问的 IP 和端口。
- 确认迁移的网络，根据用户的迁移场景和需求，确定选择不同的网络链路作迁移（公网、VPN、专线）
- 确认目标 CDB 实例是否有同名库表，避免冲突。
- 确认目标 CDB 实例容量必须大于源实例。
 
**2. 整体流程**
当迁移准备工作完成后，就可以开始配置迁移任务。
1. 进入 DTS 控制台，单击页面右上角【新建数据迁移】开始任务配置。
2. 配置迁移任务连接信息。
![](//mc.qcloudimg.com/static/img/05e859a6843188cabcc55f5ee64ffca1/image.png)
在这个步骤中，主要配置迁移任务名称，源库及目标库连接信息。其中：
 - 任务名称。默认情况下，DTS 为每个任务自动生成一个任务名称，用户可以修改这个名称，为任务配置一个具备业务意义的名称，便于后续的任务识别。
 - 配置源库连接信息。需要用户选择和填写源库类型、网络类型、地址、端口、账号、密码等连接信息。
 - 配置目标库连接信息。需要用户选择和填写目标库类型、所在地域、网络类型、地址、端口、账号、密码等连接信息。

3. 配置迁移类型及库列表
![](//mc.qcloudimg.com/static/img/49fbad2c60a05a368da3ab104313e914/image.png)
在这个步骤中，需要配置迁移类型及迁移对象。其中：
	i. 选择类型
迁移类型包括结构迁移、全量数据迁移及增量数据迁移。
如果要做全量迁移，那么选择结构迁移＋全量数据迁移。
如果要做不停机迁移，那么选择结构迁移＋全量数据迁移＋增量数据迁移。
  ii.  迁移对象
迁移对象，可以选择整个实例，也可以选择部分库表。
 iii. 预检查。
在迁移任务正式启动之前，会先进行前置预检查，只有预检查通过后，才能成功启动迁移。
如果预检查失败，那么可以点击具体检查项后的按钮，查看具体的失败详情，并根据失败原因修复后，重新进行预检查。
  iv. 启动迁移任务。
当预检查通过后，可以启动迁移任务，任务启动后，可以在任务列表中查看具体的迁移状态及进度。

**3.  注意问题**
DTS 数据迁移任务分为冷备数据导出和增量数据同步两步。其中，冷备数据导出以及迁移后的数据对比过程会对源库负载产生一定的影响，建议在业务低峰期或在备库上做数据库迁移。
仅部分库表迁移任务在增量同步开始阶段和迁移任务完成时，会重启目标 CDB 实例，源数据库不受影响。
需要具有源实例的 super 权限。

### 手动迁移
除了使用腾讯云提供的 dts 工具之外，客户也可以选择以自己的方式作手动迁移。常用的迁移方式有：
**1. 定点停机迁移**
停掉应用，把 MySQL 数据库数据迁移到新结构的 MySQL 数据库中(如：mysqldump)。完成后，切换应用。最大的缺点就是随着数据量的增加停机时间会变得非常长。
**2. MySQL binlog 方案**
MySQL 的迁移可以考虑 MySQL 的主从复制 replication 的特性，解析 binlog 日志出来，然后根据新的业务特点设计的数据库结构，把数据写入到新的数据库，运行迁移过程不需要停机。在数据迁移基本上完成的时候，停掉前段应用，等待迁移全部完成，切换应用到新库。停机时间非常短，只需要 1-2 分钟或者更少。
**3. 触发器方案**
备份老的 MySQL 数据表结构到新的 MySQL 数据库，在新库创建新的表结构，更改老的数据库表，创建触发器，让数据写入的时候同时写入到新的 MySQL 表。dump 旧的 MySQL 的数据，导入到新的 MySQL，这时新的 MySQL 表结构的表应该已经有相应的数据了。然后开启主从复制，让其跟主库数据一致。切换应用，迁移到的方案。停机时间非常短，只需要 1-2 分钟或者更少。
**4.  MySQL udf 方案**
MySQL 的 udf 允许您开发自己的函数集成到 MySQL 中，这样您可以很方便的在数据写入的时候同时写到其他地方。缺点是开发成本大，需要对 MySQL udf 有了解。也可以用现成的 memcached_functions_MySQL 和 lib_MySQLudf_json 来实现，您就不需要编写 udf 函数了，只需要实现一个 memcached 的服务端来接受数据，然后解析 json 到新的数据库即可。memcached 协议非常简单，自己实现起来也很容易。这种方案的迁移时间也会非常短。
**5. 中间件方案**
这种方案需要您的应用连接数据使用了类似中间层的方案，您只需要在中间层增加同时往新库写数据即可。这种方案的依赖比较大，一般的规模的小公司不建议考虑。
