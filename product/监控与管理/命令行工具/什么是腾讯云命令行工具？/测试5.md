## 操作场景

Kubernetes 提供 kubectl 命令行工具用于操作集群，kubectl 使用 kubeconfig 作为配置文件，默认路径为 `~/.kube/config`。如果需要使用 kubectl 管理和操作多个集群，通过 kubeconfig 配置多个集群的信息即可实现。


通过 kubectl 管理和操作容器服务 TKE 或 EKS 集群，需要在集群基本信息页面开启 APIServer 的外网访问或内网访问，获取 kubeconfig （集群访问凭证）。如果需要使用 kubectl 管理多个集群，通常做法是提取 kubeconfig 中各个字段的内容，然后将其合并到 kubectl 所在机器的 kubeconfig 文件中，但该方式操作繁琐且容易出错。

借助 kubecm 工具，可以更简单高效的将多个集群访问凭证合并添加到 kubeconfig 中。本文将介绍如何利用 kubecm 实现多集群的 kubeconfig 高效管理。



## 前提条件


- 已创建 TKE 或 EKS 集群，详情请参见 [创建集群](https://cloud.tencent.com/document/product/457/32189)。
- 在需要管理多集群的机器上已安装 [kubectl](https://kubernetes.io/zh/docs/tasks/tools/install-kubectl/) 命令行工具。


## 操作步骤

### 安装 kubecm

在管理多集群的机器上安装 [kubecm](https://kubecm.cloud/#/en-us/install)。


### 获取集群访问凭证

新建 TKE 或 EKS 集群后，请按照以下 [TKE](#tke) 或 [EKS](#eks) 获取集群访问凭证步骤获取访问凭证：


<span id="tke"></span>

#### TKE 集群获取集群访问凭证

1. 登录容器服务控制台，选择左侧导航栏中的【[集群](https://console.cloud.tencent.com/tke2/cluster)】。
2. 单击需要获取集群访问凭证的集群 ID/名称，进入该集群的管理页面。
3. 在左侧菜单栏中，单击【基本信息】，进入“基本信息” 页面。
4. 在“基本信息” 页面找到【集群APIServer信息】，开启【外网访问】和【内网访问】。
5. 单击【下载】，下载 kubeconfig。
![](https://main.qcloudimg.com/raw/eaefe0e780bf0ef303619a6f054f583a.jpg)

<span id="eks"></span>

#### EKS 集群获取集群访问凭证

1. 登录容器服务控制台，选择左侧导航栏中的【[弹性集群](https://console.cloud.tencent.com/tke2/cluster)】。
2. 单击需要获取集群访问凭证的集群 ID/名称，进入该集群的管理页面。
3. 在左侧菜单栏中，单击【基本信息】，进入“基本信息” 页面。
4. 在“基本信息” 页面找到【集群APIServer信息】，开启【外网访问】和【内网访问】。
5. 单击右侧的【下载】，下载 kubeconfig。
![](https://main.qcloudimg.com/raw/f8884ee3527e3eaf63ad3e114d8a431b.jpg)



### 使用 kubecm 添加访问凭证到 kubeconfig

获取集群访问凭证后，假设文件名为 `cls-l6whmzi3-config`，执行以下命令，使用 `kubecm` 将其添加到 kubeconfig 中（`-n` 可指定 context 名称）。示例如下：

```plaintext
kubecm add -f cls-l6whmzi3-config -n cd -c
```

### 查看集群列表

执行以下 `kubecm ls` 命令查看 kubeconfig 中的集群列表（星号标识的是当前操作的集群）。示例如下：

```plaintext
$ kubecm ls
+------------+------------+-----------------------+--------------------+-----------------------------------+-------------------+
|   CURRENT  |    NAME    |        CLUSTER        |        USER        |               SERVER              |     Namespace     |
+============+============+=======================+====================+===================================+===================+
|      *     |     cd     |   cluster-chh6kgf9d9  |   user-chh6kgf9d9  |   https://cls-l6whmzi3.ccs.tence  |      default      |
|            |            |                       |                    |            nt-cloud.com           |                   |
+------------+------------+-----------------------+--------------------+-----------------------------------+-------------------+
|            |     bj     |   cluster-6qaua96n    |   user-6qaua96n    |   https://cls-6qaua96n.ccs.tence  |    kube-system    |
|            |            |                       |                    |            nt-cloud.com           |                   |
+------------+------------+-----------------------+--------------------+-----------------------------------+-------------------+
```

### 切换集群

如果需要切换到其它集群操作，可以使用命令 `kubecm switch` 进行交互式切换。如下图所示：

![](https://main.qcloudimg.com/raw/3eea3d35d3a19f93906eabf60a423a0b.png)

### 移除集群

如果需要移除某个集群，可以使用命令 `kubecm delete` 进行移除。示例如下：

```plaintext
$ kubecm delete bj
Context Delete:「bj」
「/Users/roc/.kube/config」 write successful!
+------------+---------+-----------------------+--------------------+-----------------------------------+--------------+
|   CURRENT  |   NAME  |        CLUSTER        |        USER        |               SERVER              |   Namespace  |
+============+=========+=======================+====================+===================================+==============+
|            |    cd   |   cluster-chh6kgf9d9  |   user-chh6kgf9d9  |   https://cls-l6whmzi3.ccs.tence  |    default   |
|            |         |                       |                    |            nt-cloud.com           |              |
+------------+---------+-----------------------+--------------------+-----------------------------------+--------------+
```

## 参考文档

- [kubecm 开源地址](https://github.com/sunny0826/kubecm)
- [kubecm 官方文档](https://kubecm.cloud)
